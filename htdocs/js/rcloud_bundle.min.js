// bare-bones d3 charting facilities
function rcloud_github_handler(e,t){return function(n){if(n.ok)t&&t(n.content);else{var r=_.isObject(n)&&"ok"in n?n.content.message:n.toString();rclient.post_error(e+": "+r)}}}(function(){function e(e,t){return"translate("+e+","+t+")"}function t(e,t,n){var r=e.slice((n||t)+1||e.length);return e.length=t<0?e.length+t:t,e.push.apply(e,r)}function i(e,t){if(_.isUndefined(n[t])){var i=new Uint8Array(e.data().length);r[t]=i,n[t]=[e]}else n[t].push(e)}function o(e){return typeof e=="function"?e:function(e){return function(){return e}}(e)}Chart={};var n={},r={};Chart.get_selections=function(e){return r[this.group_id]},Chart.set_selections=function(e,t){for(var i=0;i<t.length;i++)r[e][i]=t[i];_.each(n[e],function(e){_.each(e.views,function(e){e.selection_changed()})})},Chart.data_model=function(e,t){var s=e.length,o={views:{},group_id:t,data:function(){return e},selection:function(){return r[this.group_id]},register_view:function(e){this.views[e._view_index]=e},deregister_view:function(e){delete this.views[e._view_index]},notify:function(){_.each(n[this.group_id],function(e){_.each(e.views,function(e){e.selection_changed()})})},clear_brushes:function(e){_.each(n[this.group_id],function(t){_.each(t.views,function(t){t._view_index!==e._view_index&&(console.log("clearing brush on view",t._view_index,t,e),t.clear_brush())})})}};return i(o,t),o};var s=0;Chart.scatterplot=function(t){function M(){var e=u.selection();N.attr("display",function(t){return e[t]?null:"none"})}function D(n){n.attr("d",d3.svg.symbol().type("circle")).attr("size",5).attr("transform",function(n){return n=a[n],e(v(t.x(n)),m(t.y(n)))}).style("stroke-width",function(e){return y.opts.stroke_width(a[e])})}function P(e){u.clear_brushes(y)}function H(e){var n=E.extent(),r=u.selection();T.each(function(e){var i=a[e],s=n[0][0]<=t.x(i)&&t.x(i)<=n[1][0]&&n[0][1]<=t.y(i)&&t.y(i)<=n[1][1];r[e]=s}),u.notify()}function B(){E.empty()&&M(T)}t=_.defaults(t,{width:400,height:400,padding:20,n_xticks:10,n_yticks:10,stroke:"white",stroke_width:"1.5px",fill:"black",stroke_opacity:1,fill_opacity:1}),t.stroke=o(t.stroke),t.stroke_opacity=o(t.stroke_opacity),t.stroke_width=o(t.stroke_width),t.fill=o(t.fill),t.fill_opacity=o(t.fill_opacity);var n=t.width,r=t.height,i=t.padding,u=t.data,a=u.data(),f=_.map(a,t.x),l=_.map(a,t.y),c=_.min(f),h=_.max(f),p=_.min(l),d=_.max(l),v=d3.scale.linear().domain([c,h]).range([0,n]),m=d3.scale.linear().domain([p,d]).range([r,0]),g=$("<div></div>")[0],y={_view_index:++s,opts:t,plot:g,clear_brush:function(){w.call(E.clear())},selection_changed:function(){M()},deleted:function(){u.deregister_view(this)}};u.register_view(y);var b=d3.select(g).append("svg").attr("width",n+2*i).attr("height",r+2*i),w=b.append("g").attr("transform",e(i,i)),E=d3.svg.brush().on("brushstart",P).on("brush",H).on("brushend",B);w.append("rect").attr("width",n).attr("height",r).attr("fill","#eee");var S=w.selectAll("g.x").data(v.ticks(t.n_xticks)).enter().append("g").attr("class","x");S.append("line").attr("x1",v).attr("x2",v).attr("y1",0).attr("y2",r),S.append("text").attr("x",v).attr("y",r+3).attr("dy",".71em").attr("text-anchor","middle").attr("class","rule-text").text(v.tickFormat(t.n_xticks));var x=w.selectAll("g.y").data(m.ticks(t.n_yticks)).enter().append("g").attr("class","x");x.append("line").attr("x1",0).attr("x2",n).attr("y1",m).attr("y2",m),x.append("text").attr("x",-3).attr("y",m).attr("dy",".35em").attr("text-anchor","end").attr("class","rule-text").text(m.tickFormat(t.n_yticks));var T=w.selectAll("path.dot").data(_.range(a.length)).enter().append("path"),N=w.selectAll("pathasdkf.dot").data(_.range(a.length)).enter().append("path"),C=function(e){return a[e]};T.style("fill",_.compose(t.fill,C)).style("stroke",_.compose(t.stroke,C)).style("fill-opacity",_.compose(t.fill_opacity,C)).style("stroke-opacity",_.compose(t.stroke_opacity,C)),w.call(E.x(v).y(m));var k=function(){return"red"},L=function(){return"red"},A=function(){return 1},O=function(){return 1};return N.style("fill",_.compose(k,C)).style("stroke",_.compose(L,C)).style("fill-opacity",_.compose(A,C)).style("stroke-opacity",_.compose(O,C)),b.on("keydown",function(e){console.log(e)}),D(T),D(N),M(),y},Chart.histogram=function(e){e=_.defaults(e,{width:400,height:400,padding:20,n_bins:10,stroke:"white",stroke_width:"1.5px",fill:"black",stroke_opacity:1,fill_opacity:1}),e.stroke=o(e.stroke),e.stroke_opacity=o(e.stroke_opacity),e.stroke_width=o(e.stroke_width),e.fill=o(e.fill),e.fill_opacity=o(e.fill_opacity);var t=e.width,n=e.height,r=e.padding,i=e.data,u=i.data(),a=_.map(u,e.x),f=_.min(a),l=_.max(a),c=$("<div></div>")[0],h=d3.scale.linear().domain([f,l]).range([0,t]),p=d3.layout.histogram().range([f,l]).bins(e.n_bins),d=p(e.x),v={_view_index:++s,opts:e,plot:c,clear_brush:function(){vis.call(brush.clear())},selection_changed:function(){update_selection()},deleted:function(){i.deregister_view(this)}}}})(),LuxChart={},LuxChart.lux_tour_plot=function(e){function a(){var t={},n=[];for(var r=0;r<e.length;++r)t["dim_"+r]=Lux.attribute_buffer({vertex_array:new Float32Array(e[r]),item_size:1,keep_array:!0}),n.push("dim_"+r);return t.columns=n,t}function f(){Lux.set_context(c),s=a();var e=10,t=2.5,n=1;o=[],u=[];var r,i,f=[],l=Shade.vec(0,0),h=Shade.vec(0,0),p=Shade.vec(0,0);for(var d=0;d<s.columns.length;++d){var v=s[s.columns[d]];o.push(Shade.parameter("float")),u.push(Shade.parameter("float"));var m=Shade.vec(o[d],u[d]);r=_.min(v.array),i=_.max(v.array),f=(i+r)/2,l=l.add(m.mul(v)),h=h.add(m.mul(f)),p=p.add(m.mul(f-r).abs())}Lux.Scene.add(Lux.Marks.scatterplot({elements:s[s.columns[0]].numItems,xy:l,xy_scale:Shade.Scale.linear({domain:[h.sub(p),h.add(p)],range:[Shade.vec(0,0),Shade.vec(1,1)]}),fill_color:Shade.color("red"),stroke_color:Shade.mix(Shade.color("black"),Shade.color("red"),.5),stroke_width:t,point_diameter:e}))}function l(e){var t=[],n=[],r=0,i=0;for(var s=0;s<e;++s)t[s]=Math.random()*2-1,n[s]=Math.random()*2-1,r+=t[s]*t[s],i+=n[s]*n[s];r=Math.sqrt(r),i=Math.sqrt(i);if(r===0||i===0)return l(e);var o=0;for(s=0;s<e;++s)t[s]/=r,n[s]/=i,o+=t[s]*n[s];var u=0;for(s=0;s<e;++s)n[s]=n[s]-o*t[s],u+=n[s]*n[s];u=Math.sqrt(u);if(u===0)return l(e);for(s=0;s<e;++s)n[s]/=u;return[t,n]}var t=600,n=600,r=$("<canvas></canvas>")[0];r.width=t,r.height=n;var i,s,o,u,c=Lux.init({canvas:r,clearColor:[1,1,1,1]});f();var h=l(s.columns.length),p=l(s.columns.length),d=(new Date).getTime(),v=1;return Lux.Scene.animate(function(){var e=((new Date).getTime()-d)/1e3,t=e/3;t-=Math.floor(t),t<v&&(h=p,p=l(4)),v=t;for(var n=0;n<s.columns.length;++n)o[n].set(t*p[0][n]+(1-t)*h[0][n]),u[n].set(t*p[1][n]+(1-t)*h[1][n])}),r},LuxChart.lux_osm_plot=function(e,t,n,r,i){var s=$("<canvas></canvas>")[0];s.width=r,s.height=i;var o=Lux.init({canvas:s,clearColor:[1,1,1,1],mousedown:function(e){var t=f.mousedown(e);return t},mousemove:function(e){var t=f.mousemove(e);return t},mouseup:function(e){var t=f.mouseup(e);return t}}),u=Shade.parameter("float",3),a=Shade.Camera.perspective({look_at:[Shade.vec(0,0,6),Shade.vec(0,0,-1),Shade.vec(0,1,0)],field_of_view_y:Shade.div(20,u)}),f=Lux.Marks.globe({view_proj:a,zoom:u,polygon_offset:{factor:0,units:5}});e=Lux.attribute_buffer({vertex_array:new Float32Array(e),item_size:1}),t=Lux.attribute_buffer({vertex_array:new Float32Array(t),item_size:1}),n.length===3?n=Shade.vec(n[0],n[1],n[2],1):n.length>1&&(n=Shade.vec(Lux.attribute_buffer({vertex_array:new Float32Array(n),item_size:3}),1));var l=Lux.model({type:"points",lats:e,lons:t}),c=Lux.actor({model:l,appearance:{color:n,point_size:2,position:f.lat_lon_position(l.lats.radians(),l.lons.radians())}});return Lux.Scene.add(f),Lux.Scene.add(c),s},function(){function e(e){return e==null?"NULL":'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}function t(){this.name="NoCallbackError"}function n(){throw new t}t.prototype=Object.create(Error),t.prototype.constructor=t,RClient={create:function(r){function i(){p.running=!0,p.send("rcloud.support:::session.init(username="+e(rcloud.username())+",token="+e(rcloud.github_token())+")"),r.on_connect&&r.on_connect.call(p)}function s(){$("#input-div").hide()}function o(e,t){switch(t){case 65:p.post_error(p.disconnection_error("Authentication failed. Login first!")),s();break;default:p.post_error(p.disconnection_error(e)),s()}}function u(e){p.post_error(p.disconnection_error("Socket was closed. Goodbye!")),s()}var a=$.cookies.get().token,f=$.cookies.get().execToken,l=Rserve.create({host:r.host,on_connect:i,on_error:o,on_close:u,on_data:r.on_data,on_oob_message:r.on_oob_message,login:a+"\n"+f}),c=!1,h=undefined,p;return p={handlers:{eval:function(e){return p.post_response(e),e},"markdown.eval":function(e){return p.display_markdown_response(e),e},browsePath:function(e){$.ajax({url:"http://127.0.0.1:8080"+e}).done(function(e){var t=/[\s\S]*<body>([\s\S]*)<\/body>/g.exec(e)[1];$("#help-output").html(t)})},"dev.new":function(e){return""},"dev.close":function(e){return""},internal_cmd:function(e){return""},"boot.failure":function(e){p.running=!1}},running:!1,eval:function(e){var t=this;if(e.type!=="sexp")return this.post_error("Bad protocol, should always be sexp.");e=e.value;if(e.type==="string_array")return this.post_error(e.value[0]);if(e.type==="null")return null;if(e.type!=="vector")return this.post_error("Protocol error, unexpected value of type "+e.type);if(e.value[0].type!=="string_array"||e.value[0].value.length!==1)return console.log("Protocol error?! ",e.value[0]),undefined;var n=e.value[0].value[0],r=this.handlers;return r[n]===undefined?this.post_error("Unknown command "+n):r[n].call(this,e.json()[1])},register_handler:function(e,t){this.handlers[e]=t},createFile:function(e,t){l.createFile(e,t)},writeFile:function(e,t){l.writeFile(e,t)},closeFile:function(e){l.closeFile(e)},post_div:function(e){return shell.post_div(e)},display_markdown_response:function(e){e&&($("#output").append($("<div></div>").html(e.value[0])).find("pre code").each(function(e,t){hljs.highlightBlock(t)}),MathJax.Hub.Queue(["Typeset",MathJax.Hub]))},string_error:function(e){return $("<div class='alert alert-error'></div>").text(e)},disconnection_error:function(e){var t=$("<div class='alert alert-error'></div>");t.append($("<span></span>").text(e));var n=$("<button type='button' class='close'>Reconnect</button>");return t.append(n),n.click(function(){window.location=window.location.protocol+"//"+window.location.host+"/login.R?redirect="+encodeURIComponent(window.location.pathname+window.location.search)}),t},post_error:function(e){typeof e=="string"&&(e=this.string_error(e));if(typeof e!="object")throw new Error("post_error expects a string or a jquery div");$("#output").append(e),window.scrollTo(0,document.body.scrollHeight)},post_response:function(e){var t=$("<pre></pre>").html(e);$("#output").append(t),window.scrollTo(0,document.body.scrollHeight)},capture_answers:function(e,t){function r(r){n.push(r),e--,e===0&&(c=!1,h=undefined,t(n))}if(c)throw"Still waiting for previous answers...";c=!0;var n=[];h=r},wrap_command:function(e,t){return t===undefined&&(t=!1),"rcloud.support:::session.eval({"+e+"}, "+(t?"TRUE":"FALSE")+")"},markdown_wrap_command:function(t,n){return"rcloud.support:::session.markdown.eval({markdownToHTML(text=paste(knit(text="+e(t+"\n")+'), collapse="\\n"), fragment=TRUE)}, '+(n?"TRUE":"FALSE")+")"},log:function(e){e='rcloud.support:::session.log("'+rcloud.username()+'", "'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'")',this.send(e)},record_cell_execution:function(e){var t=JSON.stringify(e.json()),n=this.r_funcall("rcloud.record.cell.execution",rcloud.username(),t);l.eval(n)},send:function(e,t){this.send_and_callback(e,n,t)},send_and_callback:function(e,r,i){function u(n){n=n.value.json();try{r(n[1])}catch(i){if(i.constructor!==t)throw'Error evaluating "'+e+'": '+i;s.handlers[n[0]](n[1])}}var s=this;_.isUndefined(r)&&(r=n);var o;i?e=i(e):e=this.wrap_command(e,!0),l.eval(e,u)},r_funcall:function(t){function n(t,n){var r=typeof n;if(n===null)t.push("NULL");else if(r==="string")t.push(e(n));else{if(r!="number")throw"unsupported r_funcall argument type "+r;t.push(String(n))}}var r=[t,"("];for(var i=1;i<arguments.length;++i){var s=arguments[i];if($.isArray(s)){r.push("c(");for(var o=0;o<s.length;++o)n(r,s[o]),o<s.length-1&&r.push(",");r.push(")")}else n(r,s);i<arguments.length-1&&r.push(",")}r.push(")");var u=r.join("");return u}},p}}}(),rcloud={},rcloud.init_client_side_data=function(){var e=this;rclient.send_and_callback("rcloud.prefix.uuid()",function(t){e.wplot_uuid=t})},rcloud.username=function(){return $.cookies.get("user")},rcloud.github_token=function(){return $.cookies.get("token")},rcloud.search=function(e,t){var n=this;_.isUndefined(t)&&(t=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.search",e),t)},rcloud.load_user_config=function(e,t){_.isUndefined(t)&&(t=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.load.user.config",e),function(e){t&&t(JSON.parse(e))})},rcloud.load_multiple_user_configs=function(e,t){rclient.send_and_callback(rclient.r_funcall("rcloud.load.multiple.user.configs",e),function(e){t&&t(JSON.parse(e))})},rcloud.save_user_config=function(e,t,n){_.isUndefined(n)&&(n=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.save.user.config",e,JSON.stringify(t)),function(e){n&&n(JSON.parse(e))})},rcloud.load_notebook=function(e,t,n){rclient.send_and_callback(rclient.r_funcall("rcloud.get.notebook",e,t),rcloud_github_handler("rcloud.get.notebook "+e,n))},rcloud.update_notebook=function(e,t,n){rclient.send_and_callback(rclient.r_funcall("rcloud.update.notebook",e,JSON.stringify(t)),rcloud_github_handler("rcloud.update.notebook",n))},rcloud.create_notebook=function(e,t){rclient.send_and_callback(rclient.r_funcall("rcloud.create.notebook",JSON.stringify(e)),rcloud_github_handler("rcloud.create.notebook",t))},rcloud.fork_notebook=function(e,t){rclient.send_and_callback(rclient.r_funcall("rcloud.fork.notebook",e),rcloud_github_handler("rcloud.fork.notebook",t))},rcloud.resolve_deferred_result=function(e,t){var n=rclient.r_funcall("rcloud.fetch.deferred.result",e);rclient.send_and_callback(n,t)},rcloud.get_users=function(e,t){rclient.send_and_callback(rclient.r_funcall("rcloud.get.users",e),t)},rcloud.rename_notebook=function(e,t,n){rclient.send_and_callback(rclient.r_funcall("rcloud.rename.notebook",e,t),rcloud_github_handler("rcloud.rename.notebook",n))},rcloud.upload_file=function(){function e(e,t){var n=e+"/"+t.name;rclient.createFile(n);var r=new FileReader,i=1048576,s=t.size,o=0;r.readAsArrayBuffer(t.slice(o,o+i)),r.onload=function(e){if(e.target.result.byteLength>0){var n=new Uint8Array(e.target.result);rclient.writeFile(n,function(){o+=i,r.readAsArrayBuffer(t.slice(o,o+i))})}else rclient.closeFile(function(){alert.show("File uploaded successfully!")})}}if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))throw"File API not supported by browser.";var t=$("#file")[0].files[0];if(_.isUndefined(t))throw"No file selected!";rclient.send_and_callback(rclient.r_funcall("rcloud.upload.path"),function(t){var n=$("#file")[0].files[0];if(_.isUndefined(n))throw new Error("No file selected!");e(t,n)})};var ui_utils={};ui_utils.fa_button=function(e,t,n,r){var i=$("<span/>",{"class":"fontawesome-button "+(n||"")}),s=$("<i/>",{"class":e});return r&&s.css(r),i.append(s).tooltip({title:t,delay:{show:250,hide:0}}),i},ui_utils.ace_editor_height=function(e){var t=e.renderer.lineHeight,n=Math.min(30,e.getSession().getLength()),r=t*n+e.renderer.scrollBar.getWidth();return Math.max(75,r)},ui_utils.make_prompt_chevron_gutter=function(e){var t=require("ace/lib/dom");e.renderer.$gutterLayer.update=function(e){var n={className:""},r=[],i=e.firstRow,s=e.lastRow,o=this.session.getNextFoldLine(i),u=o?o.start.row:Infinity,a=this.$showFoldWidgets&&this.session.foldWidgets,f=this.session.$breakpoints,l=this.session.$decorations,c=this.session.$firstLineNumber,h=0;r.push("<div class='ace_gutter-cell ","' style='height:",this.session.getRowLength(0)*e.lineHeight,"px;'>","&gt;","</div>"),this.element=t.setInnerHtml(this.element,r.join("")),this.element.style.height=e.minHeight+"px",this.session.$useWrapMode&&(h=this.session.getLength());var p=(""+h).length*e.characterWidth,d=this.$padding||this.$computePadding();p+=d.left+d.right,p!==this.gutterWidth&&!isNaN(p)&&(this.gutterWidth=p,this.element.style.width=Math.ceil(this.gutterWidth)+"px",this._emit("changeGutterWidth",p))}},Notebook={},Notebook.Cell={},function(){function e(e){return function(t){function f(){return t.content(w.getSession().getValue())}function l(e){e.removeClass("button-disabled")}function c(e){e.addClass("button-disabled")}function h(){T.html("Computing...");var e=f();C.show_result(),e!==null&&t.parent_model.controller.update_cell(t),t.controller.execute()}var n=$("<div class='notebook-cell'></div>"),r=ui_utils.fa_button("icon-plus-sign","insert cell"),i=ui_utils.fa_button("icon-edit","source"),s=ui_utils.fa_button("icon-picture","result"),o=ui_utils.fa_button("icon-trash","remove"),u=ui_utils.fa_button("icon-play","run"),a=$("<div/>").html("&nbsp;").css({"line-height":"25%"});r.click(function(e){shell.insert_markdown_cell_before(t.id)}),i.click(function(e){$(e.currentTarget).hasClass("button-disabled")||C.show_source()}),s.click(function(e){$(e.currentTarget).hasClass("button-disabled")||C.show_result()}),o.click(function(e){$(e.currentTarget).hasClass("button-disabled")||(t.parent_model.controller.remove_cell(t),$(".tooltip").remove())}),u.click(function(e){h()});var p=$("<div class='cell-controls'></div>"),d=$("<table/>");$.each([u,i,s,a,o],function(){d.append($("<tr/>").append($("<td/>").append($(this))))}),p.append(d),n.append(p);var v=$("<div class='cell-insert-control'></div>");v.append(r),n.append(v);var m=$("<div></div>"),g=$("<div style='clear:both;'></div>");n.append(m),n.append(g);var y=$('<div style="position: relative; width:100%; height:100%"></div>'),b=$('<div style="width:100%; height:100%"></div>');b.css({"background-color":e==="R"?"#E8F1FA":"#F7EEE4"}),m.append(y),y.append(b);var w=ace.edit(b[0]),E=require(e==="R"?"ace/mode/r":"ace/mode/rmarkdown").Mode,S=w.getSession(),x=S.doc;w.setReadOnly(t.parent_model.read_only),S.setMode(new E(!1,x,S)),S.on("change",function(){n.css({height:ui_utils.ace_editor_height(w)+"px"}),w.resize()}),w.setTheme("ace/theme/chrome"),S.setUseWrapMode(!0),w.resize(),w.commands.addCommand({name:"sendToR",bindKey:{win:"Ctrl-Return",mac:"Command-Return",sender:"editor"},exec:function(e,t,n){h()}});var T=$('<div class="r-result-div"><span style="opacity:0.5">Computing ...</span></div>');m.append(T);var N,C={content_updated:function(){var e=w.getCursorPosition(),n=w.getSession().setValue(t.content());return w.getSelection().moveCursorToPosition(e),n},self_removed:function(){n.remove()},result_updated:function(e){T.hide(),T.html(e),T.slideDown(150);var t=rcloud.wplot_uuid;m.find("pre code").contents().filter(function(){return this.nodeValue.indexOf(t)!==-1}).parent().parent().each(function(){var e=this.childNodes[0].childNodes[0].data.substr(8,73).split("|"),t=this;rcloud.resolve_deferred_result(e[1],function(e){$(t).replaceWith(function(){return shell.handle(e[0],e)})})}),m.find("pre code").each(function(e,t){hljs.highlightBlock(t)}),_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub]),this.show_result()},hide_buttons:function(){p.css("display","none"),v.hide()},show_buttons:function(){p.css("display",null),v.show()},show_source:function(){n.css({height:ui_utils.ace_editor_height(w)+"px"}),y.show(),w.resize(!0),n.css({height:ui_utils.ace_editor_height(w)+"px"}),w.resize(!0),c(i),l(s),l(o),y.show(),T.hide(),w.resize(),w.focus(),N="source"},show_result:function(){n.css({height:""}),l(i),c(s),l(o),y.hide(),T.slideDown(150),N="result"},hide_all:function(){n.css({height:""}),l(i),l(s),l(o),N==="result"?T.slideUp(150):y.slideUp(150)},div:function(){return n},update_model:function(){return f()},focus:function(){w.focus()},get_content:function(){return t.content()}};return C.show_result(),C.content_updated(),C}}var t={Markdown:e("Markdown"),R:e("R")};Notebook.Cell.create_html_view=function(e){return t[e.language()](e)}}(),Notebook.Cell.create_model=function(e,t){function r(){_.each(n.views,function(e){e.content_updated()})}var n={views:[],id:-1,language:function(){return t},content:function(t){return _.isUndefined(t)?e:e!=t?(e=t,r(),e):null},json:function(){return{content:e,language:t}}};return n},Notebook.Cell.create_controller=function(e){var t={execute:function(t){function i(n){_.each(e.views,function(e){e.result_updated(n)}),t&&t()}var n=this,r=e.language();rclient.record_cell_execution(e);if(r==="Markdown"){var s=rclient.markdown_wrap_command(e.content());rclient.send_and_callback(s,i,_.identity)}else if(r==="R"){var s=rclient.markdown_wrap_command("```{r}\n"+e.content()+"\n```\n");rclient.send_and_callback(s,i,_.identity)}else alert("Don't know language '"+r+"' - can only do Markdown or R for now!")}};return t},Notebook.create_html_view=function(e,t){var n={model:e,sub_views:[],cell_appended:function(e){var n=Notebook.Cell.create_html_view(e);return e.views.push(n),t.append(n.div()),this.sub_views.push(n),n},cell_inserted:function(e,n){var r=Notebook.Cell.create_html_view(e);return e.views.push(r),t.append(r.div()),$(r.div()).insertBefore(t.children(".notebook-cell")[n]),this.sub_views.splice(n,0,r),r.show_source(),r},cell_removed:function(e,t){_.each(e.views,function(e){e.self_removed()}),this.sub_views.splice(t,1)},update_model:function(){return _.map(this.sub_views,function(e){return e.update_model()})}};return e.views.push(n),n},Notebook.create_model=function(){function e(e){return e.length?e[e.length-1].id:0}return{read_only:!1,notebook:[],views:[],clear:function(){return this.remove_cell(null,e(this.notebook))},append_cell:function(t,n){t.parent_model=this;var r=[],i=1;n=n||1,n=Math.max(n,e(this.notebook)+1);while(i)r.push([n,{content:t.content(),language:t.language()}]),t.id=n,this.notebook.push(t),_.each(this.views,function(e){e.cell_appended(t)}),++n,--i;return r},insert_cell:function(e,t){var n=this;e.parent_model=this;var r=[],i=1,s=0;while(s<this.notebook.length&&this.notebook[s].id<t)++s;if(s<this.notebook.length&&t+i>this.notebook[s].id){var o=s>0?this.notebook[s-1].id:0;t=Math.max(this.notebook[s].id-i,o+1)}for(var u=0;u<i;++u)r.push([t+u,{content:e.content(),language:e.language()}]),e.id=t+u,this.notebook.splice(s,0,e),_.each(this.views,function(e){e.cell_inserted(n.notebook[s],s)}),++s;while(s<this.notebook.length&&i){if(this.notebook[s].id>t){var a=this.notebook[s].id-t;i-=a,t+=a}if(i<=0)break;r.push([this.notebook[s].id,{content:this.notebook[s].content(),rename:this.notebook[s].id+i,language:this.notebook[s].language()}]),this.notebook[s].id+=i,++s,++t}return r},remove_cell:function(e,t){var n=this,r,i;if(e!=null){r=this.notebook.indexOf(e),i=e.id;if(r===-1)throw"cell_model not in notebook model?!"}else r=0,i=1;var t=t||1,s=r,o=[];while(s<this.notebook.length&&t)this.notebook[s].id==i&&(_.each(this.views,function(e){e.cell_removed(n.notebook[s],s)}),o.push([i,{erase:1,language:n.notebook[s].language()}]),this.notebook.splice(s,1)),++i,--t;return o},update_cell:function(e){return[[e.id,{content:e.content(),language:e.language()}]]},reread_cells:function(){var e=this,t=_.map(this.views,function(e){return e.update_model()});if(t.length!=1)throw"not expecting more than one notebook view";return _.reduce(t[0],function(t,n,r){return n&&t.push([e.notebook[r].id,{content:n,language:e.notebook[r].language()}]),t},[])},json:function(){return _.map(this.notebook,function(e){return e.json()})}}},Notebook.create_controller=function(e){function n(t,n,r){var i=Notebook.Cell.create_model(t,n),s=Notebook.Cell.create_controller(i);return i.controller=s,[s,e.append_cell(i,r)]}function r(t,n,r){var i=Notebook.Cell.create_model(t,n),s=Notebook.Cell.create_controller(i);return i.controller=s,[s,e.insert_cell(i,r)]}function i(){e.read_only?$(".ace_cursor-layer").hide():$(".ace_cursor-layer").show()}function s(r,s,o){this.clear(),e.read_only=s!=null||o.user.login!=rcloud.username();var u={};_.each(o.files,function(e){var t=e.filename;if(/^part/.test(t)){var n=parseInt(t.slice(4).split(".")[0]);n!==NaN&&(u[n]=[e.content,e.language,n])}});for(var a in u)n(u[a][0],u[a][1],u[a][2]);i(),t=o,r&&r(o)}function o(e){var n=[],r=e.files,i=_.extend({},t.files);for(var s in r){if(s==="r_type")continue;s in i?((i[s].language!=r[s].language||i[s].content!=r[s].content)&&n.push([s,i[s]]),delete i[s]):n.push([s,{erase:!0,language:r[s].language}])}for(s in i){if(s==="r_type")continue;n.push([s,i[s]])}return n}var t,u={append_cell:function(e,t,r){var i=n(e,t,r);return e.length&&this.update_notebook(i[1]),i[0]},insert_cell:function(e,t,n){var i=r(e,t,n);return e.length&&this.update_notebook(i[1]),i[0]},remove_cell:function(t){var n=e.remove_cell(t);shell.input_widget.focus(),this.update_notebook(n)},clear:function(){e.clear()},load_notebook:function(e,t,n){var r=this;rcloud.load_notebook(e,t||null,_.bind(s,this,n,t))},create_notebook:function(n,r){var i=this;rcloud.create_notebook(n,function(n){i.clear(),e.read_only=n.user.login!=rcloud.username(),t=n,r&&r(n)})},fork_or_revert_notebook:function(e,t,n,r){function u(e,t,n){e.length?s.update_notebook(e,t,n):(i(),rcloud.load_notebook(t,null,n))}var s=this;e?rcloud.load_notebook(t,null,function(e){var n=o(e);u(n,t,r)}):rcloud.fork_notebook(t,function(e){if(n){var t=o(e);u(t,e.id,r)}else s.load_notebook(e.id,null,r)})},update_notebook:function(n,r,s){function o(e,t){if(_.isString(e))return e;var n;switch(t){case"R":n="R";break;case"Markdown":n="md";break;default:throw"Unknown language "+t}return"part"+e+"."+n}function u(e){function n(e,n){var r={};n[1].content!==undefined&&(r.content=n[1].content);var i=o(n[0],n[1].language);if(n[1].erase||!t[i])e[i]=null;var s=o(n[1].rename||n[0],n[1].language);return n[1].erase||(e[s]=r),e}var t=_.reduce(e,function(e,t){if(!t[1].erase){var n=t[1].rename||t[0];e[o(n,t[1].language)]=1}return e},{});return{files:_.reduce(e,n,{})}}if(!n.length)return;if(e.read_only)throw"attempted to update read-only notebook";r=r||shell.gistname(),s=s||_.bind(editor.notebook_loaded,editor,null),i();var a=function(e){t=e,s(e)};n.length&&rcloud.update_notebook(r,u(n),a)},refresh_cells:function(){return e.reread_cells()},update_cell:function(t){this.update_notebook(e.update_cell(t))},run_all:function(){var t=this.refresh_cells();this.update_notebook(t),_.each(e.notebook,function(e){e.controller.execute()})}};return e.controller=u,u};