// bare-bones d3 charting facilities
(function(){function g(a){return typeof a=="function"?a:function(a){return function(){return a}}(a)}function e(a,b){if(_.isUndefined(c[b])){var e=new Uint8Array(a.data().length);d[b]=e,c[b]=[a]}else c[b].push(a)}function b(a,b,c){var d=a.slice((c||b)+1||a.length);a.length=b<0?a.length+b:b;return a.push.apply(a,d)}function a(a,b){return"translate("+a+","+b+")"}Chart={};var c={},d={};Chart.get_selections=function(a){return d[this.group_id]},Chart.set_selections=function(a,b){for(var e=0;e<b.length;e++)d[a][e]=b[e];_.each(c[a],function(a){_.each(a.views,function(a){a.selection_changed()})})},Chart.data_model=function(a,b){var f=a.length,g={views:{},group_id:b,data:function(){return a},selection:function(){return d[this.group_id]},register_view:function(a){this.views[a._view_index]=a},deregister_view:function(a){delete this.views[a._view_index]},notify:function(){_.each(c[this.group_id],function(a){_.each(a.views,function(a){a.selection_changed()})})},clear_brushes:function(a){_.each(c[this.group_id],function(b){_.each(b.views,function(b){b._view_index!==a._view_index&&(console.log("clearing brush on view",b._view_index,b,a),b.clear_brush())})})}};e(g,b);return g};var f=0;Chart.scatterplot=function(b){function J(){v.empty()&&F(y)}function I(a){var c=v.extent(),d=h.selection();y.each(function(a){var e=i[a],f=c[0][0]<=b.x(e)&&b.x(e)<=c[1][0]&&c[0][1]<=b.y(e)&&b.y(e)<=c[1][1];d[a]=f}),h.notify()}function H(a){h.clear_brushes(s)}function G(c){c.attr("d",d3.svg.symbol().type("circle")).attr("size",5).attr("transform",function(c){c=i[c];return a(p(b.x(c)),q(b.y(c)))}).style("stroke-width",function(a){return s.opts.stroke_width(i[a])})}function F(){var a=h.selection();z.attr("display",function(b){return a[b]?null:"none"})}b=_.defaults(b,{width:400,height:400,padding:20,n_xticks:10,n_yticks:10,stroke:"white",stroke_width:"1.5px",fill:"black",stroke_opacity:1,fill_opacity:1}),b.stroke=g(b.stroke),b.stroke_opacity=g(b.stroke_opacity),b.stroke_width=g(b.stroke_width),b.fill=g(b.fill),b.fill_opacity=g(b.fill_opacity);var c=b.width,d=b.height,e=b.padding,h=b.data,i=h.data(),j=_.map(i,b.x),k=_.map(i,b.y),l=_.min(j),m=_.max(j),n=_.min(k),o=_.max(k),p=d3.scale.linear().domain([l,m]).range([0,c]),q=d3.scale.linear().domain([n,o]).range([d,0]),r=$("<div></div>")[0],s={_view_index:++f,opts:b,plot:r,clear_brush:function(){u.call(v.clear())},selection_changed:function(){F()},deleted:function(){h.deregister_view(this)}};h.register_view(s);var t=d3.select(r).append("svg").attr("width",c+2*e).attr("height",d+2*e),u=t.append("g").attr("transform",a(e,e)),v=d3.svg.brush().on("brushstart",H).on("brush",I).on("brushend",J);u.append("rect").attr("width",c).attr("height",d).attr("fill","#eee");var w=u.selectAll("g.x").data(p.ticks(b.n_xticks)).enter().append("g").attr("class","x");w.append("line").attr("x1",p).attr("x2",p).attr("y1",0).attr("y2",d),w.append("text").attr("x",p).attr("y",d+3).attr("dy",".71em").attr("text-anchor","middle").attr("class","rule-text").text(p.tickFormat(b.n_xticks));var x=u.selectAll("g.y").data(q.ticks(b.n_yticks)).enter().append("g").attr("class","x");x.append("line").attr("x1",0).attr("x2",c).attr("y1",q).attr("y2",q),x.append("text").attr("x",-3).attr("y",q).attr("dy",".35em").attr("text-anchor","end").attr("class","rule-text").text(q.tickFormat(b.n_yticks));var y=u.selectAll("path.dot").data(_.range(i.length)).enter().append("path"),z=u.selectAll("pathasdkf.dot").data(_.range(i.length)).enter().append("path"),A=function(a){return i[a]};y.style("fill",_.compose(b.fill,A)).style("stroke",_.compose(b.stroke,A)).style("fill-opacity",_.compose(b.fill_opacity,A)).style("stroke-opacity",_.compose(b.stroke_opacity,A)),u.call(v.x(p).y(q));var B=function(){return"red"},C=function(){return"red"},D=function(){return 1},E=function(){return 1};z.style("fill",_.compose(B,A)).style("stroke",_.compose(C,A)).style("fill-opacity",_.compose(D,A)).style("stroke-opacity",_.compose(E,A)),t.on("keydown",function(a){console.log(a)}),G(y),G(z),F();return s},Chart.histogram=function(a){a=_.defaults(a,{width:400,height:400,padding:20,n_bins:10,stroke:"white",stroke_width:"1.5px",fill:"black",stroke_opacity:1,fill_opacity:1}),a.stroke=g(a.stroke),a.stroke_opacity=g(a.stroke_opacity),a.stroke_width=g(a.stroke_width),a.fill=g(a.fill),a.fill_opacity=g(a.fill_opacity);var b=a.width,c=a.height,d=a.padding,e=a.data,h=e.data(),i=_.map(h,a.x),j=_.min(i),k=_.max(i),l=$("<div></div>")[0],m=d3.scale.linear().domain([j,k]).range([0,b]),n=d3.layout.histogram().range([j,k]).bins(a.n_bins),o=n(a.x),p={_view_index:++f,opts:a,plot:l,clear_brush:function(){vis.call(brush.clear())},selection_changed:function(){update_selection()},deleted:function(){e.deregister_view(this)}}}})(),LuxChart={},LuxChart.lux_tour_plot=function(a){function k(a){var b=[],c=[],d=0,e=0;for(var f=0;f<a;++f)b[f]=Math.random()*2-1,c[f]=Math.random()*2-1,d+=b[f]*b[f],e+=c[f]*c[f];d=Math.sqrt(d),e=Math.sqrt(e);if(d===0||e===0)return k(a);var g=0;for(f=0;f<a;++f)b[f]/=d,c[f]/=e,g+=b[f]*c[f];var h=0;for(f=0;f<a;++f)c[f]=c[f]-g*b[f],h+=c[f]*c[f];h=Math.sqrt(h);if(h===0)return k(a);for(f=0;f<a;++f)c[f]/=h;return[b,c]}function j(){Lux.set_context(l),f=i();var a=10,b=2.5,c=1;g=[],h=[];var d,e,j=[],k=Shade.vec(0,0),m=Shade.vec(0,0),n=Shade.vec(0,0);for(var o=0;o<f.columns.length;++o){var p=f[f.columns[o]];g.push(Shade.parameter("float")),h.push(Shade.parameter("float"));var q=Shade.vec(g[o],h[o]);d=_.min(p.array),e=_.max(p.array),j=(e+d)/2,k=k.add(q.mul(p)),m=m.add(q.mul(j)),n=n.add(q.mul(j-d).abs())}Lux.Scene.add(Lux.Marks.scatterplot({elements:f[f.columns[0]].numItems,xy:k,xy_scale:Shade.Scale.linear({domain:[m.sub(n),m.add(n)],range:[Shade.vec(0,0),Shade.vec(1,1)]}),fill_color:Shade.color("red"),stroke_color:Shade.mix(Shade.color("black"),Shade.color("red"),.5),stroke_width:b,point_diameter:a}))}function i(){var b={},c=[];for(var d=0;d<a.length;++d)b["dim_"+d]=Lux.attribute_buffer({vertex_array:new Float32Array(a[d]),item_size:1,keep_array:!0}),c.push("dim_"+d);b.columns=c;return b}var b=600,c=600,d=$("<canvas></canvas>")[0];d.width=b,d.height=c;var e,f,g,h,l=Lux.init({canvas:d,clearColor:[1,1,1,1]});j();var m=k(f.columns.length),n=k(f.columns.length),o=(new Date).getTime(),p=1;Lux.Scene.animate(function(){var a=((new Date).getTime()-o)/1e3,b=a/3;b-=Math.floor(b),b<p&&(m=n,n=k(4)),p=b;for(var c=0;c<f.columns.length;++c)g[c].set(b*n[0][c]+(1-b)*m[0][c]),h[c].set(b*n[1][c]+(1-b)*m[1][c])});return d},LuxChart.lux_osm_plot=function(a,b,c,d,e){var f=$("<canvas></canvas>")[0];f.width=d,f.height=e;var g=Lux.init({canvas:f,clearColor:[1,1,1,1],mousedown:function(a){var b=j.mousedown(a);return b},mousemove:function(a){var b=j.mousemove(a);return b},mouseup:function(a){var b=j.mouseup(a);return b}}),h=Shade.parameter("float",3),i=Shade.Camera.perspective({look_at:[Shade.vec(0,0,6),Shade.vec(0,0,-1),Shade.vec(0,1,0)],field_of_view_y:Shade.div(20,h)}),j=Lux.Marks.globe({view_proj:i,zoom:h});Lux.Scene.add(j);return f},function(){function c(){throw new b}function b(){this.name="NoCallbackError"}function a(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}b.prototype=Object.create(Error),b.prototype.constructor=b,RClient={create:function(d){function h(a){n.post_error("Socket was closed. Goodbye!"),f()}function g(a,b){b===65?n.post_error("Authentication failed. Login first!"):n.post_error(a),f()}function f(){$("#input-div").hide()}function e(){n.running=!0,n.send("rcloud.support::session.init(username="+a(rcloud.username())+",token="+a(rcloud.github_token())+")"),d.on_connect&&d.on_connect.call(n)}var i=$.cookies.get().token,j=Rserve.create({host:d.host,on_connect:e,on_error:g,on_close:h,login:i+"\n"+i}),k=d.debug||!1,l=!1,m=undefined,n;n={handlers:{eval:function(a){n.post_response(a);return a},"markdown.eval":function(a){n.display_markdown_response(a);return a},browsePath:function(a){$.ajax({url:"http://127.0.0.1:8080"+a}).done(function(a){var b=/[\s\S]*<body>([\s\S]*)<\/body>/g.exec(a)[1];$("#help-output").html(b)})},"dev.new":function(a){return""},"dev.close":function(a){return""},internal_cmd:function(a){return""},"boot.failure":function(a){n.running=!1}},running:!1,eval:function(a){var b=this;if(a.type!=="sexp")return this.post_error("Bad protocol, should always be sexp.");a=a.value;if(a.type==="string_array")return this.post_error(a.value[0]);if(a.type==="null")return null;if(a.type!=="vector")return this.post_error("Protocol error, unexpected value of type "+a.type);if(a.value[0].type!=="string_array"||a.value[0].value.length!==1){console.log("Protocol error?! ",a.value[0]);return undefined}var c=a.value[0].value[0],d=this.handlers;return d[c]===undefined?this.post_error("Unknown command "+c):d[c].call(this,a.json()[1])},register_handler:function(a,b){this.handlers[a]=b},post_div:function(a){return shell.post_div(a)},display_markdown_response:function(a){a&&($("#output").append($("<div></div>").html(a.value[0])).find("pre code").each(function(a,b){hljs.highlightBlock(b)}),MathJax.Hub.Queue(["Typeset",MathJax.Hub]))},post_error:function(a){var b=$("<div class='alert alert-error'></div>").text(a);$("#output").append(b),window.scrollTo(0,document.body.scrollHeight)},post_response:function(a){var b=$("<pre></pre>").html(a);$("#output").append(b),window.scrollTo(0,document.body.scrollHeight)},capture_answers:function(a,b){function d(d){c.push(d),a--,a===0&&(l=!1,m=undefined,b(c))}if(l)throw"Still waiting for previous answers...";l=!0;var c=[];m=d},wrap_command:function(a,b){b===undefined&&(b=!1);return"rcloud.support::session.eval({"+a+"}, "+(b?"TRUE":"FALSE")+")"},markdown_wrap_command:function(b,c){return"rcloud.support::session.markdown.eval({markdownToHTML(text=paste(knit(text="+a(b+"\n")+'), collapse="\\n"), fragment=TRUE)}, '+(c?"TRUE":"FALSE")+")"},log:function(a){a='rcloud.support::session.log("'+rcloud.username()+'", "'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'")',this.send(a)},record_cell_execution:function(a){var b=JSON.stringify(a.json()),c=this.r_funcall("rcloud.record.cell.execution",rcloud.username(),b);j.eval(c)},send:function(a,b){this.send_and_callback(a,c,b)},send_and_callback:function(a,d,e){function h(a){a=a.value.json(),k&&(debugger,console.log(a));try{d(a[1])}catch(c){if(c.constructor===b)f.handlers[a[0]](a[1]);else throw c}}var f=this;_.isUndefined(d)&&(d=c);var g;e?a=e(a):a=this.wrap_command(a,!0),k&&console.log(a),j.eval(a,h)},r_funcall:function(b){var c=[b,"("];for(var d=1;d<arguments.length;++d){var e=typeof arguments[d];e==="string"?c.push(a(arguments[d])):c.push(String(arguments[d])),d<arguments.length-1&&c.push(",")}c.push(")");var f=c.join("");return f}};return n}}}(),rcloud={},rcloud.init_client_side_data=function(){var a=this;rclient.send_and_callback("rcloud.prefix.uuid()",function(b){a.wplot_uuid=b})},rcloud.username=function(){return $.cookies.get("user")},rcloud.github_token=function(){return $.cookies.get("token")},rcloud.search=function(a,b){var c=this;_.isUndefined(b)&&(b=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.search",a),b)},rcloud.load_user_config=function(a,b){_.isUndefined(b)&&(b=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.load.user.config",a),b)},rcloud.save_user_config=function(a,b,c){_.isUndefined(c)&&(c=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.save.user.config",a,b),c)},rcloud.load_notebook=function(a,b){rclient.send_and_callback(rclient.r_funcall("rcloud.get.notebook",a),b)},rcloud.update_notebook=function(a,b,c){rclient.send_and_callback(rclient.r_funcall("rcloud.update.notebook",a,JSON.stringify(b)),c)},rcloud.create_user_file=function(a,b){debugger,rclient.send_and_callback(rclient.r_funcall("rcloud.create.user.file",rcloud.username(),a),b)},rcloud.resolve_deferred_result=function(a,b){var c=rclient.r_funcall("rcloud.fetch.deferred.result",a);rclient.send_and_callback(c,b)},Notebook={},Notebook.Cell={},function(){function c(b){function k(){v.html("Computing..."),h(),y.show_result(),b.controller.execute()}function j(a){a.addClass("button-disabled")}function i(a){a.removeClass("button-disabled")}function h(){b.content($(u).val())}var c=$("<div class='notebook-cell'></div>"),d=$("<span class='fontawesome-button'><i class='icon-edit'></i></span>").tooltip({title:"source"}),e=$("<span class='fontawesome-button'><i class='icon-picture'></i></span>").tooltip({title:"result"}),f=$("<span class='fontawesome-button'><i class='icon-resize-small'></i></span>").tooltip({title:"hide"}),g=$("<span class='fontawesome-button'><i class='icon-trash'></i></span>").tooltip({title:"remove"});d.click(function(a){$(a.currentTarget).hasClass("button-disabled")||y.show_source()}),e.click(function(a){$(a.currentTarget).hasClass("button-disabled")||y.show_result()}),f.click(function(a){$(a.currentTarget).hasClass("button-disabled")||y.hide_all()}),g.click(function(a){$(a.currentTarget).hasClass("button-disabled")||(b.parent_model.controller.remove_cell(b),$(".tooltip").remove())});var l=$("<div style='position:relative; float: right; z-index:10000'></div>"),m=$("<div style='margin:0.5em;'></div>"),n=$("<div style='margin:0.5em;'></div>");m.append(d),m.append(e),m.append(f),m.append(g),l.append(m),n.hide(),l.append(n),c.append(l);var o=$("<div></div>"),p=$("<div style='clear:both;'></div>");c.append(o),c.append(p);var q=$('<div style="position: relative; width:100%;"></div>'),r=$('<div style="position: absolute; right:-0.5em; top:-0.5em"></div>'),s=a("icon-plus-sign","insert cell");o.append(r),r.append(s),s.click(function(a){shell.insert_markdown_cell_before(b.id)});var t=$('<div style="width:100%; margin-left: 0.5em; margin-top: 0.5em"></div>');o.append(q),q.append(t);var u=$('<input type="text" style="width:88%"/>');t.append(u),u.keypress(function(a){if(a.which===13){k(),a.preventDefault();return!1}return!0});var v=$('<div class="r-result-div"></div>');o.append(v);var w=$("<span></span>");o.append(w);var x,y={content_updated:function(){u.val(b.content())},self_removed:function(){c.remove()},result_updated:function(a){v.hide(),v.html(a),v.slideDown(150);var b=rcloud.wplot_uuid;o.find("pre code").contents().filter(function(){return this.nodeValue.indexOf(b)!==-1}).parent().parent().each(function(){var a=this.childNodes[0].childNodes[0].data.substr(8,73).split("|"),b=this;rcloud.resolve_deferred_result(a[1],function(a){$(b).replaceWith(function(){return shell.handle(a[0],a)})})}),o.find("pre code").each(function(a,b){hljs.highlightBlock(b)}),_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub]),this.show_result(),w[0].scrollIntoView()},hide_buttons:function(){l.css("display","none"),r.css("display","none")},show_buttons:function(){l.css("display",null),r.css("display",null)},show_source:function(){c.css({height:""}),j(d),i(e),i(f),i(g),n.show(),q.show(),v.hide(),u.focus(),x="source"},show_result:function(){c.css({height:""}),i(d),j(e),i(f),i(g),n.hide(),q.hide(),v.slideDown(150,function(){w[0].scrollIntoView()}),x="result"},hide_all:function(){c.css({height:""}),i(d),i(e),j(f),i(g),n.hide(),x==="result"?v.slideUp(150):q.slideUp(150)},div:function(){return c},update_model:function(){h()},focus:function(){u.focus()}};y.show_result(),y.content_updated();return y}function b(b){function l(){z.html("Computing..."),i(),C.show_result(),b.controller.execute()}function k(a){a.addClass("button-disabled")}function j(a){a.removeClass("button-disabled")}function i(){b.content(v.getSession().getValue())}var c=$("<div class='notebook-cell'></div>"),d=a("icon-edit","source"),e=a("icon-picture","result"),f=a("icon-resize-small","hide"),g=a("icon-trash","remove"),h=a("icon-repeat","run");d.click(function(a){$(a.currentTarget).hasClass("button-disabled")||C.show_source()}),e.click(function(a){$(a.currentTarget).hasClass("button-disabled")||C.show_result()}),f.click(function(a){$(a.currentTarget).hasClass("button-disabled")||C.hide_all()}),g.click(function(a){$(a.currentTarget).hasClass("button-disabled")||(b.parent_model.controller.remove_cell(b),$(".tooltip").remove())}),h.click(function(a){l()});var m=$("<div style='position:relative; float: right; z-index:10000'></div>"),n=$("<div style='margin:0.5em;'></div>"),o=$("<div style='margin:0.5em;'></div>");n.append(d),n.append(e),n.append(f),n.append(g),m.append(n),o.append(h),o.hide(),m.append(o),c.append(m);var p=$("<div></div>"),q=$("<div style='clear:both;'></div>");c.append(p),c.append(q);var r=$('<div style="position: relative; width:100%; height:100%"></div>'),s=$('<div style="position: absolute; right:-0.5em; top:-0.5em"></div>'),t=a("icon-plus-sign","insert cell");p.append(s),s.append(t),t.click(function(a){shell.insert_markdown_cell_before(b.id)});var u=$('<div style="width:100%; height:100%"></div>');p.append(r),r.append(u);var v=ace.edit(u[0]),w=require("mode/rmarkdown").Mode,x=v.getSession(),y=x.doc;v.getSession().setMode(new w(!1,y,x)),v.setTheme("ace/theme/chrome"),v.getSession().setUseWrapMode(!0),v.resize(),v.commands.addCommand({name:"sendToR",bindKey:{win:"Ctrl-Return",mac:"Command-Return",sender:"editor"},exec:function(a,b,c){l()}});var z=$('<div class="r-result-div"><span style="opacity:0.5">Not evaluated</span></div>');p.append(z);var A=$("<span></span>");p.append(A);var B,C={content_updated:function(){v.getSession().setValue(b.content())},self_removed:function(){c.remove()},result_updated:function(a){z.hide(),z.html(a),z.slideDown(150);var b=rcloud.wplot_uuid;p.find("pre code").contents().filter(function(){return this.nodeValue.indexOf(b)!==-1}).parent().parent().each(function(){var a=this.childNodes[0].childNodes[0].data.substr(8,73).split("|"),b=this;rcloud.resolve_deferred_result(a[1],function(a){$(b).replaceWith(function(){return shell.handle(a[0],a)})})}),p.find("pre code").each(function(a,b){hljs.highlightBlock(b)}),_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub]),this.show_result(),A[0].scrollIntoView()},hide_buttons:function(){m.css("display","none"),s.css("display","none")},show_buttons:function(){m.css("display",null),s.css("display",null)},show_source:function(){c.css({height:"70%"}),k(d),j(e),j(f),j(g),o.show(),r.show(),z.hide(),v.resize(),v.focus(),B="source"},show_result:function(){c.css({height:""}),j(d),k(e),j(f),j(g),o.hide(),r.hide(),z.slideDown(150,function(){A[0].scrollIntoView()}),B="result"},hide_all:function(){c.css({height:""}),j(d),j(e),k(f),j(g),o.hide(),B==="result"?z.slideUp(150):r.slideUp(150)},div:function(){return c},update_model:function(){i()},focus:function(){v.focus()}};C.show_result(),C.content_updated();return C}function a(a,b){return $("<span class='fontawesome-button'><i class='"+a+"'></i></span>").tooltip({title:b,delay:{show:250,hide:0}})}var d={Markdown:b,R:c};Notebook.Cell.create_html_view=function(a){return d[a.language()](a)}}(),Notebook.Cell.create_model=function(a,b){function d(){_.each(c.views,function(a){a.content_updated()})}var c={views:[],id:-1,language:function(){return b},content:function(b){_.isUndefined(b)||(a=b,d());return a},json:function(){return{content:a,language:b}}};return c},Notebook.Cell.create_controller=function(a){var b={execute:function(){function d(b){_.each(a.views,function(a){a.result_updated(b)})}var b=this,c=a.language();rclient.record_cell_execution(a),a.parent_model.controller.update_notebook([[a.id,{content:a.content(),language:a.language()}]]);if(c==="Markdown"){var e=rclient.markdown_wrap_command(a.content());rclient.send_and_callback(e,d,_.identity)}else if(c==="R"){var e=rclient.markdown_wrap_command("```{r}\n"+a.content()+"\n```\n");rclient.send_and_callback(e,d,_.identity)}else alert("Don't know language '"+c+"' - can only do Markdown or R for now!")}};return b},Notebook.create_html_view=function(a,b){var c={model:a,sub_views:[],cell_appended:function(a){var c=Notebook.Cell.create_html_view(a);a.views.push(c),b.append(c.div()),this.sub_views.push(c);return c},cell_inserted:function(a,c){var d=Notebook.Cell.create_html_view(a);a.views.push(d),b.append(d.div()),$(d.div()).insertBefore(b.children(".notebook-cell")[c]),this.sub_views.splice(c,0,d),d.show_source();return d},cell_removed:function(a,b){_.each(a.views,function(a){a.self_removed()}),this.sub_views.splice(b,1)},update_model:function(){_.each(this.sub_views,function(a){a.update_model()})}};a.views.push(c);return c},Notebook.create_model=function(){function a(a){return a.length?a[a.length-1].id:0}return{notebook:[],views:[],clear:function(){return this.remove_cell(null,a(this.notebook))},append_cell:function(b,c){b.parent_model=this;var d=[],e=1;c=c||1,c=Math.max(c,a(this.notebook)+1);while(e)d.push([c,{content:b.content(),language:b.language()}]),b.id=c,this.notebook.push(b),_.each(this.views,function(a){a.cell_appended(b)}),++c,--e;return d},insert_cell:function(a,b){var c=this;a.parent_model=this;var d=[],e=1,f=0;while(f<this.notebook.length&&this.notebook[f].id<b)++f;if(f<this.notebook.length&&b+e>this.notebook[f].id){var g=f>0?this.notebook[f-1].id:0;b=Math.max(this.notebook[f].id-e,g+1)}for(var h=0;h<e;++h)d.push([b+h,{content:a.content(),language:a.language()}]),a.id=b+h,this.notebook.splice(f,0,a),_.each(this.views,function(a){a.cell_inserted(c.notebook[f],f)}),++f;while(f<this.notebook.length&&e){if(this.notebook[f].id>b){var i=this.notebook[f].id-b;e-=i,b+=i}if(e<=0)break;d.push([this.notebook[f].id+e,{content:this.notebook[f].content(),language:this.notebook[f].language()}]),this.notebook[f].id+=e,++f,++b}return d},remove_cell:function(a,b){var c=this,d,e;if(a!=null){d=this.notebook.indexOf(a),e=a.id;if(d===-1)throw"cell_model not in notebook model?!"}else d=0,e=1;var b=b||1,f=d,g=[];while(f<this.notebook.length&&b)this.notebook[f].id==e&&(_.each(this.views,function(a){a.cell_removed(c.notebook[f],e)}),g.push([e,{erase:1,language:c.notebook[f].language()}]),this.notebook.splice(f,1)),++e,--b;return g},json:function(){return _.map(this.notebook,function(a){return a.json()})}}},Notebook.create_controller=function(a){function d(b,c,d){var e=Notebook.Cell.create_model(b,c),f=Notebook.Cell.create_controller(e);e.controller=f;return[f,a.insert_cell(e,d)]}function c(b,c,d){var e=Notebook.Cell.create_model(b,c),f=Notebook.Cell.create_controller(e);e.controller=f;return[f,a.append_cell(e,d)]}var b,e={append_cell:function(a,b,d){var e=c(a,b,d);this.update_notebook(e[1]);return e[0]},insert_cell:function(a,b,c){var e=d(a,b,c);this.update_notebook(e[1]);return e[0]},remove_cell:function(b){var c=a.remove_cell(b);this.update_notebook(c)},clear:function(){a.clear()},load_notebook:function(a,d,e){var f=this;b=d,rcloud.load_notebook(d,function(a){f.clear();var b=JSON.parse(a),d={};_.each(b.files,function(a){var b=a.filename;if(/^part/.test(b)){var c=parseInt(b.slice(4).split(".")[0]);c!==NaN&&(d[c]=[a.content,a.language,c])}});for(var g in d)c(d[g][0],d[g][1],d[g][2]);e()})},update_notebook:function(a){function d(a){function b(a,b){var d=null;d={},b[1].content!==undefined&&(d.content=b[1].content),b[1].rename!=undefined&&(d.rename=c(b[1].rename)),b[1].erase&&(d=null),a[c(b[0],b[1].language)]=d;return a}return{files:_.reduce(a,b,{})}}function c(a,b){var c;switch(b){case"R":c="R";break;case"Markdown":c="md";break;default:throw"Unknown language "+b}return"part"+a+"."+c}rcloud.update_notebook(b,d(a),function(a){})},run_all:function(){_.each(a.notebook,function(a){a.controller.execute()})}};a.controller=e;return e}