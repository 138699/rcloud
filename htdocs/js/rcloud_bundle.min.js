// bare-bones d3 charting facilities
function reader(e){function r(e,t){return function(n,r){return[e.call(o,n,r),t||r]}}function i(e,t){return function(n,r){var i=e.call(o,n,r),s=t(i[0])(n,r-i[1]);return[s[0],i[1]+s[1]]}}function s(e){return function(t,n){var r=[],i=n;while(n>0){var s=e.call(o,t,n);r.push(s[0]),n-=s[1]}return[r,i]}}function u(e,t){return i(e,function(e){return r(function(n,r){return t(e,n)},0)})}function a(e,t){return r(function(n,r){return t(e.call(o,r),n)})}var t={},n,o={offset:0,data_view:e.make(EndianAwareDataView),msg:e,read_int:function(){var e=this.offset;return this.offset+=4,this.data_view.getInt32(e)},read_string:function(e){var t="";while(e--){var n=this.data_view.getInt8(this.offset++);n&&(t+=String.fromCharCode(n))}return t},read_stream:function(e){var t=this.offset;return this.offset+=e,this.msg.view(t,e)},read_int_vector:function(e){var t=this.offset;return this.offset+=e,this.msg.make(Int32Array,t,e)},read_double_vector:function(e){var t=this.offset;return this.offset+=e,this.msg.make(Float64Array,t,e)},read_null:r(function(e,t){return Robj.null(e)}),read_string_array:function(e,t){var n=this.read_stream(t).make(Uint8Array),r=[],i="";for(var s=0;s<n.length;++s)n[s]===0?(r.push(i),i=""):i+=String.fromCharCode(n[s]);return[Robj.string_array(r,e),t]},read_bool_array:function(e,t){var n=this.read_int(),r=this.read_stream(t-4),i=r.make(Uint8Array),s=[];for(var o=0;o<n;++o)s[o]=!!i[o];return[Robj.bool_array(s,e),t]},read_sexp:function(){var e=this.read_int(),n=Rsrv.par_parse(e),r=n[0],i=n[1],s=4,o=undefined;if(r&Rsrv.XT_HAS_ATTR){r&=~Rsrv.XT_HAS_ATTR;var u=this.read_sexp();o=u[0],s+=u[1],i-=u[1]}if(t[r]===undefined)throw"Unimplemented "+r;var a=t[r].call(this,o,i);return[a[0],s+a[1]]}};return o.read_clos=i(o.read_sexp,function(e){return i(o.read_sexp,function(t){return r(function(n,r){return Robj.clos(e,t,n)},0)})}),o.read_list=s(o.read_sexp),o.read_list_tag=i(o.read_list,function(e){return r(function(t,n){var r={};for(var i=0;i<e.length;i+=2){var s=e[i],o=e[i+1];if(o.type!=="symbol")throw"Unexpected type "+o.type+" as tag for tagged_list";r[o.value]=s}return Robj.tagged_list(r,t)},0)}),o.read_vector=u(o.read_list,Robj.vector),o.read_list_no_tag=u(o.read_list,Robj.list),o.read_lang_no_tag=u(o.read_list,Robj.lang),o.read_vector_exp=u(o.read_list,Robj.vector_exp),o.read_symname=a(o.read_string,Robj.symbol),o.read_int_array=a(o.read_int_vector,Robj.int_array),o.read_double_array=a(o.read_double_vector,Robj.double_array),t[Rsrv.XT_NULL]=o.read_null,t[Rsrv.XT_VECTOR]=o.read_vector,t[Rsrv.XT_CLOS]=o.read_clos,t[Rsrv.XT_SYMNAME]=o.read_symname,t[Rsrv.XT_LIST_NOTAG]=o.read_list_no_tag,t[Rsrv.XT_LIST_TAG]=o.read_list_tag,t[Rsrv.XT_LANG_NOTAG]=o.read_lang_no_tag,t[Rsrv.XT_VECTOR_EXP]=o.read_vector_exp,t[Rsrv.XT_ARRAY_INT]=o.read_int_array,t[Rsrv.XT_ARRAY_DOUBLE]=o.read_double_array,t[Rsrv.XT_ARRAY_STR]=o.read_string_array,t[Rsrv.XT_ARRAY_BOOL]=o.read_bool_array,o}function parse(e){var t=new Int32Array(e,0,4);if(t[0]!==Rsrv.RESP_OK&&t[0]!==Rsrv.OOB_SEND){var n=t[0]>>24;throw"ERROR FROM R SERVER: "+(Rsrv.status_codes[n]||n)+" "+t[0]+" "+t[1]+" "+t[2]+" "+t[3]+" "+e.byteLength+" "+e}var r=my_ArrayBufferView(e,16,e.byteLength-16),i=parse_payload(reader(r));return i;var s}function parse_payload(e){var t=e.read_int(),n=Rsrv.par_parse(t),r=n[0],i=n[1];if(r===Rsrv.DT_INT)return{type:"int",value:e.read_int()};if(r===Rsrv.DT_STRING)return{type:"string",value:e.read_string(i)};if(r===Rsrv.DT_BYTESTREAM)return{type:"stream",value:e.read_stream(i)};if(r===Rsrv.DT_SEXP){n=e.read_sexp();var s=n[0],o=n[1];return{type:"sexp",value:s}}throw"Bad type for parse? "+r+" "+i}function make_basic(e,t){return function(n,r){function i(){this.type=e,this.value=n,this.attributes=r}return i.prototype=t||{html_element:function(){return $("<div class='obj'></div>").append($("<div class='key'></div>").html(e))}},new i}}function pprint_array_as_div(e){function t(){var t=$("<div class='obj'></div>"),n=$("<div class='string-value'></div>"),r=this.value,i,s=this;e=e||function(e){return e};var o;this.attributes&&this.attributes.value.names?o=function(t){return s.attributes.value.names.value[t]+": "+e(String(r[t]))}:this.attributes&&this.attributes.value.levels?o=function(e){return s.attributes.value.levels.value[r[e]-1]}:o=function(t){return e(String(r[t]))};if(r.length===0)i="[]";else if(r.length===1)i=o(0);else if(r.length<=10){i="["+o(0);for(var u=1;u<r.length;++u)i=i+", "+o(u);i+="]"}else{i="["+o(0);for(var u=1;u<5;++u)i=i+", "+o(u);i+=", ... ";for(u=r.length-5;u<r.length;++u)i=i+", "+o(u);i+="]"}return n.html(i),t.append(n),t}function n(){var e=document.createElement("table"),t=document.createElement("tr");e.appendChild(t);var n=this.attributes.value.dim.value,r=this.value,i=this;return d3.select(t).selectAll("td").data(_.range(n[1]+1)).enter().append("td").text(function(e){return e===0?"":"[,"+e+"]"}),d3.select(e).selectAll("tr-data").data(_.range(n[0])).enter().append("tr").selectAll("td").data(function(e){return _.map(_.range(n[1]+1),function(t){return[e,t]})}).enter().append("td").text(function(e){var t=e[0],s=e[1];if(s===0)return"["+(t+1)+",]";var o=r[(s-1)*n[0]+t];return i.attributes&&i.attributes.value.levels?i.attributes.value.levels.value[o-1]:o}),e}return function(){return this.attributes&&this.attributes.value.dim?n.call(this):t.call(this)}}(function(){function e(e,t){return"translate("+e+","+t+")"}function t(e,t,n){var r=e.slice((n||t)+1||e.length);return e.length=t<0?e.length+t:t,e.push.apply(e,r)}function i(e,t){if(_.isUndefined(n[t])){var i=new Uint8Array(e.data().length);r[t]=i,n[t]=[e]}else n[t].push(e)}function o(e){return typeof e=="function"?e:function(e){return function(){return e}}(e)}Chart={};var n={},r={};Chart.get_selections=function(e){return r[this.group_id]},Chart.set_selections=function(e,t){for(var i=0;i<t.length;i++)r[e][i]=t[i];_.each(n[e],function(e){_.each(e.views,function(e){e.selection_changed()})})},Chart.data_model=function(e,t){var s=e.length,o={views:{},group_id:t,data:function(){return e},selection:function(){return r[this.group_id]},register_view:function(e){this.views[e._view_index]=e},deregister_view:function(e){delete this.views[e._view_index]},notify:function(){_.each(n[this.group_id],function(e){_.each(e.views,function(e){e.selection_changed()})})},clear_brushes:function(e){_.each(n[this.group_id],function(t){_.each(t.views,function(t){t._view_index!==e._view_index&&(console.log("clearing brush on view",t._view_index,t,e),t.clear_brush())})})}};return i(o,t),o};var s=0;Chart.scatterplot=function(t){function M(){var e=u.selection();N.attr("display",function(t){return e[t]?null:"none"})}function D(n){n.attr("d",d3.svg.symbol().type("circle")).attr("size",5).attr("transform",function(n){return n=a[n],e(v(t.x(n)),m(t.y(n)))}).style("stroke-width",function(e){return y.opts.stroke_width(a[e])})}function P(e){u.clear_brushes(y)}function H(e){var n=E.extent(),r=u.selection();T.each(function(e){var i=a[e],s=n[0][0]<=t.x(i)&&t.x(i)<=n[1][0]&&n[0][1]<=t.y(i)&&t.y(i)<=n[1][1];r[e]=s}),u.notify()}function B(){E.empty()&&M(T)}t=_.defaults(t,{width:400,height:400,padding:20,n_xticks:10,n_yticks:10,stroke:"white",stroke_width:"1.5px",fill:"black",stroke_opacity:1,fill_opacity:1}),t.stroke=o(t.stroke),t.stroke_opacity=o(t.stroke_opacity),t.stroke_width=o(t.stroke_width),t.fill=o(t.fill),t.fill_opacity=o(t.fill_opacity);var n=t.width,r=t.height,i=t.padding,u=t.data,a=u.data(),f=_.map(a,t.x),l=_.map(a,t.y),c=_.min(f),h=_.max(f),p=_.min(l),d=_.max(l),v=d3.scale.linear().domain([c,h]).range([0,n]),m=d3.scale.linear().domain([p,d]).range([r,0]),g=$("<div></div>")[0],y={_view_index:++s,opts:t,plot:g,clear_brush:function(){w.call(E.clear())},selection_changed:function(){M()},deleted:function(){u.deregister_view(this)}};u.register_view(y);var b=d3.select(g).append("svg").attr("width",n+2*i).attr("height",r+2*i),w=b.append("g").attr("transform",e(i,i)),E=d3.svg.brush().on("brushstart",P).on("brush",H).on("brushend",B);w.append("rect").attr("width",n).attr("height",r).attr("fill","#eee");var S=w.selectAll("g.x").data(v.ticks(t.n_xticks)).enter().append("g").attr("class","x");S.append("line").attr("x1",v).attr("x2",v).attr("y1",0).attr("y2",r),S.append("text").attr("x",v).attr("y",r+3).attr("dy",".71em").attr("text-anchor","middle").attr("class","rule-text").text(v.tickFormat(t.n_xticks));var x=w.selectAll("g.y").data(m.ticks(t.n_yticks)).enter().append("g").attr("class","x");x.append("line").attr("x1",0).attr("x2",n).attr("y1",m).attr("y2",m),x.append("text").attr("x",-3).attr("y",m).attr("dy",".35em").attr("text-anchor","end").attr("class","rule-text").text(m.tickFormat(t.n_yticks));var T=w.selectAll("path.dot").data(_.range(a.length)).enter().append("path"),N=w.selectAll("pathasdkf.dot").data(_.range(a.length)).enter().append("path"),C=function(e){return a[e]};T.style("fill",_.compose(t.fill,C)).style("stroke",_.compose(t.stroke,C)).style("fill-opacity",_.compose(t.fill_opacity,C)).style("stroke-opacity",_.compose(t.stroke_opacity,C)),w.call(E.x(v).y(m));var k=function(){return"red"},L=function(){return"red"},A=function(){return 1},O=function(){return 1};return N.style("fill",_.compose(k,C)).style("stroke",_.compose(L,C)).style("fill-opacity",_.compose(A,C)).style("stroke-opacity",_.compose(O,C)),b.on("keydown",function(e){console.log(e)}),D(T),D(N),M(),y},Chart.histogram=function(e){e=_.defaults(e,{width:400,height:400,padding:20,n_bins:10,stroke:"white",stroke_width:"1.5px",fill:"black",stroke_opacity:1,fill_opacity:1}),e.stroke=o(e.stroke),e.stroke_opacity=o(e.stroke_opacity),e.stroke_width=o(e.stroke_width),e.fill=o(e.fill),e.fill_opacity=o(e.fill_opacity);var t=e.width,n=e.height,r=e.padding,i=e.data,u=i.data(),a=_.map(u,e.x),f=_.min(a),l=_.max(a),c=$("<div></div>")[0],h=d3.scale.linear().domain([f,l]).range([0,t]),p=d3.layout.histogram().range([f,l]).bins(e.n_bins),d=p(e.x),v={_view_index:++s,opts:e,plot:c,clear_brush:function(){vis.call(brush.clear())},selection_changed:function(){update_selection()},deleted:function(){i.deregister_view(this)}}}})(),FacetChart={},FacetChart.facet_tour_plot=function(e){function a(){h.viewport(0,0,h.viewportWidth,h.viewportHeight),h.clearDepth(1),h.clearColor(0,0,0,0),h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT),i.draw()}function f(){var t={},n=[];for(var r=0;r<e.value.length;++r)t["dim_"+r]=Facet.attribute_buffer({vertex_array:e.value[r].value,item_size:1,keep_array:!0}),n.push("dim_"+r);return t.columns=n,t}function l(){Facet.set_context(h),s=f();var e=10,t=2.5,n=1;o=[],u=[];var r,a,l=[],c=Shade.vec(0,0),p=Shade.vec(0,0),d=Shade.vec(0,0);for(var v=0;v<s.columns.length;++v){var m=s[s.columns[v]];o.push(Shade.parameter("float")),u.push(Shade.parameter("float"));var g=Shade.vec(o[v],u[v]);r=_.min(m.array),a=_.max(m.array),l=(a+r)/2,c=c.add(g.mul(m)),p=p.add(g.mul(l)),d=d.add(g.mul(l-r).abs())}var y=Shade.color("red");i=Facet.Marks.scatterplot({elements:s[s.columns[0]].numItems,xy:c,xy_scale:Shade.Utils.linear(p.sub(d),p.add(d),Shade.vec(0,0),Shade.vec(1,1)),fill_color:y,stroke_color:Shade.mix(Shade.color("black"),y,.5),stroke_width:t,point_diameter:e})}function c(e){var t=[],n=[],r=0,i=0;for(var s=0;s<e;++s)t[s]=Math.random()*2-1,n[s]=Math.random()*2-1,r+=t[s]*t[s],i+=n[s]*n[s];r=Math.sqrt(r),i=Math.sqrt(i);if(r===0||i===0)return c(e);var o=0;for(s=0;s<e;++s)t[s]/=r,n[s]/=i,o+=t[s]*n[s];var u=0;for(s=0;s<e;++s)n[s]=n[s]-o*t[s],u+=n[s]*n[s];u=Math.sqrt(u);if(u===0)return c(e);for(s=0;s<e;++s)n[s]/=u;return[t,n]}var t=600,n=600,r=$("<canvas width='"+t+"' height='"+n+"'></canvas>")[0],i,s,o,u,h=Facet.init(r,{clearColor:[1,1,1,1]});l();var p=c(s.columns.length),d=c(s.columns.length),v=(new Date).getTime(),m=1,g=function(){var e=((new Date).getTime()-v)/1e3,t=e/3;t-=Math.floor(t),t<m&&(p=d,d=c(4)),m=t;for(var n=0;n<s.columns.length;++n)o[n].set(t*d[0][n]+(1-t)*p[0][n]),u[n].set(t*d[1][n]+(1-t)*p[1][n]);window.requestAnimFrame(g,r),a()};return g(),r},FacetChart.facet_osm_plot=function(e,t,n,r,i){var s=$("<canvas width='"+r+"' height='"+i+"'></canvas>")[0],o=Facet.init(s,{clearColor:[1,1,1,1],mousedown:function(e){var t=f.mousedown(e);return t},mousemove:function(e){var t=f.mousemove(e);return t},mouseup:function(e){var t=f.mouseup(e);return t}}),u=Shade.parameter("float",3),a=Shade.Camera.perspective({look_at:[Shade.vec(0,0,6),Shade.vec(0,0,-1),Shade.vec(0,1,0)],field_of_view_y:Shade.div(20,u)}),f=Facet.Marks.globe({view_proj:a,zoom:u});e=Facet.attribute_buffer({vertex_array:e,item_size:1}),t=Facet.attribute_buffer({vertex_array:t,item_size:1}),console.log(n),n.length===3?n=Shade.vec(n[0],n[1],n[2],1):n.length>1&&(n=Shade.vec(Facet.attribute_buffer({vertex_array:n,item_size:3}),1));var l=Facet.model({type:"points",lats:e,lons:t}),c=Facet.bake(l,{color:n,point_size:2,position:f.lat_lon_position(l.lats.radians(),l.lons.radians())});return Facet.Scene.add(f),Facet.Scene.add(c),s},function(e){if(e.WebSocket===undefined){if(!e.MozWebSocket)throw"WebSocket support not found";e.WebSocket=e.MozWebSocket}}(this),function(){function e(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}RClient={create:function(t,n){function l(t){t=t.data,t.substr(0,4)!=="Rsrv"?a.post_error("server is not an RServe instance"):t.substr(4,4)!=="0103"?a.post_error("sorry, I can only use the 0103 version of the R server protocol"):t.substr(8,4)!=="QAP1"?a.post_error("sorry, I only speak QAP1"):(u=!0,a.running=!0,a.send("rcloud.support::session.init(username="+e(rcloud.username())+")"),n&&n.call(a))}var r=new WebSocket(t),i=!0,s=!1,o=undefined,u=!1,a,f=0;return r.binaryType="arraybuffer",r.onmessage=function(e){if(s)try{o(a.eval(parse(e.data)))}catch(t){throw s=!1,o=undefined,t}else{if(!u){l(e);return}typeof e.data=="string"?a.post_response(e.data):a.eval(parse(e.data))}},r.onclose=function(e){a.post_response("Socket was closed. Goodbye!")},a={handlers:{eval:function(e){if(e.value.length===3){var t=e.value[2].value[0],n=this.result_handlers[t];n?n(t,e.value[1]):a.display_response(e.value[1])}return e.value[1]},"markdown.eval":function(e){if(e.value.length===3){var t=e.value[2].value[0],n=this.result_handlers[t];n?n(t,e.value[1]):a.display_markdown_response(e.value[1])}return e.value[1]},browsePath:function(e){$.ajax({url:"http://127.0.0.1:8080"+e.value[1].value}).done(function(e){var t=/[\s\S]*<body>([\s\S]*)<\/body>/g.exec(e)[1];$("#help-output").html(t)})},"img.url.update":function(e){return e.value[1]},"img.url.final":function(e){return e.value[1]},"dev.new":function(e){return""},"dev.close":function(e){return""},internal_cmd:function(e){return""},"boot.failure":function(e){a.running=!1}},running:!1,result_handlers:{},eval:function(e){var t=this;if(e.type!=="sexp")return this.post_error("Bad protocol, should always be sexp.");e=e.value;if(e.type==="string_array")return this.post_error(e.value[0]);if(e.type==="null")return null;if(e.type!=="vector")return this.post_error("Protocol error, unexpected value of type "+e.type);if(e.value[0].type!=="string_array"||e.value[0].value.length!==1)return console.log("Protocol error?! ",e.value[0]),undefined;var n=e.value[0].value[0],r=this.handlers;if(r[n]===undefined)return this.post_error("Unknown command "+n);if(n=="img.url.update"||n=="img.url.final"){var i=window.devImgIndex;i||(window.devImgIndex=i=1),n=="img.url.final"&&window.devImgIndex++;var s=document.getElementById("dimg"+i);s?s.innerHTML="<img src="+e.value[1].value[0]+">":this.post_div("<div id=dimg"+i+"><img src="+e.value[1].value[0]+"></div>")}return r[n].call(this,e)},register_handler:function(e,t){this.handlers[e]=t},post_sent_command:function(e){var t=$('<pre class="r-sent-command"></pre>').html("> "+e);$("#output").append(t)},post_debug_message:function(e){var t=new Uint8Array(e),n=Array.prototype.join.call(t,",");this.post_response(n)},post_div:function(e){return shell.post_div(e)},post_binary_response:function(e){if(i)this.post_debug_message(e),this.display_response(parse(e));else try{this.display_response(parse(e))}catch(t){this.post_error("Uncaught exception: "+t)}},display_response:function(e){e&&$("#output").append(e.html_element()),window.scrollTo(0,document.body.scrollHeight)},display_markdown_response:function(e){e&&($("#output").append($("<div></div>").html(e.value[0])).find("pre code").each(function(e,t){hljs.highlightBlock(t)}),MathJax.Hub.Queue(["Typeset",MathJax.Hub]))},post_error:function(e){var t=$("<div class='error-message'></div>").html(e);$("#output").append(t),window.scrollTo(0,document.body.scrollHeight)},post_response:function(e){var t=$("<pre></pre>").html(e);$("#output").append(t),window.scrollTo(0,document.body.scrollHeight)},capture_answers:function(e,t){function r(r){n.push(r),e--,e===0&&(s=!1,o=undefined,t(n))}if(s)throw"Still waiting for previous answers...";s=!0;var n=[];o=r},wrap_command:function(e,t){var n=f++;return t===undefined&&(t=!1),["rcloud.support::session.eval({"+e+"}, "+n+", "+(t?"TRUE":"FALSE")+")",n]},markdown_wrap_command:function(t,n){var r=f++;return["rcloud.support::session.markdown.eval({markdownToHTML(text=paste(knit(text="+e(t+"\n")+'), collapse="\\n"), fragment=TRUE)}, '+r+", "+(n?"TRUE":"FALSE")+")",r]},log:function(e){e='rcloud.support::session.log("'+rcloud.username()+'", "'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'")',this.send(e)},send:function(e,t){if(!a.running){alert("Init failed, cannot communicate with R process");return}_.isUndefined(t)||(e=t(e)[0]);var n=new ArrayBuffer(e.length+21),i=new EndianAwareDataView(n);i.setInt32(0,3),i.setInt32(4,5+e.length),i.setInt32(8,0),i.setInt32(12,0),i.setInt32(16,4+(1+e.length<<8));for(var s=0;s<e.length;++s)i.setUint8(20+s,e.charCodeAt(s));i.setUint8(n.byteLength-1,0),r.send(n)},record_cell_execution:function(e){var t=JSON.stringify(e.json()),n=rclient.r_funcall("rcloud.record.cell.execution",rcloud.username(),t);rclient.send(n)},send_and_callback:function(e,t,n){_.isUndefined(t)&&(t=_.identity);var r;n?r=n(e):r=this.wrap_command(e,!0);var i=r[1];e=r[0];var s=this;this.result_handlers[i]=function(e,n){delete s.result_handlers[e],t(n)},this.send(e)},r_funcall:function(t){var n=[t,"("];for(var r=1;r<arguments.length;++r){var i=typeof arguments[r];i==="string"?n.push(e(arguments[r])):n.push(String(arguments[r])),r<arguments.length-1&&n.push(",")}n.push(")");var s=n.join("");return s}},a}}}(),function(e){var t;(function(){var e=new ArrayBuffer(4),n=new Uint8Array(e),r=new Uint32Array(e);n[0]=1;if(r[0]===1)t=!0;else{if(r[0]!==16777216)throw"we're bizarro endian, refusing to continue";t=!1}})();var n=["Int32","Int16","Uint32","Uint16","Float32","Float64"],r=["setInt32","setInt16","setUint32","setUint16","setFloat32","setFloat64"],i=["getInt32","getInt16","getUint32","getUint16","getFloat32","getFloat64"];if(!e.DataView){console.log("polyfilling DataView");var s={};for(var o=0;o<n.length;++o){var u=this[n[o]+"Array"],a=u.BYTES_PER_ELEMENT,f=new ArrayBuffer(a),l=new u(f),c=new Uint8Array(f);s[n[o]]=function(e,t){return function(n,r,i,s){e[0]=s;for(var o=0;o<r;++o)n[i+o]=t[o]}}(l,c)}function h(e,n,r){this.buffer=e,this.byteOffset=_.isUndefined(n)?0:n,this.byteLength=_.isUndefined(r)?e.byteLength:r,this.view=new jDataView(e,n,r,t),this.byte_array=new Uint8Array(e)}var p={};h.prototype=p;for(o=0;o<n.length;++o){var d="get"+n[o];p[d]=function(e){return function(t){return this.view[e](t)}}(d);var v="set"+n[o],a=this[n[o]+"Array"].BYTES_PER_ELEMENT;p[v]=function(e,t){return function(n,r){console.log(t),console.log(s),s[t](this.byte_array,e,n,r)}}(a,n[o])}p.setUint8=function(e,t){this.byte_array[e]=t},p.setInt8=function(e,t){t<0&&(t+=256),this.byte_array[e]=t},p.getInt8=function(e){return this.view.GetInt8(e)},p.getUint8=function(e){this.byte_array[e]},e.DataView=h}e.EndianAwareDataView=function(){function o(e,t,n){t===undefined?this.view=new DataView(e):this.view=new DataView(e,t,n)}var e={setInt8:function(e,t){return this.view.setInt8(e,t)},setUint8:function(e,t){return this.view.setUint8(e,t)},getInt8:function(e){return this.view.getInt8(e)},getUint8:function(e){return this.view.getUint8(e)}},n=["setInt32","setInt16","setUint32","setUint16","setFloat32","setFloat64"],r=["getInt32","getInt16","getUint32","getUint16","getFloat32","getFloat64"];for(var i=0;i<n.length;++i){var s=n[i];e[s]=function(e){return function(n,r){return this.view[e](n,r,t)}}(s)}for(i=0;i<r.length;++i){var s=r[i];e[s]=function(e){return function(n){return this.view[e](n,t)}}(s)}return o.prototype=e,o}(),e.my_ArrayBufferView=function(e,t,n){return t=_.isUndefined(t)?0:t,n=_.isUndefined(n)?e.byteLength:n,{buffer:e,offset:t,length:n,make:function(e,t,n){t=_.isUndefined(t)?0:t,n=_.isUndefined(n)?this.length:n;var r=e.BYTES_PER_ELEMENT||1,i=n/r;if((this.offset+t)%r!=0){var s=new DataView(this.buffer,this.offset+t,n),o=new ArrayBuffer(n),u=new DataView(o);for(var a=0;a<n;++a)u.setUint8(a,s.getUint8(a));return new e(o)}return new e(this.buffer,this.offset+t,i)},view:function(e,t){return my_ArrayBufferView(this.buffer,this.offset+e,t)}}}}(this),parser=function(){var e={parse:function(e,t){function a(e,t,n){var r=e,i=n-e.length;for(var s=0;s<i;s++)r=t+r;return r}function f(e){var t=e.charCodeAt(0);if(t<=255)var n="x",r=2;else var n="u",r=4;return"\\"+n+a(t.toString(16).toUpperCase(),"0",r)}function l(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/[\x80-\uFFFF]/g,f)+'"'}function c(e){if(r<s)return;r>s&&(s=r,o=[]),o.push(e)}function h(){var t="whitespace@"+r,n=u[t];if(n)return r=n.nextPos,n.result;if(e.substr(r).match(/^[ 	\n\r]/)!==null){var s=e.charAt(r);r++}else{var s=null;i&&c("[ 	\\n\\r]")}if(s!==null){var o=[];while(s!==null){o.push(s);if(e.substr(r).match(/^[ 	\n\r]/)!==null){var s=e.charAt(r);r++}else{var s=null;i&&c("[ 	\\n\\r]")}}}else var o=null;return u[t]={nextPos:r,result:o},o}function p(){var t="command@"+r,n=u[t];if(n)return r=n.nextPos,n.result;var s=r,o=r;if(e.substr(r,1)==="@"){var a="@";r+=1}else{var a=null;i&&c('"@"')}if(a!==null){var f=d();if(f!==null){var l=h();if(l!==null){var p=v();if(p!==null)var m=[a,f,l,p];else{var m=null;r=o}}else{var m=null;r=o}}else{var m=null;r=o}}else{var m=null;r=o}var g=m!==null?function(e,t){return{id:e,ps:t}}(m[1],m[3]):null;if(g!==null)var y=g;else{var y=null;r=s}if(y!==null)var b=y;else{var w=r,E=r;if(e.substr(r,1)==="@"){var S="@";r+=1}else{var S=null;i&&c('"@"')}if(S!==null){var x=d();if(x!==null)var T=[S,x];else{var T=null;r=E}}else{var T=null;r=E}var N=T!==null?function(e){return{id:e,ps:[]}}(T[1]):null;if(N!==null)var C=N;else{var C=null;r=w}if(C!==null)var b=C;else var b=null}return u[t]={nextPos:r,result:b},b}function d(){var t="identifier@"+r,n=u[t];if(n)return r=n.nextPos,n.result;var s=r,o=r;if(e.substr(r).match(/^[A-Za-z_]/)!==null){var a=e.charAt(r);r++}else{var a=null;i&&c("[A-Za-z_]")}if(a!==null){if(e.substr(r).match(/^[A-Za-z0-9_]/)!==null){var f=e.charAt(r);r++}else{var f=null;i&&c("[A-Za-z0-9_]")}if(f!==null){var l=[];while(f!==null){l.push(f);if(e.substr(r).match(/^[A-Za-z0-9_]/)!==null){var f=e.charAt(r);r++}else{var f=null;i&&c("[A-Za-z0-9_]")}}}else var l=null;if(l!==null)var h=[a,l];else{var h=null;r=o}}else{var h=null;r=o}var p=h!==null?function(e,t){return e+t.join("")}(h[0],h[1]):null;if(p!==null)var d=p;else{var d=null;r=s}return u[t]={nextPos:r,result:d},d}function v(){var e="paramlist@"+r,t=u[e];if(t)return r=t.nextPos,t.result;var n=r,i=r,s=m();if(s!==null){var o=h();if(o!==null){var a=v();if(a!==null)var f=[s,o,a];else{var f=null;r=i}}else{var f=null;r=i}}else{var f=null;r=i}var l=f!==null?function(e,t){var n=[e];for(var r=0;r<t.length;++r)n.push(t[r]);return n}(f[0],f[2]):null;if(l!==null)var c=l;else{var c=null;r=n}if(c!==null)var p=c;else{var d=r,g=m(),y=g!==null?function(e){return[e]}(g):null;if(y!==null)var b=y;else{var b=null;r=d}if(b!==null)var p=b;else var p=null}return u[e]={nextPos:r,result:p},p}function m(){var t="parameter@"+r,n=u[t];if(n)return r=n.nextPos,n.result;var s=r,o=r;if(e.substr(r,2)==="{{"){var a="{{";r+=2}else{var a=null;i&&c('"{{"')}if(a!==null){if(e.substr(r).match(/^[A-Za-z0-9_.+\/*\-"'[\]()!@#$%^&*;:<>,\\|]/)!==null){var f=e.charAt(r);r++}else{var f=null;i&&c("[A-Za-z0-9_.+\\/*\\-\"'[\\]()!@#$%^&*;:<>,\\\\|]")}if(f!==null){var l=[];while(f!==null){l.push(f);if(e.substr(r).match(/^[A-Za-z0-9_.+\/*\-"'[\]()!@#$%^&*;:<>,\\|]/)!==null){var f=e.charAt(r);r++}else{var f=null;i&&c("[A-Za-z0-9_.+\\/*\\-\"'[\\]()!@#$%^&*;:<>,\\\\|]")}}}else var l=null;if(l!==null){if(e.substr(r,2)==="}}"){var h="}}";r+=2}else{var h=null;i&&c('"}}"')}if(h!==null)var p=[a,l,h];else{var p=null;r=o}}else{var p=null;r=o}}else{var p=null;r=o}var d=p!==null?function(e){return e.join("")}(p[1]):null;if(d!==null)var v=d;else{var v=null;r=s}return u[t]={nextPos:r,result:v},v}function g(){function t(e){e.sort();var t=null,n=[];for(var r=0;r<e.length;r++)e[r]!==t&&(n.push(e[r]),t=e[r]);switch(n.length){case 0:return"end of input";case 1:return n[0];default:return n.slice(0,n.length-1).join(", ")+" or "+n[n.length-1]}}var n=t(o),i=Math.max(r,s),u=i<e.length?l(e.charAt(i)):"end of input";return"Expected "+n+" but "+u+" found."}function y(){var t=1,n=1,r=!1;for(var i=0;i<s;i++){var o=e.charAt(i);o==="\n"?(r||t++,n=1,r=!1):o==="\r"|o==="\u2028"||o==="\u2029"?(t++,n=1,r=!0):(n++,r=!1)}return{line:t,column:n}}var n={command:p,identifier:d,parameter:m,paramlist:v,whitespace:h};if(t!==undefined){if(n[t]===undefined)throw new Error("Invalid rule name: "+l(t)+".")}else t="command";var r=0,i=!0,s=0,o=[],u={},b=n[t]();if(b===null||r!==e.length){var w=y();throw new this.SyntaxError(g(),w.line,w.column)}return b},toSource:function(){return this._source}};return e.SyntaxError=function(e,t,n){this.name="SyntaxError",this.message=e,this.line=t,this.column=n},e.SyntaxError.prototype=Error.prototype,e}(),Robj={"null":function(e){return{type:"null",value:null,attributes:e,html_element:function(){return $("<div class='obj'><div class='key'>null</div></div>")}}},clos:function(e,t,n){return{type:"clos",value:{formals:e,body:t},attributes:n,html_element:function(){var e=$("<div class='obj'></div>"),t=$("<div></div>");return t.append($("<div class='key'>formals:</div>")),t.append(this.value.formals.html_element()),e.append(t),t=$("<div></div>"),t.append($("<div class='key'>body:</div>")),t.append(this.value.body.html_element()),e.append(t),e}}},vector:make_basic("vector",{html_element:function(){var e=$("<div class='obj'></div>");if(!this.attributes)for(var t=0;t<this.value.length;++t)e.append(this.value[t].html_element());else{var n=_.map(this.value,function(e){return e.value.length}),r=this.attributes.value.names.value;if(_.all(n,function(e){return e===n[0]})){var i=document.createElement("table"),s=document.createElement("tr"),o=this.value;i.appendChild(s),d3.select(s).selectAll("th").data(_.range(n.length)).enter().append("th").text(function(e){return r[e]});var u;n[0]<11?u=_.range(n[0]):(u=[0,1,2,3,4,5],u.push.apply(u,_.range(n[0]-5,n[0]))),d3.select(i).selectAll("tr-data").data(u).enter().append("tr").selectAll("td").data(function(e){return _.map(_.range(n.length),function(t){return[e,t]})}).enter().append("td").text(function(e,t){var r=e[0],i=e[1];if(n[0]>=11&&r===5)return"...";var s=o[i].value[r];return o[i].attributes?o[i].attributes.value.levels.value[s-1]:s}),e.append(i)}else{var a=$("<div></div>");for(var t=0;t<this.value.length;++t)a.append($("<span class='key'></span>").append(r[t]+": ")),a.append(this.value[t].html_element());e.append(a)}}return e}}),symbol:make_basic("symbol"),list:make_basic("list"),lang:make_basic("lang"),tagged_list:make_basic("tagged_list"),tagged_lang:make_basic("tagged_lang"),vector_exp:make_basic("vector_exp"),int_array:make_basic("int_array",{html_element:pprint_array_as_div()}),double_array:make_basic("double_array",{html_element:pprint_array_as_div()}),string_array:make_basic("string_array",{html_element:pprint_array_as_div(function(e){var t,n,r=e.length,i='"';for(n=0;n<r;n+=1){t=e.charAt(n);if(t>=" "){if(t==="\\"||t==='"')i+="\\";i+=t}else switch(t){case"\b":i+="\\b";break;case"\f":i+="\\f";break;case"\n":i+="\\n";break;case"\r":i+="\\r";break;case"	":i+="\\t";break;default:t=t.charCodeAt(),i+="\\u00"+Math.floor(t/16).toString(16)+(t%16).toString(16)}}return i+'"'})}),bool_array:make_basic("bool_array",{html_element:pprint_array_as_div()})},Rsrv={PAR_TYPE:function(e){return e&255},PAR_LEN:function(e){return e>>8},PAR_LENGTH:function(e){return e>>8},par_parse:function(e){return[Rsrv.PAR_TYPE(e),Rsrv.PAR_LEN(e)]},SET_PAR:function(e,t){return(t&16777215)<<8|e&255},CMD_STAT:function(e){return e>>24&127},SET_STAT:function(e,t){return e|(t&127)<<24},CMD_RESP:65536,RESP_OK:65537,RESP_ERR:65538,OOB_SEND:200704,ERR_auth_failed:65,ERR_conn_broken:66,ERR_inv_cmd:67,ERR_inv_par:68,ERR_Rerror:69,ERR_IOerror:70,ERR_notOpen:71,ERR_accessDenied:72,ERR_unsupportedCmd:73,ERR_unknownCmd:74,ERR_data_overflow:75,ERR_object_too_big:76,ERR_out_of_mem:77,ERR_ctrl_closed:78,ERR_session_busy:80,ERR_detach_failed:81,CMD_long:1,CMD_voidEval:2,CMD_eval:3,CMD_shutdown:4,CMD_openFile:16,CMD_createFile:17,CMD_closeFile:18,CMD_readFile:19,CMD_writeFile:20,CMD_removeFile:21,CMD_setSEXP:32,CMD_assignSEXP:129,CMD_detachSession:48,CMD_detachedVoidEval:49,CMD_attachSession:50,CMD_ctrl:64,CMD_ctrlEval:66,CMD_ctrlSource:69,CMD_ctrlShutdown:68,CMD_setBufferSize:129,CMD_setEncoding:130,CMD_SPECIAL_MASK:240,CMD_serEval:245,CMD_serAssign:246,CMD_serEEval:247,DT_INT:1,DT_CHAR:2,DT_DOUBLE:3,DT_STRING:4,DT_BYTESTREAM:5,DT_SEXP:10,DT_ARRAY:11,DT_LARGE:64,XT_NULL:0,XT_INT:1,XT_DOUBLE:2,XT_STR:3,XT_LANG:4,XT_SYM:5,XT_BOOL:6,XT_S4:7,XT_VECTOR:16,XT_LIST:17,XT_CLOS:18,XT_SYMNAME:19,XT_LIST_NOTAG:20,XT_LIST_TAG:21,XT_LANG_NOTAG:22,XT_LANG_TAG:23,XT_VECTOR_EXP:26,XT_VECTOR_STR:27,XT_ARRAY_INT:32,XT_ARRAY_DOUBLE:33,XT_ARRAY_STR:34,XT_ARRAY_BOOL_UA:35,XT_ARRAY_BOOL:36,XT_RAW:37,XT_ARRAY_CPLX:38,XT_UNKNOWN:48,XT_LARGE:64,XT_HAS_ATTR:128,BOOL_TRUE:1,BOOL_FALSE:0,BOOL_NA:2,GET_XT:function(e){return e&63},GET_DT:function(e){return e&63},HAS_ATTR:function(e){return(e&Rsrv.XT_HAS_ATTR)>0},IS_LARGE:function(e){return(e&Rsrv.XT_LARGE)>0},itop:function(e){return e},ptoi:function(e){return e},dtop:function(e){return e},ptod:function(e){return e},fixdcpy:function(){throw"unimplemented"},status_codes:{65:"ERR_auth_failed",66:"ERR_conn_broken",67:"ERR_inv_cmd",68:"ERR_inv_par",69:"ERR_Rerror",70:"ERR_IOerror",71:"ERR_notOpen",72:"ERR_accessDenied",73:"ERR_unsupportedCmd",74:"ERR_unknownCmd",75:"ERR_data_overflow",76:"ERR_object_too_big",77:"ERR_out_of_mem",78:"ERR_ctrl_closed",80:"ERR_session_busy",81:"ERR_detach_failed"}},rcloud={},rcloud.init_client_side_data=function(){var e=this;rcloud.get_user_filenames(function(t){e.user_filenames=t.value;var n=t.value,r=d3.select("#internals-user-files");r.append("h3").text("User files"),r.append("ul").selectAll("li").data(n).enter().append("li").text(function(e){return e})}),rclient.send_and_callback("rcloud.prefix.uuid()",function(t){e.wplot_uuid=t.value[0]})},rcloud.username=function(){return $.cookies.get("user")},rcloud.get_user_filenames=function(e){_.isUndefined(e)&&(e=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.list.initial.filenames",this.username()),e)},rcloud.search=function(e,t){var n=this;_.isUndefined(t)&&(t=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.search",e),t)},rcloud.get_all_user_filenames=function(e){var t=this;_.isUndefined(e)&&(e=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.list.all.initial.filenames"),e)},rcloud.load_user_file=function(e,t,n){rclient.send_and_callback(rclient.r_funcall("rcloud.load.user.file",e,t),n)},rcloud.save_to_user_file=function(e,t,n,r){rclient.send_and_callback(rclient.r_funcall("rcloud.save.to.user.file",e,t,n),r)},rcloud.create_user_file=function(e,t){rclient.send_and_callback(rclient.r_funcall("rcloud.create.user.file",rcloud.username(),e),t)},rcloud.resolve_deferred_result=function(e,t){var n=rclient.r_funcall("rcloud.fetch.deferred.result",e);rclient.send_and_callback(n,t)},Notebook={},Notebook.Cell={},function(){function e(e,t){return $("<span class='fontawesome-button'><i class='"+e+"'></i></span>").tooltip({title:t,delay:{show:250,hide:0}})}function t(t){function a(){t.content(E.getSession().getValue())}function f(e){e.removeClass("button-disabled")}function l(e){e.addClass("button-disabled")}function c(){N.html("Computing..."),a(),L.show_result(),t.controller.execute()}var n=$("<div class='notebook-cell'></div>"),r=e("icon-edit","source"),i=e("icon-picture","result"),s=e("icon-resize-small","hide"),o=e("icon-trash","remove"),u=e("icon-repeat","run");r.click(function(e){$(e.currentTarget).hasClass("button-disabled")||L.show_source()}),i.click(function(e){$(e.currentTarget).hasClass("button-disabled")||L.show_result()}),s.click(function(e){$(e.currentTarget).hasClass("button-disabled")||L.hide_all()}),o.click(function(
e){$(e.currentTarget).hasClass("button-disabled")||(t.parent_model.controller.remove_cell(t),$(".tooltip").remove())}),u.click(function(e){c()});var h=$("<div style='position:relative; float: right; z-index:10000'></div>"),p=$("<div style='margin:0.5em;'></div>"),d=$("<div style='margin:0.5em;'></div>");p.append(r),p.append(i),p.append(s),p.append(o),h.append(p),d.append(u),d.hide(),h.append(d),n.append(h);var v=$("<div></div>"),m=$("<div style='clear:both;'></div>");n.append(v),n.append(m);var g=$('<div style="position: relative; width:100%; height:100%"></div>'),y=$('<div style="position: absolute; right:-0.5em; top:-0.5em"></div>'),b=e("icon-plus-sign","insert cell");v.append(y),y.append(b),b.click(function(e){var t=n.index(),r=t;shell.insert_markdown_cell_before(r)});var w=$('<div style="width:100%; height:100%"></div>');v.append(g),g.append(w);var E=ace.edit(w[0]),S=require("mode/rmarkdown").Mode,x=E.getSession(),T=x.doc;E.getSession().setMode(new S(!1,T,x)),E.setTheme("ace/theme/chrome"),E.getSession().setUseWrapMode(!0),E.resize(),E.commands.addCommand({name:"sendToR",bindKey:{win:"Ctrl-Return",mac:"Command-Return",sender:"editor"},exec:function(e,t,n){c()}});var N=$('<div class="r-result-div"><span style="opacity:0.5">Not evaluated</span></div>');v.append(N);var C=$("<span></span>");v.append(C);var k,L={content_updated:function(){E.getSession().setValue(t.content())},self_removed:function(){n.remove()},result_updated:function(e){N.hide(),N.html(e.value[0]),N.slideDown(150);var t=rcloud.wplot_uuid;v.find("pre code").contents().filter(function(){return this.nodeValue.indexOf(t)!==-1}).parent().parent().each(function(){var e=this.childNodes[0].childNodes[0].data.substr(8,73).split("|"),t=this;rcloud.resolve_deferred_result(e[1],function(e){$(t).replaceWith(function(){return shell.handle(e.value[0].value[0],e)})})}),v.find("pre code").each(function(e,t){hljs.highlightBlock(t)}),_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub]),this.show_result(),C[0].scrollIntoView()},hide_buttons:function(){h.css("display","none"),y.css("display","none")},show_buttons:function(){h.css("display",null),y.css("display",null)},show_source:function(){n.css({height:"70%"}),l(r),f(i),f(s),f(o),d.show(),g.show(),N.hide(),E.resize(),E.focus(),k="source"},show_result:function(){n.css({height:""}),f(r),l(i),f(s),f(o),d.hide(),g.hide(),N.slideDown(150,function(){C[0].scrollIntoView()}),k="result"},hide_all:function(){n.css({height:""}),f(r),f(i),l(s),f(o),d.hide(),k==="result"?N.slideUp(150):g.slideUp(150)},remove_self:function(){t.parent_model.remove_cell(t),n.remove()},div:function(){return n},update_model:function(){a()},focus:function(){E.focus()}};return L.show_result(),L.content_updated(),L}function n(t){function u(){t.content($(w).val())}function a(e){e.removeClass("button-disabled")}function f(e){e.addClass("button-disabled")}function l(){E.html("Computing..."),u(),T.show_result(),t.controller.execute()}var n=$("<div class='notebook-cell'></div>"),r=$("<span class='fontawesome-button'><i class='icon-edit'></i></span>").tooltip({title:"source"}),i=$("<span class='fontawesome-button'><i class='icon-picture'></i></span>").tooltip({title:"result"}),s=$("<span class='fontawesome-button'><i class='icon-resize-small'></i></span>").tooltip({title:"hide"}),o=$("<span class='fontawesome-button'><i class='icon-trash'></i></span>").tooltip({title:"remove"});r.click(function(e){$(e.currentTarget).hasClass("button-disabled")||T.show_source()}),i.click(function(e){$(e.currentTarget).hasClass("button-disabled")||T.show_result()}),s.click(function(e){$(e.currentTarget).hasClass("button-disabled")||T.hide_all()}),o.click(function(e){$(e.currentTarget).hasClass("button-disabled")||(t.parent_model.controller.remove_cell(t),$(".tooltip").remove())});var c=$("<div style='position:relative; float: right; z-index:10000'></div>"),h=$("<div style='margin:0.5em;'></div>"),p=$("<div style='margin:0.5em;'></div>");h.append(r),h.append(i),h.append(s),h.append(o),c.append(h),p.hide(),c.append(p),n.append(c);var d=$("<div></div>"),v=$("<div style='clear:both;'></div>");n.append(d),n.append(v);var m=$('<div style="position: relative; width:100%;"></div>'),g=$('<div style="position: absolute; right:-0.5em; top:-0.5em"></div>'),y=e("icon-plus-sign","insert cell");d.append(g),g.append(y),y.click(function(e){var t=n.index(),r=t;shell.insert_markdown_cell_before(r)});var b=$('<div style="width:100%; margin-left: 0.5em; margin-top: 0.5em"></div>');d.append(m),m.append(b);var w=$('<input type="text" style="width:88%"/>');b.append(w),w.keypress(function(e){return e.which===13?(l(),e.preventDefault(),!1):!0});var E=$('<div class="r-result-div"></div>');d.append(E);var S=$("<span></span>");d.append(S);var x,T={content_updated:function(){w.val(t.content())},self_removed:function(){n.remove()},result_updated:function(e){E.hide(),E.html(e.value[0]),E.slideDown(150);var t=rcloud.wplot_uuid;d.find("pre code").contents().filter(function(){return this.nodeValue.indexOf(t)!==-1}).parent().parent().each(function(){var e=this.childNodes[0].childNodes[0].data.substr(8,73).split("|"),t=this;rcloud.resolve_deferred_result(e[1],function(e){$(t).replaceWith(function(){return shell.handle(e.value[0].value[0],e)})})}),d.find("pre code").each(function(e,t){hljs.highlightBlock(t)}),_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub]),this.show_result(),S[0].scrollIntoView()},hide_buttons:function(){c.css("display","none"),g.css("display","none")},show_buttons:function(){c.css("display",null),g.css("display",null)},show_source:function(){n.css({height:""}),f(r),a(i),a(s),a(o),p.show(),m.show(),E.hide(),w.focus(),x="source"},show_result:function(){n.css({height:""}),a(r),f(i),a(s),a(o),p.hide(),m.hide(),E.slideDown(150,function(){S[0].scrollIntoView()}),x="result"},hide_all:function(){n.css({height:""}),a(r),a(i),f(s),a(o),p.hide(),x==="result"?E.slideUp(150):m.slideUp(150)},remove_self:function(){t.parent_model.remove_cell(t),n.remove()},div:function(){return n},update_model:function(){u()},focus:function(){w.focus()}};return T.show_result(),T.content_updated(),T}var r={markdown:t,interactive:n};Notebook.Cell.create_html_view=function(e){return r[e.type()](e)}}(),Notebook.Cell.create_model=function(e,t){function r(){_.each(n.views,function(e){e.content_updated()})}var n={views:[],type:function(){return t},content:function(t){return _.isUndefined(t)||(e=t,r()),e},json:function(){return{content:e,type:t}}};return n},Notebook.Cell.create_controller=function(e){var t={execute:function(){function r(t){_.each(e.views,function(e){e.result_updated(t)})}var t=this,n=e.type();rclient.record_cell_execution(e);if(n==="markdown"){var i=rclient.markdown_wrap_command(e.content());rclient.send_and_callback(i,r,_.identity)}else if(n==="interactive"){var i=rclient.markdown_wrap_command("```{r}\n"+e.content()+"\n```\n");rclient.send_and_callback(i,r,_.identity)}else alert("Can only do markdown or interactive for now!")}};return t},Notebook.create_html_view=function(e,t){var n={model:e,sub_views:[],cell_appended:function(e){var n=Notebook.Cell.create_html_view(e);return e.views.push(n),t.append(n.div()),this.sub_views.push(n),n},cell_inserted:function(e,n){var r=Notebook.Cell.create_html_view(e);return e.views.push(r),t.append(r.div()),$(r.div()).insertBefore(t.children()[n]),this.sub_views.splice(n,0,r),r.show_source(),r},cell_removed:function(e,t){_.each(e.views,function(e){e.self_removed()}),this.sub_views.splice(t,1)},update_model:function(){_.each(this.sub_views,function(e){e.update_model()})}};return e.views.push(n),n},Notebook.create_model=function(){return{notebook:[],views:[],clear:function(){while(this.notebook.length)this.remove_cell(this.notebook[this.notebook.length-1])},append_cell:function(e){e.parent_model=this,this.notebook.push(e),_.each(this.views,function(t){t.cell_appended(e)})},insert_cell:function(e,t){e.parent_model=this,this.notebook.splice(t,0,e),_.each(this.views,function(n){n.cell_inserted(e,t)})},json:function(){return _.map(this.notebook,function(e){return e.json()})},remove_cell:function(e){var t=this.notebook.indexOf(e);if(t===-1)throw"cell_model not in notebook model?!";_.each(this.views,function(n){n.cell_removed(e,t)}),this.notebook.splice(t,1)}}},Notebook.create_controller=function(e){var t={append_cell:function(t,n){var r=Notebook.Cell.create_model(t,n),i=Notebook.Cell.create_controller(r);return r.controller=i,e.append_cell(r),i},insert_cell:function(t,n,r){var i=Notebook.Cell.create_model(t,n),s=Notebook.Cell.create_controller(i);return i.controller=s,e.insert_cell(i,r),s},remove_cell:function(t){e.remove_cell(t)},clear:function(){e.clear()},load_from_file:function(e,t,n){var r=this;rcloud.load_user_file(e,t,function(e){var t=JSON.parse(e.value.join("\n"));r.clear(),_.each(t,function(e){var t=r.append_cell(e.content,e.type)}),n()})},save_file:function(t,n,r){var i=this,s=JSON.stringify(e.json());rcloud.load_user_file(t,n,function(e){e=e.value.join("\n"),s!==e?rcloud.save_to_user_file(t,n,s,function(){r&&r()}):r&&r()})},run_all:function(){_.each(e.notebook,function(e){e.controller.execute()})}};return e.controller=t,t};