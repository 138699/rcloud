RClient={create:function(e){function t(){if(!u.ocap_mode){a.post_error(a.disconnection_error("Expected an object-capability Rserve. Shutting Down!")),n();return}u.ocap([s,o],function(t){t!==null?(a.running=!0,e.on_connect&&e.on_connect.call(a,t)):r("Login failed. Shutting down!")})}function n(){f||$("#input-div").hide(),u.closed||u.close()}function r(t,r){if(e.on_error&&e.on_error(t,r))return;a.post_error(a.disconnection_error(t)),n()}function i(e){f||(a.post_error(a.disconnection_error("Socket was closed. Goodbye!")),n())}var s=$.cookies.get().token,o=$.cookies.get().execToken,u=Rserve.create({host:e.host,on_connect:t,on_error:r,on_close:i,on_data:e.on_data}),a,f=!1;return a={_rserve:u,host:e.host,running:!1,string_error:function(e){var t=$("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>"),n=$("<div class='alert alert-danger alert-dismissable'></div>"),r=$("<span></span>");return n.append(t),n.append(r),r.text(e),n},disconnection_error:function(e){var t=$("<div class='alert alert-danger'></div>");t.append($("<span></span>").text(e));var n=$("<button type='button' class='close'>Reconnect</button>");return t.append(n),n.click(function(){window.location=window.location.protocol+"//"+window.location.host+"/login.R?redirect="+encodeURIComponent(window.location.pathname+window.location.search)}),t},post_error:function(e){typeof e=="string"&&(e=this.string_error(e));if(typeof e!="object")throw new Error("post_error expects a string or a jquery div");$("#output").append(e),window.scrollTo(0,document.body.scrollHeight)},post_response:function(e){var t=$("<pre></pre>").html(e);$("#output").append(t),window.scrollTo(0,document.body.scrollHeight)},close:function(){f=!0,n()}},a}},RCloud={},RCloud.is_exception=function(e){return _.isArray(e)&&e.r_attributes&&e.r_attributes["class"]==="try-error"},RCloud.exception_message=function(e){if(!RCloud.is_exception(e))throw new Error("Not an R exception value");return e[0]},RCloud.create=function(rcloud_ocaps){function json_k(e){return function(t){var n={};try{n=JSON.parse(t)}catch(r){rclient.post_error(r.message)}e&&e(n)}}function rcloud_github_handler(e,t){return function(n){if(n.ok)t&&t(n.content);else{var r=_.isObject(n)&&"ok"in n?n.content.message:n.toString();rclient.post_error(e+": "+r),t&&t({error:n.content})}}}function setup_unauthenticated_ocaps(){rcloud.anonymous_session_init=function(e){rcloud_ocaps.anonymous_session_init(e||_.identity)},rcloud.username=function(){return $.cookies.get("user")},rcloud.github_token=function(){return $.cookies.get("token")},rcloud.init_client_side_data=function(e){e=e||_.identity;var t=this;rcloud_ocaps.prefix_uuid(function(n){t.deferred_knitr_uuid=n,e()})},rcloud.get_conf_value=function(e,t){rcloud_ocaps.get_conf_value(e,t)},rcloud.get_notebook=function(e,t,n){n=rcloud_github_handler("rcloud.get.notebook "+e,n),rcloud_ocaps.get_notebook(e,t,function(e){n(e)})},rcloud.load_notebook=function(e,t,n){n=rcloud_github_handler("rcloud.load.notebook "+e,n),rcloud_ocaps.load_notebook(e,t,function(e){n(e)})},rcloud.call_notebook=function(e,t,n){n=rcloud_github_handler("rcloud.call.notebook "+e,n),rcloud_ocaps.call_notebook(e,t,function(e){n(e)})},rcloud.install_notebook_stylesheets=function(e){rcloud_ocaps.install_notebook_stylesheets(e||_.identity)},rcloud.get_users=function(e,t){rcloud_ocaps.get_users(e,t||_.identity)},rcloud.record_cell_execution=function(e){var t=_.identity,n=JSON.stringify(e.json());rcloud_ocaps.log.record_cell_execution(rcloud.username(),n,t)},rcloud.setup_js_installer=function(e,t){rcloud_ocaps.setup_js_installer(e,t||_.identity)},rcloud.modules={},rcloud.setup_js_installer({install_js:function(name,content,k){var result=eval(content);rcloud.modules[name]=result,k(result)},clear_css:function(e,t){$(".rcloud-user-defined-css").remove(),t()},install_css:function(e,t){_.isString(e)&&(e=[e]),_.each(e,function(e){$("head").append($('<link type="text/css" rel="stylesheet" class="rcloud-user-defined-css" href="'+e+'"/>'))}),t()}}),rcloud.get_all_comments=function(e,t){rcloud_ocaps.comments.get_all(e,t||_.identity)},rcloud.debug={},rcloud.debug.raise=function(e,t){rcloud_ocaps.debug.raise(e,t||_.identity)},rcloud.stars={},rcloud.stars.is_notebook_starred=function(e,t){rcloud_ocaps.stars.is_notebook_starred(e,t)},rcloud.stars.get_notebook_star_count=function(e,t){rcloud_ocaps.stars.get_notebook_star_count(e,t)},rcloud.stars.get_multiple_notebook_star_counts=function(e,t){rcloud_ocaps.stars.get_multiple_notebook_star_counts(e,t)},rcloud.session_cell_eval=function(e,t,n,r){rcloud_ocaps.session_cell_eval(e,t,n,r)},rcloud.reset_session=function(e){e=e||_.identity,rcloud_ocaps.reset_session(e)},rcloud.display={},rcloud.display.set_device_pixel_ratio=function(e){rcloud_ocaps.set_device_pixel_ratio(window.devicePixelRatio,e||_.identity)}}function setup_authenticated_ocaps(){rcloud.session_init=function(e,t,n){rcloud_ocaps.session_init(e,t,n||_.identity)},rcloud.search=function(e,t){rcloud_ocaps.search(e,t||_.identity)},rcloud.load_user_config=function(e,t){rcloud_ocaps.load_user_config(e,json_k(t))},rcloud.load_multiple_user_configs=function(e,t){rcloud_ocaps.load_multiple_user_configs(e,json_k(t))},rcloud.save_user_config=function(e,t,n){rcloud_ocaps.save_user_config(e,JSON.stringify(t),json_k(n))},rcloud.update_notebook=function(e,t,n){n=rcloud_github_handler("rcloud.update.notebook",n),rcloud_ocaps.update_notebook(e,JSON.stringify(t),n)},rcloud.create_notebook=function(e,t){t=rcloud_github_handler("rcloud.create.notebook",t),rcloud_ocaps.create_notebook(JSON.stringify(e),t)},rcloud.fork_notebook=function(e,t){t=rcloud_github_handler("rcloud.fork.notebook",t),rcloud_ocaps.fork_notebook(e,t)},rcloud.port_notebooks=function(e,t,n,r){rcloud_ocaps.port_notebooks(e,t,n,r)},rcloud.get_completions=function(e,t,n){return rcloud_ocaps.get_completions(e,t,function(e){_.isString(e)&&(e=[e]),n(_.map(e,function(e){return{meta:"local",name:"library",score:3,value:e}}))})},rcloud.rename_notebook=function(e,t,n){n=rcloud_github_handler("rcloud.rename.notebook",n),rcloud_ocaps.rename_notebook(e,t,n)},rcloud.session_markdown_eval=function(e,t,n,r){rcloud_ocaps.session_markdown_eval(e,t,n,r||_.identity)},rcloud.upload_to_notebook=function(e,t,n){function r(e){var n=new FileReader,r=1048576,i=e.size,s=new Uint8Array(i),o=0;n.readAsArrayBuffer(e.slice(o,o+r)),n.onload=function(i){if(i.target.result.byteLength>0){var u=new Uint8Array(i.target.result);s.set(u,o),o+=u.byteLength,n.readAsArrayBuffer(e.slice(o,o+r))}else rcloud_ocaps.notebook_upload(s.buffer,e.name,function(n){t(s,e,n.content)})}}t=t||_.identity,n=n||_.identity;if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))throw new Error("File API not supported by browser.");var i=$("#file")[0].files[0];if(_.isUndefined(i))throw new Error("No file selected!");rcloud_ocaps.file_upload.upload_path(function(e){var t=$("#file")[0].files[0];if(_.isUndefined(t))throw new Error("No file selected!");r(t)})},rcloud.upload_file=function(e,t,n){function r(r,i){var s=r+"/"+i.name;rcloud_ocaps.file_upload.create(s,e,function(e){if(RCloud.is_exception(e)){n(RCloud.exception_message(e));return}var s=new FileReader,o=1048576,u=i.size,a=0;s.readAsArrayBuffer(i.slice(a,a+o)),s.onload=function(e){if(e.target.result.byteLength>0){var n=new Uint8Array(e.target.result);rcloud_ocaps.file_upload.write(n.buffer,function(){a+=o,s.readAsArrayBuffer(i.slice(a,a+o))})}else rcloud_ocaps.file_upload.close(function(){t(r,i)})}})}t=t||_.identity;if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))throw"File API not supported by browser.";var i=$("#file")[0].files[0];if(_.isUndefined(i))throw"No file selected!";rcloud_ocaps.file_upload.upload_path(function(e){var t=$("#file")[0].files[0];if(_.isUndefined(t))throw new Error("No file selected!");r(e,t)})},rcloud.post_comment=function(e,t,n){rcloud_ocaps.comments.post(e,t,n||_.identity)},rcloud.is_notebook_published=function(e,t){rcloud_ocaps.is_notebook_published(e,t)},rcloud.publish_notebook=function(e,t){rcloud_ocaps.publish_notebook(e,t||_.identity)},rcloud.unpublish_notebook=function(e,t){rcloud_ocaps.unpublish_notebook(e,t||_.identity)},rcloud.stars={},rcloud.stars.star_notebook=function(e,t){rcloud_ocaps.stars.star_notebook(e,t||_.identity)},rcloud.stars.unstar_notebook=function(e,t){rcloud_ocaps.stars.unstar_notebook(e,t||_.identity)},rcloud.stars.is_notebook_starred=function(e,t){rcloud_ocaps.stars.is_notebook_starred(e,t)},rcloud.stars.get_notebook_star_count=function(e,t){rcloud_ocaps.stars.get_notebook_star_count(e,t)},rcloud.stars.get_multiple_notebook_star_counts=function(e,t){rcloud_ocaps.stars.get_multiple_notebook_star_counts(e,t)},rcloud.stars.get_my_starred_notebooks=function(e){rcloud_ocaps.stars.get_my_starred_notebooks(e)}}function set_curtain(){if(curtains_on)return;curtains_on=!0,_.isUndefined(progress_dialog)&&(progress_dialog=$('<div id="progress-dialog" class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-body">Please wait...</div></div></div>'),$("body").append(progress_dialog)),progress_dialog.modal({keyboard:!0})}function clear_curtain(){if(!curtains_on)return;curtains_on=!1,progress_dialog.modal("hide")}function set_cursor(){_.delay(function(){document.body.style.cursor="wait"},0)}function clear_cursor(){_.delay(function(){document.body.style.cursor=""},0)}var rcloud={};rcloud.authenticated=rcloud_ocaps.authenticated,setup_unauthenticated_ocaps(),rcloud.authenticated&&setup_authenticated_ocaps();var progress_dialog,progress_counter=0,allowed=1,curtains_on=!1;return rcloud.with_progress=function(e,t){function n(){progress_counter-=1,progress_counter===0&&(clear_cursor(),clear_curtain())}_.isUndefined(t)&&(t=2e3),set_cursor(),_.delay(function(){progress_counter>0&&allowed>0&&set_curtain()},t),progress_counter+=1,e(n)},rcloud.prevent_progress_modal=function(){allowed===1&&progress_counter>0&&(clear_cursor(),clear_curtain()),allowed-=1},rcloud.allow_progress_modal=function(){allowed===0&&progress_counter>0&&(set_cursor(),set_curtain()),allowed+=1},rcloud};var ui_utils={};ui_utils.fa_button=function(e,t,n,r){var i=$("<span/>",{"class":"fontawesome-button "+(n||"")}),s=$("<i/>",{"class":e});return r&&s.css(r),i.append(s).tooltip({title:t,delay:{show:250,hide:0}}),i},ui_utils.enable_fa_button=function(e){e.removeClass("button-disabled")},ui_utils.disable_fa_button=function(e){e.addClass("button-disabled")},ui_utils.enable_bs_button=function(e){e.removeClass("disabled")},ui_utils.disable_bs_button=function(e){e.addClass("disabled")},ui_utils.ace_editor_height=function(e){var t=e.renderer.lineHeight,n=Math.min(30,e.getSession().getLength()),r=t*n+e.renderer.scrollBar.getWidth();return Math.max(75,r)},ui_utils.ace_set_pos=function(e,t,n){var r=e.getSelection(),i=r.getRange();i.setStart(t,n),i.setEnd(t,n),r.setSelectionRange(i)},ui_utils.install_common_ace_key_bindings=function(e){var t=require("ace/autocomplete").Autocomplete,n=e.getSession();e.commands.addCommands([{name:"another autocomplete key",bindKey:"Ctrl-.",exec:t.startCommand.exec},{name:"disable gotoline",bindKey:{win:"Ctrl-L",mac:"Command-L"},exec:function(){return!1}},{name:"execute-selection-or-line",bindKey:{win:"Alt-Return",mac:"Alt-Return",sender:"editor"},exec:function(e,t,r){var i=n.getTextRange(e.getSelectionRange());if(i.length==0){var s=e.getCursorPosition(),o=require("ace/range").Range,u=new o(s.row,0,s.row+1,0);i=n.getTextRange(u)}shell.new_interactive_cell(i,!0)}}])},ui_utils.ignore_programmatic_changes=function(e,t){var n=!0;return e.on("change",function(){n&&t(e.getValue())}),function(t){n=!1;var r=e.setValue(t);return n=!0,r}},ui_utils.twostate_icon=function(e,t,n,r,i){function s(t){e[0].checked=t;var n=e.find("i");t?(n.removeClass(i),n.addClass(r)):(n.removeClass(r),n.addClass(i))}function o(){var e=!this.checked;s(e),e?t():n()}function u(t){e.off("click"),t&&e.click(o)}return u(!0),{set_state:s,enable:u}},ui_utils.checkbox_menu_item=function(e,t,n){var r=ui_utils.twostate_icon(e,t,n,"icon-check","icon-check-empty"),i=r.enable;return r.enable=function(e){$("#publish-notebook").parent().toggleClass("disabled",!e),i(e)},r},ui_utils.make_prompt_chevron_gutter=function(e){var t=require("ace/lib/dom");e.renderer.$gutterLayer.update=function(e){var n={className:""},r=[],i=e.firstRow,s=e.lastRow,o=this.session.getNextFoldLine(i),u=o?o.start.row:Infinity,a=this.$showFoldWidgets&&this.session.foldWidgets,f=this.session.$breakpoints,l=this.session.$decorations,c=this.session.$firstLineNumber,h=0;r.push("<div class='ace_gutter-cell ","' style='height:",this.session.getRowLength(0)*e.lineHeight,"px;'>","&gt;","</div>"),this.element=t.setInnerHtml(this.element,r.join("")),this.element.style.height=e.minHeight+"px",this.session.$useWrapMode&&(h=this.session.getLength());var p=(""+h).length*e.characterWidth,d=this.$padding||this.$computePadding();p+=d.left+d.right,p!==this.gutterWidth&&!isNaN(p)&&(this.gutterWidth=p,this.element.style.width=Math.ceil(this.gutterWidth)+"px",this._emit("changeGutterWidth",p))}};var bootstrap_utils={};bootstrap_utils.alert=function(e){e=_.defaults(e||{},{close_button:!0});var t=$('<div class="alert"></div>');return e.html&&t.html(e.html),e.text&&t.text(e.text),e["class"]&&t.addClass(e["class"]),e.close_button&&t.prepend($('<button type="button" class="close" data-dismiss="alert">&times;</button>')),t},bootstrap_utils.button=function(e){e=e||{};var t=$('<a class="btn" href="#"></a>');return t.text(e.text),e["class"]&&t.addClass(e["class"]),t},Notebook={},Notebook.Cell={},function(){function e(e){return function(t){function f(){return t.content(w.getSession().getValue())}function h(){N.html("Computing...");var e=f();k.show_result(),e!==null&&t.parent_model.controller.update_cell(t),rcloud.with_progress(function(e){t.controller.execute(function(){e()})})}var n=$("<div class='notebook-cell'></div>"),r=ui_utils.fa_button("icon-plus-sign","insert cell"),i=ui_utils.fa_button("icon-edit","source"),s=ui_utils.fa_button("icon-picture","result"),o=ui_utils.fa_button("icon-trash","remove"),u=ui_utils.fa_button("icon-play","run"),a=$("<div/>").html("&nbsp;").css({"line-height":"25%"}),l=ui_utils.enable_fa_button,c=ui_utils.disable_fa_button;r.click(function(e){shell.insert_markdown_cell_before(t.id)}),i.click(function(e){$(e.currentTarget).hasClass("button-disabled")||k.show_source()}),s.click(function(e){$(e.currentTarget).hasClass("button-disabled")||k.show_result()}),o.click(function(e){$(e.currentTarget).hasClass("button-disabled")||(t.parent_model.controller.remove_cell(t),$(".tooltip").remove())}),u.click(function(e){h()});var p=$("<div class='cell-controls'></div>"),d=$("<table/>");$.each([u,i,s,a,o],function(){d.append($("<tr/>").append($("<td/>").append($(this))))}),p.append(d),n.append(p);var v=$("<div class='cell-insert-control'></div>");v.append(r),n.append(v);var m=$("<div></div>"),g=$("<div style='clear:both;'></div>");n.append(m),n.append(g);var y=$('<div style="position: relative; width:100%; height:100%"></div>'),b=$('<div style="width:100%; height:100%"></div>');b.css({"background-color":e==="R"?"#E8F1FA":"#F7EEE4"}),e==="R"?m.addClass("r-language-pseudo"):m.addClass("rmarkdown-language-pseudo"),m.append(y),y.append(b),ace.require("ace/ext/language_tools");var w=ace.edit(b[0]),E=require(e==="R"?"ace/mode/r":"ace/mode/rmarkdown").Mode,S=w.getSession();w.setValue(t.content()),ui_utils.ace_set_pos(w,0,0),window.setTimeout(function(){S.getUndoManager().reset()},0);var x=S.doc;w.setReadOnly(t.parent_model.read_only()),w.setOptions({enableBasicAutocompletion:!0}),S.setMode(new E(!1,x,S)),S.on("change",function(){n.css({height:ui_utils.ace_editor_height(w)+"px"}),w.resize()}),w.setTheme("ace/theme/chrome"),S.setUseWrapMode(!0),w.resize(),ui_utils.install_common_ace_key_bindings(w),w.commands.addCommands([{name:"sendToR",bindKey:{win:"Ctrl-Return",mac:"Command-Return",sender:"editor"},exec:function(e,t,n){h()}}]);var T=ui_utils.ignore_programmatic_changes(w,function(){t.parent_model.on_dirty()}),N=$('<div class="r-result-div"><span style="opacity:0.5">Computing ...</span></div>');m.append(N);var C,k={content_updated:function(){var e=w.getSelection().getRange(),n=T(t.content());return w.getSelection().setSelectionRange(e),n},self_removed:function(){n.remove()},result_updated:function(e){N.hide(),N.html(e),N.slideDown(150);var n=rcloud.deferred_knitr_uuid;m.find("pre code").length===0&&N.prepend("<pre><code>"+t.content()+"</code></pre>"),m.find("img").each(function(e,t){t.style.width=t.width/window.devicePixelRatio}),m.find("pre code").contents().filter(function(){return this.nodeValue?this.nodeValue.indexOf(n)!==-1:!1}).parent().parent().each(function(){var e=this,t=this.childNodes[0].childNodes[0].data.substr(8,65).split("|"),n=[t[1]];n.r_attributes={"class":"OCref"};var r=rclient._rserve.wrap_ocap(n);r(function(t){if(RCloud.is_exception(t)){var n=RCloud.exception_message(t);$(e).replaceWith(function(){return rclient.string_error(n)})}else{var n=t();$(e).replaceWith(function(){return n})}})}),m.find("pre code").each(function(e,t){hljs.highlightBlock(t)}),_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub]),shell.notebook.controller._r_source_visible||Notebook.hide_r_source(m),this.show_result()},set_readonly:function(e){w.setReadOnly(e)},hide_buttons:function(){p.css("display","none"),v.hide()},show_buttons:function(){p.css("display",null),v.show()},show_source:function(){n.css({height:ui_utils.ace_editor_height(w)+"px"}),y.show(),w.resize(!0),n.css({height:ui_utils.ace_editor_height(w)+"px"}),w.resize(!0),c(i),l(s),l(o),y.show(),N.hide(),w.resize(),w.focus(),C="source"},show_result:function(){n.css({height:""}),l(i),c(s),l(o),y.hide(),N.slideDown(150),C="result"},hide_all:function(){n.css({height:""}),l(i),l(s),l(o),C==="result"?N.slideUp(150):y.slideUp(150)},div:function(){return n},update_model:function(){return f()},focus:function(){w.focus()},get_content:function(){return t.content()}};return k.show_result(),k}}var t={Markdown:e("Markdown"),R:e("R")};Notebook.Cell.create_html_view=function(e){return t[e.language()](e)}}(),Notebook.Cell.create_model=function(e,t){function r(){_.each(n.views,function(e){e.content_updated()})}var n={views:[],id:-1,parent_model:null,language:function(){return t},content:function(t){return _.isUndefined(t)?e:e!=t?(e=t,r(),e):null},json:function(){return{content:e,language:t}}};return n},Notebook.Cell.create_controller=function(e){var t={execute:function(t){function i(e){n.set_status_message(e),t&&t()}var n=this,r=e.language();rcloud.record_cell_execution(e),rcloud.authenticated?rcloud.session_markdown_eval(e.content(),r,!1,i):rcloud.session_cell_eval(Notebook.part_name(e.id,e.language()),e.language(),!1,i)},set_status_message:function(t){_.each(e.views,function(e){e.result_updated(t)})}};return t},Notebook.create_html_view=function(e,t){function n(e){e?$(".ace_cursor-layer").hide():$(".ace_cursor-layer").show()}var r={model:e,sub_views:[],cell_appended:function(e){var n=Notebook.Cell.create_html_view(e);return e.views.push(n),t.append(n.div()),this.sub_views.push(n),n},cell_inserted:function(e,n){var r=Notebook.Cell.create_html_view(e);return e.views.push(r),t.append(r.div()),$(r.div()).insertBefore(t.children(".notebook-cell")[n]),this.sub_views.splice(n,0,r),r.show_source(),r},cell_removed:function(e,t){_.each(e.views,function(e){e.self_removed()}),this.sub_views.splice(t,1)},set_readonly:function(e){n(e),_.each(this.sub_views,function(t){t.set_readonly(e)})},update_model:function(){return _.map(this.sub_views,function(e){return e.update_model()})}};return e.views.push(r),r},Notebook.create_model=function(){function t(e){return e.length?e[e.length-1].id:0}function n(e,t,n){var r={id:e,language:n};return t===""?r.erase=!0:r.content=t,r}var e=!1;return{notebook:[],views:[],dishers:[],clear:function(){return this.remove_cell(null,t(this.notebook))},append_cell:function(e,n){e.parent_model=this;var r=[],i=1;n=n||1,n=Math.max(n,t(this.notebook)+1);while(i)r.push({id:n,content:e.content(),language:e.language()}),e.id=n,this.notebook.push(e),_.each(this.views,function(t){t.cell_appended(e)}),++n,--i;return r},insert_cell:function(e,t){var n=this;e.parent_model=this;var r=[],i=1,s=0;while(s<this.notebook.length&&this.notebook[s].id<t)++s;if(s<this.notebook.length&&t+i>this.notebook[s].id){var o=s>0?this.notebook[s-1].id:0;t=Math.max(this.notebook[s].id-i,o+1)}for(var u=0;u<i;++u)r.push({id:t+u,content:e.content(),language:e.language()}),e.id=t+u,this.notebook.splice(s,0,e),_.each(this.views,function(e){e.cell_inserted(n.notebook[s],s)}),++s;while(s<this.notebook.length&&i){if(this.notebook[s].id>t){var a=this.notebook[s].id-t;i-=a,t+=a}if(i<=0)break;r.push({id:this.notebook[s].id,content:this.notebook[s].content(),rename:this.notebook[s].id+i,language:this.notebook[s].language()}),this.notebook[s].id+=i,++s,++t}return r},remove_cell:function(e,t){var n=this,r,i;if(e!=null){r=this.notebook.indexOf(e),i=e.id;if(r===-1)throw"cell_model not in notebook model?!"}else r=0,i=1;t=t||1;var s=r,o=[];while(s<this.notebook.length&&t)this.notebook[s].id==i&&(_.each(this.views,function(e){e.cell_removed(n.notebook[s],s)}),o.push({id:i,erase:1,language:n.notebook[s].language()}),this.notebook.splice(s,1)),++i,--t;return o},update_cell:function(e){return[n(e.id,e.content(),e.language())]},reread_cells:function(){var e=this,t=_.map(this.views,function(e){return e.update_model()});if(t.length!=1)throw"not expecting more than one notebook view";return _.reduce(t[0],function(t,r,i){return r!==null&&t.push(n(e.notebook[i].id,r,e.notebook[i].language())),t},[])},read_only:function(t){return _.isUndefined(t)||(e=t,_.each(this.views,function(t){t.set_readonly(e)})),e},on_dirty:function(){_.each(this.dishers,function(e){e.on_dirty()})},json:function(){return _.map(this.notebook,function(e){return e.json()})}}},Notebook.create_controller=function(e){function u(t,n,r){var i=Notebook.Cell.create_model(t,n),s=Notebook.Cell.create_controller(i);return i.controller=s,{controller:s,changes:e.append_cell(i,r)}}function a(t,n,r){var i=Notebook.Cell.create_model(t,n),s=Notebook.Cell.create_controller(i);return i.controller=s,{controller:s,changes:e.insert_cell(i,r)}}function f(n,r,i){if(!_.isUndefined(i.files)){this.clear();var s={};_.each(i.files,function(e){var t=e.filename;if(/^part/.test(t)){var n=parseInt(t.slice(4).split(".")[0]);n!==NaN&&(s[n]=[e.content,e.language,n])}});for(var o in s)u(s[o][0],s[o][1],s[o][2]);e.read_only(r!=null||i.user.login!=rcloud.username()),t=i}n&&n(i)}function l(e){var n=[],r=e.files,i=_.extend({},t.files);for(var s in r){if(s==="r_type"||s==="r_attributes")continue;s in i?((i[s].language!=r[s].language||i[s].content!=r[s].content)&&n.push({id:s,language:i[s].language,content:i[s].content}),delete i[s]):n.push({id:s,erase:!0,language:r[s].language})}for(s in i){if(s==="r_type"||s==="r_attributes")continue;n.push({id:s,language:i[s].language,content:i[s].content})}return n}function c(){n||(r&&ui_utils.enable_bs_button(r),n=!0),i&&window.clearTimeout(i),i=window.setTimeout(function(){p.save(),i=null},s)}function h(){o=ui_utils.checkbox_menu_item($("#show-source"),function(){p.show_r_source()},function(){p.hide_r_source()}),o.set_state(!0)}var t,n=!1,r=null,i=null,s=3e4,o=null;h(),e.dishers.push({on_dirty:c});var p={save_button:function(e){return arguments.length&&(r=e),r},append_cell:function(e,t,n){var r=u(e,t,n);return this.update_notebook(r.changes),r.controller},insert_cell:function(e,t,n){var r=a(e,t,n);return this.update_notebook(r.changes),r.controller},remove_cell:function(t){var n=e.remove_cell(t);shell.prompt_widget.focus(),this.update_notebook(n)},clear:function(){e.clear()},load_notebook:function(e,t,n){var r=this;rcloud.load_notebook(e,t||null,_.bind(f,this,n,t))},create_notebook:function(n,r){var i=this;rcloud.create_notebook(n,function(n){i.clear(),e.read_only(n.user.login!=rcloud.username()),t=n,r&&r(n)})},fork_or_revert_notebook:function(e,t,n,r){function s(e,t,n){var r=function(){i.load_notebook(t,null,n)};e.length?i.update_notebook(e,t,r):r()}var i=this;e?rcloud.load_notebook(t,null,function(e){var n=l(e);s(n,t,r)}):rcloud.fork_notebook(t,function(e){n?rcloud.get_notebook(e.id,null,function(e){var t=l(e);s(t,e.id,r)}):s([],e.id,r)})},update_notebook:function(n,r,i){function s(e){function n(e,n){var r={};n.content!==undefined&&(r.content=n.content);var i=Notebook.part_name(n.id,n.language);if(n.erase||!t[i])e[i]=null;if(!n.erase){var s=Notebook.part_name(n.rename||n.id,n.language);e[s]=r}return e}var t=_.reduce(e,function(e,t){if(!t.erase){var n=t.rename||t.id;e[Notebook.part_name(n,t.language)]=1}return e},{});return{files:_.reduce(e,n,{})}}n=n.filter(function(e){return!!e.content||e.erase});if(!n.length)return;if(e.read_only())throw"attempted to update read-only notebook";r=r||shell.gistname(),i=i||editor.load_callback(null,!0,!0);var o=function(e){if("error"in e){i(e);return}t=e,i(e)};n.length&&rcloud.update_notebook(r,s(n),o)},refresh_cells:function(){return e.reread_cells()},update_cell:function(t){this.update_notebook(e.update_cell(t))},save:function(){if(n){var e=this.refresh_cells();this.update_notebook(e),r&&ui_utils.disable_bs_button(r),n=!1}},run_all:function(t){function i(){--n,r.length&&r.shift()(),n===0&&t&&t()}this.save();var n=e.notebook.length,r;_.each(e.notebook,function(e){e.controller.set_status_message("Waiting...")}),r=_.map(e.notebook,function(e){return function(){e.controller.set_status_message("Computing...")}}),r.length?(r.shift()(),_.each(e.notebook,function(e){e.controller.execute(i)})):t&&t()},_r_source_visible:!0,hide_r_source:function(){this._r_source_visible=!1,o.set_state(this._r_source_visible),Notebook.hide_r_source()},show_r_source:function(){this._r_source_visible=!0,o.set_state(this._r_source_visible),Notebook.show_r_source()}};return e.controller=p,p},Notebook.hide_r_source=function(e){e?e=$(e).find(".r"):e=$(".r"),e.parent().hide()},Notebook.show_r_source=function(e){e?e=$(e).find(".r"):e=$(".r"),e.parent().show()},Notebook.part_name=function(e,t){if(_.isString(e))return e;var n;switch(t){case"R":n="R";break;case"Markdown":n="md";break;default:throw"Unknown language "+t}return"part"+e+"."+n};