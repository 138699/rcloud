// bare-bones d3 charting facilities
(function(){function e(e,t){return"translate("+e+","+t+")"}function t(e,t,n){var r=e.slice((n||t)+1||e.length);return e.length=t<0?e.length+t:t,e.push.apply(e,r)}function i(e,t){if(_.isUndefined(n[t])){var i=new Uint8Array(e.data().length);r[t]=i,n[t]=[e]}else n[t].push(e)}function o(e){return typeof e=="function"?e:function(e){return function(){return e}}(e)}Chart={};var n={},r={};Chart.get_selections=function(e){return r[this.group_id]},Chart.set_selections=function(e,t){for(var i=0;i<t.length;i++)r[e][i]=t[i];_.each(n[e],function(e){_.each(e.views,function(e){e.selection_changed()})})},Chart.data_model=function(e,t){var s=e.length,o={views:{},group_id:t,data:function(){return e},selection:function(){return r[this.group_id]},register_view:function(e){this.views[e._view_index]=e},deregister_view:function(e){delete this.views[e._view_index]},notify:function(){_.each(n[this.group_id],function(e){_.each(e.views,function(e){e.selection_changed()})})},clear_brushes:function(e){_.each(n[this.group_id],function(t){_.each(t.views,function(t){t._view_index!==e._view_index&&(console.log("clearing brush on view",t._view_index,t,e),t.clear_brush())})})}};return i(o,t),o};var s=0;Chart.scatterplot=function(t){function M(){var e=u.selection();N.attr("display",function(t){return e[t]?null:"none"})}function D(n){n.attr("d",d3.svg.symbol().type("circle")).attr("size",5).attr("transform",function(n){return n=a[n],e(v(t.x(n)),m(t.y(n)))}).style("stroke-width",function(e){return y.opts.stroke_width(a[e])})}function P(e){u.clear_brushes(y)}function H(e){var n=E.extent(),r=u.selection();T.each(function(e){var i=a[e],s=n[0][0]<=t.x(i)&&t.x(i)<=n[1][0]&&n[0][1]<=t.y(i)&&t.y(i)<=n[1][1];r[e]=s}),u.notify()}function B(){E.empty()&&M(T)}t=_.defaults(t,{width:400,height:400,padding:20,n_xticks:10,n_yticks:10,stroke:"white",stroke_width:"1.5px",fill:"black",stroke_opacity:1,fill_opacity:1}),t.stroke=o(t.stroke),t.stroke_opacity=o(t.stroke_opacity),t.stroke_width=o(t.stroke_width),t.fill=o(t.fill),t.fill_opacity=o(t.fill_opacity);var n=t.width,r=t.height,i=t.padding,u=t.data,a=u.data(),f=_.map(a,t.x),l=_.map(a,t.y),c=_.min(f),h=_.max(f),p=_.min(l),d=_.max(l),v=d3.scale.linear().domain([c,h]).range([0,n]),m=d3.scale.linear().domain([p,d]).range([r,0]),g=$("<div></div>")[0],y={_view_index:++s,opts:t,plot:g,clear_brush:function(){w.call(E.clear())},selection_changed:function(){M()},deleted:function(){u.deregister_view(this)}};u.register_view(y);var b=d3.select(g).append("svg").attr("width",n+2*i).attr("height",r+2*i),w=b.append("g").attr("transform",e(i,i)),E=d3.svg.brush().on("brushstart",P).on("brush",H).on("brushend",B);w.append("rect").attr("width",n).attr("height",r).attr("fill","#eee");var S=w.selectAll("g.x").data(v.ticks(t.n_xticks)).enter().append("g").attr("class","x");S.append("line").attr("x1",v).attr("x2",v).attr("y1",0).attr("y2",r),S.append("text").attr("x",v).attr("y",r+3).attr("dy",".71em").attr("text-anchor","middle").attr("class","rule-text").text(v.tickFormat(t.n_xticks));var x=w.selectAll("g.y").data(m.ticks(t.n_yticks)).enter().append("g").attr("class","x");x.append("line").attr("x1",0).attr("x2",n).attr("y1",m).attr("y2",m),x.append("text").attr("x",-3).attr("y",m).attr("dy",".35em").attr("text-anchor","end").attr("class","rule-text").text(m.tickFormat(t.n_yticks));var T=w.selectAll("path.dot").data(_.range(a.length)).enter().append("path"),N=w.selectAll("pathasdkf.dot").data(_.range(a.length)).enter().append("path"),C=function(e){return a[e]};T.style("fill",_.compose(t.fill,C)).style("stroke",_.compose(t.stroke,C)).style("fill-opacity",_.compose(t.fill_opacity,C)).style("stroke-opacity",_.compose(t.stroke_opacity,C)),w.call(E.x(v).y(m));var k=function(){return"red"},L=function(){return"red"},A=function(){return 1},O=function(){return 1};return N.style("fill",_.compose(k,C)).style("stroke",_.compose(L,C)).style("fill-opacity",_.compose(A,C)).style("stroke-opacity",_.compose(O,C)),b.on("keydown",function(e){console.log(e)}),D(T),D(N),M(),y},Chart.histogram=function(e){e=_.defaults(e,{width:400,height:400,padding:20,n_bins:10,stroke:"white",stroke_width:"1.5px",fill:"black",stroke_opacity:1,fill_opacity:1}),e.stroke=o(e.stroke),e.stroke_opacity=o(e.stroke_opacity),e.stroke_width=o(e.stroke_width),e.fill=o(e.fill),e.fill_opacity=o(e.fill_opacity);var t=e.width,n=e.height,r=e.padding,i=e.data,u=i.data(),a=_.map(u,e.x),f=_.min(a),l=_.max(a),c=$("<div></div>")[0],h=d3.scale.linear().domain([f,l]).range([0,t]),p=d3.layout.histogram().range([f,l]).bins(e.n_bins),d=p(e.x),v={_view_index:++s,opts:e,plot:c,clear_brush:function(){vis.call(brush.clear())},selection_changed:function(){update_selection()},deleted:function(){i.deregister_view(this)}}}})(),LuxChart={},LuxChart.lux_tour_plot=function(e){function a(){var t={},n=[];for(var r=0;r<e.length;++r)t["dim_"+r]=Lux.attribute_buffer({vertex_array:new Float32Array(e[r]),item_size:1,keep_array:!0}),n.push("dim_"+r);return t.columns=n,t}function f(){Lux.set_context(c),s=a();var e=10,t=2.5,n=1;o=[],u=[];var r,i,f=[],l=Shade.vec(0,0),h=Shade.vec(0,0),p=Shade.vec(0,0);for(var d=0;d<s.columns.length;++d){var v=s[s.columns[d]];o.push(Shade.parameter("float")),u.push(Shade.parameter("float"));var m=Shade.vec(o[d],u[d]);r=_.min(v.array),i=_.max(v.array),f=(i+r)/2,l=l.add(m.mul(v)),h=h.add(m.mul(f)),p=p.add(m.mul(f-r).abs())}Lux.Scene.add(Lux.Marks.scatterplot({elements:s[s.columns[0]].numItems,xy:l,xy_scale:Shade.Scale.linear({domain:[h.sub(p),h.add(p)],range:[Shade.vec(0,0),Shade.vec(1,1)]}),fill_color:Shade.color("red"),stroke_color:Shade.mix(Shade.color("black"),Shade.color("red"),.5),stroke_width:t,point_diameter:e}))}function l(e){var t=[],n=[],r=0,i=0;for(var s=0;s<e;++s)t[s]=Math.random()*2-1,n[s]=Math.random()*2-1,r+=t[s]*t[s],i+=n[s]*n[s];r=Math.sqrt(r),i=Math.sqrt(i);if(r===0||i===0)return l(e);var o=0;for(s=0;s<e;++s)t[s]/=r,n[s]/=i,o+=t[s]*n[s];var u=0;for(s=0;s<e;++s)n[s]=n[s]-o*t[s],u+=n[s]*n[s];u=Math.sqrt(u);if(u===0)return l(e);for(s=0;s<e;++s)n[s]/=u;return[t,n]}var t=600,n=600,r=$("<canvas></canvas>")[0];r.width=t,r.height=n;var i,s,o,u,c=Lux.init({canvas:r,clearColor:[1,1,1,1]});f();var h=l(s.columns.length),p=l(s.columns.length),d=(new Date).getTime(),v=1;return Lux.Scene.animate(function(){var e=((new Date).getTime()-d)/1e3,t=e/3;t-=Math.floor(t),t<v&&(h=p,p=l(4)),v=t;for(var n=0;n<s.columns.length;++n)o[n].set(t*p[0][n]+(1-t)*h[0][n]),u[n].set(t*p[1][n]+(1-t)*h[1][n])}),r},LuxChart.lux_osm_plot=function(e,t,n,r,i){var s=$("<canvas></canvas>")[0];s.width=r,s.height=i;var o=Lux.init({canvas:s,clearColor:[1,1,1,1],mousedown:function(e){var t=f.mousedown(e);return t},mousemove:function(e){var t=f.mousemove(e);return t},mouseup:function(e){var t=f.mouseup(e);return t}}),u=Shade.parameter("float",3),a=Shade.Camera.perspective({look_at:[Shade.vec(0,0,6),Shade.vec(0,0,-1),Shade.vec(0,1,0)],field_of_view_y:Shade.div(20,u)}),f=Lux.Marks.globe({view_proj:a,zoom:u});return Lux.Scene.add(f),s},function(){function e(e){return e==null?"NULL":'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}function t(){this.name="NoCallbackError"}function n(){throw new t}t.prototype=Object.create(Error),t.prototype.constructor=t,RClient={create:function(r){function i(){d.running=!0,d.send("rcloud.support::session.init(username="+e(rcloud.username())+",token="+e(rcloud.github_token())+")"),r.on_connect&&r.on_connect.call(d)}function s(){$("#input-div").hide()}function o(e,t){t===65?d.post_error("Authentication failed. Login first!"):d.post_error(e),s()}function u(e){d.post_error("Socket was closed. Goodbye!"),s()}var a=$.cookies.get().token,f=$.cookies.get().execToken,l=Rserve.create({host:r.host,on_connect:i,on_error:o,on_close:u,login:a+"\n"+f}),c=r.debug||!1,h=!1,p=undefined,d;return d={handlers:{eval:function(e){return d.post_response(e),e},"markdown.eval":function(e){return d.display_markdown_response(e),e},browsePath:function(e){$.ajax({url:"http://127.0.0.1:8080"+e}).done(function(e){var t=/[\s\S]*<body>([\s\S]*)<\/body>/g.exec(e)[1];$("#help-output").html(t)})},"dev.new":function(e){return""},"dev.close":function(e){return""},internal_cmd:function(e){return""},"boot.failure":function(e){d.running=!1}},running:!1,eval:function(e){var t=this;if(e.type!=="sexp")return this.post_error("Bad protocol, should always be sexp.");e=e.value;if(e.type==="string_array")return this.post_error(e.value[0]);if(e.type==="null")return null;if(e.type!=="vector")return this.post_error("Protocol error, unexpected value of type "+e.type);if(e.value[0].type!=="string_array"||e.value[0].value.length!==1)return console.log("Protocol error?! ",e.value[0]),undefined;var n=e.value[0].value[0],r=this.handlers;return r[n]===undefined?this.post_error("Unknown command "+n):r[n].call(this,e.json()[1])},register_handler:function(e,t){this.handlers[e]=t},post_div:function(e){return shell.post_div(e)},display_markdown_response:function(e){e&&($("#output").append($("<div></div>").html(e.value[0])).find("pre code").each(function(e,t){hljs.highlightBlock(t)}),MathJax.Hub.Queue(["Typeset",MathJax.Hub]))},post_error:function(e){var t=$("<div class='alert alert-error'></div>").text(e);$("#output").append(t),window.scrollTo(0,document.body.scrollHeight)},post_response:function(e){var t=$("<pre></pre>").html(e);$("#output").append(t),window.scrollTo(0,document.body.scrollHeight)},capture_answers:function(e,t){function r(r){n.push(r),e--,e===0&&(h=!1,p=undefined,t(n))}if(h)throw"Still waiting for previous answers...";h=!0;var n=[];p=r},wrap_command:function(e,t){return t===undefined&&(t=!1),"rcloud.support::session.eval({"+e+"}, "+(t?"TRUE":"FALSE")+")"},markdown_wrap_command:function(t,n){return"rcloud.support::session.markdown.eval({markdownToHTML(text=paste(knit(text="+e(t+"\n")+'), collapse="\\n"), fragment=TRUE)}, '+(n?"TRUE":"FALSE")+")"},log:function(e){e='rcloud.support::session.log("'+rcloud.username()+'", "'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'")',this.send(e)},record_cell_execution:function(e){var t=JSON.stringify(e.json()),n=this.r_funcall("rcloud.record.cell.execution",rcloud.username(),t);l.eval(n)},send:function(e,t){this.send_and_callback(e,n,t)},send_and_callback:function(e,r,i){function u(e){e=e.value.json();if(c){debugger;console.log(e)}try{r(e[1])}catch(n){if(n.constructor!==t)throw n;s.handlers[e[0]](e[1])}}var s=this;_.isUndefined(r)&&(r=n);var o;i?e=i(e):e=this.wrap_command(e,!0),c&&console.log(e),l.eval(e,u)},r_funcall:function(t){function n(t,n){var r=typeof n;if(r==="string")t.push(e(n));else{if(r!="number")throw"unsupported r_funcall argument type "+r;t.push(String(n))}}var r=[t,"("];for(var i=1;i<arguments.length;++i){var s=arguments[i];if($.isArray(s)){r.push("c(");for(var o=0;o<s.length;++o)n(r,s[o]),o<s.length-1&&r.push(",");r.push(")")}else n(r,s);i<arguments.length-1&&r.push(",")}r.push(")");var u=r.join("");return u}},d}}}(),rcloud={},rcloud.init_client_side_data=function(){var e=this;rclient.send_and_callback("rcloud.prefix.uuid()",function(t){e.wplot_uuid=t})},rcloud.username=function(){return $.cookies.get("user")},rcloud.github_token=function(){return $.cookies.get("token")},rcloud.search=function(e,t){var n=this;_.isUndefined(t)&&(t=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.search",e),t)},rcloud.load_user_config=function(e,t){_.isUndefined(t)&&(t=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.load.user.config",e),function(e){t&&t(JSON.parse(e))})},rcloud.load_multiple_user_configs=function(e,t){rclient.send_and_callback(rclient.r_funcall("rcloud.load.multiple.user.configs",e),function(e){t&&t(JSON.parse(e))})},rcloud.save_user_config=function(e,t,n){_.isUndefined(n)&&(n=_.identity),rclient.send_and_callback(rclient.r_funcall("rcloud.save.user.config",e,JSON.stringify(t)),function(e){n&&n(JSON.parse(e))})},rcloud.load_notebook=function(e,t){rclient.send_and_callback(rclient.r_funcall("rcloud.get.notebook",e),function(e){t&&t(JSON.parse(e))})},rcloud.update_notebook=function(e,t,n){rclient.send_and_callback(rclient.r_funcall("rcloud.update.notebook",e,JSON.stringify(t)),function(e){n&&n(JSON.parse(e))})},rcloud.create_notebook=function(e,t){rclient.send_and_callback(rclient.r_funcall("rcloud.create.notebook",JSON.stringify(e)),function(e){t&&t(JSON.parse(e))})},rcloud.resolve_deferred_result=function(e,t){var n=rclient.r_funcall("rcloud.fetch.deferred.result",e);rclient.send_and_callback(n,t)},rcloud.get_users=function(e){rclient.send_and_callback(rclient.r_funcall("rcloud.get.users"),function(t){e&&e(t)})},Notebook={},Notebook.Cell={},function(){function e(e,t){return $("<span class='fontawesome-button'><i class='"+e+"'></i></span>").tooltip({title:t,delay:{show:250,hide:0}})}function t(t){function a(){return t.content(E.getSession().getValue())}function f(e){e.removeClass("button-disabled")}function l(e){e.addClass("button-disabled")}function c(){N.html("Computing...");var e=a();L.show_result(),e&&t.parent_model.controller.update_cell(t),t.controller.execute()}var n=$("<div class='notebook-cell'></div>"),r=e("icon-edit","source"),i=e("icon-picture","result"),s=e("icon-resize-small","hide"),o=e("icon-trash","remove"),u=e("icon-repeat","run");r.click(function(e){$(e.currentTarget).hasClass("button-disabled")||L.show_source()}),i.click(function(e){$(e.currentTarget).hasClass("button-disabled")||L.show_result()}),s.click(function(e){$(e.currentTarget).hasClass("button-disabled")||L.hide_all()}),o.click(function(e){$(e.currentTarget).hasClass("button-disabled")||(t.parent_model.controller.remove_cell(t),$(".tooltip").remove())}),u.click(function(e){c()});var h=$("<div style='position:relative; float: right; z-index:10000'></div>"),p=$("<div style='margin:0.5em;'></div>"),d=$("<div style='margin:0.5em;'></div>");p.append(r),p.append(i),p.append(s),p.append(o),h.append(p),d.append(u),d.hide(),h.append(d),n.append(h);var v=$("<div></div>"),m=$("<div style='clear:both;'></div>");n.append(v),n.append(m);var g=$('<div style="position: relative; width:100%; height:100%"></div>'),y=$('<div style="position: absolute; right:-0.5em; top:-0.5em"></div>'),b=e("icon-plus-sign","insert cell");v.append(y),y.append(b),b.click(function(e){shell.insert_markdown_cell_before(t.id)});var w=$('<div style="width:100%; height:100%"></div>');v.append(g),g.append(w);var E=ace.edit(w[0]),S=require("mode/rmarkdown").Mode,x=E.getSession(),T=x.doc;E.getSession().setMode(new S(!1,T,x)),E.setTheme("ace/theme/chrome"),E.getSession().setUseWrapMode(!0),E.resize(),E.commands.addCommand({name:"sendToR",bindKey:{win:"Ctrl-Return",mac:"Command-Return",sender:"editor"},exec:function(e,t,n){c()}});var N=$('<div class="r-result-div"><span style="opacity:0.5">Not evaluated</span></div>');v.append(N);var C=$("<span></span>");v.append(C);var k,L={content_updated:function(){return E.getSession().setValue(t.content())},self_removed:function(){n.remove()},result_updated:function(e){N.hide(),N.html(e),N.slideDown(150);var t=rcloud.wplot_uuid;v.find("pre code").contents().filter(function(){return this.nodeValue.indexOf(t)!==-1}).parent().parent().each(function(){var e=this.childNodes[0].childNodes[0].data.substr(8,73).split("|"),t=this;rcloud.resolve_deferred_result(e[1],function(e){$(t).replaceWith(function(){return shell.handle(e[0],e)})})}),v.find("pre code").each(function(e,t){hljs.highlightBlock(t)}),_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub]),this.show_result(),C[0].scrollIntoView()},hide_buttons:function(){h.css("display","none"),y.css("display","none")},show_buttons:function(){h.css("display",null),y.css("display",null)},show_source:function(){n.css({height:"70%"}),l(r),f(i),f(s),f(o),d.show(),g.show(),N.hide(),E.resize(),E.focus(),k="source"},show_result:function(){n.css({height:""}),f(r),l(i),f(s),f(o),d.hide(),g.hide(),N.slideDown(150,function(){C[0].scrollIntoView()}),k="result"},hide_all:function(){n.css({height:""}),f(r),f(i),l(s),f(o),d.hide(),k==="result"?N.slideUp(150):g.slideUp(150)},div:function(){return n},update_model:function(){return a()},focus:function(){E.focus()},get_content:function(){return t.content()}};return L.show_result(),L.content_updated(),L}function n(t){function u(){return t.content($(w).val())}function a(e){e.removeClass("button-disabled")}function f(e){e.addClass("button-disabled")}function l(){E.html("Computing...");var e=u();T.show_result(),e&&t.parent_model.controller.update_cell(t),t.controller.execute()}var n=$("<div class='notebook-cell'></div>"),r=$("<span class='fontawesome-button'><i class='icon-edit'></i></span>").tooltip({title:"source"}),i=$("<span class='fontawesome-button'><i class='icon-picture'></i></span>").tooltip({title:"result"}),s=$("<span class='fontawesome-button'><i class='icon-resize-small'></i></span>").tooltip({title:"hide"}),o=$("<span class='fontawesome-button'><i class='icon-trash'></i></span>").tooltip({title:"remove"});r.click(function(e){$(e.currentTarget).hasClass("button-disabled")||T.show_source()}),i.click(function(e){$(e.currentTarget).hasClass("button-disabled")||T.show_result()}),s.click(function(e){$(e.currentTarget).hasClass("button-disabled")||T.hide_all()}),o.click(function(e){$(e.currentTarget).hasClass("button-disabled")||(t.parent_model.controller.remove_cell(t),$(".tooltip").remove())});var c=$("<div style='position:relative; float: right; z-index:10000'></div>"),h=$("<div style='margin:0.5em;'></div>"),p=$("<div style='margin:0.5em;'></div>");h.append(r),h.append(i),h.append(s),h.append(o),c.append(h),p.hide(),c.append(p),n.append(c);var d=$("<div></div>"),v=$("<div style='clear:both;'></div>");n.append(d),n.append(v);var m=$('<div style="position: relative; width:100%;"></div>'),g=$('<div style="position: absolute; right:-0.5em; top:-0.5em"></div>'),y=e("icon-plus-sign","insert cell");d.append(g),g.append(y),y.click(function(e){shell.insert_markdown_cell_before(t.id)});var b=$('<div style="width:100%; margin-left: 0.5em; margin-top: 0.5em"></div>');d.append(m),m.append(b);var w=$('<input type="text" style="width:88%"/>');b.append(w),w.keypress(function(e){return e.which===13?(l(),e.preventDefault(),!1):!0});var E=$('<div class="r-result-div"></div>');d.append(E);var S=$("<span></span>");d.append(S);var x,T={content_updated:function(){w.val(t.content())},self_removed:function(){n.remove()},result_updated:function(e){E.hide(),E.html(e),E.slideDown(150);var t=rcloud.wplot_uuid;d.find("pre code").contents().filter(function(){return this.nodeValue.indexOf(t)!==-1}).parent().parent().each(function(){var e=this.childNodes[0].childNodes[0].data.substr(8,73).split("|"),t=this;rcloud.resolve_deferred_result(e[1],function(e){$(t).replaceWith(function(){return shell.handle(e[0],e)})})}),d.find("pre code").each(function(e,t){hljs.highlightBlock(t)}),_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub]),this.show_result(),S[0].scrollIntoView()},hide_buttons:function(){c.css("display","none"),g.css("display","none")},show_buttons:function(){c.css("display",null),g.css("display",null)},show_source:function(){n.css({height:""}),f(r),a(i),a(s),a(o),p.show(),m.show(),E.hide(),w.focus(),x="source"},show_result:function(){n.css({height:""}),a(r),f(i),a(s),a(o),p.hide(),m.hide(),E.slideDown(150,function(){S[0].scrollIntoView()}),x="result"},hide_all:function(){n.css({height:""}),a(r),a(i),f(s),a(o),p.hide(),x==="result"?E.slideUp(150):m.slideUp(150)},div:function(){return n},update_model:function(){return u()},focus:function(){w.focus()},get_content:function(){return t.content()}};return T.show_result(),T.content_updated(),T}var r={Markdown:t,R:t};Notebook.Cell.create_html_view=function(e){return r[e.language()](e)}}(),Notebook.Cell.create_model=function(e,t){function r(){_.each(n.views,function(e){e.content_updated()})}var n={views:[],id:-1,language:function(){return t},content:function(t){return _.isUndefined(t)?e:e!=t?(e=t,r(),e):null},json:function(){return{content:e,language:t}}};return n},Notebook.Cell.create_controller=function(e){var t={execute:function(){function r(t){_.each(e.views,function(e){e.result_updated(t)})}var t=this,n=e.language();rclient.record_cell_execution(e);if(n==="Markdown"){var i=rclient.markdown_wrap_command(e.content());rclient.send_and_callback(i,r,_.identity)}else if(n==="R"){var i=rclient.markdown_wrap_command("```{r}\n"+e.content()+"\n```\n");rclient.send_and_callback(i,r,_.identity)}else alert("Don't know language '"+n+"' - can only do Markdown or R for now!")}};return t},Notebook.create_html_view=function(e,t){var n={model:e,sub_views:[],cell_appended:function(e){var n=Notebook.Cell.create_html_view(e);return e.views.push(n),t.append(n.div()),this.sub_views.push(n),n},cell_inserted:function(e,n){var r=Notebook.Cell.create_html_view(e);return e.views.push(r),t.append(r.div()),$(r.div()).insertBefore(t.children(".notebook-cell")[n]),this.sub_views.splice(n,0,r),r.show_source(),r},cell_removed:function(e,t){_.each(e.views,function(e){e.self_removed()}),this.sub_views.splice(t,1)},update_model:function(){return _.map(this.sub_views,function(e){return e.update_model()})}};return e.views.push(n),n},Notebook.create_model=function(){function e(e){return e.length?e[e.length-1].id:0}return{notebook:[],views:[],clear:function(){return this.remove_cell(null,e(this.notebook))},append_cell:function(t,n){t.parent_model=this;var r=[],i=1;n=n||1,n=Math.max(n,e(this.notebook)+1);while(i)r.push([n,{content:t.content(),language:t.language()}]),t.id=n,this.notebook.push(t),_.each(this.views,function(e){e.cell_appended(t)}),++n,--i;return r},insert_cell:function(e,t){var n=this;e.parent_model=this;var r=[],i=1,s=0;while(s<this.notebook.length&&this.notebook[s].id<t)++s;if(s<this.notebook.length&&t+i>this.notebook[s].id){var o=s>0?this.notebook[s-1].id:0;t=Math.max(this.notebook[s].id-i,o+1)}for(var u=0;u<i;++u)r.push([t+u,{content:e.content(),language:e.language()}]),e.id=t+u,this.notebook.splice(s,0,e),_.each(this.views,function(e){e.cell_inserted(n.notebook[s],s)}),++s;while(s<this.notebook.length&&i){if(this.notebook[s].id>t){var a=this.notebook[s].id-t;i-=a,t+=a}if(i<=0)break;r.push([this.notebook[s].id,{content:this.notebook[s].content(),rename:this.notebook[s].id+i,language:this.notebook[s].language()}]),this.notebook[s].id+=i,++s,++t}return r},remove_cell:function(e,t){var n=this,r,i;if(e!=null){r=this.notebook.indexOf(e),i=e.id;if(r===-1)throw"cell_model not in notebook model?!"}else r=0,i=1;var t=t||1,s=r,o=[];while(s<this.notebook.length&&t)this.notebook[s].id==i&&(_.each(this.views,function(e){e.cell_removed(n.notebook[s],s)}),o.push([i,{erase:1,language:n.notebook[s].language()}]),this.notebook.splice(s,1)),++i,--t;return o},update_cell:function(e){return[[e.id,{content:e.content(),language:e.language()}]]},reread_cells:function(){var e=this,t=_.map(this.views,function(e){return e.update_model()});if(t.length!=1)throw"not expecting more than one notebook view";return _.reduce(t[0],function(t,n,r){return n&&t.push([e.notebook[r].id,{content:n,language:e.notebook[r].language()}]),t},[])},json:function(){return _.map(this.notebook,function(e){return e.json()})}}},Notebook.create_controller=function(e){function t(t,n,r){var i=Notebook.Cell.create_model(t,n),s=Notebook.Cell.create_controller(i);return i.controller=s,[s,e.append_cell(i,r)]}function n(t,n,r){var i=Notebook.Cell.create_model(t,n),s=Notebook.Cell.create_controller(i);return i.controller=s,[s,e.insert_cell(i,r)]}var r={append_cell:function(e,n,r){var i=t(e,n,r);return this.update_notebook(i[1]),i[0]},insert_cell:function(e,t,r){var i=n(e,t,r);return this.update_notebook(i[1]),i[0]},remove_cell:function(t){var n=e.remove_cell(t);this.update_notebook(n)},clear:function(){e.clear()},load_notebook:function(e,n){var r=this;rcloud.load_notebook(e,function(e){r.clear();var i={};_.each(e.files,function(e){var t=e.filename;if(/^part/.test(t)){var n=parseInt(t.slice(4).split(".")[0]);n!==NaN&&(i[n]=[e.content,e.language,n])}});for(var s in i)t(i[s][0],i[s][1],i[s][2]);n&&n(e)})},create_notebook:function(e,t){var n=this;rcloud.create_notebook(e,function(e){n.clear(),t&&t(e)})},update_notebook:function(e){function t(e,t){var n;switch(t){case"R":n="R";break;case"Markdown":n="md";break;default:throw"Unknown language "+t}return"part"+e+"."+n}function n(e){function r(e,r){var i={};r[1].content!==undefined&&(i.content=r[1].content);var s=t(r[0],r[1].language);if(r[1].erase||!n[s])e[s]=null;var o=t(r[1].rename||r[0],r[1].language);return r[1].erase||(e[o]=i),e}var n=_.reduce(e,function(e,n){if(!n[1].erase){var r=n[1].rename||n[0];e[t(r,n[1].language)]=1}return e},{});return{files:_.reduce(e,r,{})}}if(!e.length)return;rcloud.update_notebook(shell.gistname,n(e),_.bind(editor.notebook_loaded,editor))},refresh_cells:function(){return e.reread_cells()},update_cell:function(t){this.update_notebook(e.update_cell(t))},run_all:function(){var t=this.refresh_cells();this.update_notebook(t),_.each(e.notebook,function(e){e.controller.execute()})}};return e.controller=r,r};