RCloud={version:"2.0.6",is_exception:function(e){return _.isObject(e)&&e.r_attributes&&"OCAP-eval-error"===e.r_attributes.class},exception_message:function(e){if(!RCloud.is_exception(e))throw new Error("Not an R exception value");var t=e.traceback?e.traceback:"";return t.join&&(t=t.join("\n")),e.error+"R trace:\n"+t}},RCloud.promisify_paths=function(r,e,t){var i=t?"":"Async";return _.each(e,function(e){var t=function(e){for(var t=r,o=0;o<e.length;++o)t=t[e[o]];return t}(e);!function(e,t){for(var o=r,n=0;n<e.length-1;++n)o=o[e[n]];o[e[e.length-1]+i]=t}(e,t?function(t,e){function o(e){if(e&&RCloud.is_exception(e))throw new Error(t+": "+RCloud.exception_message(e));return e}return function(){return e.apply(this,arguments).then(o)}}(e.join("."),Promise.promisify(t)):null)}),r},RCloud.create=function(rcloud_ocaps){function rcloud_github_handler(o,e){return e.then(function(e){if(e.ok)return e.content;var t;throw t=e.content&&e.content.message?e.content.message+" ("+e.code+")":"error code "+e.code,new Error(o+": "+t)})}var rcloud={};function setup_unauthenticated_ocaps(){var paths=[["version_info"],["anonymous_session_init"],["anonymous_compute_init"],["has_compute_separation"],["signal_to_compute"],["prefix_uuid"],["get_conf_value"],["get_conf_values"],["get_gist_sources"],["get_notebook"],["load_notebook"],["load_notebook_compute"],["call_notebook"],["install_notebook_stylesheets"],["get_version_by_tag"],["get_tag_by_version"],["get_users"],["log","record_cell_execution"],["setup_js_installer"],["replace_token"],["comments","get_all"],["help"],["debug","raise"],["stars","star_notebook"],["stars","unstar_notebook"],["stars","is_notebook_starred"],["stars","get_notebook_star_count"],["stars","get_notebook_starrer_list"],["stars","get_multiple_notebook_star_counts"],["stars","get_my_starred_notebooks"],["discovery","get_notebooks"],["discovery","get_thumb"],["session_cell_eval"],["reset_session"],["set_device_pixel_ratio"],["api","enable_echo"],["api","disable_echo"],["api","enable_warnings"],["api","disable_warnings"],["api","set_url"],["api","get_url"],["notebook_by_name"],["get_notebook_info"],["get_multiple_notebook_infos"],["languages","get_list"],["plots","render"],["plots","get_formats"],["get_fork_count"],["get_multiple_fork_counts"]],cached_device_pixel_ratio;RCloud.promisify_paths(rcloud_ocaps,paths),rcloud.get_fork_count=rcloud_ocaps.get_fork_countAsync,rcloud.get_multiple_fork_counts=rcloud_ocaps.get_multiple_fork_countsAsync,rcloud.username=function(){return $.cookies.get("user")},rcloud.github_token=function(){return $.cookies.get("token")},rcloud.version_info=function(){return rcloud_ocaps.version_infoAsync.apply(null,arguments)},rcloud.anonymous_session_init=function(){return rcloud_ocaps.anonymous_session_initAsync()},rcloud.anonymous_compute_init=function(){return rcloud_ocaps.anonymous_compute_initAsync()},rcloud.init_client_side_data=function(){var o=this;return Promise.all([rcloud_ocaps.prefix_uuidAsync(),rcloud_ocaps.has_compute_separationAsync()]).spread(function(e,t){o.deferred_knitr_uuid=e,o.has_compute_separation=t})},rcloud.signal_to_compute=function(e){return rcloud_ocaps.signal_to_computeAsync(e)},rcloud.get_conf_value=function(e,t){return rcloud_ocaps.get_conf_valueAsync(e,t)},rcloud.get_conf_values=function(e){return rcloud_ocaps.get_conf_valuesAsync(e)},rcloud.get_gist_sources=function(){return rcloud_ocaps.get_gist_sourcesAsync()},rcloud.get_notebook=function(e,t,o,n){return void 0===o&&(o=null),void 0===n&&(n=!1),rcloud_github_handler("rcloud.get.notebook "+e,rcloud_ocaps.get_notebookAsync(e,t,o,n))},rcloud.load_notebook=function(e,t){return Promise.all([rcloud_github_handler("rcloud.load.notebook.compute "+e,rcloud_ocaps.load_notebook_computeAsync(e,t)),rcloud_github_handler("rcloud.load.notebook "+e,rcloud_ocaps.load_notebookAsync(e,t))]).spread(function(e,t){return t})},rcloud.refresh_compute_notebook=function(e){return rcloud_github_handler("rcloud.load.notebook.compute (refresh) "+e,rcloud_ocaps.load_notebook_computeAsync(e,null,null,!1))},rcloud.get_version_by_tag=function(e,t){return rcloud_ocaps.get_version_by_tagAsync(e,t)},rcloud.get_tag_by_version=function(e,t){return rcloud_ocaps.get_tag_by_versionAsync(e,t)},rcloud.call_notebook=function(e,t){return rcloud_github_handler("rcloud.call.notebook "+e,rcloud_ocaps.call_notebookAsync(e,t))},rcloud.install_notebook_stylesheets=function(){return rcloud_ocaps.install_notebook_stylesheetsAsync()},rcloud.help=function(t){return rcloud_ocaps.helpAsync(t).then(function(e){e||RCloud.UI.help_frame.display_content("<h2>No help found for <em>"+t+"</em></h2>")})},rcloud.get_users=function(){return rcloud_ocaps.get_usersAsync()},rcloud.record_cell_execution=function(e){return rcloud_ocaps.log.record_cell_executionAsync(rcloud.username(),e)},rcloud.setup_js_installer=function(e){return rcloud_ocaps.setup_js_installerAsync(e)},rcloud.modules={},rcloud.setup_js_installer({install_js:function(name,content,k){try{var result=eval(content);rcloud.modules[name]=result,k(null,result)}catch(e){Promise.reject(e);var v={type:e.name,message:e.message};k(v,null)}},clear_css:function(e,t){$(".rcloud-user-defined-css").remove(),t(null,null)},install_css:function(e,t){_.isString(e)?e=[e]:_.isArray(e)||(e=[]),_.each(e,function(e){$("head").append($('<link type="text/css" rel="stylesheet" class="rcloud-user-defined-css" href="'+e+'"/>'))}),t(null,null)}}),rcloud.replace_token=function(e,t){return rcloud_ocaps.replace_tokenAsync(e,t)},rcloud.get_all_comments=function(e){return rcloud_ocaps.comments.get_allAsync(e)},rcloud.debug={},rcloud.debug.raise=function(e){return rcloud_ocaps.debug.raiseAsync(e)},rcloud.stars={},rcloud.stars.is_notebook_starred=function(e){return rcloud_ocaps.stars.is_notebook_starredAsync(e)},rcloud.stars.get_notebook_star_count=function(e){return rcloud_ocaps.stars.get_notebook_star_countAsync(e)},rcloud.stars.get_notebook_starrer_list=function(e){return rcloud_ocaps.stars.get_notebook_starrer_listAsync(e)},rcloud.stars.get_multiple_notebook_star_counts=function(e){return rcloud_ocaps.stars.get_multiple_notebook_star_countsAsync(e)},rcloud.discovery={get_notebooks:rcloud_ocaps.discovery.get_notebooksAsync,get_thumb:rcloud_ocaps.discovery.get_thumbAsync},rcloud.session_cell_eval=function(e,t,o,n,r){return rcloud_ocaps.session_cell_evalAsync(e,t,o,n,r)},rcloud.reset_session=function(){return rcloud_ocaps.reset_sessionAsync()},rcloud.display={},rcloud.display.set_device_pixel_ratio=function(){return cached_device_pixel_ratio=window.devicePixelRatio,rcloud_ocaps.set_device_pixel_ratioAsync(window.devicePixelRatio)},rcloud.display.get_device_pixel_ratio=function(){return cached_device_pixel_ratio},rcloud.get_notebook_by_name=function(e,t){return rcloud_ocaps.notebook_by_nameAsync(e,t)},rcloud.get_notebook_info=rcloud_ocaps.get_notebook_infoAsync,rcloud.get_multiple_notebook_infos=rcloud_ocaps.get_multiple_notebook_infosAsync,rcloud.api={},rcloud.api.disable_warnings=function(){return rcloud_ocaps.api.disable_warningsAsync()},rcloud.api.enable_warnings=function(){return rcloud_ocaps.api.enable_warningsAsync()},rcloud.api.disable_echo=function(){return rcloud_ocaps.api.disable_echoAsync()},rcloud.api.enable_echo=function(){return rcloud_ocaps.api.enable_echoAsync()},rcloud.api.set_url=function(e){return rcloud_ocaps.api.set_urlAsync(e)},rcloud.api.get_url=function(){return rcloud_ocaps.api.get_urlAsync()},rcloud.languages={},rcloud.languages.get_list=function(){return rcloud_ocaps.languages.get_listAsync()},rcloud.plots={},rcloud.plots.render=function(e,t,o){return rcloud_ocaps.plots.renderAsync(e,t,o)},rcloud.plots.get_formats=function(){return rcloud_ocaps.plots.get_formatsAsync()}}function setup_authenticated_ocaps(){RCloud.promisify_paths(rcloud_ocaps,[["session_init"],["compute_init"],["search"],["search_description"],["update_notebook"],["create_notebook"],["fork_notebook"],["port_notebooks"],["purl_source"],["get_completions"],["rename_notebook"],["authenticated_cell_eval"],["session_markdown_eval"],["notebook_upload"],["tag_notebook_version"],["file_upload","upload_path"],["file_upload","create"],["file_upload","write"],["file_upload","close"],["comments","post"],["comments","modify"],["comments","delete"],["is_notebook_published"],["publish_notebook"],["unpublish_notebook"],["set_notebook_visibility"],["protection","get_notebook_cryptgroup"],["protection","set_notebook_cryptgroup"],["protection","get_cryptgroup_users"],["protection","get_user_cryptgroups"],["protection","create_cryptgroup"],["protection","set_cryptgroup_name"],["protection","add_cryptgroup_user"],["protection","remove_cryptgroup_user"],["protection","delete_cryptgroup"],["protection","has_notebook_protection"],["api","disable_warnings"],["api","enable_echo"],["api","disable_warnings"],["api","enable_echo"],["config","all_notebooks"],["config","all_user_notebooks"],["config","all_notebooks_multiple_users"],["config","get_all_notebook_info"],["config","add_notebook"],["config","remove_notebook"],["config","get_current_notebook"],["config","set_current_notebook"],["config","new_notebook_number"],["config","get_recent_notebooks"],["config","set_recent_notebook"],["config","clear_recent_notebook"],["config","get_user_option"],["config","set_user_option"],["config","get_alluser_option"],["set_notebook_info"],["get_notebook_property"],["set_notebook_property"],["remove_notebook_property"]]),rcloud.session_init=function(e,t){return rcloud_ocaps.session_initAsync(e,t)},rcloud.compute_init=function(e,t){return rcloud_ocaps.compute_initAsync(e,t)},rcloud.update_notebook=function(e,t,o){return void 0===o&&(o=!0),rcloud_github_handler("rcloud.update.notebook",rcloud_ocaps.update_notebookAsync(e,t,o))},rcloud.search=rcloud_ocaps.searchAsync,rcloud.search_description=rcloud_ocaps.search_descriptionAsync,rcloud.create_notebook=function(e,t){return void 0===t&&(t=!0),rcloud_github_handler("rcloud.create.notebook",rcloud_ocaps.create_notebookAsync(e,t)).then(function(e){return t&&rcloud_ocaps.load_notebook_computeAsync(e.id),e})},rcloud.fork_notebook=function(e){return rcloud_github_handler("rcloud.fork.notebook",rcloud_ocaps.fork_notebookAsync(e))},rcloud.port_notebooks=function(e,t,o){return rcloud_ocaps.port_notebooksAsync(e,t,o)},rcloud.purl_source=function(e){return rcloud_ocaps.purl_sourceAsync(e)},rcloud.get_completions=function(e,t,o){return rcloud_ocaps.get_completionsAsync(e,t,o).then(function(t){return t.values?(_.isString(t.values)&&(t.values=[t.values]),_.map(t.values,function(e){return{meta:"local",name:"library",score:3,position:t.position,prefix:t.prefix,value:e}})):(_.isString(t)&&(t=[t]),_.map(t,function(e){return{meta:"local",name:"library",score:3,value:e}}))})},rcloud.rename_notebook=function(e,t){return rcloud_github_handler("rcloud.rename.notebook",rcloud_ocaps.rename_notebookAsync(e,t))},rcloud.authenticated_cell_eval=function(e,t,o,n,r){return rcloud_ocaps.authenticated_cell_evalAsync(e,t,o,n,r)},rcloud.notebook_upload=function(e,t){return rcloud_github_handler("rcloud.upload.to.notebook",rcloud_ocaps.notebook_uploadAsync(e,t))},rcloud.tag_notebook_version=function(e,t,o){return rcloud_ocaps.tag_notebook_versionAsync(e,t,o)},rcloud.post_comment=function(e,t){return rcloud_github_handler("rcloud.post.comment",rcloud_ocaps.comments.postAsync(e,t))},rcloud.modify_comment=function(e,t,o){return rcloud_ocaps.comments.modifyAsync(e,t,o)},rcloud.delete_comment=function(e,t){return rcloud_ocaps.comments.deleteAsync(e,t)},rcloud.is_notebook_published=function(e){return rcloud_ocaps.is_notebook_publishedAsync(e)},rcloud.publish_notebook=function(e){return rcloud_ocaps.publish_notebookAsync(e)},rcloud.unpublish_notebook=function(e){return rcloud_ocaps.unpublish_notebookAsync(e)},rcloud.set_notebook_visibility=function(e,t){return rcloud_ocaps.set_notebook_visibilityAsync(e,t)},rcloud.protection={},rcloud.protection.get_notebook_cryptgroup=function(e){return rcloud_ocaps.protection.get_notebook_cryptgroupAsync(e)},rcloud.protection.set_notebook_cryptgroup=function(e,t,o){return void 0===o&&(o=!0),rcloud_ocaps.protection.set_notebook_cryptgroupAsync(e,t,o)},rcloud.protection.get_cryptgroup_users=function(e){return rcloud_ocaps.protection.get_cryptgroup_usersAsync(e)},rcloud.protection.get_user_cryptgroups=function(e){return rcloud_ocaps.protection.get_user_cryptgroupsAsync(e)},rcloud.protection.create_cryptgroup=function(e){return rcloud_ocaps.protection.create_cryptgroupAsync(e)},rcloud.protection.set_cryptgroup_name=function(e,t){return rcloud_ocaps.protection.set_cryptgroup_nameAsync(e,t)},rcloud.protection.add_cryptgroup_user=function(e,t,o){return rcloud_ocaps.protection.add_cryptgroup_userAsync(e,t,o)},rcloud.protection.remove_cryptgroup_user=function(e,t){return rcloud_ocaps.protection.remove_cryptgroup_userAsync(e,t)},rcloud.protection.delete_cryptgroup=function(e){return rcloud_ocaps.protection.delete_cryptgroupAsync(e)},rcloud.protection.has_notebook_protection=function(){return rcloud_ocaps.protection.has_notebook_protectionAsync()},rcloud.stars.star_notebook=function(e){return rcloud_ocaps.stars.star_notebookAsync(e)},rcloud.stars.unstar_notebook=function(e){return rcloud_ocaps.stars.unstar_notebookAsync(e)},rcloud.stars.get_my_starred_notebooks=function(){return rcloud_ocaps.stars.get_my_starred_notebooksAsync()},rcloud.config={all_notebooks:rcloud_ocaps.config.all_notebooksAsync,all_user_notebooks:rcloud_ocaps.config.all_user_notebooksAsync,all_notebooks_multiple_users:rcloud_ocaps.config.all_notebooks_multiple_usersAsync,get_all_notebook_info:rcloud_ocaps.config.get_all_notebook_infoAsync,add_notebook:rcloud_ocaps.config.add_notebookAsync,remove_notebook:rcloud_ocaps.config.remove_notebookAsync,get_current_notebook:rcloud_ocaps.config.get_current_notebookAsync,set_current_notebook:rcloud_ocaps.config.set_current_notebookAsync,new_notebook_number:rcloud_ocaps.config.new_notebook_numberAsync,get_recent_notebooks:rcloud_ocaps.config.get_recent_notebooksAsync,set_recent_notebook:rcloud_ocaps.config.set_recent_notebookAsync,clear_recent_notebook:rcloud_ocaps.config.clear_recent_notebookAsync,get_user_option:rcloud_ocaps.config.get_user_optionAsync,set_user_option:rcloud_ocaps.config.set_user_optionAsync,get_alluser_option:rcloud_ocaps.config.get_alluser_optionAsync},rcloud.set_notebook_info=function(e,t){return t.username?t.description?t.last_commit?rcloud_ocaps.set_notebook_infoAsync(e,t):Promise.reject(new Error("attempt to set info no last_commit")):Promise.reject(new Error("attempt to set info no description")):Promise.reject(new Error("attempt to set info no username"))},rcloud.get_notebook_property=rcloud_ocaps.get_notebook_propertyAsync,rcloud.set_notebook_property=rcloud_ocaps.set_notebook_propertyAsync,rcloud.remove_notebook_property=rcloud_ocaps.remove_notebook_propertyAsync}return rcloud._ocaps=rcloud_ocaps,rcloud.authenticated=rcloud_ocaps.authenticated,setup_unauthenticated_ocaps(),rcloud.authenticated&&setup_authenticated_ocaps(),rcloud},RClient={create:function(o){function n(){a||$("#input-div").hide(),l.closed||l.close()}function r(e,t){o.debug,o.on_error&&o.on_error(e,t)||n()}o=_.defaults(o,{debug:!1});var i,t=$.cookies.get().token,s=$.cookies.get().execToken,l=Rserve.create({host:o.host,on_connect:function(){if(!l.ocap_mode)return RCloud.UI.session_pane.post_error(ui_utils.disconnection_error("Expected an object-capability Rserve. Shutting Down!")),void n();var e=o.mode?o.mode:"client";l.ocap([t,s],e,RCloud.version,function(e,t){e?r(e[0],e[1]):null===(t=Promise.promisifyAll(t))?r("Login failed. Shutting down!"):RCloud.is_exception(t)?r(t):(i.running=!0,o.on_connect&&o.on_connect.call(i,t))})},on_error:r,on_close:function(e){o.debug,a||(window.rcloud?rcloud.username()?RCloud.UI.fatal_dialog("Your session has been logged out.","Reconnect",ui_utils.relogin_uri()):RCloud.UI.fatal_dialog("Your session closed unexpectedly.","Reload",window.location.href):RCloud.UI.fatal_dialog("Could not connect to server.","Retry",window.location.href),n())},on_data:o.on_data,on_oob_message:o.on_oob_message}),a=!1;return i={_rserve:l,host:o.host,running:!1,post_response:function(e){var t=$("<pre class='response'></pre>").html(e);$("#output").append(t)},post_rejection:function(e){throw RCloud.UI.session_pane.post_error(e.message),e},close:function(){a=!0,n()}}}};var ui_utils={make_url:function(e,t){t=t||{};var o=window.location.protocol+"//"+window.location.host+"/"+e;return t.do_path?t.notebook&&(o+="/"+t.notebook,t.version&&(o+="/"+t.version)):t.notebook?(o+="?notebook="+t.notebook,t.source&&(o+="&source="+t.source),t.tag?o+="&tag="+t.tag:t.version&&(o+="&version="+t.version)):t.new_notebook&&(o+="?new_notebook=true"),o},relogin_uri:function(e){return e=e||window.location.pathname+window.location.search,window.location.protocol+"//"+window.location.host+"/login.R?redirect="+encodeURIComponent(e)},disconnection_error:function(e,t){var o=$("<div class='alert alert-danger'></div>");o.append($("<span></span>").text(e)),t=t||"Reconnect";var n=$("<button type='button' class='close'>"+t+"</button>");return o.append(n),n.click(function(){window.location=ui_utils.relogin_uri()}),o},string_error:function(e){var t=$("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>"),o=$("<div class='alert alert-danger alert-dismissable'></div>");o.append(t);var n=_.map(e.split("\n"),function(e){var t,o=$("<div></div>").text(e);if(t=e.match(/^( {4})+/)){var n=t[0].length/4;o.css("left",n+"em"),o.css("position","relative")}return o});return o.append(n),o},fa_button:function(e,t,o,n,r){var i=$.el.i({class:e}),s=$.el.span({class:"fontawesome-button "+(o||"")},i);if(n)for(var l in n)i.style[l]=n[l];var a={title:t,delay:{show:250,hide:0}};return r||(a.container="body"),$(s).tooltip(a)},enable_fa_button:function(e){e.removeClass("button-disabled")},disable_fa_button:function(e){e.addClass("button-disabled")},enable_bs_button:function(e){e.removeClass("disabled")},disable_bs_button:function(e){e.addClass("disabled")},ace_editor_height:function(e,t,o){return t=_.isUndefined(t)?0:t,o=_.isUndefined(o)?30:o,e.renderer.lineHeight*Math.max(t,e.getSession().getScreenLength())+e.renderer.scrollBar.getWidth()},ace_get_last:function(e){var t=e.getSession(),o=t.getLength()-1;return{row:o,column:t.getLine(o).length}},ace_set_pos:function(e,t,o){var n=e.getSelection(),r=n.getRange();r.setStart(t,o),r.setEnd(t,o),n.setSelectionRange(r)},install_common_ace_key_bindings:function(e,l){var r=ace.require("ace/autocomplete").Autocomplete,a=e.getSession(),i=e.commands.commandKeyBinding.tab;e.commands.removeCommand("gotoline"),e.commands.addCommands([{name:"another autocomplete key",bindKey:"Ctrl-.",exec:r.startCommand.exec},{name:"the autocomplete key people want",bindKey:"Tab",exec:function(e,t,o){var n=e.getSelection().getRange();e.getSession().getLine(n.start.row).substring(0,n.start.column).match(/\S/)?r.startCommand.exec(e,t,o):i.exec(e,t,o)}},{name:"execute-selection-or-line",bindKey:{win:"Ctrl-Return",mac:"Command-Return",sender:"editor"},exec:function(e,t,o){if(!e.getOption("readOnly")){var n=a.getTextRange(e.getSelectionRange());if(0===n.length){var r=e.getCursorPosition(),i=new(ace.require("ace/range").Range)(r.row,0,r.row+1,0);n=a.getTextRange(i),e.navigateDown(1),e.navigateLineEnd()}RCloud.UI.command_prompt.history().add_entry(n);var s=shell.new_cell(n,l());shell.scroll_to_end(),s.controller.enqueue_execution_snapshot(s.updatePromise)}}},{name:"cursor at beginning of line",ctrlACount:0,lastRow:-1,bindKey:{mac:"Ctrl-A",sender:"editor"},exec:function(e,t,o){if(!e.getOption("readOnly")){var n=e.getCursorPosition().row;this.lastRow!==n?(this.ctrlACount=1,e.navigateLineStart()):0===this.ctrlACount?(e.navigateLineStart(),this.ctrlACount++):1===this.ctrlACount&&(e.navigateTo(n,0),this.ctrlACount=0),this.lastRow=n}}},{name:"cursor at end of line",bindKey:{mac:"Ctrl-E",sender:"editor"},exec:function(e,t,o){var n=e.getCursorPosition().row,r=ui_utils.last_col(e,n);e.navigateTo(n,r)}}])},last_col:function(e,t){return e.getSession().getDocument().getLine(t).length},character_offset_of_pos:function(e,t){var o=e.getSession().getDocument(),n=o.getNewLineCharacter().length,r=o.getAllLines();if(t.row>r.length)throw new Error("getting position off end of editor");var i,s=0;for(i=0;i<t.row;i++)s+=r[i].length+n;return s+=t.column},position_of_character_offset:function(e,t){var o,n=e.getSession().getDocument(),r=n.getNewLineCharacter().length,i=n.getAllLines();for(o=0;o<i.length&&!(t<=i[o].length);o++)t-=i[o].length+r;if(o===i.length)throw new Error("character offset off end of editor");return{row:o,column:t}},ace_range_of_character_range:function(e,t,o){var n=ace.require("ace/range").Range,r=ui_utils.position_of_character_offset(e,t),i=ui_utils.position_of_character_offset(e,o);return new n(r.row,r.column,i.row,i.column)},ignore_programmatic_changes:function(o,e){var n=!0;return o.on("change",function(){n&&e(o.getValue())}),function(e){n=!1;var t=e!==o.getValue()?o.setValue(e):null;return n=!0,t}},set_ace_readonly:function(e,t){e.setOptions({readOnly:t,highlightActiveLine:!t,highlightGutterLine:!t}),e.renderer.$cursorLayer.element.style.opacity=t?0:1,e.textInput.setReadOnly(t)},twostate_icon:function(o,t,n,r,i){function s(e){o[0].checked=e;var t=o.find("i");e?(t.removeClass(i),t.addClass(r)):(t.removeClass(r),t.addClass(i))}function l(){var e=!this.checked;s(e),e?t():n()}function e(e){o.off("click"),e&&o.click(l)}return e(!0),{set_state:s,enable:e}},checkbox_menu_item:function(t,e,o){var n=ui_utils.twostate_icon(t,e,o,"icon-check","icon-check-empty"),r=n.enable;return n.enable=function(e){t.parent().toggleClass("disabled",!e),r(e)},n},customize_ace_gutter:function(e,c){var u=ace.require("ace/lib/dom");e.renderer.$gutterLayer.update=function(e){for(var t=[],o=e.firstRow,n=e.lastRow,r=this.session.getNextFoldLine(o),i=(r&&r.start.row,this.$showFoldWidgets&&this.session.foldWidgets,this.session.$breakpoints,this.session.$decorations,this.session.$firstLineNumber,0);o<=n;++o){var s=c(o);t.push("<div class='ace_gutter-cell ","' style='height:",this.session.getRowLength(0)*e.lineHeight,"px;'>",s,"</div>"),i=Math.max(i,s.length)}this.element=u.setInnerHtml(this.element,t.join("")),this.element.style.height=e.minHeight+"px";var l=i*e.characterWidth,a=this.$padding||this.$computePadding();(l+=a.left+a.right)===this.gutterWidth||isNaN(l)||(this.gutterWidth=l,this.element.style.width=Math.ceil(this.gutterWidth)+"px",this._emit("changeGutterWidth",l))}},editable:function(r,i){function n(e){var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}function s(e){var t=document.createRange(),o=r.get(0).firstChild;t.setStart(o,e),t.setEnd(o,e),n(t)}function l(){return window.getSelection().getRangeAt(0)}function a(){return r.data("__editable")}function e(e){return i.allow_multiline&&(e=e.replace(/\n/g,"<br/>")),e.replace(/  /g,"  ")}function c(e){return i.allow_multiline&&(e=e.replace(/<br>/g,"\n")),e.replace(/\xa0/g," ")}function t(e,t){e?r.html(t):r.text(t)}var o=a(),u=o;if(_.isObject(i)){var d;d=o?$.extend({},o):{on_change:function(){return!0},allow_edit:!0,inactive_text:r.text(),active_text:r.text(),allow_multiline:!1,select:function(e){var t=document.createRange();return t.selectNodeContents(e),t}},u=$.extend(d,i),r.data("__editable",u)}else{if("destroy"!==i&&!o)throw new Error("expected already editable for command "+i);var f=function(e,t){o=$.extend({},o),u[e]=t};switch(i){case"destroy":r.data("__editable",null),u=null;break;case"option":if(!arguments[2])return o;if(!arguments[3])return o[arguments[2]];f(arguments[2],arguments[3]);break;case"disable":f("allow_edit",!1);break;case"enable":f("allow_edit",!0)}}var h=null;switch(o&&o.allow_edit||!u||!u.allow_edit?!o||!o.allow_edit||u&&u.allow_edit||(h="freeze"):h="melt",u&&t(i.allow_multiline,e(a().__active?u.active_text:u.inactive_text)),h){case"freeze":r.removeAttr("contenteditable"),r.off("keydown.editable"),r.off("focus.editable"),r.off("click.editable"),r.off("blur.editable");break;case"melt":r.attr("contenteditable","true"),r.on({"focus.editable":function(){a().__active||(a().__active=!0,t(i.allow_multiline,e(a().active_text)),window.setTimeout(function(){n(a().select(r[0])),r.off("blur.editable"),r.on("blur.editable",function(){t(i.allow_multiline,e(a().inactive_text)),a().__active=!1})},10))},"click.editable":function(e){e.stopPropagation()},"keydown.editable":function(e){if(e.keyCode===$.ui.keyCode.ENTER||e.keyCode===$.ui.keyCode.TAB){var t=c(r.text());function o(e){return!!a().validate(t)&&(a().__active=!1,r.off("blur.editable"),r.blur(),e(t,t!=a().active_text),!0)}if(a().ctrl_cmd&&(e.ctrlKey||e.metaKey))return e.preventDefault(),o(a().ctrl_cmd);if(!i.allow_multiline||e.ctrlKey||e.metaKey)return e.preventDefault(),o(a().change)}else if(e.keyCode===$.ui.keyCode.ESCAPE)r.blur(),window.getSelection().removeAllRanges();else if(e.keyCode===$.ui.keyCode.HOME)s(0);else if(e.keyCode===$.ui.keyCode.END)s(c(r.text()).length);else if(e.keyCode===$.ui.keyCode.RIGHT)if(e.ctrlKey||e.altKey){var n=r.text().substring(l().startOffset);(0==(n.match(/ /g)||[]).length||1==(n.match(/ /g)||[]).length&&" "==n[0]||0===l().startOffset&&l().endOffset===r.text().length)&&(e.preventDefault(),s(c(r.text()).length))}else(l().startOffset===c(r.text()).length-1||0===l().startOffset&&l().endOffset===r.text().length)&&s(c(r.text()).length);return!0},"input.editable":function(e){0===r.text().length?r.css("padding-right","1px"):r.css("padding-right","")}})}return r},fake_hover:function(e){var t=e.parent,o="none"!==$(".notebook-commands.appear",e.element).css("display")?t.children.indexOf(e):void 0;ui_utils.on_next_tick(function(){if(0<=o&&o<t.children.length){var e=t.children[o];$(e.element).mouseover()}})},on_next_tick:function(e){window.setTimeout(e,0)},scroll_to_after:function(e,t,o,n,r){var i=$.extend($.scrollTo.defaults,{axis:"y"},t);if(0!==e.length){r||(r=0),o||(o=e.parent());var s=ui_utils.get_top_offset(n),l=o.scrollTop()+s+e.position().top+e.outerHeight()-r;o.scrollTo(l,i)}},get_top_offset:function(e){var t=0;return e&&e.forEach(function(e){t+=e.position().top}),t},is_visible_in_scrollable:function(e,t){var o=+e.css("height").replace("px",""),n=ui_utils.get_top_offset(t);return $(t[t.length-1]).is(":visible")&&(n+=t[t.length-1].outerHeight()),(n-=e.get(0).offsetTop)<=o},scroll_into_view:function(e,t,o,n){if(arguments.length<5)console.warn("scroll_into_view needs offset elements");else{var r=$.extend($.scrollTo.defaults,{axis:"y",duration:600}),i=+e.css("height").replace("px",""),s=e.scrollTop();n&&(r.onAfter=function(e,t){n()});var l=ui_utils.get_top_offset(Array.prototype.slice.call(arguments,4));i<l?e.scrollTo(s+l-i+t,r):l<0?e.scrollTo(s+l-o,r):n&&n()}},prevent_backspace:function(e){e.unbind("keydown").bind("keydown",function(e){var t=!1;if(e.keyCode===$.ui.keyCode.BACKSPACE){var o=e.srcElement||e.target;t=("INPUT"!==o.tagName.toUpperCase()||"TEXT"!==o.type.toUpperCase()&&"PASSWORD"!==o.type.toUpperCase()&&"FILE"!==o.type.toUpperCase()&&"EMAIL"!==o.type.toUpperCase())&&"TEXTAREA"!==o.tagName.toUpperCase()&&!o.isContentEditable||(o.readOnly||o.disabled)}t&&e.preventDefault()})}};ui_utils.is_a_mac=function(){var e=navigator.platform.toUpperCase();return function(){return-1!==e.indexOf("MAC")}}(),ui_utils.is_ie=function(){var e=window.navigator.userAgent;return 0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")},ui_utils.kill_popovers=function(){window.allPopovers&&($(window.allPopovers).each(function(e,t){$(this).popover("destroy")}),window.allPopovers.length=0)},ui_utils.hide_selectize_dropdown=function(){$(".selectize-dropdown").hide(),$(".selectize-input").removeClass("focus input-active dropdown-active")},ui_utils.select_allowed_elements=function(e){var t=window.getSelection(),o=$('<pre class="offscreen"></pre>');$("body").append(o);for(var n=0;n<t.rangeCount;++n){var r=t.getRangeAt(n);o.append(r.cloneContents())}o.find(".nonselectable").remove(),o.is(":empty")?t.removeAllRanges():t.selectAllChildren(o[0]),window.setTimeout(function(){o.remove()},1e3)},RCloud.utils={},RCloud.utils.promise_for=function(e,t,o){return e(o)?t(o).then(RCloud.utils.promise_for.bind(null,e,t)):o},RCloud.utils.promise_sequence=function(t,o){return RCloud.utils.promise_for(function(e){return e<t.length},function(e){return o(t[e]).return(++e)},0)},RCloud.utils.slow_promise=function(e,n){return new Promise(function(t,o){window.setTimeout(function(){e.then(function(e){t(e)},function(e){o(e)})},n)})},RCloud.utils.get_url_parameter=function(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},RCloud.utils.get_notebook_from_url=function(e){var t=e.match(new RegExp("[?&]notebook=([^&#]*)"));return t&&t[1]},RCloud.utils.clean_r=function(e){return delete e.r_attributes,delete e.r_type,e},RCloud.utils.split_number=function(e){var t=/(\d+)$/.exec(e);return t?[e.slice(0,t.index),t[1]]:null},RCloud.utils.format_date_time_stamp=function(e,t,o,n,r){var i,s=new Date,l='<span class="notebook-time">'+e.getHours()+":"+((i=e.getMinutes())<10?"0"+i:i)+"</span>",a=e.getMonth()+1+"/"+e.getDate(),c=e.getFullYear().toString().substr(2,2);return t<864e5&&o&&r&&n?l:e.getFullYear()===s.getFullYear()?"<span>"+a+" "+l+"</span>":"<span>"+a+"/"+c+" "+l+"</span>"},RCloud.utils.date_diff_days=function(e,t){var o=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),n=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());return Math.floor((n-o)/864e5)},RCloud.utils.filter=function(e,t){return _.mixin({invokeWith:function(){var t=arguments;return function(e){return e.apply(null,t)}}}),_.isArray(e)||(e=[e]),_.filter(e,_.compose(_.partial(_.all,t),_.invokeWith))},RCloud.extension={filter_field:function(t,o){return function(e){return e[t]===o}},create:function(e){var o={},t={},n=(e=e||{}).defaults?e.defaults:{};if(e.sections)for(var r in e.sections)t[r]={filter:e.sections[r].filter};else t.all={};function i(){for(r in t)t[r].entries=_.filter(o,function(e){return!e.disable&&(!t[r].filter||t[r].filter(e))}),t[r].entries.sort(function(e,t){return e.sort-t.sort})}return{add:function(e){for(var t in e)o[t]=_.extend(_.extend({key:t},n),e[t]);return i(),this},remove:function(e){return delete o[e],i(),this},disable:function(e,t){return o[e]&&(o[e].disable=t,i()),this},get:function(e){return o[e]},entries:function(e){return t[e].entries},create:function(e,t){var o={},n=[],r=Array.prototype.slice.call(arguments,1),i=this.entries(e);return i&&i.forEach(function(e){n.push(o[e.key]=e.create.apply(e,r))}),{map:o,array:n}},sections:t}}};var bootstrap_utils={alert:function(e){e=_.defaults(e||{},{close_button:!0,on_close:function(){}});var t=$('<div class="alert"></div>');return e.html&&t.html(e.html),e.text&&t.text(e.text),e.class&&t.addClass(e.class),e.close_button&&t.prepend($('<button type="button" class="close" data-dismiss="alert">&times;</button>').click(e.on_close)),t},button:function(e){e=e||{};var t=$('<a class="btn" href="#"></a>');return t.text(e.text),e.class&&t.addClass(e.class),t}};Notebook={Buffer:{},Cell:{},Asset:{}},Notebook.Buffer.create_model=function(o,t){var n="";function r(e){return Notebook.empty_for_github(e)}return{views:[],parent_model:null,renew_content:function(){n=""},content:function(e){return _.isUndefined(e)?o:o!==e?(o=e,this.notify_views(function(e){e.content_updated()}),o):null},language:function(e){if(!_.isUndefined(e))return t!==e?(t=e,this.notify_views(function(e){e.language_updated()}),t):null;if(void 0===t)throw new Error("tried to read no language");return null===t?"Text":t},change_object:function(e){if(e.content)throw new Error("content must come from the object");if(!e.filename)throw new Error("change object must have filename");var t={filename:e.filename};return e.erase?t.erase=!r(n):e.rename?r(o)?r(n)||(t.erase=!0):(r(n)?t.filename=e.rename:t.rename=e.rename,t.content=o):r(o)?r(n)||(t.erase=!0):(o!=n&&(t.content=o),r(n)&&(t.create=!0)),n=o,t},asset_url:function(e){var t=this.parent_model.controller.current_gist(),o=[window.location.protocol+"//"+window.location.host,"notebook.R",t.id];return e&&o.push(t.history[0].version),o.push(this.filename()),o.join("/")},notify_views:function(t){_.each(this.views,function(e){t(e)})}}},Notebook.Asset.create_html_view=function(n){var e=$("<li></li>"),t=$("<div></div>"),r=$("<span style='cursor:pointer'>"+n.filename()+"</span>"),i=ui_utils.fa_button("icon-remove","remove","",{position:"relative",left:"2px",opacity:"0.75"},!0),s=$('<i class="icon-camera" style="padding-left: 4px; cursor: help;" title="Shown as your notebook\'s thumbnail on the Discover page"></i>');t.append(r),e.append(t),a(n.filename())&&t.append(s),t.append(i);var l=r.text();function a(e){return"thumb.png"===e}var o={change:function(e){shell.notebook.controller.save().then(function(){var o=r.text().trim();o=o.replace(/\s/g," ");var e=n.content();if(Notebook.is_part_name(o))return alert("Asset names cannot start with 'part[0-9]', sorry!"),void r.text(l);l===o?r.text(l):shell.notebook.model.get_asset(o)?(alert('An asset with the name "'+o+'" already exists. Please choose a different name.'),r.text(l)):shell.notebook.controller.append_asset(e,o).spread(function(e,t){t.select(),n.controller.remove(!0),!a(l)&&a(o)?s.insertBefore(i):a(l)&&!a(o)&&s.remove()})})},select:function(e){if(1!==e.childNodes.length||e.firstChild.nodeType!=e.TEXT_NODE)throw new Error("expecting simple element with child text");var t=e.firstChild.textContent,o=document.createRange();return o.setStart(e.firstChild,0),o.setEnd(e.firstChild,0<t.lastIndexOf(".")?t.lastIndexOf("."):t.length),o},validate:function(e){return editor.validate_name(e)}};return t.click(function(){n.active()||n.controller.select()}),i.click(function(){n.controller.remove()}),{filename_updated:function(){t.text(n.filename())},content_updated:function(){n.active()&&RCloud.UI.scratchpad.content_updated()},language_updated:function(){n.active()&&RCloud.UI.scratchpad.language_updated()},active_updated:function(){n.active()?(shell.notebook.model.read_only()||ui_utils.editable(r,$.extend({allow_edit:!0,inactive_text:r.text(),active_text:r.text()},o)),e.addClass("active")):(ui_utils.editable(r,"destroy"),e.removeClass("active"))},self_removed:function(){e.remove()},set_readonly:function(e){e?i.hide():i.show()},div:function(){return e}}},Notebook.Asset.create_model=function(e,t){var o,n=!1,r=Notebook.Buffer.create_model(e),i=r.change_object;return _.extend(r,{active:function(e){return _.isUndefined(e)?n:n!==e?(n=e,this.notify_views(function(e){e.active_updated()}),n):null},cursor_position:function(e){return _.isUndefined(e)||(o=e),o},filename:function(e){return _.isUndefined(e)?t:t!=e?(t=e,this.notify_views(function(e){e.filename_updated()}),t):null},json:function(){return{content:e,filename:this.filename(),language:this.language()}},change_object:function(e){return(e=e||{}).filename=e.filename||this.filename(),i.call(this,e)}}),r},Notebook.Asset.create_controller=function(n){return{select:function(){RCloud.UI.scratchpad.current_model&&RCloud.UI.scratchpad.current_model.controller.deselect(),n.active(!0),RCloud.UI.scratchpad.set_model(n)},deselect:function(){n.active(!1)},remove:function(e){var t=n.filename();if((e||confirm("Do you want to remove the asset '"+t+"' from the notebook?"))&&(n.parent_model.controller.remove_asset(n),n===RCloud.UI.scratchpad.current_model)){var o=n.parent_model.assets;o.length?o[0].controller.select():RCloud.UI.scratchpad.set_model(null)}}}},function(){var ie=$("#rcloud-cellarea");function t(d,f){var h,p,m,g,v,i,s,n,r,b,e,o,y,l,k,w,a,t,c,u,C,x,R,I,U="unknown",E=[],A={options:{no_of_results_in_batch:20,notebook_update_delay:20},results:[],stop:!1,prev_scroll:null,result_consumer:null,scrolled:!1},S={},P=$("<div class='notebook-cell'></div>");function N(){return p?f.content(p.getValue()):null}function O(){P.attr("id",Notebook.part_name(f.id(),f.language())),l&&l.controls.cell_number.set(f.id())}function T(e){K.css("height",e||ui_utils.ace_editor_height(h,2)+2+"px")}P.data("rcloud.model",f),e=$("<div class='cell-status nonselectable'></div>");var j=$("<div class='cell-status-left'></div>");if(e.append(j),l=RCloud.UI.cell_commands.decorate("left",j,f,S),!shell.is_view_mode()){var D=$("<div class='cell-control-bar'></div>");e.append(D),D.mousedown(function(e){e.stopPropagation()}),y=RCloud.UI.cell_commands.decorate("cell",D,f,S);var M=$("<div class='cell-controls-above nonselectable'></div>");o=RCloud.UI.cell_commands.decorate("above",M,f,S),P.append(M),e.click(function(e){var t=$(this).closest(".notebook-cell").data("rcloud.model");(e.ctrlKey||e.metaKey||e.shiftKey)&&e.preventDefault(),t.parent_model.controller.select_cell(t,{is_toggle:ui_utils.is_a_mac()&&e.metaKey||!ui_utils.is_a_mac()&&e.ctrlKey,is_range:e.shiftKey,is_exclusive:!e.ctrlKey&&!e.shiftKey}),$(":focus").blur()}).children().click(function(e){$(e.target).hasClass("cell-number")||e.stopPropagation()})}P.append(e);function B(e){var t=RCloud.language.is_a_markdown(d);e.toggleClass(t?"edit-markdown":"edit-code",!0),e.toggleClass(t?"edit-code":"edit-markdown",!1)}function L(){if(d=f.language(),RCloud.language.is_a_markdown(d)||S.hide_source&&S.hide_source(!1),y&&y.controls.language_cell.set(d),B(v.find("pre")),h){q.toggleClass("active",!0),B(q);var e=RCloud.language.ace_mode(d);p.setMode(new e({suppressHighlighting:!1,doc:m,session:p,language:d}))}}var z=$("<div></div>"),F=$("<div style='clear:both;'></div>");P.append(z),P.append(F),g=$('<div class="source-div"></div>'),v=$('<div class="code-div"></div>'),g.append(v);var K=$('<div class="outer-ace-div"></div>'),q=$('<div style="width:100%; height:100%;"></div>');function H(r,e){e?(B(v.find("pre")),!1===U&&r.toggleClass("inactive",!0),r.on({"mousedown.rcloud-cell":function(e){$(this).data("p0",{x:e.pageX,y:e.pageY})},"mouseup.rcloud-cell":function(e){var t=$(this).data("p0");if(t){var o=e.pageX,n=e.pageY;Math.sqrt(Math.pow(o-t.x,2)+Math.pow(n-t.y,2))<4&&(U?S.hide_source(!1):S.edit_source(!0,e),r.mouseleave())}}})):r.off("mousedown.rcloud-cell mouseup.rcloud-cell")}function Q(){i.empty(),s=!1,y&&ne(!1)}function G(){return $.contains(document,P.get(0))}function W(){return ui_utils.is_visible_in_scrollable($("#rcloud-cellarea"),[P,i])}function J(){if(t){var e=$("#rcloud-cellarea");if(i){ui_utils.scroll_to_after(i,{axis:"y",duration:0,interrupt:!0,offset:{top:10}},e,[P],e.height())}}}function Y(e,t){switch(e){case"selection":case"deferred_result":break;default:Notebook.Cell.preprocessors.entries("all").forEach(function(e){t=e.process(t)})}var o;switch("code"!=e&&(n=null),"error"!=e&&(r=null),e){case"code":n||(o=$("<pre></pre>"),n=$("<code></code>"),o.append(n),i.append(o)),n.append(_.escape(t));break;case"error":r||(o=$("<pre></pre>"),r=$('<code style="color: crimson"></code>'),o.append(r),i.append(o)),r.append(_.escape(t));break;case"selection":case"html":i.append(t);break;case"deferred_result":i.append('<span class="deferred-result">'+t+"</span>");break;default:throw new Error("unknown result type "+e)}}function V(e){return e&&!W()&&!A.scrolled}function X(e){!A.stop&&A.result_consumer||(A.stop=!1,A.results.length=0,A.result_consumer=function(){var e=0,t=W();for(A.scrolled=!1;e<A.options.no_of_results_in_batch;){var o=A.results.shift();if(!o)break;Y(o.type,o.result),e++,V(t)&&J()}Notebook.Cell.postprocessors.entries("all").forEach(function(e){e.process(i,S)});var n=function(e,t){if(e<=7&&(0<i.find(".rcloud-htmlwidget").length&&i.find(".rcloud-htmlwidget").find("div").is(":empty")||0<i.find(".deferred-result").length)){var o=e+1;setTimeout(n,Math.max(3^o,300),o,t)}else t()};setTimeout(n,0,1,function(){V(t)&&J(),G()&&(!A.stop||0<A.results.length)&&window.setTimeout(A.result_consumer,A.options.notebook_update_delay)})},window.setTimeout(A.result_consumer,e))}function Z(e,t){ace.require("ace/ext/language_tools");var a=ace.edit(e[0]),o=a.getSession();a.setValue(t),ui_utils.ace_set_pos(a,0,0),ui_utils.on_next_tick(function(){o.getUndoManager().reset()});var n=o.getDocument();return a.gotoPageUp=function(){a.renderer.layerConfig.height=$("#rcloud-cellarea").height(),a.$moveByPage(-1,!1)},a.gotoPageDown=function(){a.renderer.layerConfig.height=$("#rcloud-cellarea").height(),a.$moveByPage(1,!1)},a.setAutoScrollEditorIntoView=function(e){if(e){var i,s=a,l=!1;a.$scrollAnchor||(a.$scrollAnchor=window.document.createElement("div"));var t=a.$scrollAnchor;t.style.cssText="position:absolute;",$("#rcloud-cellarea").prepend(t);var o=a.on("changeSelection",function(){l=!0}),n=a.renderer.on("beforeRender",function(){l&&(i=s.renderer.container.getBoundingClientRect())}),r=a.renderer.on("afterRender",function(){if(l&&i&&s.isFocused()){var e=s.renderer,t=e.$cursorLayer.$pixelPos,o=e.layerConfig,n=t.top-o.offset;if(null!=(l=0<=t.top&&n+i.top<$("#rcloud-cellarea").offset().top||!(t.top<o.height&&t.top+i.top+o.lineHeight>window.innerHeight)&&null)){var r=$(e.$cursorLayer.element).closest(".outer-ace-div").offset().top+$("#rcloud-cellarea").scrollTop()-$("#rcloud-cellarea").offset().top;r+=t.top,l?$("#rcloud-cellarea").scrollTop(r):$("#rcloud-cellarea").scrollTop(r-$("#rcloud-cellarea").height()+o.lineHeight)}l=i=null}});a.setAutoScrollEditorIntoView=function(e){e||(delete a.setAutoScrollEditorIntoView,a.removeEventListener("changeSelection",o),a.renderer.removeEventListener("afterRender",r),a.renderer.removeEventListener("beforeRender",n))}}},a.setOptions({enableBasicAutocompletion:!0,autoScrollEditorIntoView:!0}),a.setTheme("ace/theme/chrome"),o.setNewLineMode("unix"),o.setOption("indentedSoftWrap",!1),o.setUseWrapMode(!0),{widget:a,session:o,document:n}}function ee(){var e;switch(a){case"waiting":case"unknown":e="unknown";break;case"running":case"unknown-running":e="unknown-running";break;default:e="ready"}S.state_changed(e)}function te(e){return"find-highlight "+e}function oe(e){y&&y.controls.edit.control.find("i").toggleClass("icon-border",e)}function ne(e){y&&y.controls.results.control.find("i").toggleClass("icon-border",e)}function re(e){e=e||f.content(),e=E.reduce(function(e,t){return t(e)},e),v.empty();var t,o=$("<code></code>").append(e),n=$('<div class="rcloud-gutter"></div>'),r=RCloud.language.hljs_class(f.language());r&&o.addClass(r),v.append(n,$("<pre></pre>").append(o)),(t=v,t.find("pre code").filter(function(e,t){return 0<t.classList.length})).each(function(e,t){hljs.highlightBlock(t)}),v.find(".rcloud-line-number .hljs-number").css("color","black"),"unknown"!==U&&H(v.find("pre"),!0),B(v.find("pre"))}return B(q),O(),K.append(q),g.append(K),z.append(g),E.push(function(t){var o=_.escape,n=0,r=[];return w&&w.forEach(function(e){r.push(o(t.substring(n,e.begin))),r.push('<span class="',te(e.kind),'">',o(t.substring(e.begin,e.end)),"</span>"),n=e.end}),r.push(o(t.substring(n))),r.join("")},function(e){var t=1;return e=e.split("\n").map(function(e){return['<span class="rcloud-line-number-position nonselectable">',"&#x200b;",'<span class="rcloud-line-number">',t++,"</span></span>",e].join("")}).join("\n"),e+="&nbsp;"},function(e){"\n"===e[e.length-1]&&(e+="\n");var t=(e.match(/\n/g)||[]).length;return t<2&&(e+=new Array(3-t).join("\n")),e}),re(),i=$('<div class="r-result-div"></div>'),Q(),z.append(i),u=$('<div class="input-div"></div>'),C=$('<div style="height: 100%"></div>'),u.hide().append(C),z.append(u),L(),_.extend(S,{content_updated:function(){if(re(),h){var e=p.getScrollTop(),t=h.getSelection().getRange(),o=b(f.content());h.getSelection().setSelectionRange(t),p.setScrollTop(e)}return o},self_removed:function(){P.remove()},ace_widget:function(){return h},id_updated:O,language_updated:function(){L(),ee()},selected_updated:function(){f.is_selected()?P.addClass("selected"):P.removeClass("selected"),P.find('.cell-control input[type="checkbox"]').prop("checked",f.is_selected())},state_changed:function(e){var t=l.controls.run_state;switch("unknown"===a&&"running"===e&&(s=!(e="unknown-running")),e){case"ready":t.icon("icon-circle-blank").color("#777").title("content has not been run");break;case"waiting":t.icon("icon-arrow-right").color("blue").title("cell is enqueued and waiting to run");break;case"cancelled":t.icon("icon-asterisk").color("#e06a06").title("execution was cancelled before this cell could run");break;case"unknown-running":t.icon("icon-question icon-spin").color("blue").title("cell is currently running");break;case"running":t.icon("icon-spinner icon-spin").color("blue").title("cell is currently running"),s=!1;break;case"complete":t.icon("icon-circle").color("#72B668").title("cell successfully ran");break;case"error":t.icon("icon-exclamation").color("crimson").title("cell ran but had an error");break;case"unknown":t.icon("icon-question").color("purple").title("output may or may not reflect current content")}return a=e,this},add_result:function(e,t){s||(i.empty(),RCloud.language.is_a_markdown(d)&&S.hide_source(!0),s=!0,X(A.options.notebook_update_delay)),this.toggle_results(!0),A.results.push({type:e,result:t})},end_output:function(e){s||(i.empty(),s=!0);var t=this;!function(e){A.stop=!0;var t=function(){G()&&(0<A.results.length?setTimeout(t,A.options.notebook_update_delay):e())};t()}(function(){t.state_changed(e?"error":"unknown-running"===a?"unknown":"complete"),n=r=null})},clear_result:Q,set_readonly:function(t){U=t,h&&ui_utils.set_ace_readonly(h,t),[y,o,l].forEach(function(e){e&&e.set_flag("modify",!t)}),H(v.find("pre"),!t),e.toggleClass("readonly",t),t&&oe($(g).is(":visible"))},set_show_cell_numbers:function(e){l.set_flag("cell-numbers",e)},set_autoscroll_notebook_output:function(e){t=e},on_scroll:function(e){A.prev_scroll&&(A.scrolled=A.prev_scroll>e.currentTarget.scrollTop),A.prev_scroll=e.currentTarget.scrollTop},click_to_edit:H,execute_cell:function(){f.controller.enqueue_execution_snapshot(f.parent_model.controller.save())},toggle_edit:function(){return this.edit_source(!k)},edit_source:function(e,t){if(e!==k){if(e){var o=ie.scrollTop();y&&oe(!0),RCloud.language.is_a_markdown(d)&&this.hide_source(!1);var n=v.height();if(v.hide(),function(){if(!h){var e=Z(q,f.content());h=e.widget,p=e.session,m=e.document,p.on("change",function(){T(),h.resize()}),h.resize(),h.commands.removeCommand("findnext"),h.commands.removeCommand("findprevious"),ui_utils.install_common_ace_key_bindings(h,function(){return d}),h.commands.commandKeyBinding.left,h.commands.commandKeyBinding.right;var a=h.commands.commandKeyBinding.up,l=h.commands.commandKeyBinding.down;h.commands.addCommands([{name:"executeCell",bindKey:{win:"Alt-Return",mac:"Alt-Return",sender:"editor"},exec:function(){S.execute_cell()}},{name:"executeCellsFromHere",bindKey:{win:"Shift-Alt-Return",mac:"Shift-Alt-Return",sender:"editor"},exec:function(){shell.run_notebook_from(f.id())}},{name:"up",bindKey:{win:"up",mac:"up"},exec:function(e,t,o){var n=h.getCursorPosition(),r=!0;if(0===n.row&&0===n.column){var i=f.parent_model.prior_cell(f);if(i){i.set_focus();var s=i.views[0].ace_widget(),l=ui_utils.ace_get_last(s);s.gotoLine(l.row+1,0),r=!1}}r&&a.exec(e,t,o)}},{name:"down",bindKey:{win:"down",mac:"down"},exec:function(e,t,o){var n=!0,r=h.getCursorPosition(),i=ui_utils.ace_get_last(h);if(r.row==i.row&&r.column===i.column){n=!1;var s=f.parent_model.subsequent_cell(f);s&&(s.set_focus(),s.views[0].ace_widget().gotoLine(1,0))}n&&l.exec(e,t,o)}},{name:"navigateToPreviousCell",bindKey:{win:"Ctrl-Shift-,",mac:"Ctrl-Shift-,",sender:"editor"},exec:function(){var e=f.parent_model.prior_cell(f);e&&e.set_focus()}},{name:"navigateToNextCell",bindKey:{win:"Ctrl-Shift-.",mac:"Ctrl-Shift-.",sender:"editor"},exec:function(){var e=f.parent_model.subsequent_cell(f);e&&e.set_focus()}},{name:"insertCellBefore",bindKey:{win:"Ctrl-[",mac:"Cmd-[",sender:"editor"},exec:function(){var e=shell.insert_cell_before("",f.language(),f.id());e.updatePromise.then(function(){e.controller.edit_source(!0)})}},{name:"insertCellAfter",bindKey:{win:"Ctrl-]",mac:"Cmd-]",sender:"editor"},exec:function(){var e=shell.insert_cell_after("",f.language(),f.id());e.updatePromise.then(function(){e.controller.edit_source(!0)})}},{name:"blurCell",bindKey:{win:"Escape",mac:"Escape",sender:"editor"},exec:function(){h.blur()}},{name:"executeAll",bindKey:{win:"Ctrl-Shift-Enter",mac:"Ctrl-Shift-Enter",sender:"editor"},exec:function(){RCloud.UI.run_button.run()}}]),h.commands.removeCommands(["find","replace"]),b=ui_utils.ignore_programmatic_changes(h,function(){ee(),f.parent_model.on_dirty()}),L()}}(),K.show(),h.resize(!0),T(n),h.resize(!0),y&&y.set_flag("edit",!0),K.show(),h.resize(),h.focus(),t){ie.scrollTop(o);var r=h.getSession().getScrollTop(),i=h.renderer.pixelToScreenCoordinates(t.pageX,t.pageY-r),s=p.screenToDocumentPosition(Math.abs(i.row),Math.abs(i.column)),l=ace.require("ace/range").Range,a=Math.abs(s.row),c=Math.abs(s.column),u=new l(a,c,a,c);h.getSelection().setSelectionRange(u)}}else{y&&oe(!1),null!==N()&&f.parent_model.controller.update_cell(f),g.css({height:""}),y&&y.set_flag("edit",!1),v.show(),K.hide()}k=e,this.change_highlights(w)}else e&&h.focus()},scroll_into_view:function(){var e=h.renderer,t=e.container.getBoundingClientRect(),o=e.$cursorLayer.$pixelPos,n=e.layerConfig,r=o.top-n.offset;if(0<=o.top&&r+t.top<$("#rcloud-cellarea").offset().top?shouldScroll=!0:o.top<n.height&&o.top+t.top+n.lineHeight>window.innerHeight?shouldScroll=!1:shouldScroll=null,null!=shouldScroll){var i=$(e.$cursorLayer.element).closest(".outer-ace-div").offset().top+$("#rcloud-cellarea").scrollTop()-$("#rcloud-cellarea").offset().top;i+=o.top,shouldScroll?$("#rcloud-cellarea").scrollTop(i):$("#rcloud-cellarea").scrollTop(i-$("#rcloud-cellarea").height()+n.lineHeight)}},toggle_source:function(){this.hide_source($(g).is(":visible"))},hide_source:function(e){e?(g.hide(),oe(!1)):(g.show(),oe(!0))},toggle_results:function(e){void 0===e&&(e=i.is(":hidden")),y&&ne(e),e?i.show():i.hide()},get_input:function(e,t,o){s||(i.empty(),s=!0,X(A.options.notebook_update_delay)),c=_.escape(t).replace(/\n/g,""),function(){if(!x){var e=Z(C,"");x=e.widget,ui_utils.customize_ace_gutter(x,function(e){return 0===e?c:""}),x.commands.addCommands([{name:"enter",bindKey:"Return",exec:function(e,t,o){var n=e.getValue();S.add_result("code",_.unescape(c)+n+"\n"),R&&R(null,n),u.hide(),window.clearInterval(I),I=null}}]),RCloud.UI.prevent_progress_modal()}}(),x.setValue(""),u.show(),u.css("height","36px"),x.renderer.$gutterLayer.gutterWidth=0,x.renderer.$changes|=x.renderer.__proto__.CHANGE_FULL,x.resize(!0),x.focus(),u.css("border-color","#eeeeee");var n=!1,r=function(){u.animate({borderColor:n?"#ffac88":"#E34234"},{duration:1e3,easing:"easeInOutCubic",queue:!1}),n=!n};r(),I=window.setInterval(r,1e3),ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,P,u),R=o},div:function(){return P},update_model:function(){return N()},focus:function(){return h.focus(),this},get_content:function(){return f.content()},get_selection:function(){return this.ace_widget().getSession().doc.getTextRange(this.ace_widget().selection.getRange())},reformat:function(){return k&&(h.resize(),T(),h.resize()),this},check_buttons:function(){return o&&o.set_flag("first",!f.parent_model.prior_cell(f)),this},change_highlights:function(e){if(w=e,k){var t=p.getMarkers();for(var o in t)"rcloud-select"===t[o].type&&p.removeMarker(o);e&&e.forEach(function(t){var e=ui_utils.ace_range_of_character_range(h,t.begin,t.end);p.addMarker(e,te(t.kind),"rcloud-select"),/active/.test(t.kind)&&(h.scrollToLine(e.start.row),window.setTimeout(function(){var e=q.find(".find-highlight."+t.kind);e.size()&&ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,P,q,e)},0))})}else{re();var n=v.find(".find-highlight.active, .find-highlight.activereplaced");n.size()&&ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,P,v,n)}return this},select_highlight_range:function(e,t){this.edit_source(!0);var o=ui_utils.ace_range_of_character_range(h,e,t);h.getSelection().setSelectionRange(o)}}),S.edit_source(!1),S}Notebook.Cell.create_html_view=function(e){return t(e.language(),e)}}(),Notebook.Cell.create_model=function(e,t){var o=-1,n=!1,r=Notebook.Buffer.create_model(e,t),i=r.change_object;return _.extend(r,{id:function(e){return _.isUndefined(e)||e==o||(o=e,this.notify_views(function(e){e.id_updated()})),o},filename:function(){if(arguments.length)throw new Error("can't set filename of cell");return Notebook.part_name(this.id(),this.language())},get_execution_snapshot:function(e){console.assert(e);var t=this.language()||"Text";return{controller:this.controller,json_rep:this.json(),partname:Notebook.part_name(this.id(),t),language:t,versionPromise:e}},set_focus:function(){this.notify_views(function(e){e.edit_source(!0),e.scroll_into_view(!0)})},deselect_cell:function(){return n=!1,this.notify_views(function(e){e.selected_updated()}),n},select_cell:function(){return n=!0,this.notify_views(function(e){e.selected_updated()}),n},toggle_cell:function(){return n=!n,this.notify_views(function(e){e.selected_updated()}),n},hide_cell_result:function(){return this.notify_views(function(e){e.toggle_results(!1)}),!1},show_cell_result:function(){return this.notify_views(function(e){e.toggle_results(!0)}),!0},is_selected:function(){return n},json:function(){return{content:e,language:this.language()}},change_object:function(e){if((e=e||{}).id&&e.filename)throw new Error("must specify only id or filename");if(!e.filename){var t=e.id||this.id();if(0<t!=!0)throw new Error("bad id for cell change object: "+t);e.filename=Notebook.part_name(t,this.language())}return e.rename&&_.isNumber(e.rename)&&(e.rename=Notebook.part_name(e.rename,this.language())),i.call(this,e)}}),r},Notebook.Cell.create_controller=function(s){var l=null;function a(e){return e.history[0].version}return{enqueue_execution_snapshot:function(e){var t=this;if(!l){function o(e){return t.append_result.bind(this,e)}var n=o("code");l={end:this.end_output.bind(this),out:n,err:o("error"),msg:n,html_out:o("html"),deferred_result:o("deferred_result"),selection_out:o("selection"),in:this.get_input.bind(this,"in")}}var r=RCloud.register_output_context(l);t.set_run_state("waiting"),t.edit_source(!1);var i=s.get_execution_snapshot(e.then(a));RCloud.UI.processing_queue.enqueue(function(){return t.set_run_state("running"),s.parent_model.controller.execute_cell_version(r,i)},function(){t.set_run_state("cancelled")})},set_run_state:function(t){s.notify_views(function(e){e.state_changed(t)})},clear_result:function(){s.notify_views(function(e){e.clear_result()})},append_result:function(t,o){s.notify_views(function(e){e.add_result(t,o)})},end_output:function(t){s.notify_views(function(e){t&&!0!==t&&e.add_result("error",t),e.end_output(t)})},get_input:function(e,t,o){var n=_.find(s.views,function(e){return e.get_input});n?n.get_input(e,t,o):o("cell view does not support input",null)},edit_source:function(t){s.notify_views(function(e){e.edit_source(t)})},change_language:function(e){s.language(e)}}},Notebook.Cell.preprocessors=RCloud.extension.create(),Notebook.Cell.postprocessors=RCloud.extension.create(),Notebook.Cell.postprocessors.add({device_pixel_ratio:{sort:1e3,disable:!0,process:function(e){var n=rcloud.display.get_device_pixel_ratio();e.find("img").each(function(e,t){function o(){t.style.width=t.width/n}0===t.width?$(t).on("load",o):o()})}},deferred_results:{sort:2e3,process:function(e){rcloud.deferred_knitr_uuid;e.find("span.deferred-result").each(function(){var n=this,e=[this.textContent.split("|")[1]];e.r_attributes={class:"OCref"},rclient._rserve.wrap_ocap(e)(function(e,t){var o;e?$(n).replaceWith(function(){return ui_utils.string_error(e[0])}):(o=t(),$(n).replaceWith(function(){return o}))})})}},mathjax:{sort:3e3,process:function(e){_.isUndefined(window.MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub])}},shade_pre_r:{sort:4e3,process:function(e){e.find("pre code").filter(function(e,t){return 0<t.classList.length}).parent().toggleClass("r",!0)}},hide_source:{sort:5e3,process:function(e){shell.notebook.controller._r_source_visible||Notebook.hide_r_source(e)}},click_markdown_code:{sort:6e3,process:function(e,t){t.click_to_edit(e.find("pre.r"),!0)}}}),Notebook.Cell.preprocessors.add({quote_deferred_results:{sort:1e3,process:function(){var r,i,s;return function(e){!r!=rcloud.deferred_knitr_uuid&&(r=rcloud.deferred_knitr_uuid,i=new RegExp(r+"\\|[\\+a-zA-Z_0-9.]*","g"),s='<span class="deferred-result">$&</span>');var t=i.exec(e);if(t){for(var o=[],n=0;t;)o.push(e.substring(n,t.index)),o.push(s.replace("$&",e.substr(t.index,t[0].length).replace("+","@"))),n=t.index+t[0].length,t=i.exec(e);o.push(e.substring(n)),e=o.join("")}return e}}()}}),Notebook.create_html_view=function(t,n){var o,r;function i(){_.each(l.sub_views,function(e){e.check_buttons()})}function s(e){e.set_readonly(t.read_only()||shell.is_view_mode()),e.set_show_cell_numbers(o),e.set_autoscroll_notebook_output(r)}var l={model:t,sub_views:[],asset_sub_views:[],cell_appended:function(e){var t=Notebook.Cell.create_html_view(e);return e.views.push(t),n.append(t.div()),this.sub_views.push(t),s(t),i(),t},asset_appended:function(e,t){var o=Notebook.Asset.create_html_view(e);return e.views.push(o),void 0===t?($("#asset-list").append(o.div()),this.asset_sub_views.push(o)):(this.asset_sub_views.splice(t,0,o),$("#asset-list").find("li:eq("+t+")").after(o.div())),i(),o},cell_inserted:function(e,t){var o=Notebook.Cell.create_html_view(e);return e.views.push(o),n.append(o.div()),$(o.div()).insertBefore(n.children(".notebook-cell")[t]),this.sub_views.splice(t,0,o),s(o),i(),o},cell_removed:function(e,t){_.each(e.views,function(e){e.self_removed()}),this.sub_views.splice(t,1),i()},asset_removed:function(e,t){_.each(e.views,function(e){e.self_removed()}),this.asset_sub_views.splice(t,1)},cell_moved:function(e,t,o){this.sub_views.splice(t,1),this.sub_views.splice(o,0,e.views[0]),i()},set_readonly:function(t){_.each(this.sub_views,function(e){e.set_readonly(t)}),_.each(this.asset_sub_views,function(e){e.set_readonly(t)})},set_show_cell_numbers:function(t){o=t,_.each(this.sub_views,function(e){e.set_show_cell_numbers(t)})},set_autoscroll_notebook_output:function(t){r=t,_.each(this.sub_views,function(e){e.set_autoscroll_notebook_output(t)})},update_urls:function(){RCloud.UI.scratchpad.update_asset_url()},update_model:function(){return _.map(this.sub_views,function(e){return e.update_model()})},reformat:function(){_.each(this.sub_views,function(e){e.reformat()})},on_scroll:function(t){r&&_.each(this.sub_views,function(e){e.on_scroll(t)})}};return t.views.push(l),$("#rcloud-cellarea").on("scroll",function(e){l.on_scroll(e)}),l},Notebook.create_model=function(){var t=!1,o="",l=void 0;function i(e){return e.length?e[e.length-1].id():0}return{cells:[],assets:[],views:[],dishers:[],execution_watchers:[],clear:function(){var e=this.remove_cell(null,i(this.cells)),t=this.remove_asset(null,this.assets.length);return RCloud.UI.selection_bar.update(this.cells),e.concat(t)},get_asset:function(t){return _.find(this.assets,function(e){return e.filename()==t})},append_asset:function(t,e,o){t.parent_model=this;var n=[];n.push(t.change_object());var r=this.assets.findIndex(function(e){return t.change_object().filename.localeCompare(e.change_object().filename,void 0,{sensitivity:"base"})<=0});return r<0?this.assets.push(t):this.assets.splice(r,0,t),o||_.each(this.views,function(e){e.asset_appended(t,r)}),n},cell_count:function(){return this.cells.length},selected_count:function(){return _.filter(this.cells,function(e){return e.is_selected()}).length},append_cell:function(t,e,o){t.parent_model=this,t.renew_content();var n=[],r=1;for(e=e||1,e=Math.max(e,i(this.cells)+1);r;)t.id(e),n.push(t.change_object()),this.cells.push(t),o||_.each(this.views,function(e){e.cell_appended(t)}),++e,--r;return RCloud.UI.selection_bar.update(this.cells),n},insert_cell:function(e,t,o){var n=this;e.parent_model=this,e.renew_content();for(var r=[],i=1,s=0;s<this.cells.length&&this.cells[s].id()<t;)++s;if(s<this.cells.length&&t+i>this.cells[s].id()){var l=0<s?this.cells[s-1].id():0;t=Math.max(this.cells[s].id()-i,l+1)}for(var a=0;a<i;++a)r.push(e.change_object({id:t+a})),e.id(t+a),this.cells.splice(s,0,e),o||_.each(this.views,function(e){e.cell_inserted(n.cells[s],s)}),++s;for(;s<this.cells.length&&i;){if(this.cells[s].id()>t){var c=this.cells[s].id()-t;i-=c,t+=c}if(i<=0)break;r.push(this.cells[s].change_object({rename:this.cells[s].id()+i})),this.cells[s].id(this.cells[s].id()+i),++s,++t}return RCloud.UI.selection_bar.update(this.cells),r.reverse()},remove_asset:function(e,t,o){if(0===this.assets.length)return[];var n,r,i=this;if(null!==e){if(n=this.assets.indexOf(e),r=e.filename(),-1===n)throw new Error("asset_model not in notebook model?!")}else n=0,r=this.assets[n].filename();t=t||1;for(var s=n,l=[];s<this.assets.length&&t;)this.assets[s].filename()==r&&(o||_.each(this.views,function(e){e.asset_removed(i.assets[s],s)}),l.push(i.assets[s].change_object({erase:1})),this.assets.splice(s,1)),s<this.assets.length&&(r=this.assets[s].filename()),--t;return l},remove_cell:function(e,t,o){var n,r;if(null!==e){if(n=this.cells.indexOf(e),r=e.id(),-1===n)throw new Error("cell_model not in notebook model?!")}else n=0,r=1;t=t||1;for(var i=n,s=[];i<this.cells.length&&t;){if(this.cells[i].id()==r){var l=this.cells[i];this.cells.splice(i,1),o||_.each(this.views,function(e){e.cell_removed(l,i)}),s.push(l.change_object({erase:1}))}++r,--t}return RCloud.UI.selection_bar.update(this.cells),s},remove_selected_cells:function(){var t=this,o=[];return _.chain(this.cells).filter(function(e){return e.is_selected()}).each(function(e){o=o.concat(t.remove_cell(e))}),RCloud.UI.selection_bar.update(this.cells),o},invert_selected_cells:function(){_.each(this.cells,function(e){e.toggle_cell()}),RCloud.UI.selection_bar.update(this.cells)},hide_selected_cells_results:function(){this.get_selected_cells().length?_.each(this.get_selected_cells(),function(e){e.hide_cell_result()}):_.each(this.cells,function(e){e.hide_cell_result()})},show_selected_cells_results:function(){this.get_selected_cells().length?_.each(this.get_selected_cells(),function(e){e.show_cell_result()}):_.each(this.cells,function(e){e.show_cell_result()})},clear_all_selected_cells:function(){_.each(this.cells,function(e){e.deselect_cell()}),RCloud.UI.selection_bar.update(this.cells)},get_selected_cells:function(){return this.cells.filter(function(e){return e.is_selected()})},crop_cells:function(){var t=this,o=[];return _.chain(this.cells).filter(function(e){return!e.is_selected()}).each(function(e){o=o.concat(t.remove_cell(e))}),RCloud.UI.selection_bar.update(this.cells),o},can_crop_cells:function(){return this.selected_count()&&this.selected_count()!==this.cell_count()},select_all_cells:function(){_.each(this.cells,function(e){e.select_cell()}),RCloud.UI.selection_bar.update(this.cells)},move_cell:function(t,e){var o=this.cells.indexOf(t),n=this.remove_cell(t,1,!0).concat(0<=e?this.insert_cell(t,e,!0):this.append_cell(t,null,!0)),r=this.cells.indexOf(t);return l=r,_.each(this.views,function(e){e.cell_moved(t,o,r)}),n},prior_cell:function(e){var t=this.cells.indexOf(e);return 0<t?this.cells[t-1]:null},subsequent_cell:function(e){var t=this.cells.indexOf(e);return t<this.cells.length-1?this.cells[t+1]:null},change_cell_language:function(e,t){var o=e.filename();return e.language(t),[e.change_object({filename:o,rename:e.filename()})]},select_cell:function(e,t){var n=this,r=function(){_.chain(n.cells).filter(function(e){return e.is_selected()}).each(function(e){e.deselect_cell()})};if(t.is_toggle)e.toggle_cell(),l=this.cells.indexOf(e);else if(t.is_exclusive){var o=e.is_selected()&&1===this.get_selected_cells().length;r(),o?l=void 0:(e.toggle_cell(),l=this.cells.indexOf(e))}else{var i=this.cells.indexOf(e),s=l;!function(e,t){r();for(var o=e;o<=t;o++)n.cells[o].select_cell()}(Math.min(i,s),Math.max(i,s))}RCloud.UI.selection_bar.update(this.cells)},update_cell:function(e){return[e.change_object()]},update_asset:function(e){return[e.change_object()]},reread_buffers:function(){var e=_.map(this.views,function(e){return e.update_model()});if(1!=e.length)throw new Error("not expecting more than one notebook view");for(var t=e[0],o=[],n=0;n<t.length;++n)null!==t[n]&&o.push(this.cells[n].change_object());if(null!==RCloud.UI.scratchpad.update_model()){var r=RCloud.UI.scratchpad.current_model;o.push(r.change_object())}return o},read_only:function(e){return _.isUndefined(e)||(t=e,_.each(this.views,function(e){e.set_readonly(t)})),t},user:function(e){return _.isUndefined(e)||(o=e),o},update_files:function(e){for(var t=0;t<this.assets.length;++t){var o=e[this.assets[t].filename()];o&&this.assets[t].language(o.language)}_.each(this.views,function(e){e.update_urls()})},on_dirty:function(){_.each(this.dishers,function(e){e.on_dirty()})},json:function(){return _.map(this.cells,function(e){return e.json()})}}},Notebook.create_controller=function(u){var c,d,e,n=!1,r=null,f=(e=null,function(){if(!e){var o=editor.load_callback({is_change:!0,selroot:!0});e=function(e){var t=RCloud.UI.navbar.control("save_notebook");return t&&t.disable(),n=!1,r&&(window.clearTimeout(r),r=null),rcloud.refresh_compute_notebook(e.id),o(e)}}return e});function h(e,t,o){var n=Notebook.Cell.create_model(e,t),r=Notebook.Cell.create_controller(n);return{controller:n.controller=r,changes:u.append_cell(n,o)}}function p(e,t){var o=Notebook.Asset.create_model(e,t),n=Notebook.Asset.create_controller(o);return{controller:o.controller=n,changes:u.append_asset(o,t),model:o}}function m(e,t,o){var n=Notebook.Cell.create_model(e,t),r=Notebook.Cell.create_controller(n);return{controller:n.controller=r,changes:u.insert_cell(n,o)}}function g(e,t){return e.collaborators&&e.collaborators.find(function(e){return e.login===t})}function o(e,t){var o;shell.is_view_mode()||(o=editor.get_notebook_info(t.id));var n=o&&o.source||null!==e||t.user.login!==rcloud.username()&&!g(t,rcloud.username())||shell.is_view_mode();if(c=t,d=Promise.resolve(t),u.read_only(n),!_.isUndefined(t.files)){var r;t.description||(t.description="(untitled)"),this.clear();var i,s={},l={};for(r in _.each(t.files,function(e,t){if("r_attributes"!==t&&"r_type"!==t){var o=e.filename;if(Notebook.is_part_name(o)){var n=parseInt(o.slice(4).split(".")[0]);isNaN(n)||(s[n]=[e.content,e.language,n])}else l[o]=[e.content,e.filename]}}),s)h(s[r][0],s[r][1],s[r][2]);for(r in l){var a=p(l[r][0],l[r][1]).controller;i=i||a}u.user(t.user.login),u.update_files(t.files),i?i.select():RCloud.UI.scratchpad.set_model(null),u.read_only(n)}return t}function i(e,t){function o(e){return e.name=function(e){return e},e}var n=[],r=e.files,i=_.extend({},t?t.files:c.files);for(var s in r)"r_type"!==s&&"r_attributes"!==s&&(s in i?(i[s].language==r[s].language&&i[s].content==r[s].content||n.push(o({filename:s,language:i[s].language,content:i[s].content})),delete i[s]):n.push(o({filename:s,erase:!0,language:r[s].language})));for(s in i)"r_type"!==s&&"r_attributes"!==s&&n.push(o({filename:s,language:i[s].language,content:i[s].content}));return n}function v(e,t,o){if(e=e.filter(function(e){return e.content||e.erase||e.rename}),u.read_only())return Promise.reject(new Error("attempted to update read-only notebook"));if(!e.length&&_.isUndefined(o))return d;t=t||shell.gistname();var n,r,i,s,l=(r=e,i={},s={},_.each(r,function(e){e.erase||e.rename?(s[e.filename]?delete i[e.filename]:i[e.filename]=null,e.rename&&(i[e.rename]={content:e.content})):(!e.create||e.filename in i||(s[e.filename]=!0),i[e.filename]={content:e.content})}),n={files:i},_.isUndefined(o)?n:_.extend(_.clone(n),o));return d=rcloud.update_notebook(t,l).then(function(e){if("error"in e)throw e;return c=e,u.update_files(e.files),e}).catch(function(e){throw/non-existent/.test(e.message)&&editor.fatal_reload(e.message),e})}function s(e,t){return(e.length?v(e,t):Promise.resolve(void 0)).then(function(){return l.load_notebook(t,null)})}function b(){return u.reread_buffers()}u.dishers.push({on_dirty:function(){if(!n){var e=RCloud.UI.navbar.control("save_notebook");e&&e.enable(),n=!0}r&&window.clearTimeout(r);var t=shell.autosave_timeout();0<t&&(r=window.setTimeout(function(){l.save(),r=null},t))}});var l={current_gist:function(){return c},append_asset:function(e,t,o){var n=p(e,t);return v(b().concat(n.changes)).then(f()).then(function(e){return n.model.content(e.files[t].content),[e,n.controller]})},cell_count:function(){return u.cell_count()},selected_count:function(){return u.selected_count()},append_cell:function(e,t,o){var n=h(e,t,o);return{controller:n.controller,updatePromise:v(b().concat(n.changes)).then(f())}},insert_cell:function(e,t,o){var n=m(e,t,o);return{controller:n.controller,updatePromise:v(b().concat(n.changes)).then(f())}},remove_cell:function(e){var t=b().concat(u.remove_cell(e));return RCloud.UI.command_prompt.focus(),v(t).then(f())},remove_selected_cells:function(){var e=b().concat(u.remove_selected_cells());return RCloud.UI.command_prompt.focus(),v(e).then(f())},invert_selected_cells:function(){u.invert_selected_cells()},clear_all_selected_cells:function(){u.clear_all_selected_cells()},get_selected_cells:function(){return u.get_selected_cells()},crop_cells:function(){if(!this.can_crop_cells())return Promise.resolve(null);var e=b().concat(u.crop_cells());return RCloud.UI.command_prompt.focus(),v(e).then(f())},can_crop_cells:function(){return u.can_crop_cells()},select_all_cells:function(){u.select_all_cells()},remove_asset:function(e){return v(b().concat(u.remove_asset(e))).then(f())},move_cell:function(e,t){return v(b().concat(u.move_cell(e,t?t.id():-1))).then(f())},hide_cells_results:function(){u.hide_selected_cells_results()},show_cells_results:function(){u.show_selected_cells_results()},join_prior_cell:function(e){var t=u.prior_cell(e);if(!t)return Promise.resolve(void 0);function o(e){return e.length&&"\n"!=e[e.length-1]?e+"\n":e}function n(e,t,o){var n=new RegExp("^```{"+o.toLowerCase()+"}"),r=/```\n$/;return r.test(e)&&n.test(t)?e.replace(r,"")+t.replace(n,""):e+t}function r(e,t){return"```{"+e.toLowerCase()+"}\n"+o(t)+"```\n"}var i,s=b(),l="RMarkdown",a="Markdown";function c(e){return 0<=[a.toLowerCase(),l.toLowerCase()].indexOf(e.toLowerCase())}return t.language()===e.language()?i=n(o(t.content()),e.content(),t.language()):c(t.language())||c(e.language())?c(t.language())&&c(e.language())?(i=n(o(t.content()),e.content(),l),s=s.concat(u.change_cell_language(t,l))):c(t.language())?i=o(t.content())+r(e.language(),e.content()):(i=r(t.language(),t.content())+o(e.content()),s=s.concat(u.change_cell_language(t,e.language()))):(i=r(t.language(),t.content())+r(e.language(),e.content()),(s=s.concat(u.change_cell_language(t,a)))[s.length-1].content=i),t.content(i),s=s.concat(u.update_cell(t)),_.each(t.views,function(e){e.clear_result(),e.hide_source(!1)}),v(s=s.concat(u.remove_cell(e))).then(f())},split_cell:function(e,t,o){var n=b(),r=e.content();if(o<=t&&(o=void 0),void 0!==o&&/^\s*$/.test(r.substring(o))&&(o=void 0),void 0!==t&&(/^\s*$/.test(r.substring(t))?t=void 0:/^\s*$/.test(r.substring(0,t))&&(t=o)),void 0===t)return Promise.resolve(void 0);var i=[r.substring(0,t)],s=e.id(),l=e.language();void 0===o?i.push(r.substring(t)):i.push(r.substring(t,o),r.substring(o)),function(e){for(var t=0;t<e.length-1;++t)!/\n$/.test(e[t])&&/^\n/.test(e[t+1])&&(e[t]=e[t].concat("\n"),e[t+1]=e[t+1].replace(/^\n/,""))}(i),e.content(i[0]),_.each(e.views,function(e){e.clear_result()}),n=n.concat(u.update_cell(e));for(var a=1;a<i.length;++a)n=n.concat(m(i[a],l,s+a).changes);return v(n).then(f())},change_cell_language:function(e,t){return v(b().concat(u.change_cell_language(e,t))).then(f())},select_cell:function(e,t){b().concat(u.select_cell(e,t))},clear:function(){u.clear(),RCloud.UI.scratchpad.clear()},load_notebook:function(e,t){return rcloud.load_notebook(e,t||null).catch(function(e){throw e.from_load=!0,e}).then(_.bind(o,this,t))},create_notebook:function(e){return rcloud.create_notebook(e).then(_.bind(o,this,null))},revert_notebook:function(t,e){return u.read_only(!1),rcloud.load_notebook(t,null).then(function(e){return[i(e),t]}).spread(s)},pull_and_replace_notebook:function(e){return e.files["encrypted.notebook.content.bin.b64"]?Promise.reject(new Error("Can't pull from encrypted notebook")):(u.read_only(!1),s(i(c,e),shell.gistname()))},fork_notebook:function(e,t){return u.read_only(!1),rcloud.fork_notebook(e).then(function(e){return t?rcloud.get_notebook(e.id,null).then(function(e){return[i(e),e.id]}):[[],e.id]}).spread(s)},update_cell:function(e){return v(b().concat(u.update_cell(e))).then(f())},update_asset:function(t){return v(b().concat(u.update_asset(t))).then(function(e){return t.content(e.files[t.filename()].content),e}).then(f())},rename_notebook:function(e){return v(b(),null,{description:e}).then(f())},apply_changes:function(e){return v(e).then(f())},save:function(){return n?v(b()).then(f()):Promise.resolve(d)},execute_cell_version:function(n,r){function t(e){if(e&&e.r_attributes){if("parse-error"===e.r_attributes.class)throw RCloud.end_cell_output(n,"Parse error: "+e.error),"stop";if("cell-eval-error"===e.r_attributes.class){var t=e.traceback||"";t.join&&(t=t.join("\n"));var o=!t||"trace:\n"+t;throw RCloud.end_cell_output(n,o),"stop"}RCloud.end_cell_output(n,null)}else RCloud.end_cell_output(n,null);_.each(u.execution_watchers,function(e){e.run_cell(r.json_rep)})}rcloud.record_cell_execution(r.json_rep);var o=rcloud.authenticated?rcloud.authenticated_cell_eval:rcloud.session_cell_eval;return r.versionPromise.then(function(e){return o(n,r.partname,r.language,e,!1).then(t)})},run_all:function(){var t=this.save();return _.each(u.cells,function(e){e.controller.enqueue_execution_snapshot(t)}),t},run_from:function(t){var o=!1,n=this.save();return _.each(u.cells,function(e){(o||e.id()===t)&&(o=!0,e.controller.enqueue_execution_snapshot(n))}),n},run_cells:function(t){var o=this.save();return _.each(u.cells,function(e){-1<t.indexOf(e.id())&&e.controller.enqueue_execution_snapshot(o)}),o},show_cell_numbers:function(t){return _.each(u.views,function(e){e.set_show_cell_numbers(t)}),this},autoscroll_notebook_output:function(t){return _.each(u.views,function(e){e.set_autoscroll_notebook_output(t)}),this},is_mine:function(){return rcloud.username()===u.user()||g(this.current_gist(),rcloud.username())},_r_source_visible:!0,hide_r_source:function(){this._r_source_visible=!1,RCloud.UI.advanced_menu.check("show_source",!1),Notebook.hide_r_source()},show_r_source:function(){this._r_source_visible=!0,RCloud.UI.advanced_menu.check("show_source",!0),Notebook.show_r_source()}};return u.controller=l},Notebook.hide_r_source=function(e){(e=e?$(e).find(".r"):$(".r")).hide()},Notebook.show_r_source=function(e){(e=e?$(e).find(".r"):$(".r")).show()},Notebook.is_binary_content=function(e){return!_.isUndefined(e.byteLength)&&!_.isUndefined(e.slice)},Notebook.read_from_file=function(e,t){var o,n=new FileReader;t=_.defaults(t,{on_load_end:$.noop,on_error:$.noop,on_notebook_parse_complete:$.noop}),n.onloadend=function(e){t.on_load_end();try{if(!(o=JSON.parse(n.result)).description)return void t.on_error("Invalid notebook format: has no description");if(!o.files||_.isEmpty(o.files))return void t.on_error("Invalid notebook format: has no files");o=Notebook.sanitize(o),t.on_notebook_parsed(o)}catch(e){t.on_error("Invalid notebook format: couldn't parse JSON")}},n.readAsText(e)},RCloud.discovery_model=function(){var i={};return{get_notebooks:function(e,t){t=_.filter(t,function(e){return e.length&&"r"!==e[0]});var o=_.difference(t,Object.keys(i));return(o.length?Promise.all([rcloud.get_multiple_notebook_infos(o),rcloud.stars.get_multiple_notebook_star_counts(o),e?Promise.resolve([]):rcloud.stars.get_my_starred_notebooks(),rcloud.get_multiple_fork_counts(o)]).spread(function(t,o,e,n){var r;delete(r=t).r_attributes,delete r.r_type,t=r,Object.keys(t).forEach(function(e){t[e].stars=o[e]||0,t[e].forks=n[e]||0}),_.extend(i,t),_.each(e,function(e){i[e]&&(i[e].is_starred_by_me=!0)})}):Promise.resolve()).then(function(){return _.pick(i,t)})}}}(),Notebook.part_name=function(e,t){if(_.isString(e))return e;var o=RCloud.language.extension(t);if(_.isUndefined(o))throw new Error("Unknown language "+t);return"part"+e+"."+o},Notebook.empty_for_github=function(e){return/^\s*$/.test(e)},Notebook.is_part_name=function(e){return e.match(/^part\d+\./)},Notebook.sanitize=function(e){var t=(e=_.pick(e,"description","files")).files;for(var o in delete t.r_attributes,delete t.r_type,t)t[o]=_.pick(t[o],"content");return e},Notebook.valid_gist_id=function(e){return null!==e.match(/^[a-f0-9]*$/i)&&-1!==[20,32].indexOf(e.length)},function(){function r(e,t){RCloud.UI.session_pane.append_text(t)}function s(e){var t=arguments[1],o=Array.prototype.slice.call(arguments,2),n=i[t];return console.log("forward_to_context, ctx="+t+", type="+e+", old.ctx="+n),n&&n[e]?(n[e].apply(n,o),!0):(r(0,o[0]),!1)}function e(e,t,o,n,r,i){(console.log("handle_img ",e," device ",r," page ",i," url ",o),o)&&s("selection_out",t,RCloud.UI.image_manager.update(o,n,r,i).div())}var i={},t=17;function o(e,t){return function(){!s.apply(null,[e].concat(Array.prototype.slice.call(arguments,0)))&&t&&arguments[arguments.length-1]("context does not support input",null)}}RCloud.register_output_context=function(e){return i[t]=e,t++},RCloud.unregister_output_context=function(e){delete i[e]},RCloud.end_cell_output=function(e,t){s("end",e,t),RCloud.unregister_output_context(e)};var n={browsePath:function(e,t){var o=" "+window.location.protocol+"//"+window.location.host+t+" ";RCloud.UI.help_frame.display_href(o)},browseURL:function(e,t){window.open(t,"_blank")},pager:function(e,t,o,n){for(var r="<h2>"+n+"</h2>\n",i=0;i<t.length;++i)_.isArray(o)&&o[i]&&(r+="<h3>"+o[i]+"</h3>\n"),r+="<pre>"+t[i]+"</pre>";RCloud.UI.help_frame.display_content(r)},editor:function(e,t,o,n){r(0,"what: "+t+"\ncontents:"+o+"\nname: "+n+"\n")},"console.out":o("out"),"console.msg":o("msg"),"console.err":o("err"),"img.url.update":e.bind(null,"img.url.update"),"img.url.final":e.bind(null,"img.url.final"),stdout:r,stderr:r,"html.out":o("html_out"),"deferred.result":o("deferred_result"),compute_terminated:function(){RCloud.UI.fatal_dialog("Your compute session died. Reload the notebook and start a new session?","Reload",function(){editor.load_notebook(shell.gistname(),shell.version())})}};function l(e){e=e.value.json(),console.log("OOB send arrived: ['"+e[0]+"']"+(n[e[0]]?"":" (unhandled)")),n[e[0]]&&n[e[0]].apply(null,e.slice(1))}var a={"console.in":o("in",!0)};function c(e,t){e=e.value.json(),console.log("OOB message arrived: ['"+e[0]+"']"+(a[e[0]]?"":" (unhandled)")),a[e[0]]?(e.push(t),a[e[0]].apply(null,e.slice(1))):t("unhandled",null)}function u(e){var t="Could not initialize session. The GitHub backend might be down or you might have an invalid authorization token. (You could try clearing your cookies, for example).";return e&&(t+="<br />Error: "+e.toString()),t}function d(o){return function(e){if(window.rclient&&rclient.close(),"Authentication required"===e.message)RCloud.session.first_session_?window.location=ui_utils.relogin_uri(o):RCloud.UI.fatal_dialog("Your session has been logged out.","Reconnect",ui_utils.relogin_uri(o));else{var t=e.message||e.error||e;RCloud.UI.fatal_dialog(u(t),"Logout","/logout.R")}throw e}}function f(r,e){return new Promise(function(t,o){rclient=RClient.create({debug:!1,mode:"IDE",host:location.href.replace(/^http/,"ws").replace(/#.*$/,""),on_connect:function(e){t(e)},on_data:l,on_oob_message:c,on_error:function(e){return o(e),!1}}),rclient.allow_anonymous_=r}).then(function(e){var t,o,n;return r?(t=e,rcloud=RCloud.create(t.rcloud),rcloud.authenticated?(o=rcloud.compute_init(rcloud.username(),rcloud.github_token()),n=rcloud.session_init(rcloud.username(),rcloud.github_token())):(o=rcloud.anonymous_compute_init(),n=rcloud.anonymous_session_init()),o.catch(function(e){RCloud.UI.fatal_dialog(u(e),"Logout","/logout.R")}),n.catch(function(e){RCloud.UI.fatal_dialog(u(e),"Logout","/logout.R")}),Promise.all([o,n])):function(e){if(rcloud=RCloud.create(e.rcloud),!rcloud.authenticated)return Promise.reject(new Error("Authentication required"));var t=rcloud.compute_init(rcloud.username(),rcloud.github_token()),o=rcloud.session_init(rcloud.username(),rcloud.github_token());return Promise.all([t,o])}(e)}).then(function(e){$("#output > .response").length||rclient.post_response(e)}).catch(e).then(function(){return Promise.all([rcloud.get_conf_value("exec.token.renewal.time").then(function(t){if(t){t*=1e3;var o=function(){rcloud.replace_token($.cookies.get("execToken"),"rcloud.exec").then(function(e){$.cookies.set("execToken",e),setTimeout(o,t)})};setTimeout(o,t)}}),rcloud.display.set_device_pixel_ratio(),rcloud.api.set_url(window.location.href),rcloud.languages.get_list().then(function(e){RCloud.language._set_available_languages(_.omit(e,"r_type","r_attributes"))}),RCloud.UI.image_manager.load_available_formats(),rcloud.init_client_side_data()])})}RCloud.session={first_session_:!0,listeners:[],reset:function(e){return this.first_session_?(this.first_session_=!1,RCloud.UI.with_progress(function(){})):(this.listeners.forEach(function(e){e.on_reset()}),on_connect_error_handler=d(e),RCloud.UI.with_progress(function(){var e=rclient.allow_anonymous_;return rclient.close(),f(e,on_connect_error_handler)}))},init:function(e,t){return this.first_session_=!0,d(),f(e)},on_data:l,on_oob_message:c,invoke_context_callback:s}}(),RCloud.language=function(){var o={CSS:{ace_mode:"ace/mode/css"},JavaScript:{ace_mode:"ace/mode/javascript"},Text:{ace_mode:"ace/mode/text",extension:"txt"},HTML:{ace_mode:"ace/mode/html"}},n=[];return{is_a_markdown:function(e){return!!o[e]&&o[e].is_a_markdown},ace_mode:function(e){var t=o[e]&&o[e].ace_mode||o.Text.ace_mode;return(ace.require(t)||ace.require(o.Text.ace_mode)).Mode},extension:function(e){var t=o[e]&&o[e].extension||"";return _.isArray(t)&&(t=t[0]),t},hljs_class:function(e){return o[e]&&o[e].hljs_class||null},_set_available_languages:function(e){for(var t in n=[],e)n.push(t),o[t]=o[t]||{},o[t].is_a_markdown=e[t]["is.a.markdown"],o[t].ace_mode=e[t]["ace.mode"],o[t].hljs_class=e[t]["hljs.class"],o[t].extension=e[t].extension},available_languages:function(){return n.slice()}}}(),function(){function o(e){if(_.isBoolean(e)||_.isUndefined(e))e={force:!!e};else if(!_.isObject(e))throw new Error("didn't understand options "+e);return(e=$.extend({force:!1},e)).files||(e.files=e.$file?e.$file[0].files:[]),e}RCloud.upload_assets=function(e,s){s=s||{},e=o(e);var l=!1,a={};if(e.filenames&&e.files.length===e.filenames.length){l=!0;for(var t=0;t<e.filenames.length;t++)a[e.files[t].name]=e.filenames[t]}return RCloud.utils.promise_sequence(e.files,function(i){return 25e5<i.size?Promise.reject(new Error("File "+i.name+" rejected: maximum asset size is 2.5MB")):Promise.promisify(function(e,t){var o=new FileReader;o.onload=function(e){t(null,o.result)},o.onerror=function(e){t(o.error,null)},o.readAsArrayBuffer(e.slice(0,e.size))})(i).then(function(e){if(_.isString(e)&&Notebook.empty_for_github(e))throw new Error("empty");return t=l?a[i.name]:i.name,o=e,(r=shell.notebook.model.get_asset(t))?(s.replace&&s.replace(t),r.content(o),n=shell.notebook.controller.update_asset(r).return(r.controller)):(s.add&&s.add(t),n=shell.notebook.controller.append_asset(o,t).then(function(){return shell.notebook.model.get_asset(t).controller})),n.then(function(e){e.select()});var t,o,n,r})})},RCloud.upload_files=function(n,r){var i=n.upload_ocaps||rcloud._ocaps.file_upload;r=r||{},n=o(n);var d,f,s=(d=i,f=r,Promise.promisify(function(n,r,i){var s=new FileReader,l=131072,a=n.size,c=0,u=0;f.start&&f.start(n.name),s.readAsArrayBuffer(n.slice(c,c+l)),s.onload=function(e){var t;if(f.progress&&f.progress(u,a),0<e.target.result.byteLength){var o=new Uint8Array(e.target.result);t=d.writeAsync(o.buffer).then(function(){u+=e.target.result.byteLength,c+=l,s.readAsArrayBuffer(n.slice(c,c+l))})}else t=d.closeAsync().then(function(){f.done&&f.done(r,n.name),i(null,!0)});t.catch(function(e){i(e,null)})}}));return window.File&&window.FileReader&&window.FileList&&window.Blob?_.isUndefined(n.files)||!n.files.length?Promise.reject(new Error("No files selected!")):i.upload_pathAsync().then(function(e){return RCloud.utils.promise_sequence(n.files,function(e,t){var o=e+"/"+t.name;return i.createAsync(o,n.force).catch(function(e){if(r.confirm_replace&&/exists/.test(e.message))return r.confirm_replace(t.name).then(function(e){return e?i.createAsync(o,!0).return("overwrite"):Promise.resolve(!1)});throw e}).then(function(e){return e?s(t,"overwrite"===e):Promise.resolve(void 0)})}.bind(null,e))}):Promise.reject(new Error("File API not supported by browser."))}}(),RCloud.UI={},RCloud.UI.tree={},RCloud.UI.event=function(e){var t=function(e){this._sender=e,this._listeners=[]};return t.prototype={attach:function(e){this._listeners.push(e)},notify:function(e){var t;for(t=0;t<this._listeners.length;t+=1)this._listeners[t](this._sender,e)}},t}(),RCloud.UI.advanced_menu=function(){var e,t={init:function(){(e=RCloud.UI.menu.create()).init(),d3.rebind(t,e,"add","remove","check","uncheck","enable","create"),RCloud.UI.menus.add({advanced_menu:{sort:5e3,type:"menu",title:"Advanced",modes:["view","edit"],menu:e}}),e.add({open_in_github:{sort:1e3,text:"Open in GitHub",modes:["view","edit"],disabled_reason:"The notebook source does not support a web interface",action:function(){shell.github_url().then(function(e){e?window.open(e,"_blank"):alert("Sorry, Open in GitHub is not supported for this notebook source.")})}},open_from_github:{sort:2e3,text:"Load Notebook by ID",modes:["edit"],action:function(){var e=prompt("Enter notebook ID or github URL:");null!==e&&shell.open_from_github(e)}},show_source:{sort:9e3,text:"Show Source",checkbox:!0,value:!0,modes:["view"],action:function(e){e?shell.notebook.controller.show_r_source():shell.notebook.controller.hide_r_source()}},publish_notebook:{sort:1e4,text:"Publish Notebook",checkbox:!0,modes:["edit"],disabled_reason:"You can't publish someone else's notebook",action:function(e){function t(t,o){return function(e){e||console.log("Failed to "+(o?"un":"")+"publish notebook "+t)}}e?rcloud.publish_notebook(editor.current().notebook).then(t(editor.current().notebook,!1)):rcloud.unpublish_notebook(editor.current().notebook).then(t(editor.current().notebook,!0))}}})}};return t}(),RCloud.UI.cell_commands=function(){var l;return{create_button:function(e,t,o){var n=ui_utils.fa_button(e,t);return n.click(function(e){$(".tooltip").remove(),$(e.currentTarget).hasClass("button-disabled")||o(n,e)}),{control:n,enable:function(){ui_utils.enable_fa_button(n)},disable:function(){ui_utils.disable_fa_button(n)}}},create_select:function(t,o){var n=$("<select class='form-control cell-control-select'></select>");return n.append.apply(n,t.map(function(e){return $("<option></option>").text(e)})),n.change(function(){var e=n.val();o(e)}),{control:n,enable:function(){n.prop("disabled",!1)},disable:function(){n.prop("disabled","disabled")},set:function(e){if(t.indexOf(e)<0)throw new Error("tried to select unknown value "+e);n.val(e)}}},create_static:function(e,t,o){var n=$("<span><span/>").html(e),r=t?t(n):n;return o&&o(r),{control:r,enable:function(){},disable:function(){},set:function(e){return n.html(e),this},get:function(){return n}}},create_icon:function(e,t,o){var n=this.create_static("<i></i>");return(n=_.extend(n,{icon:function(e){return n.get().find("i").attr("class",e),this},color:function(e){return n.get().find("i").css("color",e),this},title:function(e){return n.get().find("i").attr("title",e),this}})).get().attr("class","state-icon left-indicator"),n.icon(e).color(t),n},init:function(){l=RCloud.extension.create({defaults:{},sections:{above:{filter:RCloud.extension.filter_field("area","above")},cell:{filter:RCloud.extension.filter_field("area","cell")},prompt:{filter:RCloud.extension.filter_field("area","prompt")},left:{filter:RCloud.extension.filter_field("area","left")}}});var s=this;return this.add({insert:{area:"above",sort:1e3,enable_flags:["modify"],create:function(t){return s.create_button("icon-plus-sign","insert cell",function(){var e=shell.insert_cell_before("",t.language(),t.id());e.updatePromise.then(function(){e.controller.edit_source(!0)})})}},join:{area:"above",sort:2e3,enable_flags:["modify"],display_flags:["!first"],create:function(e){return s.create_button("icon-link","join cells",function(){shell.join_prior_cell(e)})}},language_cell:{area:"cell",sort:1e3,enable_flags:["modify"],create:function(t,o){var e=RCloud.language.available_languages();return e.indexOf(t.language())<0&&e.push(t.language()),s.create_select(e,function(e){t.parent_model.controller.change_cell_language(t,e),o.clear_result(),o.edit_source(!0)})}},run:{area:"cell",sort:2e3,create:function(o,n){return s.create_button("icon-play","run",function(e,t){t.shiftKey?shell.run_notebook_from(o.id()):n.execute_cell()})}},edit:{area:"cell",sort:3e3,create:function(e,t){return s.create_button("icon-edit borderable","toggle edit mode",function(){e.parent_model.read_only()?t.toggle_source():t.toggle_edit()})}},results:{area:"cell",sort:3500,create:function(e,t){return s.create_button("icon-picture borderable","show/hide results",function(){t.toggle_results()})}},command_gap:{area:"cell",sort:3500,create:function(e){return s.create_static("&nbsp;")}},split:{area:"cell",sort:4e3,enable_flags:["modify","edit"],create:function(r,i){return s.create_button("icon-unlink","split cell",function(){var e=i.ace_widget();if(e){var t,o,n=e.getSelection().getRange();t=ui_utils.character_offset_of_pos(e,n.start),n.isEmpty()||(o=ui_utils.character_offset_of_pos(e,n.end)),shell.split_cell(r,t,o)}})}},remove:{area:"cell",sort:5e3,enable_flags:["modify"],create:function(e){return s.create_button("icon-trash","remove",function(){e.parent_model.controller.remove_cell(e)})}},selection:{area:"left",sort:1250,display_flags:["modify"],create:function(t){return s.create_static("<input type='checkbox'></input>",function(e){return $("<span class='cell-selection'>").append(e)},function(e){e.click(function(e){t.parent_model.controller.select_cell(t,{is_toggle:!e.shiftKey,is_range:e.shiftKey})})})}},left_gap:{area:"left",sort:1500,display_flags:["!modify"],create:function(e){return s.create_static("&nbsp;")}},run_state:{area:"left",sort:2e3,create:function(e){return s.create_icon("icon-circle-blank","#777")}},cell_number:{area:"left",sort:3e3,display_flags:["cell-numbers"],create:function(e){return s.create_static(e.id(),function(e){return $("<span class='left-indicator cell-number'></span>").append("cell ",e)},function(e){})}}}),this},add:function(e){return l&&l.add(e),this},remove:function(e){return l&&l.remove(e),this},decorate:function(e,t,o,n){return function(n,e,t,o){var r=l.create(n,t,o);r.array.forEach(function(e){e.control.addClass("cell-control")});var i={};return e.append.apply(e,_.pluck(r.array,"control")),{controls:r.map,set_flag:function(e,t){var o=function(e){var t;return"!"==e.substr(0,1)&&(t=!0,e=e.substr(1)),t^i[e]};i[e]=t,l.entries(n).forEach(function(e){_.every(e.enable_flags,o)?r.map[e.key].enable():r.map[e.key].disable(),_.every(e.display_flags,o)?r.map[e.key].control.show():r.map[e.key].control.hide()})}}}(e,t,o,n)}}}(),RCloud.UI.column=function(t){var o;function n(e){return"col-md-"+e+" col-sm-"+e}return{init:function(){var e=$(t);0!==e.length&&e.attr("class").split(/\s+/).forEach(function(e){var t=/^col-(?:md|sm)-(\d+)$/.exec(e);if(t)if(t=+t[1],void 0===o)o=t;else if(o!==t)throw new Error("mismatched col-md- or col-sm- in column classes")})},colwidth:function(e){return _.isUndefined(e)||e==o||($(t).removeClass(n(o)).addClass(n(e)),o=e),o}}},RCloud.UI.collapsible_column=function(y,k,o){var r=!1,e=RCloud.UI.column(y),n=e.init.bind(e),t=e.colwidth.bind(e);function w(){return $(k+" > .panel > div.panel-collapse:not(.out)")}function s(e,t,o){if(e.data("would-collapse")==t)return!1;if(e.data("would-collapse",t),o&&rcloud.config&&e.length){var n="ui/"+e[0].id;rcloud.config.set_user_option(n,t)}return!0}function i(){return $.makeArray(w()).every(function(e){return $(e).hasClass("out")||!0===$(e).data("would-collapse")})}function l(e){return e.replace("#","ui/")}return $(k).data("collapsible-column",e),_.extend(e,{init:function(){var t=this;n(),w().each(function(){$(this).data("would-collapse",!$(this).hasClass("in")&&!$(this).hasClass("out"))}),$(k+" > .panel > div.panel-heading").click(function(){var e=$(this.dataset.target);return t.collapse(e,e.hasClass("in")),!1}),w().on("size-changed",function(){t.resize(!0)}),w().on("shown.bs.collapse",function(){var e=$(this).find("iframe");if(e)for(var t=0;t<e.length;t++){var o=e.get(t);o.contentDocument&&o.contentDocument.location&&o.contentDocument.location.reload(!0)}}),$(o).click(function(){r?t.show(!0):t.hide(!0)})},load_options:function(){var i=this,e=$.makeArray(w()).map(function(e){return"#"+e.id});e.push(k);var t=e.map(l);return rcloud.config.get_user_option(t).then(function(e){var t;for(var o in e){var n=o.replace("ui/","#");n===k?t=e[o]:"boolean"==typeof e[o]&&s($(n),e[o],!1)}var r=!1;void 0===t&&(r=!(t=!1)),t?i.hide(r):i.show(r)})},colwidth:function(e){return e=t(e),w().trigger("panel-resize"),e},collapse:function(e,t,o){if(void 0===o&&(o=!0),r)return w().each(function(){this===e[0]?s($(this),!1,o):s($(this),!0,o)}),void this.show(!0);var n=s(e,t,o);i()?this.hide(o,!n):this.show(o,!n)},resize:function(e){if(!e){var t=this.calcwidth();this.colwidth(t)}RCloud.UI.middle_column.update();var o={},n={},r=w(),i=(r.length,null);r.each(function(){if(!$(this).hasClass("out")&&!$(this).data("would-collapse")){var e=$(this).data("panel-sizer"),t=e?e(this):RCloud.UI.collapsible_column.default_sizer(this);o[this.id]=t.height,n[this.id]=t.padding,i||"greedy"!==$(this).attr("data-widgetheight")||(i=$(this))}});var s=$(y).height(),l=d3.sum($(k+" .panel-heading").map(function(e,t){return $(t).outerHeight()}));for(var a in s-=l,n)s-=n[a];var c=s,u=!1;for(a in o)c-=o[a];if(0<=c)null!==i&&(o[i.get(0).id]+=c,u=!0);else{c=s;for(var d,f=_.keys(o),h=!1,p=c/f.length;f.length&&!h;){for(h=!0,d=0;d<f.length;++d)o[f[d]]<p&&(c-=o[f[d]],f.splice(d,1),--d,h=!1);p=c/f.length}for(d=0;d<f.length;++d)o[f[d]]=p;u=!0}for(a in o){$el=$("#"+a);var m=$el.find(".panel-fixed-header");if(m.length){var g=m.outerHeight();$el.find(".panel-scrollable-content").height(o[a]-g)}else $el.find(".panel-body").height(o[a]);$el.trigger("panel-resize")}$(k+" .panel-shadow").each(function(e){var t=$(this).parent().find(".panel-body").outerHeight();0===t&&(t="100%"),$(this).attr("height",t)});var v=$(y).height(),b=d3.sum(_.values(n))+d3.sum(_.values(o))+l;u&&v!=b&&console.log("Error in vertical layout algo: filling "+v+" pixels with "+b)},hide:function(e,t){w().each(function(){var e=$(this).data("heading-content-selector");e&&e.hide()}),$(k+" > .panel > div.panel-collapse:not(.collapse):not(.out)").collapse("hide"),$(o+" i").removeClass("icon-minus").addClass("icon-plus"),$(o).attr("title","Expand Pane"),r=!0,this.resize(t),e&&rcloud.config&&rcloud.config.set_user_option(l(k),!0)},show:function(e,t){w().each(function(){var e=$(this).data("heading-content-selector");e&&e.show()}),i()&&s($(w()[0]),!1,!0),w().each(function(){$(this).collapse($(this).data("would-collapse")?"hide":"show")}),$(o+" i").removeClass("icon-plus").addClass("icon-minus"),$(o).attr("title","Collapse Pane"),r=!1,this.resize(t),e&&rcloud.config&&rcloud.config.set_user_option(l(k),!1)},calcwidth:function(){if(r)return 1;var t=[];return w().each(function(){var e=$(this).data("would-collapse")?1:$(this).attr("data-colwidth");0<e&&t.push(e)}),d3.max(t)}}),e},RCloud.UI.collapsible_column.default_padder=function(e){var t=$(e),o=t.find(".panel-body"),n=o.find(".panel-fixed-header"),r=o.find(".panel-scrollable-content");return t.outerHeight()-t.height()+o.outerHeight()-o.height()+(n.length?r.outerHeight()-r.height():0)},RCloud.UI.collapsible_column.default_sizer=function(e){var t=$(e).find(".widget-vsize").height();return padding=RCloud.UI.collapsible_column.default_padder(e),{height:t,padding:padding}},RCloud.UI.column_sizer={init:function(){$(".notebook-sizer").draggable({axis:"x",opacity:.75,zindex:1e4,revert:!0,revertDuration:0,grid:[window.innerWidth/12,0],stop:function(e,t){var o,n,r=window.innerWidth/12;if($(this).hasClass("left"))o=Math.round(t.position.left/r),1===(n=Math.max(1,Math.min(+RCloud.UI.left_panel.colwidth()+o,11-RCloud.UI.right_panel.colwidth())))?RCloud.UI.left_panel.hide(!0,!0):RCloud.UI.left_panel.show(!0,!0),RCloud.UI.left_panel.colwidth(n),RCloud.UI.middle_column.update();else{if(!$(this).hasClass("right"))throw new Error("unexpected shadow drag with classes "+$(this).attr("class"));o=Math.round(t.position.left/r)-RCloud.UI.middle_column.colwidth(),1===(n=Math.max(1,Math.min(+RCloud.UI.right_panel.colwidth()-o,11-RCloud.UI.left_panel.colwidth())))?RCloud.UI.right_panel.hide(!0,!0):RCloud.UI.right_panel.show(!0,!0),RCloud.UI.right_panel.colwidth(n),RCloud.UI.middle_column.update()}$(this).css({left:"",right:"",top:""})}}),$(window).resize(function(){var e=window.innerWidth/12;$(".notebook-sizer").draggable("option","grid",[e,0])})}},RCloud.UI.command_prompt=function(){var r,d,n=!1,i=!0,f=null,o=null,h=null,s=null;function t(){var e=$("#prompt-area"),t=$("#command-prompt"),o=$("#prompt-area .cell-status .cell-control-bar");i?e.hide():(e.show(),n?(t.show(),o.removeClass("flipped")):(t.hide(),o.addClass("flipped")))}var p={init:function(){RCloud.UI.cell_commands.add({insert_prompt:{area:"prompt",modifying:!0,sort:1e3,create:function(){return RCloud.UI.cell_commands.create_button("icon-plus","insert new cell",function(){var e=shell.new_cell("",h);e.updatePromise.then(function(){e.controller.edit_source(!0)})})}},language_prompt:{area:"prompt",modifying:!0,sort:2e3,create:function(){return RCloud.UI.cell_commands.create_select(RCloud.language.available_languages(),function(e){window.localStorage.last_cell_lang=e,RCloud.UI.command_prompt.language(e,!0)})}}});var e=$(RCloud.UI.panel_loader.load_snippet("command-prompt-snippet"));$("#rcloud-cellarea").append(e);var t=$("#prompt-area .cell-control-bar");s=RCloud.UI.cell_commands.decorate("prompt",t),f=function(){var r=[],i=[],s=0;function l(){return i[s]||(s<r.length?r[s]:"")}var a=null;return{init:function(){a="rcloud.history."+shell.gistname()+".";var e=0;r=[],i=[];for(var t=window.localStorage.last_cell_lang||"R";;){var o=window.localStorage[a+e],n=window.localStorage[a+e+".alt"];if(void 0!==n&&(i[e]=n),void 0===o)break;r.push(o),++e}return s=r.length,{cmd:l(),lang:t}},add_entry:function(e){""!==e&&(i[r.length]=null,r.push(e),i[s]=null,s=r.length,window.localStorage[a+(s-1)]=e)},has_last:function(){return 0<s},last:function(){return 0<s&&--s,l()},has_next:function(){return s<r.length},next:function(){return s<r.length&&++s,l()},change:function(e){window.localStorage[a+s+".alt"]=i[s]=e}}}(),o=function(){var e=$("#command-prompt");if(!e.length)return null;function t(){e.css({height:ui_utils.ace_editor_height(n,5)+6+"px"}),n.resize(),shell.scroll_to_end(0)}e.css({"background-color":"#fff"}),e.addClass("r-language-pseudo"),ace.require("ace/ext/language_tools");var n=ace.edit(e[0]);r=n,t(),ace.require("ace/mode/r").Mode;var i=n.getSession();(d=i).doc,n.setOptions({enableBasicAutocompletion:!0}),i.on("change",t),n.setTheme("ace/theme/chrome"),i.setNewLineMode("unix"),i.setOption("indentedSoftWrap",!1),i.setUseWrapMode(!0),n.resize();var s=ui_utils.ignore_programmatic_changes(n,f.change.bind(f));function o(e,t,o){var n=i.getValue();if(n.length){RCloud.UI.command_prompt.history().add_entry(n);var r=shell.new_cell(n,h);shell.scroll_to_end(),r.controller.enqueue_execution_snapshot(r.updatePromise),s("")}}function l(e){return e.getSession().getDocument().getLength()-1}function a(e,t){return e.getSession().getDocument().getLine(t).length}ui_utils.install_common_ace_key_bindings(n,p.language.bind(p));var c=n.commands.commandKeyBinding.up,u=n.commands.commandKeyBinding.down;return n.commands.addCommands([{name:"execute",bindKey:{win:"Return",mac:"Return",sender:"editor"},exec:o},{name:"execute-2",bindKey:{win:"Alt-Return",mac:"Alt-Return",sender:"editor"},exec:o},{name:"up-with-history",bindKey:"up",exec:function(e,t,o){var n=e.getCursorPositionScreen();if(0<n.row)c.exec(e,t,o);else if(f.has_last()){s(f.last());var r=e.getSession().getScreenLength();ui_utils.ace_set_pos(e,r,n.column)}else ui_utils.ace_set_pos(e,0,0)}},{name:"down-with-history",bindKey:"down",exec:function(e,t,o){var n=e.getCursorPositionScreen(),r=e.getSession().getScreenLength();n.row<r-1?u.exec(e,t,o):f.has_next()?(s(f.next()),ui_utils.ace_set_pos(e,0,n.column)):(r=l(e),ui_utils.ace_set_pos(e,r,a(e,r)))}},{name:"blurCell",bindKey:{win:"Escape",mac:"Escape"},exec:function(){r.blur()}}]),n.commands.removeCommands(["find","replace"]),ui_utils.customize_ace_gutter(n,function(e){return 0===e?"&gt;":"+"}),{widget:n,restore:function(){var e=f.init();if(!_.contains(RCloud.language.available_languages(),e.lang)){var t=RCloud.language.available_languages()[0];console.error("Language "+e.lang+" is not available. Using "+t+" to restore prompt widget."),e={cmd:"",lang:t}}s(e.cmd),p.language(e.lang);var o=l(n);ui_utils.ace_set_pos(n,o,a(n,o))},set_language:function(e){var t=RCloud.language.ace_mode(e);i.setMode(new t({suppressHighlighting:!1,doc:i.doc,session:i,language:e}))}}}()},history:function(){return f},show_prompt:function(e){return arguments.length?(n=e,t(),this):n},readonly:function(e){return arguments.length?(i=e,t(),this):i},language:function(e,t){return void 0===e?h:(h=e,t||s.controls.language_prompt.set(h),o.set_language(h),this)},focus:function(){o&&(o.widget.focus(),o.restore())},ace_widget:function(){return r},get_selection:function(){return n?d.doc.getTextRange(r.selection.getRange()):void 0}};return p}(),RCloud.UI.comments_frame=function(){var n=!1;var i={body:function(){return RCloud.UI.panel_loader.load_snippet("comments-snippet")},init:function(){var t=this,o=$("#comment-entry-body"),n=0,r="";$("#comment-submit").click(function(){return Notebook.empty_for_github(o.val())||(t.post_comment(_.escape(o.val())),o.height("41px")),!1}),o.keydown(function(e){if(e.keyCode==$.ui.keyCode.ENTER&&(e.ctrlKey||e.metaKey))return Notebook.empty_for_github(o.val())||(t.post_comment(_.escape(o.val())),o.height("41px"),n=0,r=""),!1;o.bind("input",function(){return 1<n&&r!=o[0].scrollHeight&&o.height(o[0].scrollHeight+"px"),n+=1,r=o[0].scrollHeight,$("#comments-qux").animate({scrollTop:$(document).height()},"slow"),!1})})},set_foreign:function(e){e?($("#comment-entry").hide(),$("#comments-not-allowed").show()):($("#comment-entry").show(),$("#comments-not-allowed").hide()),n=e},display_comments:function(){return rcloud.get_all_comments(shell.gistname()).then(function(e){!function(e){try{e=JSON.parse(e)}catch(e){return RCloud.UI.session_pane.post_error("populate comments: "+e.message)}var t=rcloud.username(),r=function(e){return e.user.login===t&&!n};d3.select("#comment-count").text(String(e.length)),d3.select("#comments-container").selectAll("div").remove();var o=d3.select("#comments-container").selectAll("div").data(e).enter().append("div").attr("class","comment-container").on("mouseover",function(e){r(e)&&$(".comment-header-close",this).show()}).on("mouseout",function(e){$(".comment-header-close",this).hide()}).attr("comment_id",function(e){return e.id});o.append("div").attr("class","comment-header").style({"max-width":"30%"}).text(function(e){return e.user.login}),o.append("div").attr("class","comment-body").style({"max-width":"70%"}).append("div").attr("class","comment-body-wrapper").append("div").attr("class","comment-body-text").text(function(e){return e.body}).each(function(o){var n=$(this),e={change:function(e){var t=n.html();i.modify_comment(o.id,t)},allow_multiline:!0,validate:function(e){return!Notebook.empty_for_github(e)}};ui_utils.editable(n,$.extend({allow_edit:r(o),inactive_text:n.text(),active_text:n.text()},e))}),d3.selectAll(".comment-body-wrapper",this).append("i").attr("class","icon-remove comment-header-close").style({"max-width":"5%"}).on("click",function(e,t){r(e)&&i.delete_comment(e.id)}),$("#collapse-comments").trigger("size-changed"),ui_utils.on_next_tick(function(){ui_utils.scroll_to_after($("#comments-qux"))})}(e)})},post_comment:function(e){return e=JSON.stringify({body:e}),rcloud.post_comment(shell.gistname(),e).then(this.display_comments.bind(this)).then(function(){$("#comment-entry-body").val("")})},modify_comment:function(e,t){return t=JSON.stringify({body:t}),rcloud.modify_comment(shell.gistname(),e,t).then(this.display_comments.bind(this))},delete_comment:function(e){return rcloud.delete_comment(shell.gistname(),e).then(this.display_comments.bind(this))}};return i}(),RCloud.UI.configure_readonly=function(){var e=$("#readonly-notebook"),t=RCloud.UI.navbar.control("revert_notebook"),o=RCloud.UI.navbar.control("save_notebook");shell.notebook.controller.is_mine()?shell.notebook.model.read_only()?(t&&t.show(),o&&o.hide()):(t&&t.hide(),o&&o.show()):(t&&t.hide(),o&&o.hide()),shell.notebook.model.read_only()?(RCloud.UI.command_prompt.readonly(!0),RCloud.UI.selection_bar.hide(),e.show(),$("#output").sortable("disable"),$("#upload-to-notebook").prop("checked",!1).attr("disabled",!0),RCloud.UI.scratchpad.set_readonly(!0),RCloud.UI.find_replace.hide_replace()):(RCloud.UI.command_prompt.readonly(!1),RCloud.UI.selection_bar.show(),e.hide(),$("#output").sortable("enable"),$("#upload-to-notebook").prop("checked",!1).removeAttr("disabled"),RCloud.UI.scratchpad.set_readonly(!1))},function(){var r,i,s,l,a;RCloud.UI.fatal_dialog=function(e,t,o){if($("#loading-animation").hide(),a=o,_.isUndefined(r)){s=$("<button type='submit' class='btn btn-primary' style='float:right'>"+t+"</span>"),l=$("<span class='btn' style='float:right'>Ignore</span>");var n=$("<div />").append("<h1>Aw, shucks</h1>");i=$('<p style="white-space: pre-wrap">'+e+"</p>"),n.append(i,s),n.append(l),n.append('<div style="clear: both;"></div>'),s.click(function(e){e.preventDefault(),_.isString(a)?window.location=a:_.isFunction(a)?(r.modal("hide"),a()):r.modal("hide")}),l.click(function(){r.modal("hide")}),r=$('<div id="fatal-dialog" class="modal fade" />').append($('<div class="modal-dialog" />').append($('<div class="modal-content" />').append($('<div class="modal-body" />').append(n)))),$("body").append(r),r.on("shown.bs.modal",function(){s.focus()})}r.modal({keyboard:!1})}}(),RCloud.UI.find_replace=function(){var i,h,p,m,g,v,b,y,k,w,C,x,R,I,U,E,A,S,P=null,N=!1,O=!1,T=null,j=null,D=!1,M=[],s=0,B=!1;function e(e,t){function o(e){if(e.keyCode===$.ui.keyCode.ENTER||!ui_utils.is_a_mac()&&114===e.keyCode)return e.preventDefault(),e.stopPropagation(),e.shiftKey?H():q(),!1}_.isUndefined(t)&&(t={}),B=e;var n=P&&"none"!==P.css("display");if(!P){var r=$(_.template($("#find-in-notebook-snippet").html())({}));$("#middle-column").prepend(r),P=$(r.get(0)),h=r.find("#find-form"),p=r.find("#find-details"),m=r.find("#find-input"),w=r.find("#match-case-opt"),C=r.find("#match-word-opt");var i=r.find("#find-options-menu");g=r.find("#match-status"),v=r.find("#match-index"),b=r.find("#match-total"),x=r.find("#find-next"),R=r.find("#find-last"),y=r.find("#replace-input"),I=r.find("#replace"),U=r.find("#replace-all"),k=r.find(".replace"),E=r.find("#find-close");var s=function(e){$(".dropdown-menu").each(function(e,t){$(t).is(":visible")&&$(t.parentElement).find(".dropdown-toggle").dropdown("toggle")})},l=function(e){e.get(0).checked?$("#find-options-menu > .btn").addClass("active"):$("#find-options-menu > .btn").removeClass("active")};m.on("change",function(e){e.preventDefault(),e.stopPropagation(),L()}),i.on("hide.bs.dropdown",function(e){var t=$(e.target).find("[data-keepOpen='true']");return!t.length||(t.each(function(e,t){$(t).attr("data-keepOpen",!1)}),!1)}),i.find(".checkbox").on("click",function(e){$(this).attr("data-keepOpen",!0)}),w.on("change",function(e){l(w),L()}),C.on("change",function(e){l(C),L()}),p.click(function(){m.focus()}),m.click(function(e){e.stopPropagation(),s()}),-1===navigator.userAgent.toLowerCase().indexOf("firefox")&&(h.on("focusout",function(e){setTimeout(function(){0===$(document.activeElement).closest(h).length&&(D=!1,z())},100)}),h.on("focusin",function(e){D||(shell.save_notebook(),L(m.data("searchagain")?A:void 0)),D=!0})),x.click(function(e){return e.preventDefault(),e.stopPropagation(),s(),q(),!1}),R.click(function(e){return e.preventDefault(),e.stopPropagation(),s(),H(),!1}),I.click(function(e){e.preventDefault(),e.stopPropagation(),s(),Q()}),U.click(function(e){return e.preventDefault(),e.stopPropagation(),s(),G(),!1}),j=["find-input","find-last","find-next","replace-input","replace","replace-all"],(T=["find-input","find-last","find-next"]).push("find-close"),j.push("find-close"),m.keydown(o),y.keydown(o),h.keydown(function(e){switch(e.keyCode){case $.ui.keyCode.TAB:e.preventDefault(),e.stopPropagation();var t=O?j:T,o=t.indexOf(e.target.id)+t.length;return e.shiftKey?--o:++o,o%=t.length,$("#"+t[o]).focus(),!1;case $.ui.keyCode.ESCAPE:F()}}),h.find("input").focus(function(){window.setTimeout(function(){this.select()}.bind(this),0)}),E.click(function(){F()})}if(P.show(),e?k.show():k.hide(),S||(S=setInterval(function(){var e=m.data("value"),t=m.val();t!==e&&(L(),m.data("value",t))},250)),!N){var a=function(){var e=K();if(e)return e.views[0].get_selection();return RCloud.UI.command_prompt.ace_widget()&&RCloud.UI.command_prompt.ace_widget().textInput.isFocused()?RCloud.UI.command_prompt.get_selection():null}();if(null!==a)m.val(a);else{ui_utils.select_allowed_elements();var c=window.getSelection().toString();c&&m.val(c)}}if(L(t.search_again?A:void 0),t&&t.search_again){var u,d,f=function(e){var t=K();if(!t)return;var o=t.views[0].ace_widget(),n=o.getSelectionRange();return{cell_index:t.index,cursor_index:o.session.doc.positionToIndex(e?n.end:n.start)}}(t.next);if(M.length&&f)(d=_.find(M,function(e){return e.index===f.cell_index&&e.begin>=f.cursor_index||e.index>f.cell_index}))?(u=M.findIndex(function(e){return e.begin===d.begin&&e.end===d.end&&e.index===d.index}),t.previous&&(u-=1)<0&&(u=M.length-1)):M.length&&(u=t.next?0:M.length-1),L(u)}N&&(t.next?q():t.previous&&H()),e&&n?y.focus():m.focus(),N=!0,O=e}function L(e){var t;A=void 0,findOpts={filter:m.val(),matchCase:w.get(0).checked,matchWord:C.get(0).checked},r(findOpts),u(),m.val().length?(A=_.isUndefined(e)?0:e,g.css("visibility","visible"),c("activate")):(A=void 0,o()),t=0===M.length?"0":_.isUndefined(e)?"1":(e+1).toString(),g[0===M.length?"addClass":"removeClass"]("no-matches"),n(t,M.length)}function a(){return 0!==M.length&&!isNaN(A)}function o(){g.css("visibility","hidden")}function n(e,t){v.text(e),b.text(t)}function z(){o(),A=void 0,r(null),u(),N=!1}function F(){if(!shell.notebook.model.read_only()){var e=M[A];if(e&&shell.notebook.model.cells[e.index])shell.notebook.model.cells[e.index].views[0].select_highlight_range(e.begin,e.end)}m.data("searchagain",m.val()),clearInterval(S),S=null,z(),P.hide()}function l(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function r(e){if(e&&e.filter&&0<e.filter.length){var t="g";e.matchCase||(t+="i");var o=l(e.filter);s=0,e.matchWord&&(o="\\b("+o+")\\b",s=1),i=new RegExp(o,t)}else i=null}function K(){var e=_.find(shell.notebook.model.cells,function(e){return!_.isUndefined(e.views[0].ace_widget())&&e.views[0].ace_widget().textInput.isFocused()});if(e)for(var t=0;shell.notebook.model.cells.length;t++)if(shell.notebook.model.cells[t].filename()===e.filename()){e.index=t;break}return e}function c(e){if(a()){var t=M[A];if(t){switch(e){case"replace":t.kind="replaced";break;case"activate":t.kind="replaced"===t.kind?"activereplaced":"active";break;case"deactivate":t.kind="activereplaced"===t.kind?"replaced":"normal"}o=t,n=M.filter(function(e){return e.filename===o.filename}),shell.notebook.model.cells[o.index].notify_views(function(e){e.change_highlights(n)})}}var o,n}function u(){shell.is_view_mode()&&shell.notebook.controller.show_r_source(),M=[],shell.notebook.model.cells.forEach(function(e,t){var o,n,r=function(e){var t=[];if(i)for(var o,n=e.content();o=i.exec(n);){var r=o[0].indexOf(o[s]);t.push({begin:o.index+r,end:o.index+o[s].length+r,kind:t.length===A?"active":"normal"}),o.index===i.lastIndex&&++i.lastIndex}return e.notify_views(function(e){e.change_highlights(t)}),t}(e);M.push.apply(M,(o=e,n=t,r.map(function(e){return _.extend({index:n,filename:o.filename()},e)})))})}function q(e){c(e||"deactivate"),a()?n((A=(A+M.length+1)%M.length)+1,M.length):A=0,c("activate")}function H(){c("deactivate"),a()?n((A=(A+M.length-1)%M.length)+1,M.length):A=0,c("activate")}function Q(){if(a()){var e=d();e&&shell.notebook.controller.update_cell(e).then(function(){q("replace")})}else q();return!1}function d(){if(!a())return null;var e=M[A],t=shell.notebook.model.cells[e.index],o=t.content(),n=o.substring(0,e.begin),r=o.substring(e.end),i=y.val(),s=i.length+e.begin-e.end;e.begin=n.length,e.end=n.length+i.length;for(var l=A+1;l<M.length&&M[l].filename===e.filename;++l)M[l].begin+=s,M[l].end+=s;return t.content(n+i+r)?t:null}function G(){return a()?(c("deactivate"),function(){var e=shell.notebook.model.reread_buffers();for(;A<M.length;){var t=d();c("replace"),t&&e.push.apply(e,shell.notebook.model.update_cell(t)),++A}A=void 0,shell.notebook.controller.apply_changes(e)}()):function(e,n){if(u(),!e||!e.length)return;e=l(e);var r=new RegExp(e,"g"),i=shell.notebook.model.reread_buffers();shell.notebook.model.cells.forEach(function(e){var t=e.content(),o=t.replace(r,n);e.content(o)&&i.push.apply(i,shell.notebook.model.update_cell(e))}),shell.notebook.controller.apply_changes(i)}(m.val(),y.val()),!1}return{init:function(){RCloud.UI.shortcut_manager.add([{category:"Search/Replace",id:"notebook_find",description:"Find text",keys:{mac:[["command","f"]],win:[["ctrl","f"]]},action:function(){e(!1)}},{category:"Search/Replace",id:"notebook_find_next",description:"Find text (next)",keys:{mac:[["command","g"]],win:[["ctrl","g"],["f3"]]},action:function(){e(!1,{next:!0,search_again:!0})}},{category:"Search/Replace",id:"notebook_find_previous",description:"Find text (previous)",keys:{mac:[["command","shift","g"]],win:[["ctrl","shift","g"],["shift","f3"]]},action:function(){e(!1,{previous:!0,search_again:!0})}},{category:"Search/Replace",id:"notebook_replace",description:"Replace text",keys:{mac:[["command","option","f"]],win:[["ctrl","h"]]},modes:["writeable"],action:function(){e(!shell.notebook.model.read_only())}},{category:"Search/Replace",id:"notebook_replace_text_match",description:"Replace next match",keys:{win_mac:[["alt","r"]]},modes:["writeable"],element_scope:"#find-form",action:function(){B&&Q()}},{category:"Search/Replace",id:"notebook_replace_text_all",description:"Replace all matches",keys:{win_mac:[["alt","a"]]},modes:["writeable"],element_scope:"#find-form",action:function(){B&&G()}},{category:"Search/Replace",id:"notebook_goto_previous_match",description:"Go to previous search match",keys:{mac:[["shift","enter"]],win:[["shift","enter"],["shift","f3"]]}},{category:"Search/Replace",id:"notebook_goto_next_match",description:"Go to next search match",keys:{mac:[["enter"]],win:[["enter"],["f3"]]}}])},hide_replace:function(){k&&k.hide()},clear_highlights:function(){z()}}}(),RCloud.UI.shortcut_manager=function(){var n;function c(t){return _.find(n.sections.all.entries,function(e){return e.id===t})}function t(e,o){_.isArray(e)||(e=[e]),_.each(e,function(e){var t=c(e);t&&o(t)})}function u(e){return e.enabled&&_.contains(e.modes,shell.notebook.model.read_only()?"readonly":"writeable")&&_.contains(e.on_page,shell.is_view_mode()?"view":"edit")&&(!_.isFunction(e.is_active)||_.isFunction(e.is_active)&&e.is_active())}return{init:function(){return window.Mousetrap.prototype.stopCallback=function(e,t,o){return(!(e.metaKey||e.ctrlKey||e.altKey||114===e.keyCode)||!["mousetrap","ace_text-input"].some(function(e){return-1<(" "+t.className+" ").indexOf(" "+e+" ")}))&&("INPUT"==t.tagName&&"checkbox"!==t.type||"SELECT"==t.tagName||"TEXTAREA"==t.tagName||t.contentEditable&&"true"==t.contentEditable)},n=RCloud.extension.create({}),this.add([]),this},add:function(e){var t,o,l,a;return n&&n.add((t=e,l={},a=n.sections.all.entries,o=_.isArray(t)?t:[t],_.each(o,function(r){var e=!0,i=_.defaults(r,{category:"General",modes:["writeable","readonly"],on_page:["view","edit"],ignore_clash:!1,enable_in_dialogs:!1,enabled:!0}),t=ui_utils.is_a_mac();if(r.keys&&(r.keys.hasOwnProperty("win_mac")?r.bind_keys=r.keys.win_mac:r.bind_keys=r.keys[t?"mac":"win"]),r.click_keys&&(r.click_keys.hasOwnProperty("win_mac")?r.click_keys.keys=r.click_keys.win_mac:(r.click_keys.hasOwnProperty("win")||r.click_keys.hasOwnProperty("mac"))&&(r.click_keys.keys=r.click_keys[t?"mac":"win"])),r.bind_keys&&r.bind_keys.length||r.click_keys){if(i.key_desc=[],r.bind_keys)for(var o=0;o<r.bind_keys.length;o++){var n=_.chain(r.bind_keys[o]).map(function(e){return e.toLowerCase()}).sortBy(function(e){return{command:1,ctrl:2,shift:3}[e]}).value();i.key_desc.push(n.join("+"))}if(!i.ignore_clash)for(var s=0;s<a.length;s++)if(!a[s].ignore_clash&&0<_.intersection(a[s].key_desc,i.key_desc).length){console.warn('Keyboard shortcut "'+i.description+'" cannot be registered because its keycode clashes with an existing shortcut id "'+a[s].id+'" in the "'+a[s].category+'" category.'),e=!1;break}e&&(_.isUndefined(r.action)?i.create=function(){}:i.create=function(){_.each(i.key_desc,function(e){var t=function(e){if(u(c(i.id))){var t=!0;if(!r.enable_in_dialogs&&$(".modal").is(":visible")&&(t=!1),r.element_scope){var o=$(r.element_scope),n=$(":focus");t=!(!o.length||!n.length)&&$.contains(o.get(0),n.get(0))}t&&(e.preventDefault(),r.action(e))}};i.global?window.Mousetrap.bindGlobal(e,t):window.Mousetrap().bind(e,t)})},e&&(l[r.id]=i,a.push(i)))}}),l)),this},load:function(){n&&n.create("all")},disable:function(e){t(e,function(e){e.enabled=!1})},disable_all:function(){this.disable(_.pluck(n.sections.all.entries,"id"))},enable:function(e){t(e,function(e){e.enabled=!0})},get_registered_shortcuts_by_category:function(e){var t=_.map(e,function(e,t){return{key:e,value:t+1}});t=_.object(_.pluck(t,"key"),_.pluck(t,"value"));var o=_.filter(_.sortBy(n.sections.all.entries,function(e){return e.category+e.description}),function(e){return u(e)});return _.sortBy(_.map(_.chain(o).groupBy("category").value(),function(e,t){return{category:t,shortcuts:e}}),function(e){return t[e.category]})}}}(),RCloud.UI.shortcut_dialog=function(){var o=[];return{show:function(){$("#loading-animation").hide();var t=[];o&&(o=RCloud.UI.shortcut_manager.get_registered_shortcuts_by_category(["Code Editor","Code Prompt","Cell Management","Notebook Management","Search/Replace","General"]));var n=function(e){var t=_.findWhere([{initial:"option",replace_with:"opt"},{initial:"command",replace_with:"cmd"}],{initial:e});return t?t.replace_with:e};_.each(o,function(e){var o={name:e.category,shortcuts:[]};_.each(e.shortcuts,function(e){var t={description:e.description,keys:[]};_.each(e.bind_keys,function(e){e=_.map(e,function(e){return n(e)}),t.keys.push(e.join(" "))}),e.click_keys&&t.keys.push({keys:_.map(e.click_keys.keys,function(e){return n(e)}).join(" "),target:e.click_keys.target}),o.shortcuts.push(t)}),t.push(o)});var e=_.template($("#shortcut_dialog_content_template").html())({categories:t});$("#shortcut-content").html(e),$("#shortcut-dialog").modal({keyboard:!1})}}}(),RCloud.UI.ace_shortcuts={init:function(){var e=[{category:"Code prompt",id:"code_prompt_execute",description:"Create cell and execute code",keys:{win_mac:[["enter"],["alt","enter"]]}},{category:"Code prompt",id:"code_prompt_history_back",description:"Go back in code history",keys:{win_mac:[["up"]]}},{category:"Code prompt",id:"code_prompt_history_forwards",description:"Go forwards in code history",keys:{win_mac:[["down"]]}},{category:"Code Editor",id:"code_editor_execute",description:"Execute code",keys:{win_mac:[["alt","enter"]]}},{category:"Code Editor",id:"code_editor_autocomplete",description:"Suggest autocompletion",keys:{win_mac:[["ctrl","."],["tab"]]}},{category:"Code Editor",id:"code_editor_execute_selection_or_line",description:"Execute selection or line",keys:{mac:[["command","enter"]],win:[["ctrl","enter"]]}},{category:"Code Editor",id:"code_editor_cursor_start_of_line",description:"Cursor at beginning of line",keys:{mac:[["ctrl","a"]]}},{category:"Code Editor",id:"code_editor_cursor_end_of_line",description:"Cursor at end of line",keys:{mac:[["ctrl","e"]]}},{category:"Code Editor",id:"ace_remove_line",description:"Remove line",keys:{mac:[["cmd","d"]],win:[["ctrl","d"]]}},{category:"Code Editor",id:"ace_copy_lines_down",description:"Copy lines down",keys:{mac:[["cmd","option","down"]],win:[["alt","shift","down"]]}},{category:"Code Editor",id:"ace_remove_line",description:"Copy lines up",keys:{mac:[["cmd","option","up"]],win:[["alt","shift","up"]]}},{category:"Code Editor",id:"ace_move_lines_down",description:"Move lines down",keys:{mac:[["option","down"]],win:[["alt","down"]]}},{category:"Code Editor",id:"ace_move_lines_up",description:"Move lines up",keys:{mac:[["option","up"]],win:[["alt","up"]]}},{category:"Code Editor",id:"ace_remove_to_line_end",description:"Remove to line end",keys:{mac:[["ctrl","k"]],win:[["alt","delete"]]}},{category:"Code Editor",id:"ace_remove_to_line_start",description:"Remove to line start",keys:{mac:[["cmd","backspace"]],win:[["alt","backspace"]]}},{category:"Code Editor",id:"ace_remove_word_left",description:"Remove word left",keys:{mac:[["option","backspace"],["ctrl","option","backspace"]],win:[["ctrl","backspace"]]}},{category:"Code Editor",id:"ace_remove_word_right",description:"Remove word right",keys:{mac:[["option","delete"]],win:[["ctrl","delete"]]}},{category:"Code Editor",id:"ace_split_line",description:"Split line",keys:{mac:[["ctrl","o"]]}},{category:"Code Editor",id:"ace_select_all",description:"Select all",keys:{mac:[["cmd","a"]],win:[["ctrl","a"]]}},{category:"Code Editor",id:"ace_select_left",description:"Select left",keys:{win_mac:[["shift","left"]]}},{category:"Code Editor",id:"ace_select_right",description:"Select right",keys:{win_mac:[["shift","right"]]}},{category:"Code Editor",id:"ace_select_word_left",description:"Select word left",keys:{mac:[["option","shift","left"]],win:[["ctrl","shift","left"]]}},{category:"Code Editor",id:"ace_select_word_right",description:"Select word right",keys:{mac:[["option","shift","right"]],win:[["ctrl","shift","right"]]}},{category:"Code Editor",id:"ace_select_line_start",description:"Select line start",keys:{win_mac:[["shift","home"]]}},{category:"Code Editor",id:"ace_select_line_end",description:"Select line end",keys:{win_mac:[["shift","end"]]}},{category:"Code Editor",id:"ace_select_line_end",description:"Select to line end",keys:{mac:[["option","shift","right"]],win:[["alt","shift","right"]]}},{category:"Code Editor",id:"ace_select_line_start",description:"Select to line start",keys:{mac:[["option","shift","left"]],win:[["alt","shift","left"]]}},{category:"Code Editor",id:"ace_select_up",description:"Select up",keys:{win_mac:[["shift","up"]]}},{category:"Code Editor",id:"ace_select_down",description:"Select down",keys:{win_mac:[["shift","down"]]}},{category:"Code Editor",id:"ace_select_page_up",description:"Select page up",keys:{win_mac:[["shift","pageup"]]}},{category:"Code Editor",id:"ace_select_page_down",description:"Select page down",keys:{win_mac:[["shift","pagedown"]]}},{category:"Code Editor",id:"ace_select_to_start",description:"Select to start",keys:{mac:[["command","shift","up"]],win:[["ctrl","shift","home"]]}},{category:"Code Editor",id:"ace_select_to_end",description:"Select to end",keys:{mac:[["command","shift","down"]],win:[["ctrl","shift","end"]]}},{category:"Code Editor",id:"ace_duplicate_selection",description:"Duplicate selection",keys:{mac:[["command","shift","d"]],win:[["ctrl","shift","d"]]}},{category:"Code Editor",id:"ace_select_to_matching_bracket",description:"Select to matching bracket",keys:{win:[["ctrl","shift","p"]]}},{category:"Code Editor",id:"ace_go_to_left",description:"Go to left",keys:{mac:[["left"],["ctrl","b"]],win:[["left"]]}},{category:"Code Editor",id:"ace_go_to_right",description:"Go to right",keys:{mac:[["right"],["ctrl","f"]],win:[["right"]]}},{category:"Code Editor",id:"ace_go_to_word_left",description:"Go to word left",keys:{mac:[["option","left"]],win:[["ctrl","left"]]}},{category:"Code Editor",id:"ace_go_to_word_right",description:"Go to word right",keys:{mac:[["option","right"]],win:[["ctrl","right"]]}},{category:"Code Editor",id:"ace_go_line_up",description:"Go line up",keys:{mac:[["up"],["ctrl","p"]],win:[["up"]]}},{category:"Code Editor",id:"ace_go_line_down",description:"Go line down",keys:{mac:[["down"],["ctrl","n"]],win:[["down"]]}},{category:"Code Editor",id:"ace_go_to_line_start",description:"Go to line start",keys:{mac:[["command","left"],["home"],["ctrl","a"]],win:[["alt","left"],["home"]]}},{category:"Code Editor",id:"ace_go_to_line_end",description:"Go to line end",keys:{mac:[["command","right"],["end"],["ctrl","e"]],win:[["alt","right"],["end"]]}},{category:"Code Editor",id:"ace_go_to_page_up",description:"Go to page up",keys:{mac:[["option","pageup"]],win:[["pageup"]]}},{category:"Code Editor",id:"ace_go_to_page_down",description:"Go to page down",keys:{mac:[["option","pagedown"],["ctrl","v"]],win:[["pagedown"]]}},{category:"Code Editor",id:"ace_go_to_start",description:"Go to start",keys:{mac:[["command","home"],["command","up"]],win:[["ctrl","home"]]}},{category:"Code Editor",id:"ace_go_to_end",description:"Go to end",keys:{mac:[["command","end"],["command","down"]],win:[["ctrl","end"]]}},{category:"Code Editor",id:"ace_go_to_matching_bracket",description:"Go to matching bracket",keys:{win:[["ctrl","p"]]}},{category:"Code Editor",id:"ace_scroll_page_down",description:"Scroll page down",keys:{mac:[["option","pagedown"]]}},{category:"Code Editor",id:"ace_scroll_page_up",description:"Scroll page up",keys:{mac:[["option","pageup"]]}},{category:"Code Editor",id:"ace_indent",description:"Indent",keys:{win_mac:[["tab"]]}},{category:"Code Editor",id:"ace_outdent",description:"Outdent",keys:{win_mac:[["shift","tab"]]}},{category:"Code Editor",id:"ace_undo",description:"Undo",keys:{mac:[["command","z"]],win:[["ctrl","z"]]}},{category:"Code Editor",id:"ace_redo",description:"Redo",keys:{mac:[["command","shift","z"],["command","y"]],win:[["ctrl","y"],["ctrl","shift","z"]]}},{category:"Code Editor",id:"ace_toggle_comment",description:"Toggle comment",keys:{mac:[["command","/"]],win:[["ctrl","/"]]}},{category:"Code Editor",id:"ace_change_to_lower_case",description:"Change to lower case",keys:{win_mac:[["ctrl","shift","u"]]}},{category:"Code Editor",id:"ace_change_to_upper_case",description:"Change to upper case",keys:{win_mac:[["ctrl","u"]]}},{category:"Code Editor",id:"ace_insert",description:"Overwrite",keys:{win_mac:[["insert"]]}},{category:"Code Editor",id:"ace_delete",description:"Delete",keys:{win_mac:[["delete"]]}}];_.each(e,function(e){e.ignore_clash=!0,e.modes=["writeable"]}),RCloud.UI.shortcut_manager.add(e)}},RCloud.UI.help_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("help-snippet")},init:function(){$("#help-body").append('<iframe id="help-frame" frameborder="0" />'),$("#help-form").submit(function(e){e.preventDefault(),e.stopPropagation();var t=$("#input-text-help").val();return $("#input-text-help").blur(),rcloud.help(t),!1}),$("#show-shortcuts").click(function(e){e.preventDefault(),RCloud.UI.shortcut_dialog.show()})},panel_sizer:function(e){return"none"===$("#help-body").css("display")?RCloud.UI.collapsible_column.default_sizer(e):{padding:RCloud.UI.collapsible_column.default_padder(e),height:9e3}},show:function(){$("#help-body").css("display","table-row"),$("#help-body").attr("data-widgetheight","greedy"),$("#collapse-help").trigger("size-changed");var e=$("#collapse-help").closest(".panel-group").attr("id").includes("left")?"left":"right";RCloud.UI[e+"_panel"].collapse($("#collapse-help"),!1),ui_utils.prevent_backspace($("#help-frame").contents())},display_content:function(e){$("#help-frame").contents().find("body").html(e),this.show()},display_href:function(e){$("#help-frame").attr("src",e),this.show()}},RCloud.UI.image_manager=function(){var s={},g=RCloud.extension.create();function l(o,i,s,n,r){var l,a,c,u,d,e;function f(t){var e={type:t};d&&(e.dim=d),rcloud.plots.render(n,r,e).then(function(e){saveAs(function(e){var t,o,n,r=";base64,";if(-1==e.indexOf(r))return o=(t=e.split(","))[0].split(":")[1],n=decodeURIComponent(t[1]),new Blob([n],{type:o});o=(t=e.split(r))[0].split(":")[1];for(var i=(n=window.atob(t[1])).length,s=new Uint8Array(i),l=0;l<i;++l)s[l]=n.charCodeAt(l);return new Blob([s],{type:o})}(e.url),o+"."+t)})}function h(e,t){var o=[t.size.width,t.size.height];rcloud.plots.render(n,r,{dim:o}).then(function(e){m.update(e.url,o)}).catch(function(e){if(!/Error in replayPlot/.test(e.message))throw e})}function p(e){e&&(e[0]&&c.css("width",e[0]),e[1]&&c.css("height",e[1]),d=e)}e={id:o,src:i},a=$($.el.img(e)),l=function(e){var t=$('<div class="live-plot-container"></div>'),o=$('<div class="live-plot"></div>');u=$('<div class="live-plot-scroller"></div>'),c=$("<div></div>"),o.append(u),u.append(c,$("<br/>")),c.append(e);var n,r=$('<span class="live-plot-commands"></div>');return window.shell&&!shell.notebook.model.read_only()&&r.append(((n=ui_utils.fa_button("icon-camera","set as thumb")).click(function(){RCloud.UI.scratchpad.update_thumb(),RCloud.UI.thumb_dialog.display_image(i)}),n)),r.append(function(){var e=$('<span class="dropdown"></div>'),t=$('<span class="dropdown-toggle fontawesome-button" type="button" data-toggle="dropdown" aria-expanded="true"></span>');t.append($('<i class="icon-save"></i>'));var n=$('<ul role="menu" class="dropdown-menu plot-save-formats"></ul>');_.pluck(g.entries("all"),"key").forEach(function(e){var t=$('<a role="menuitem" href="#">'+e+"</a>");t.click(function(){f(e)});var o=$('<li role="presentation"></li>').append(t);n.append(o)});var o={title:"save image",delay:{show:250,hide:0},container:"body"};return t.tooltip(o),e.append(t,n),e}()),r.hide(),o.hover(function(){r.show()},function(){r.hide()}),o.append(r),e.css({width:"100%",height:"100%"}),p(s),c.resizable({autoHide:!0,stop:h}),t.append(o),t}(a);var m={div:function(){return l},update:function(e,t){a.attr("src",e),p(t)},locate:function(i){l.attr("tabindex",1).css("cursor","crosshair"),l.focus().keydown(function(e){e.keyCode===$.ui.keyCode.ESCAPE&&(l.off("keydown").blur(),a.off("click"),l.attr("tabindex",null).removeAttr("style"),i(null,null))}),a.click(function(e){$(this).offset();var t=$(this).offset().top-$(window).scrollTop(),o=$(this).offset().left-$(window).scrollLeft(),n=Math.round(e.clientX-o),r=Math.round(e.clientY-t);l.off("keydown").blur(),a.off("click"),l.attr("tabindex",null).removeAttr("style"),i(null,[n,r])})}};return m}function a(e,t){return e+"-"+t}return{update:function(e,t,o,n){var r,i=a(o,n);return s[i]?(r=s[i]).update(e,t):(r=l(i,e,t,o,n),s[i]=r),r},locate:function(e,t,o){var n=a(e,t);s[n]?s[n].locate(o):o("ERROR: cannot find image corresponding to the locator")},load_available_formats:function(){return rcloud.plots.get_formats().then(function(e){e=_.without(e,"r_attributes","r_type");var t=1e3,o={};e.forEach(function(e){o[e]={sort:t},t+=1e3}),RCloud.UI.image_manager.formats.add(o)})},formats:g}}(),RCloud.UI.import_export=function(){var t;function i(e,t,o){var n=new Blob([t],{type:o});saveAs(n,e)}function o(){var e=[];return t?(e=shell.get_selected_cells().map(function(e){return e.filename()}),Promise.resolve(e)):Promise.resolve([])}function s(t,e){return e&&e.length&&_.difference(Object.keys(t.files),e).forEach(function(e){delete t.files[e]}),t}return{init:function(){return RCloud.UI.advanced_menu.add({import_notebooks:{sort:4e3,text:"Import External Notebooks",modes:["edit"],action:function(){function e(){var e=$("#import-source").val(),t=$("#import-gists").val(),o=$("#import-prefix").val();t=_.without(t.split(/[\s,;]+/),""),rcloud.port_notebooks(e,t,o).then(function(e){var t=[],o=[];for(var n in e)"r_type"!==n&&"r_attributes"!==n&&(e[n].ok?t.push(e[n].content):o.push(n));var r=[];t.forEach(function(e){r.push(editor.star_notebook(!0,{notebook:e}).then(function(){return editor.set_notebook_visibility(e.id,!0,function(){})}))}),Promise.all(r).then(function(){editor.highlight_imported_notebooks(t)}),o.length&&RCloud.UI.session_pane.post_error("Failed to import notebooks: "+o.join(", "))}),l.modal("hide")}var t,o,n,r,i,s,l=$("#import-notebooks-dialog");l.length||(t=$('<div class="container"/>').append($(["<p>Import notebooks from another GitHub instance.</p><p>Currently import does not preserve history.</p>",'<p>source repo api url:&nbsp;<input type="text" class="form-control-ext" id="import-source" style="width:100%;" value="https://api.github.com"></input></td>','<p>notebooks:<br /><textarea class="form-control-ext" style="height: 20%;width: 50%;max-width: 100%" rows="10" cols="30" id="import-gists" form="port"></textarea></p>','<p>prefix (e.g. <code>folder/</code> to put notebooks in a folder):&nbsp;<input type="text" class="form-control-ext" id="import-prefix" style="width:100%;"></input>'].join(""))),o=$('<span class="btn btn-cancel">Cancel</span>').on("click",function(){$(s).modal("hide")}),n=$('<span class="btn btn-primary">Import</span>').on("click",e),r=$('<div class="modal-footer"></div>').append(o).append(n),i=$(['<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>',"<h3>Import Notebooks</h3>","</div>"].join("")),s=$('<div id="import-notebooks-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(i).append(t).append(r))),$("body").append(s),s.on("show.bs.modal",function(){$("#import-gists").val("")}).on("shown.bs.modal",function(){$("#import-source").focus().select()}),l=s),l.modal({keyboard:!0})}},export_notebook_gist:{sort:5e3,text:"Export Notebook to File",modes:["edit"],action:function(){rcloud.protection.get_notebook_cryptgroup(shell.gistname()).then(function(e){e?alert("Exporting protected notebooks is not supported at this time (and will always export in the clear)"):o().then(function(o){return rcloud.get_notebook(shell.gistname(),shell.version(),null,!0).then(function(e){e=s(e=Notebook.sanitize(e),o);var t=JSON.stringify(e);return i(e.description+".gist",t,"text/json"),e})})})}},import_notebook_gist:{sort:6e3,text:"Import Notebook from File",modes:["edit"],action:function(){var e=$("#import-notebook-file-dialog");e.length?e.data().reset():e=function(){var t=null,o=null,n=null,r=null;function i(){var e=n.val();t&&0<e.length&&(t.description=e,rcloud.create_notebook(t,!1).then(function(e){editor.star_notebook(!0,{notebook:e}).then(function(){editor.set_notebook_visibility(e.id,!0),editor.highlight_imported_notebooks(e)})}),d.modal("hide"))}var e=$('<div class="container"/>'),s=$('<input type="file" id="notebook-file-upload" size="50"></input>');s.click(function(){ui_utils.disable_bs_button(r),[l,o].forEach(function(e){e.hide()}),s.val(null)}).change(function(){var e;e=s[0].files[0],o.hide(),l.hide(),Notebook.read_from_file(e,{on_load_end:function(){o.show()},on_error:function(e){o.text(e)},on_notebook_parsed:function(e){t=e,o.text(""),n.val(t.description),l.show(),ui_utils.enable_bs_button(r)}})}),(o=$("<span />")).append(o);var l=$("<span>Notebook description: </span>");n=$('<input type="text" class="form-control-ext" size="50" id="import-notebook-description"></input>').on("change paste keyup",function(e){var t=$(this).val().length;return t?ui_utils.enable_bs_button(r):ui_utils.disable_bs_button(r),e.which!==$.ui.keyCode.ENTER||!t||(i(),!1)}),l.append(n),e.append($("<p/>").append(s)).append($("<p/>").append(o.hide())).append($("<p/>").append(l.hide()));var a=$('<span class="btn btn-cancel">Cancel</span>').on("click",function(){$(d).modal("hide")});r=$('<span class="btn btn-primary">Import</span>').on("click",i),ui_utils.disable_bs_button(r);var c=$('<div class="modal-footer"></div>').append(a).append(r),u=$(['<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>',"<h3>Import Notebook File</h3>","</div>"].join("")),d=$('<div id="import-notebook-file-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(u).append(e).append(c)));return $("body").append(d),d.on("show.bs.modal",function(){$("#notebook-file-upload")[0].value=null,o.text(""),o.hide(),n.val(""),l.hide()}),d.data("reset",function(){t=null,ui_utils.disable_bs_button(r)}),d}(),e.modal({keyboard:!0})}},export_notebook_r:{sort:7e3,text:"Export Notebook as R Source File",modes:["edit"],action:function(){return o().then(function(r){rcloud.get_notebook(shell.gistname(),shell.version()).then(function(o){var e=[],n=[];o=s(o,r),_.each(o.files,function(e){var t=e.filename;if(/^part/.test(t)){var o=parseInt(t.slice(4).split(".")[0]);isNaN(o)||("R"===e.language?n[o]="```{r}\n"+e.content+"\n```":n[o]=e.content)}});for(var t=0;t<n.length;++t)_.isUndefined(n[t])||e.push(n[t]);e.push(""),rcloud.purl_source(e.join("\n")).then(function(e){var t=_.isString(e)?e:e.join("\n");i(o.description+".R",t,"text/plain")})})})}}}),this},export_only_selected_files:function(e){t=e}}}(),RCloud.UI.pull_and_replace=function(){var r,i=$("#pull-changes-dialog"),o=$("#pull-changes-by"),t=$("#pull-notebook-file"),e=$("#pull-notebook-url"),n=$("#pull-notebook-id"),s="#pull-error",l=i.find(".btn-primary"),a=[t,e,n],c=function(){v(),a.forEach(function(e){e.val("")}),r=void 0,u("url")},u=function(e,t){p(),o.val(e),$(i).find("div[data-by]").hide(),$(i).find('div[data-by="'+e+'"]').show(),_.isUndefined(t)||h().val("file"===e?"":t)},d=function(){function o(e){return Notebook.valid_gist_id(e)?e.toLowerCase()===shell.gistname().toLowerCase()?Promise.reject(new Error("You cannot pull from your current notebook; the source must be a different notebook.")):rcloud.get_notebook(e):Promise.reject(new Error("Invalid notebook ID."))}var e,t=f();g(),"id"===t?e=o:"file"===t?e=function(){return r?Promise.resolve(r):Promise.reject(new Error("No file to upload"))}:"url"===t&&(e=function(e){var t=RCloud.utils.get_notebook_from_url(e);return t?o(t):Promise.reject(new Error("Invalid URL"))});var n=h().val();e(n).then(function(e){return Promise.all([rcloud.set_notebook_property(shell.gistname(),"pull-changes-by",t+":"+n),editor.pull_and_replace_notebook(e).then(function(){c(),i.modal("hide")})])}).catch(function(e){v(),-1!==e.message.indexOf("Not Found (404)")?m("The notebook could not be found."):m(e.message)})},f=function(){return o.val()},h=function(){return $("#pull-notebook-"+f())},p=function(){$(s).remove()},m=function(e){p(),$("<div />",{id:s.substring(1),text:e}).appendTo($(i).find('div[data-by="'+f()+'"]'))},g=function(){l.text("Pulling"),i.addClass("pulling")},v=function(){l.text("Pull"),i.removeClass("pulling")};return{init:function(){return RCloud.UI.advanced_menu.add({pull_and_replace_notebook:{sort:3e3,text:"Pull and Replace Notebook",modes:["edit"],disabled_reason:"You can't pull and replace into a read only notebook",action:function(){rcloud.get_notebook_property(shell.gistname(),"pull-changes-by").then(function(e){if(e&&-1!==e.indexOf(":")){var t=e.indexOf(":"),o=e.substring(0,t),n=e.substring(t+1);u(o,n)}else u("url");i.modal({keyboard:!0})})}}}),$(i).on("hide.bs.modal",function(){c()}),o.change(function(){t.val(null),u($(this).val())}),t.click(function(){p(),t.val(null),r=void 0}).change(function(){var e;e=t[0].files[0],Notebook.read_from_file(e,{on_load_end:function(){},on_error:function(e){r=void 0,m(e)},on_notebook_parsed:function(e){r=e}})}),[e,n,o,t].forEach(function(e){e.keydown(function(e){e.keyCode===$.ui.keyCode.ENTER&&(d(),e.preventDefault())})}),l.click(d),this}}}(),RCloud.UI.init=function(){var r;RCloud.UI.processing_queue.init(),RCloud.UI.run_button.init(),RCloud.UI.stop_button.init(),(r=$("#output")).sortable({items:"> .notebook-cell",start:function(e,t){$(e.toElement).addClass("grabbing"),t.placeholder.height(t.item.height())},stop:function(e,t){$(e.toElement).removeClass("grabbing")},update:function(e,t){r.sortable("toArray");var o=t.item.data("rcloud.model"),n=t.item.next().data("rcloud.model");shell.notebook.controller.move_cell(o,n)},handle:" .cell-status",helper:"clone",scroll:!0,scrollSensitivity:40,forcePlaceholderSize:!0}),RCloud.UI.column_sizer.init(),$(window).bind("unload",function(){return shell.save_notebook(),!0}),RCloud.UI.menus.init(),RCloud.UI.advanced_menu.init(),RCloud.UI.navbar.init(),RCloud.UI.selection_bar.init(),RCloud.UI.shortcut_manager.init(),RCloud.UI.ace_shortcuts.init(),RCloud.UI.find_replace.init(),RCloud.UI.share_button.init(),RCloud.UI.notebook_commands.init(),RCloud.UI.cell_commands.init(),RCloud.UI.panel_loader.init(),RCloud.UI.import_export.init(),RCloud.UI.pull_and_replace.init(),ui_utils.prevent_backspace($(document)),$(document).on("copy",function(e){!$(e.target).hasClass("ace_text-input")&&$(e.target).closest($("#output")).size()&&ui_utils.select_allowed_elements()}),shell.is_view_mode()||$(document).on("scroll",function(){$(this).scrollLeft(0),$(this).scrollTop(0)}),$("#rcloud-cellarea").on("scroll",function(){$(this).scrollLeft(0)}),$(window).resize(function(e){shell.refresh_notebook_title()}),RCloud.UI.shortcut_manager.add([{category:"Notebook Management",id:"notebook_cell",description:"Save the current notebook",keys:{mac:[["command","s"]],win:[["ctrl","s"]]},modes:["writeable"],action:function(){RCloud.UI.navbar.get("save_notebook")&&shell.save_notebook()}},{category:"Notebook Management",id:"select_all",description:"Select all",keys:{mac:[["command","a"]],win:[["ctrl","a"]]},modes:["writeable"],action:function(e){if($(e.target).parents("#find-form").length)$(e.target).select();else{var t=window.getSelection();t.removeAllRanges();var o=new Range;o.selectNode(document.getElementById("output")),o.setStartAfter($(".response")[0]),t.addRange(o)}}},{category:"Notebook Management",id:"history_undo",description:"Step back through the notebook's history",keys:{mac:[["command","alt","z"]],win:[["ctrl","alt","z"]]},on_page:["edit"],action:function(){editor.step_history_undo()}},{category:"Notebook Management",id:"history_redo",description:"Step forwards through the notebook's history",keys:{mac:[["command","shift","z"]],win:[["ctrl","y"]]},on_page:["edit"],action:function(){editor.step_history_redo()}},{category:"Notebook Management",id:"history_revert",description:"Revert a notebook",keys:{mac:[["command","e"]],win:[["ctrl","e"]]},on_page:["edit"],is_active:function(){return shell.notebook.controller.is_mine()&&shell.notebook.model.read_only()},action:function(){this.is_active()&&editor.revert_notebook(shell.notebook.controller.is_mine(),shell.gistname(),shell.version())}},{category:"Cell Management",id:"notebook_run_all",description:"Run all cells",keys:{win_mac:[["ctrl","shift","enter"]]},action:function(){RCloud.UI.run_button.run()}}]),RCloud.UI.shortcut_manager.add([{category:"Cell Management",id:"remove_cells",description:"Remove selected cells",keys:{mac:[["command","backspace"]],win:[["ctrl","del"],["ctrl","backspace"]]},modes:["writeable"],action:function(){shell.notebook.controller.remove_selected_cells()}},{category:"Cell Management",id:"invert_cells",description:"Invert selected cells",keys:{mac:[["command","shift","i"]],win:[["ctrl","shift","i"]]},modes:["writeable"],action:function(){shell.notebook.controller.invert_selected_cells(),$(":focus").blur()}},{category:"Cell Management",id:"crop_cells",description:"Crop cells",keys:{mac:[["command","k"]],win:[["ctrl","k"]]},modes:["writeable"],action:function(){shell.notebook.controller.crop_cells()}},{category:"Cell Management",id:"arrow_next_cell_down",description:"Enter next cell (from last line of current)",keys:{win_mac:[["down"]]},modes:["writeable"]},{category:"Cell Management",id:"arrow_previous_cell_up",description:"Enter previous cell (from first line of current)",keys:{win_mac:[["up"]]},modes:["writeable"]},{category:"Cell Management",id:"goto_previous_cell",description:"Go to previous cell",keys:{win_mac:[["ctrl","shift","<"]]},modes:["writeable"]},{category:"Cell Management",id:"goto_next_cell",description:"Go to next cell",keys:{win_mac:[["ctrl","shift",">"]]},modes:["writeable"]},{category:"Cell Management",id:"insert_cell_before",description:"Insert cell before current",keys:{win:[["ctrl","["]],mac:[["command","["]]},modes:["writeable"],action:function(){}},{category:"Cell Management",id:"insert_cell_after",description:"Insert cell after current",keys:{win:[["ctrl","]"]],mac:[["command","]"]]},modes:["writeable"],action:function(){}},{category:"Cell Management",id:"run_selected_cells",description:"Run the selected cells",click_keys:{target:"Play button",win:[["ctrl"]],mac:[["command"]]}},{category:"Cell Management",id:"cell_run_from_here",description:"Run from this cell on",keys:{win_mac:[["shift","alt","enter"]]},click_keys:{target:"Play button",win_mac:[["shift"]]},modes:["writeable"]},{category:"Cell Management",id:"show_results_of_cells",description:"Show results of selected/all cells",click_keys:{target:"Hide results button",win:[["ctrl"]],mac:[["command"]]}},{category:"Cell Management",id:"blur_cell",description:"Blur Cell/Command Prompt",keys:{win_mac:[["esc"]]},modes:["writeable"]},{category:"Cell Management",id:"select_cell",description:"Select individual cell",click_keys:{target:"Cell title"}},{category:"Cell Management",id:"toggle_select_cell",description:"Toggle cell selection",click_keys:{target:"Cell title",win:["ctrl"],mac:["command"]}},{category:"Cell Management",id:"select_cell_range",description:"Select range of cells",click_keys:{target:"Cell title",win_mac:["shift"]}}]),RCloud.UI.shortcut_manager.add([{category:"General",id:"show_help",description:"Show shortcuts help",keys:{win_mac:[["?"]]},modes:["writeable","readonly"],action:function(e){RCloud.UI.shortcut_dialog.show()}},{category:"General",id:"close_modal",description:"Close dialog",keys:{win_mac:[["esc"]]},ignore_clash:!0,enable_in_dialogs:!0,global:!0,action:function(){$(".modal").modal("hide")}}])},RCloud.UI.left_panel=RCloud.UI.collapsible_column("#left-column","#accordion-left","#left-pane-collapser"),RCloud.UI.load_options=function(){return rcloud.get_conf_value("smtp.server").then(function(e){return e&&RCloud.UI.settings_frame.add({"subscribe-to-comments":RCloud.UI.settings_frame.checkbox({sort:5e3,default_value:!1,label:"Subscribe To Comments",condition:function(){}})}),Promise.all([rcloud.protection.has_notebook_protection(),RCloud.UI.panel_loader.load()]).spread(function(e,t){e&&RCloud.UI.menus.get("advanced_menu").menu.add({manage_groups:{sort:7e3,text:"Manage Groups",modes:["edit"],action:function(e){RCloud.UI.notebook_protection.init("group-tab-enabled")}}});return RCloud.UI.left_panel.init(),RCloud.UI.middle_column.init(),RCloud.UI.right_panel.init(),shell.is_view_mode()||RCloud.UI.incremental_search.init(),RCloud.UI.command_prompt.init(),$(".panel-collapse").collapse({toggle:!1}),Promise.all([RCloud.UI.navbar.load(),RCloud.UI.menus.load(),RCloud.UI.shortcut_manager.load(),RCloud.UI.share_button.load(),RCloud.UI.left_panel.load_options(),RCloud.UI.right_panel.load_options()])})})},RCloud.UI.menu=function(){var t,o;return{filter_mode:function(t){return function(e){return 0<=e.modes.indexOf(t)}},mode_sections:function(e){return arguments.length?(t=e,this):(t||(t={view:{filter:RCloud.UI.menu.filter_mode("view")},edit:{filter:RCloud.UI.menu.filter_mode("edit")}}),t)},ui_mode:function(e){return arguments.length?(o=e,this):o||(shell.is_view_mode()?"view":"edit")},create:function(){var r;return{init:function(){r=RCloud.extension.create({sections:RCloud.UI.menu.mode_sections()})},add:function(e){return r&&r.add(e),this},remove:function(e){return r.remove(e),this},check:function(e,t){var o=r.get(e);if(!o||!o.checkbox||!o.checkbox_widget)throw new Error("menu check fail on "+e);return o.checkbox_widget.set_state(t),this},enable:function(e,t){var o=r.get(e);if(!o||!o.$li)throw new Error("menu disable fail on "+e);return t?o.$li.find("a").removeAttr("title"):o.disabled_reason&&o.$li.find("a").attr("title",o.disabled_reason),o.disabled=!t,o.$li.toggleClass("disabled",!t),this},create_checkbox:function(e){var t=$.el.li($.el.a({href:"#",id:e.key},$.el.i({class:"icon-check"})," ",e.text));return e.checkbox_widget=ui_utils.checkbox_menu_item($(t),function(){e.disabled||e.action(!0)},function(){e.disabled||e.action(!1)}),e.value&&e.checkbox_widget.set_state(e.value),t},create_link:function(e){return $.el.li($.el.a({href:"#",id:e.key},e.text))},create:function(e){var o=this,t=$('<ul class="dropdown-menu"></ul>');e.append(t);var n=r.entries(RCloud.UI.menu.ui_mode());return t.append($(n.map(function(e){var t;return t=e.checkbox?o.create_checkbox(e):o.create_link(e),e.disabled&&o.enable(e,!1),e.$li=$(t),t}))),t.find("li a").click(function(){var e=r.get(this.id);if(!e)throw new Error("bad id in advanced menu");e.checkbox||e.disabled||e.action()}),this}}}}}(),RCloud.UI.menus=function(){var g;return{init:function(){g=RCloud.extension.create({sections:RCloud.UI.menu.mode_sections()}),this.add({discover_divider:{sort:7e3,type:"divider",modes:["edit"]},discover:{sort:8e3,type:"link",href:"/discover.html",text:"Discover",target:"_blank",modes:["edit"]},logout_divider:{sort:1e4,type:"divider",modes:["edit"]},logout:{sort:12e3,type:"link",href:"/logout.R",text:"Logout",modes:["edit"]}})},add:function(e){return g.add(e),this},remove:function(e){return g.remove(e),this},get:function(e){return g.get(e)},create_menu:function(e){var t=$.el.li({class:"dropdown"},$.el.a({href:"#",class:"dropdown-toggle","data-toggle":"dropdown"},e.title+" ",$.el.b({class:"caret"})));return e.menu.create($(t)),t},create_link:function(e){var t={href:e.href};return e.target&&(t.target=e.target),$.el.li($.el.a(t,e.text))},create_divider:function(e){return $.el.li({class:"divider-vertical"})},load:function(e){var p=this,m=$("#rcloud-navbar-menu");return rcloud.get_conf_values("^rcloud\\.menu\\..*").then(function(e){e=_.omit(e,"r_type","r_attributes");var t={};for(var o in e){var n=e[o].split(/ *, */),r=o.split(".");if(3!=r.length)throw new Error("submenus not supported yet - invalid menu key "+o);var i,s=+n[0],l=n[1].split(/ *\| */),a=n[2],c=n[3],u=n[4],d=n[5]||"_blank";if(isNaN(s))throw new Error("bad sort value "+n[0]+" in menu key "+o);switch(a){case"link":i={sort:s,modes:l,type:a,text:c,href:u,target:d};break;case"divider":i={sort:s,modes:l,type:a};break;default:throw new Error("invalid menu type "+a+" in menu key "+o)}t[r[2]]=i}p.add(t);var f=g.entries(RCloud.UI.menu.ui_mode()),h=$(f.map(function(e){switch(e.type){case"divider":return p.create_divider();case"menu":return p.create_menu(e);case"link":return p.create_link(e);default:throw new Error("unknown navbar menu entry type "+e.type)}}));m.append(h)})}}}(),function(){var i,s;RCloud.UI.message_dialog=function(e,t,o){if($("#loading-animation").hide(),_.isUndefined(i)){var n=$("<button type='submit' class='btn btn-primary' style='float:right'>OK</span>"),r=$("<div />").append($("<h1 />").append(e));s=$('<p style="white-space: pre-wrap">'+t+"</p>"),r.append(s,n),r.append('<div style="clear: both;"></div>'),n.click(function(e){e.preventDefault(),i.modal("hide")}),i=$('<div id="message-dialog" class="modal fade" />').append($('<div class="modal-dialog" />').append($('<div class="modal-content" />').append($('<div class="modal-body" />').append(r)))),$("body").append(i),i.on("shown.bs.modal",function(){n.focus()})}else s.text(t);i.off("hidden.bs.modal").on("hidden.bs.modal",function(){o()}),i.modal({keyboard:!0})}}(),RCloud.UI.middle_column=function(){var t=RCloud.UI.column("#middle-column");return _.extend(t,{update:function(){var e=12-RCloud.UI.left_panel.colwidth()-RCloud.UI.right_panel.colwidth();t.colwidth(e),shell.notebook.view.reformat()}}),t}(),RCloud.UI.navbar=function(){var i,s;return{create_button:function(e,t,o){var n=$.el.button({id:e,title:t,type:"button",class:"btn btn-link navbar-btn"},$.el.i({class:o})),r=$(n);return{control:n,click:function(e){return $(n).click(e),this},hide:function(){return r.hide(),this},show:function(){return r.show(),this},disable:function(){return ui_utils.disable_bs_button(r),this},enable:function(){return ui_utils.enable_bs_button(r),this},display:function(e,t){return $(n).find("i").removeClass().addClass(t),$(n).attr("title",e),this}}},create_highlight_button:function(e,t,o){var r=this.create_button(e,t,o);return r.highlight_color="#ffff4d",r.icon_class=o,r.original_color=null,r.highlighted=!1,r.highlight=function(e){var o=this,n=500;return o.highlighted=e,o.original_color||(o.original_color=$($(r.control).find("."+r.icon_class)).css("color")),o.highlighted&&function e(){var t=$(o.control).find("."+o.icon_class);o.highlighted?t.is(":animated")||t.animate({color:o.highlight_color},{duration:n}).delay(n).animate({color:o.original_color},{duration:n,complete:e}):(t.stop(!0,!0),t.removeAttr("style"))}(),this},r},init:function(){$("#rcloud-navbar-header").empty().append('<a class="navbar-brand" href="/edit.html">RCloud</a>');var t=RCloud.extension.filter_field("area","commands"),o=RCloud.UI.menu.filter_mode("view"),n=RCloud.UI.menu.filter_mode("edit");i=RCloud.extension.create({sections:{header:{filter:RCloud.extension.filter_field("area","header")},view_commands:{filter:function(e){return t(e)&&o(e)}},edit_commands:{filter:function(e){return t(e)&&n(e)}}}}),this.add({shareable_link:{area:"commands",sort:1e3,modes:["edit"],create:function(){var t,o=$.el.a({href:"#",id:"share-link",title:"Shareable Link",class:"btn btn-link navbar-btn",style:"text-decoration:none; padding-right: 0px",target:"_blank"},$.el.i({class:"icon-share"}));return $(o).on("click",function(e){shell.save_notebook()}),{control:$.el.span(o,$.el.span({class:"dropdown",style:"position: relative; margin-left: -2px; padding-right: 12px"},$.el.a({href:"#",class:"dropdown-toggle","data-toggle":"dropdown",id:"view-mode"},$.el.b({class:"caret"})),t=$.el.ul({class:"dropdown-menu view-menu",id:"view-type"}))),set_url:function(e){return o&&$(o).attr("href",e),this},open:function(){return o&&$(o)[0].click(),this},set_view_types:function(e){$(t).append($(e.map(function(e){var t=$.el.a({href:"#"},e.title);return $(t).click(e.handler),$.el.li(t)})))}}}},star_notebook:{area:"commands",sort:2e3,modes:["edit"],create:function(){var o,n,t,r,e=$.el.button({id:"star-notebook",title:"Star Notebook",type:"button",class:"btn btn-link navbar-btn",style:"padding-left: 3px"},$.el.i({class:"icon-star-empty"}),$.el.sub(r=$.el.span({id:"curr-star-count"})));return t=ui_utils.twostate_icon($(e),function(){o()},function(){n()},"icon-star","icon-star-empty"),{control:e,set_star_unstar:function(e,t){return o=e,n=t,this},set_fill:function(e){return t.set_state(e),$(this.control).attr("title",e?"Unstar Notebook":"Star Notebook"),this},set_count:function(e){return $(r).text(e),this}}}},fork_notebook:{area:"commands",sort:3e3,modes:["edit"],create:function(){var e=RCloud.UI.navbar.create_button("fork-notebook","Fork","icon-code-fork");return $(e.control).click(function(e){var t=shell.notebook.controller.is_mine(),o=shell.gistname(),n=shell.version();e.metaKey||e.ctrlKey?editor.fork_notebook(t,o,n,!1).then(function(e){var t=ui_utils.make_url("edit.html",{notebook:e.id});window.open(t,"_blank")}):editor.fork_notebook(t,o,n,!0)}),e}},save_notebook:{area:"commands",sort:4e3,modes:["edit"],create:function(){var e=RCloud.UI.navbar.create_button("save-notebook","Save","icon-save");return $(e.control).click(function(){shell.save_notebook()}),e.disable(),e}},revert_notebook:{area:"commands",sort:5e3,modes:["edit"],create:function(){var e=RCloud.UI.navbar.create_button("revert-notebook","Revert","icon-undo");return $(e.control).click(function(){var e=shell.notebook.controller.is_mine(),t=shell.gistname(),o=shell.version();editor.revert_notebook(e,t,o)}),e}},edit_notebook:{area:"commands",sort:1e3,modes:["view"],create:function(){var e=RCloud.UI.navbar.create_button("edit-notebook","Edit Notebook","icon-edit");return $(e.control).click(function(){window.location="edit.html?notebook="+shell.gistname()}),e}},run_notebook:{area:"commands",sort:6e3,modes:["edit","view"],create:function(){var e=RCloud.UI.navbar.create_highlight_button("run-notebook","Run All","icon-play");return $(e.control).click(function(e){if(e.metaKey||e.ctrlKey){var t=shell.get_selected_cells().map(function(e){return e.id()});t.length&&shell.run_notebook_cells(t)}else RCloud.UI.run_button.run()}),e}},stop_notebook:{area:"commands",sort:7e3,modes:["edit","view"],create:function(){var e=RCloud.UI.navbar.create_button("stop-notebook","Stop","icon-stop");return $(e.control).click(function(e){RCloud.UI.stop_button.stop()}),e.disable(),e}}})},add:function(e){return i&&i.add(e),this},remove:function(e){return i&&i.remove(e),this},get:function(e){return i?i.get(e):null},control:function(e){return s?s[e]:null},load:function(){if(i){var e=i.create("header").array,t=$("#rcloud-navbar-header");e.length&&t.empty().append.apply(t,e);var o=RCloud.UI.menu.ui_mode()+"_commands",n=i.create(o),r=$("#rcloud-navbar-main");n.array.length&&r.prepend.apply(r,n.array.map(function(e){return $.el.li(e.control)})),s=n.map}return Promise.resolve(void 0)}}}(),RCloud.UI.notebook_commands=function(){var a,c,r={"line-height":"90%"},t=_.extend({"font-size":"80%"},r),i={true:{class:"icon-star",title:"unstar"},false:{class:"icon-star-empty",title:"star"}},o={},n={condition0:function(e){return e.gistname&&!e.version},condition1:function(e){return!0}};function u(t,o,e){e.forEach(function(e){o.append(document.createTextNode(String.fromCharCode(160))),o.append(e.create(t))})}return{init:function(){return this.add({star_unstar:{section:"always",sort:1e3,create:function(o){var n=editor.i_starred(o.gistname),e=ui_utils.fa_button(i[n].class,function(e){return i[n].title},"star",t,!0);return e.click(function(e){e.preventDefault(),e.stopPropagation(),ui_utils.kill_popovers();var t=!n;editor.star_notebook(t,{gistname:o.gistname,user:o.user})}),e[0].set_state=function(e){n=!!e,$(this).find("i").attr("class",i[n].class)},e.append($.el.sub(String(editor.num_stars(o.gistname)))),e}},history:{section:"appear",sort:2e3,create:function(e){var t=editor.current(),o=t.notebook===e.gistname&&t.version,n=ui_utils.fa_button("icon-time","history","history",r,!0);return o&&n.addClass("button-disabled"),n.click(function(){return ui_utils.kill_popovers(),ui_utils.fake_hover(e),o||editor.show_history(e,!0),!1}),n}},visibility:{section:"appear",sort:3e3,condition1:function(e){return e.user===editor.username()},create:function(e){var t=ui_utils.fa_button("icon-eye-close","hide notebook","hide-notebook",r,!0),o=ui_utils.fa_button("icon-eye-open","show notebook","show-notebook",r,!0);return e.visible?o.hide():t.hide(),t.click(function(){if(ui_utils.fake_hover(e),e.user!==editor.username())throw new Error("attempt to set visibility on notebook not mine");editor.set_notebook_visibility(e.gistname,!1)}),o.click(function(){if(ui_utils.fake_hover(e),e.user!==editor.username())throw new Error("attempt to set visibility on notebook not mine");return editor.set_notebook_visibility(e.gistname,!0),!1}),t.add(o)}},remove:{section:"appear",sort:4e3,condition1:function(e){return e.user===editor.username()},create:function(t){var e=ui_utils.fa_button("icon-remove","remove","remove",r,!0);return e.click(function(e){return $("div.popover").remove(),confirm("Do you want to remove '"+t.full_name+"'?")&&(e.stopPropagation(),e.preventDefault(),editor.remove_notebook(t.user,t.gistname)),!1}),e}},fork_folder:{section:"appear",sort:1e3,condition0:function(e){return e.full_name&&!e.gistname},create:function(n){var e=ui_utils.fa_button("icon-code-fork","fork","fork",r,!0);return e.click(function(e){var t=n.full_name,o=new RegExp("^"+t);editor.find_next_copy_name(t).then(function(e){editor.fork_folder(n,o,e)})}),e}},remove_folder:{section:"appear",sort:2e3,condition0:function(e){return e.full_name&&!e.gistname&&e.user===editor.username()},create:function(o){var e=ui_utils.fa_button("icon-remove","remove folder","remove",r,!0),n=[];return e.click(function(e){if(editor.for_each_notebook(o,null,function(e){n.push(e.full_name)}),confirm("Do you want to remove ALL the following notebooks?\n"+n.join("\n"))){var t=[];editor.for_each_notebook(o,null,function(e){t.push(editor.remove_notebook(e.user,e.gistname))})}return!1}),e}}}),this},add:function(e){for(var t in e)o[t]=_.extend(_.extend({},n),e[t]);return a=_.filter(o,function(e){return"always"===e.section}),c=_.filter(o,function(e){return"appear"===e.section}),[a,c].forEach(function(e){e.sort(function(e,t){return e.sort-t.sort})}),this},remove:function(e){return delete o[e],this},icon_style:function(){return r},decorate:function(e,o,t){var n,r,i=$(t),s=(r=o,function(t){return _.every(["condition0","condition1","condition2"],function(e){return!t[e]||t[e](r)})});function l(e){e.on("mousedown mouseup click",function(e){e.stopPropagation()})}return function(){var e=a.filter(s);if(e.length){var t=$($.el.span({class:"notebook-commands-right"}));l(t),u(o,t,e),i.append(t)}}(),e.find("div.jqtree-element").hover(function(){n||function(){var e=c.filter(s);if(e.length){var t=$($.el.span({class:"notebook-commands appear"}));l(t),u(o,t,e),i.append(t),i.find(".notebook-date").toggleClass("disappear",!0),t.hide(),i.append($.el.span({class:"notebook-commands appear-wrapper"},t[0]))}n=!0}();editor.get_notebook_info(o.gistname);$(".notebook-commands.appear",this).show(),$(".notebook-date.disappear",this).css("visibility","hidden")},function(){$(".notebook-commands.appear",this).hide(),$(".notebook-date.disappear",this).css("visibility","visible")}),this}}}(),RCloud.UI.selection_bar=function(){var n,r,i,s,l,a,c,u,d,e=function(){r.prop("checked",!1),n.hide()};return{init:function(){var e=$(RCloud.UI.panel_loader.load_snippet("selection-bar-snippet"));n=e.find(".cell-selection span"),r=e.find('.cell-selection input[type="checkbox"]'),i=e.find(".dropdown-toggle"),s=e.find("#selection-bar-delete"),l=e.find("#selection-bar-crop"),e.find("#selection-bar-toggle-results"),a=e.find(".cell-selection"),c=s.find("span"),u=e.find("#selected-count"),d=e.find("#cell-count"),e.find('.btn-default input[type="checkbox"]').click(function(e){e.stopPropagation(),shell.notebook.controller.cell_count()?$(this).is(":checked")?shell.notebook.controller.select_all_cells():shell.notebook.controller.clear_all_selected_cells():e.preventDefault()}).end().find("a[data-action]").click(function(){shell.notebook.controller[$(this).attr("data-action")]()}).end().find("#selection-bar-delete").click(function(){shell.notebook.controller.remove_selected_cells()}).end().find("#selection-bar-crop").click(function(){shell.notebook.controller.crop_cells()}).end().find("#selection-bar-toggle-results").click(function(e){e.metaKey||e.ctrlKey?shell.notebook.controller.show_cells_results():shell.notebook.controller.hide_cells_results()}).end(),e.find('div[type="button"].cell-selection').click(function(e){$(this).find("input").trigger("click")}),$("#"+e.attr("id")).replaceWith(e)},update:function(e){var t=e.length,o=shell.notebook.controller.selected_count();r.prop({checked:o===t&&0!=t,disabled:0===t}),_.each([i,a],function(e){e[t?"removeClass":"addClass"]("disabled")}),n[o!==t&&0!==o?"show":"hide"](),s[o?"removeClass":"addClass"]("disabled"),l[shell.notebook.controller.can_crop_cells()?"removeClass":"addClass"]("disabled"),u.text(o),d.text(t),c[0!==o?"show":"hide"]()},hide:function(){$("#selection-bar").hide(),e()},show:function(){$("#selection-bar").show(),e()}}}(),RCloud.UI.notebook_title=function(){var a=null;function c(e){return editor.rename_notebook(e).then(function(){t.set(e)})}var u={change:c,select:function(e){if(1!==e.childNodes.length||e.firstChild.nodeType!=e.TEXT_NODE)throw new Error("expecting simple element with child text");var t=e.firstChild.textContent,o=document.createRange();return o.setStart(e.firstChild,t.lastIndexOf("/")+1),o.setEnd(e.firstChild,t.length),o},ctrl_cmd:function(t,o){var e=shell.notebook.controller.is_mine(),n=shell.gistname(),r=shell.version();editor.fork_notebook(e,n,r).then(function(e){return o?c(t):void 0})},validate:function(e){return editor.validate_name(e)}},t={set:function(e){$("#notebook-author").text(shell.notebook.model.user()),$("#author-title-dash").show(),$("#rename-notebook").show(),$("#loading-animation").hide();var t=shell.notebook.model.read_only(),o=e,n=!1,r=!1,i=$("#notebook-title");function s(e){return d3.sum($(e).map(function(e,t){return $(t).width()}))}var l=$("#rcloud-navbar-header").width()+s("#rcloud-navbar-menu li")+50;for(i.text(e);10<e.length&&window.innerWidth<l+s("#rcloud-navbar-main");){var a=e.search("/");0<=a?(n=!0,e=e.slice(a+1)):(r=!0,e=e.substr(0,e.length-5)),i.text((n?".../":"")+e+(r?"...":""))}ui_utils.editable(i,$.extend({allow_edit:!t&&!shell.is_view_mode(),inactive_text:i.text(),active_text:o},u))},update_fork_info:function(e){var o=ui_utils.make_url(shell.is_view_mode()?"view.html":"edit.html",{notebook:e});e?rcloud.get_notebook_info(e).then(function(e){var t=(e.username||"unknown")+" / "+(e.description||"unknown");$("#forked-from-desc").html("forked from <a href='"+o+"'>"+t+"</a>")}).catch(function(e){/does not exist or has not been published/.test(e)?$("#forked-from-desc").html("forked from <a href='"+o+"'>(unknown notebook)</a>"):$("#forked-from-desc").text("")}):$("#forked-from-desc").text("")},make_editable:function(e,t,o){function n(e,t){return $("> div > .jqtree-title",t)}if(a&&(!e||e.gistname&&a!==e)&&ui_utils.editable(n(0,a.element),"destroy"),e){var r=u;e.version?r=$.extend({},u,{change:(l=e,function(e){return editor.tag_version(l.gistname,l.version,e).then(function(){return editor.show_history(l.parent,{update:!0})})}),validate:function(e){return!0}}):e.gistname||(r=$.extend({},u,{change:(s=e,function(e){editor.for_each_notebook(s,e,function(e,t){e.gistname===shell.gistname()?c(t):rcloud.update_notebook(e.gistname,{description:t},!1).then(function(e){editor.update_notebook_from_gist(e)})},function(e,t){return t+"/"+e.name})}),ctrl_cmd:(i=e,function(e){var t=new RegExp("^"+i.full_name);editor.fork_folder(i,t,e)}),validate:function(e){return editor.validate_name(e)}})),ui_utils.editable(n(0,t),$.extend({allow_edit:o,inactive_text:e.name,active_text:e.version?e.name:e.full_name},r))}var i,s,l;e&&e.gistname&&(a=e)}};return t}(),RCloud.UI.notebooks_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("notebooks-snippet")},heading_content:function(){return RCloud.UI.panel_loader.load_snippet("notebooks-panel-heading")},heading_content_selector:function(){return $("#notebooks-panel-controls")}},RCloud.UI.output_context={create:function(e){var t=function(e){var o=$(e);function t(e){var t=function(e){switch(e){case"code":return function(e){return $.el.pre($.el.code(e))};case"error":return function(e){return $('<code style="color: crimson"></code>').append(e)};case"html":return function(e){return e};default:throw new Error("unknown output type "+e)}}(e);return function(e){o.append(t(e))}}return{end:function(){console.log("not expecting end on custom output context")},out:t("code"),err:t("error"),msg:t("code"),html_out:t("html"),selection_out:t("html"),deferred_result:null,in:null}}(e);return RCloud.register_output_context(t)},close:function(e){RCloud.unregister_output_context(e)}},RCloud.UI.panel_loader=function(){var o,r={};function f(e){return"collapse-"+e}return{init:function(){o=RCloud.extension.create({sections:{left:{filter:function(e){return"left"===e.side}},right:{filter:function(e){return"right"===e.side}}}}),r={Notebooks:{side:"left",name:"notebook-tree",title:"Notebooks",icon_class:"icon-folder-open",colwidth:3,greedy:!0,sort:1e3,panel:RCloud.UI.notebooks_frame},"File Upload":{side:"left",name:"file-upload",title:"File Upload",icon_class:"icon-upload-alt",colwidth:2,sort:2e3,panel:RCloud.UI.upload_frame},Settings:{side:"left",name:"settings",title:"Settings",icon_class:"icon-cog",colwidth:3,sort:3e3,panel:RCloud.UI.settings_frame},Comments:{side:"left",name:"comments",title:"Comments",icon_class:"icon-comments",colwidth:2,sort:4e3,panel:RCloud.UI.comments_frame},Assets:{side:"right",name:"assets",title:"Assets",icon_class:"icon-copy",colwidth:4,sort:1e3,panel:RCloud.UI.scratchpad},Search:{side:"right",name:"search",title:"Search",icon_class:"icon-search",colwidth:4,sort:2e3,panel:RCloud.UI.search},Help:{side:"right",name:"help",title:"Help",icon_class:"icon-question",colwidth:5,sort:3e3,panel:RCloud.UI.help_frame},Session:{side:"right",name:"session-info",title:"Session",icon_class:"icon-info",colwidth:3,sort:4e3,panel:RCloud.UI.session_pane}}},add:function(e){o&&o.add(e)},remove:function(e){return o.remove(e),this},load_snippet:function(e){return $($("#"+e).html())[0]},load:function(){var t=this;function n(e,t){o.entries(t).forEach(function(e){!function(e){var t,o="accordion-"+e.side,n=f(e.name),r={class:"panel-heading clearfix","data-toggle":"collapse","data-parent":"#"+o,"data-target":"#"+n},i=$.el.span({class:"title-offset"},e.title),s=$.el.i({class:e.icon_class}),l=$.el.a({class:"accordion-toggle "+e.side,href:"#"+n},s," ",i),a=e.panel.heading_content?e.panel.heading_content():null;if("left"===e.side)t=$.el.div(r,l,a);else{if("right"!==e.side)throw new Error("Unknown panel side "+e.side);t=$.el.div(r,a,l)}var c={id:n,class:"panel-collapse collapse","data-colwidth":e.colwidth};e.greedy&&(c["data-widgetheight"]="greedy");var u=$.el.div(c,$.el.img({height:"100%",width:"5px",src:"left"===e.side?"/img/right_bordergray.png":"/img/left_bordergray.png",class:"panel-shadow "+e.side}),e.panel.body()),d=$.el.div({class:"panel panel-default"},t,u);$("#"+o).append(d)}(e),e.panel.init&&e.panel.init(),e.panel.load&&e.panel.load(),e.panel.panel_sizer&&$("#"+f(e.name)).data("panel-sizer",e.panel.panel_sizer),e.panel.heading_content_selector&&$("#"+f(e.name)).data("heading-content-selector",e.panel.heading_content_selector())}),function(e){for(var t="accordion-"+e,o=$("<div/>",{class:"panel-body",style:"border-top-color: transparent; background-color: #777"}),n=0;n<60;++n)o.append($.el.br());var r=$.el.div({class:"panel-collapse out"},o[0]),i=$.el.div({class:"panel panel-default"},r);$("#"+t).append(i)}(t)}return rcloud.config.get_user_option("panel-layout-by-size").then(function(e){if(null===e&&(e=!0),!e){var o=function(e,t,o){r[e].side=t,r[e].sort=o};_.each(["Notebooks","Search","Settings","Help"],function(e,t){o(e,"left",1e3*(t+1))}),_.each(["Assets","File Upload","Comments","Session"],function(e,t){o(e,"right",1e3*(t+1))})}return t.add(r),n(0,"left"),n(0,"right"),$("#left-column").append(t.load_snippet("left-pane-collapser-snippet")),$("#right-column").append(t.load_snippet("right-pane-collapser-snippet")),Promise.cast(void 0)})}}}(),function(){var e,n=0,r=1,t=!1;function i(){t||(t=!0,_.isUndefined(e)&&(e=$('<div id="progress-dialog" class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-body">Please wait...</div></div></div>'),$("body").append(e),e.on("hide.bs.modal",function(){n=0,a()})),e.modal({keyboard:!0}))}function s(){t&&(t=!1,e.modal("hide"))}function l(){_.delay(function(){document.body.style.cursor="wait"},0)}function a(){_.delay(function(){document.body.style.cursor=""},0)}RCloud.UI.with_progress=function(e,t){function o(){0===(n-=1)&&(a(),s())}return _.isUndefined(t)&&(t=2e3),l(),_.delay(function(){0<n&&0<r&&i()},t),n+=1,Promise.resolve(o).then(e).then(function(e){return o(),e}).catch(function(e){throw o(),e})},RCloud.UI.prevent_progress_modal=function(){1===r&&0<n&&(a(),s()),r-=1},RCloud.UI.allow_progress_modal=function(){0===r&&0<n&&(l(),i()),r+=1}}(),RCloud.UI.right_panel=RCloud.UI.collapsible_column("#right-column","#accordion-right","#right-pane-collapser"),RCloud.UI.processing_queue=function(){var n=!1,r=!1,i=[],s=[],l=null;return onStartCallbacks=[],finallyCallbacks=[],{init:function(){var e=this;RCloud.session.listeners.push({on_reset:function(){e.on_stopped()}})},is_running:function(){return n},is_stopping:function(){return r},start_queue:function(){var e=this;if(0===i.length)return n=r=!1,Promise.resolve(void 0);n=!0;var t=Promise.resolve(void 0).then(function(t){return onStartCallbacks.forEach(function(e){e(t)}),t}),o=i.shift();return t.then(o).then(function(){if(r)throw r=!1,"stop";return s.shift(),e.start_queue()})},stop:function(){n&&(rcloud.has_compute_separation?rcloud.signal_to_compute(2):r=!0)},on_stopped:function(){s.forEach(function(e){e()}),i=[],n=!(s=[]),l=null},addFinallyCallback:function(e){finallyCallbacks.push(e)},addOnStartCallback:function(e){onStartCallbacks.push(e)},enqueue:function(e,t){var o=this;return i.push(e),s.push(t||function(){}),n||(l=o.start_queue().catch(function(e){if("stop"===e)s.shift(),o.on_stopped();else if(console.log(e),o.on_stopped(),!/^ERROR FROM R SERVER: 127/.test(e))throw e}).finally(function(t){return finallyCallbacks.forEach(function(e){e(t)}),t})),l}}}(),RCloud.UI.run_button=function(){var t=!1,o=!1;function n(e){RCloud.UI.navbar.control("run_notebook").highlight(e)}function r(e){e?RCloud.UI.navbar.control("run_notebook").enable():RCloud.UI.navbar.control("run_notebook").disable()}function i(e){return(t?RCloud.session.reset().then(function(){return rcloud.load_notebook(shell.gistname(),shell.version())}):Promise.resolve(void 0)).then(function(){return shell.run_notebook()})}return{init:function(){var t=this;RCloud.session.listeners.push({on_reset:function(){t.on_stopped()}}),RCloud.UI.processing_queue.addOnStartCallback(function(e){r(!1),n(!0)}),RCloud.UI.processing_queue.addFinallyCallback(function(e){t.on_stopped()})},run:function(){var e=Promise.resolve(void 0);return RCloud.UI.processing_queue.is_running()||o||(o=!0,e=e.then(i).finally(function(e){o=!1})),e},on_stopped:function(){n(!1),r(!0)},reset_on_run:function(e){return arguments.length?(t=e,this):t}}}(),RCloud.UI.stop_button=function(){function o(e){e?RCloud.UI.navbar.control("stop_notebook").enable():RCloud.UI.navbar.control("stop_notebook").disable()}return{init:function(){var t=this;RCloud.session.listeners.push({on_reset:function(){t.on_stopped()}}),RCloud.UI.processing_queue.addOnStartCallback(function(e){o(!0)}),RCloud.UI.processing_queue.addFinallyCallback(function(e){t.on_stopped()})},on_stopped:function(){o(!1)},stop:function(){RCloud.UI.processing_queue.stop()}}}(),RCloud.UI.scratchpad=function(){var s;return{session:null,widget:null,exists:!1,current_model:null,change_content:null,body:function(){return RCloud.UI.panel_loader.load_snippet("assets-snippet")},init:function(){var a=this;var o,e=$("#scratchpad-editor");e.length&&(this.exists=!0,function(e){var t=$("<div></div>"),o=$("<div style='clear:both;'></div>");e.append(t),e.append(o);var n=$('<div style="width:100%; height:100%"></div>');n.css({"background-color":"#f1f1f1"}),t.append(n),ace.require("ace/ext/language_tools");var r=ace.edit(n[0]),i=ace.require("ace/mode/r").Mode,s=r.getSession();a.session=s,a.widget=r;var l=s.doc;s.on("change",function(){r.resize()}),r.setOptions({enableBasicAutocompletion:!0}),r.commands.addCommands([{name:"blurCell",bindKey:{win:"Escape",mac:"Escape"},exec:function(){a.widget.blur()}}]),s.setMode(new i({suppressHighlighting:!1,doc:l,session:s,language:"R"})),s.setNewLineMode("unix"),s.setOption("indentedSoftWrap",!1),s.setUseWrapMode(!0),r.resize(),ui_utils.on_next_tick(function(){s.getUndoManager().reset(),r.resize()}),a.change_content=ui_utils.ignore_programmatic_changes(a.widget,function(){a.current_model&&a.current_model.parent_model.on_dirty()}),ui_utils.install_common_ace_key_bindings(r,function(){return a.current_model.language()}),$("#collapse-assets").on("shown.bs.collapse panel-resize",function(){r.resize()}),RCloud.UI.thumb_dialog.init(),$("#update-thumb").click(RCloud.UI.scratchpad.update_thumb)}(e),$(document).on("dragstart dragenter dragover",function(e){if(!RCloud.UI.thumb_dialog.is_visible()){var t=e.originalEvent.dataTransfer;t&&null!==t.types&&(t.types.indexOf?-1!=t.types.indexOf("Files")&&-1==t.types.indexOf("text/html"):t.types.contains("application/x-moz-file"))&&(shell.notebook.model.read_only()?(e.stopPropagation(),e.preventDefault()):(e.stopPropagation(),e.preventDefault(),$("#asset-drop-overlay").css({display:"block"}),o=!0))}}),$(document).on("drop dragleave",function(e){e.stopPropagation(),e.preventDefault(),o=!1,setTimeout(function(){o||$("#asset-drop-overlay").css({display:"none"})},100)}),$("#scratchpad-wrapper").bind({drop:function(e){var t=(e=e.originalEvent||e).files||e.dataTransfer.files;e.dataTransfer,shell.notebook.model.read_only()||RCloud.UI.upload_with_alerts(!0,{files:t}).catch(function(){}),$("#asset-drop-overlay").css({display:"none"})},"dragenter dragover":function(e){var t=e.originalEvent.dataTransfer;shell.notebook.model.read_only()||(t.dropEffect="copy")}})),$("#new-asset > a").click(function(){var e=prompt("Choose a filename for your asset");if(e&&(e=e.trim()))if(Notebook.is_part_name(e))alert("Asset names cannot start with 'part[0-9]', sorry!");else{var t=shell.notebook.model.get_asset(e);if(t)t.controller.select();else{var o=-1!=e.indexOf(".")?e.match(/\.(.*)/)[1]:"";shell.notebook.controller.append_asset(function(e,t){switch(t){case"css":return"/* "+e+" */\n";case"js":return"// "+e+"\n";case"html":return"\x3c!-- "+e+" --\x3e\n";default:return"# "+e+"\n"}}("New file "+e,o),e).spread(function(e,t){t.select(),ui_utils.ace_set_pos(RCloud.UI.scratchpad.widget,2,1)})}}})},panel_sizer:function(e){return{padding:RCloud.UI.collapsible_column.default_padder(e),height:9e3}},set_model:function(e){var t=this;if(this.exists){if(this.current_model&&!s&&(this.current_model.cursor_position(this.widget.getCursorPosition()),this.current_model.content(this.widget.getValue())&&this.current_model.parent_model.controller.update_asset(this.current_model)),this.current_model=e,!this.current_model)return $("#scratchpad-binary").hide(),$("#scratchpad-editor").show(),t.change_content(""),t.widget.resize(),t.widget.setReadOnly(!0),$("#scratchpad-editor > *").hide(),void $("#asset-link").hide();this.update_asset_url(),$("#asset-link").show();var o=this.current_model.content();if(Notebook.is_binary_content(o)){s=!0,$("#scratchpad-editor").hide();var n=$("#scratchpad-binary"),r=this.current_model.filename().substr(this.current_model.filename().lastIndexOf(".")+1);-1!==["bmp","jpg","jpeg","png","gif"].indexOf(r.toLowerCase())?(n.html('<div><img src="'+this.current_model.asset_url(!0)+'"/></div>"'),n.find("div").removeClass("embed")):"pdf"===r.toLowerCase()?(n.html('<div><object><embed type="application/pdf" src="'+this.current_model.asset_url(!0)+'" /></object></div>'),n.find("div").addClass("embed")):(n.html("<div><p>Preview not supported for this file type</p></div>"),n.find("div").removeClass("embed")),n.show()}else{s=!1,t.widget.setReadOnly(shell.notebook.model.read_only()),$("#scratchpad-binary").hide(),$("#scratchpad-editor").show(),$("#scratchpad-editor > *").show(),this.change_content(o);var i=e.cursor_position();i?ui_utils.ace_set_pos(this.widget,i):ui_utils.ace_set_pos(this.widget,0,0),ui_utils.on_next_tick(function(){t.session.getUndoManager().reset()}),t.language_updated(),t.widget.resize(),t.widget.focus()}}},update_model:function(){return this.current_model&&!s?this.current_model.content(this.widget.getSession().getValue()):null},content_updated:function(){var e;if(e=this.current_model.content(),s=Notebook.is_binary_content(e),e&&!s){var t=this.widget.getSelection().getRange();this.change_content(e),this.widget.getSelection().setSelectionRange(t)}return e},language_updated:function(){if(!s){var e=this.current_model.language(),t=RCloud.language.ace_mode(e);this.session.setMode(new t({suppressHighlighting:!1,doc:this.session.doc,session:this.session,language:e}))}},set_readonly:function(e){shell.is_view_mode()||(this.widget&&!s&&ui_utils.set_ace_readonly(this.widget,e),$("#new-asset, #update-thumb")[e?"hide":"show"]())},update_asset_url:function(){this.current_model&&$("#asset-link").attr("href",this.current_model.asset_url())},update_thumb:function(){var e=shell.notebook.model.get_asset("thumb.png");e&&e.controller.select(),RCloud.UI.thumb_dialog.show()},clear:function(){this.exists&&(this.change_content(""),this.session.getUndoManager().reset(),this.widget.resize())}}}(),RCloud.UI.search=function(){var p=10,m=['<p style="color:black;margin:0;">The search engine in RCloud uses Lucene for advanced search features.',"It appears you may have used one of the special characters in Lucene syntax incorrectly. ",'Please see this <a target="_blank" href="http://lucene.apache.org/core/4_10_0/queryparser/org/apache/lucene/queryparser/classic/package-summary.html#Terms">link</a> to learn about Lucene syntax. ','</p><p style="color:black;margin:0;">Or, if you mean to search for the character itself, escape it using a backslash, e.g. "foo\\:"</p>'];function o(){return $("#sort-by option:selected").val()}function n(){return $("#order-by option:selected").val()}function r(){return $("#all-sources").is(":checked")}function i(){var e;switch(o()){case"starcount":case"updated_at":case"score":e="desc";break;case"user":case"description":e="asc"}$("#order-by").val(e)}return{body:function(){return RCloud.UI.panel_loader.load_snippet("search-snippet")},init:function(){if(rcloud.search){$("#search-form").submit(function(e){return t(),!1}),rcloud.get_gist_sources().then(function(e){_.isString(e)&&(e=[e]),e.length<2?$("#all-sources").parent().hide():$("#all-sources").change(function(e){var t=r();rcloud.config.set_user_option("search-all-sources",t)})}),$("#sort-by").change(function(){rcloud.config.set_user_option("search-sort-by",o()),i(),rcloud.config.set_user_option("search-order-by",n()),t()}),$("#order-by").change(function(){rcloud.config.set_user_option("search-order-by",n()),t()});var t=function(){var e=$("#input-text-search").val();$("#input-text-search").focus(),""!==$("#input-text-search").val()?RCloud.UI.search.exec(e,o(),n(),0,p):($("#paging").html(""),$("#search-results").html(""),$("#search-summary").html(""))}}else $("#search-wrapper").text("Search engine not enabled on server")},load:function(){return rcloud.config.get_user_option(["search-all-sources","search-results-per-page","search-sort-by","search-order-by"]).then(function(e){$("#all-sources").prop("checked",e["search-all-sources"]),e["search-results-per-page"]&&(p=e["search-results-per-page"]),e["search-sort-by"]||(e["search-sort-by"]="score"),$("#sort-by").val(e["search-sort-by"]),e["search-order-by"]?$("#order-by").val(e["search-order-by"]):i()})},panel_sizer:function(e){var t=RCloud.UI.collapsible_column.default_padder(e),o=24+$("#search-summary").height()+$("#search-results").height()+$("#search-results-pagination").height();return{height:o+=40,padding:t}},toggle:function(n,e){return $("#"+e).text(function(e,t){var o="";return-1<t.indexOf("Show me more...")?(o="Show me less...",$("#"+n).css("height","auto")):(o="Show me more...",$("#"+n).css("height","150px")),o}),!1},exec:function(c,e,t,u,d,f){function h(e,t){$("#search-summary").css("color",t||"black"),$("#search-summary").show().html($("<h4/>").append(e))}function o(e){console.log(e);var t,o,n="";if(null===e||"null"===e||"0"===e.n_notebooks)h("No Results Found");else if("error"===e[0])e[1]=e[1].replace(/\n/g,"<br/>"),""!=$("#paging").html&&$("#paging").html(""),-1<e[1].indexOf("org.apache.solr.search.SyntaxError")&&(n=m.join("")),t=n+"ERROR:\n"+e[1],o="darkred",$("#search-summary").css("display","none"),$("#search-results").css("color",o||"black"),$("#search-results-row").show().animate({scrollTop:$(document).height()},"slow"),$("#search-results").show().html($("<h4/>").append(t));else{try{numpaged=numfound=parseInt(e.n_notebooks);e.QTime;var r=Math.ceil(numpaged/p),i=_.template($("#search_results_template").html())}catch(e){h("Error : \n"+e,"darkred")}if(!f&&($("#paging").html(""),$("#search-results-pagination").show(),0<parseInt(numpaged)-parseInt(p))){var s=r;if($("#current_page").val(0),0!=numfound){$("#paging").bootpag({total:s,page:1,maxVisible:8}).on("page",function(e,t){var o,n,r,i,s,l;o=p,n=parseInt(t-1)*parseInt(o),r=parseInt(n)+parseInt(o),i=$("#input-text-search").val(),s=$("#sort-by option:selected").val(),l=$("#order-by option:selected").val(),$("#input-text-search").blur(),""!==$("#input-text-search").val()&&RCloud.UI.search.exec(i,s,l,n,r,!0)})}}var l=decodeURIComponent(c);if(l=(l=l.replace(/</g,"&lt;")).replace(/>/g,"&gt;"),0===numfound)h("No Results Found");else if(parseInt(numpaged)<p)h(numfound+" Results Found","darkgreen");else{var a=numfound+" Results Found, showing ";numfound-u==1?a+=u+1:0<numfound-d?a+=u+1+" - "+d:a+=u+1+" - "+numfound,h(a,"darkgreen")}$("#search-results-row").css("display","table-row"),$("#search-results-scroller").scrollTop(0),$("#search-results").html(i({notebooks:e.notebooks})),$("#search-results .search-result-heading").click(function(e){e.preventDefault();var t=$(this).attr("data-gistname"),o=$(this).attr("data-gistsource");return editor.open_notebook(t,null,o,null,e.metaKey||e.ctrlKey),!1})}$("#collapse-search").trigger("size-changed")}h("Searching..."),f||($("#search-results-row").hide(),$("#search-results").html("")),c=encodeURIComponent(c),RCloud.UI.with_progress(function(){return rcloud.search(c,r(),e,t,u,p).then(function(e){o(e)})})}}}(),RCloud.UI.session_pane={error_dest_:null,clear_session_:null,allow_clear:!0,BUFFER_LIMIT:1e4,body:function(){return RCloud.UI.panel_loader.load_snippet("session-info-snippet")},init:function(){var o=this;this.error_dest_=$("#session-info"),this.error_dest_.length?this.show_error_area=function(){RCloud.UI.right_panel.collapse($("#collapse-session-info"),!1,!1)}:(this.error_dest_=$("#output"),this.show_error_area=function(){}),RCloud.session.listeners.push({on_reset:function(){o.clear()}}),this.clear_session_=$("#clear-session"),this.clear_session_.length&&this.clear_session_.click(function(e){e.preventDefault(),e.stopPropagation(),o.clear()}),Promise.onPossiblyUnhandledRejection(function(e,t){o.post_rejection(e)})},panel_sizer:function(e){var t=RCloud.UI.collapsible_column.default_sizer(e);return t.height&&(t.height+=20),t},error_dest:function(){return this.error_dest_},clear:function(){this.allow_clear&&$("#session-info").empty()},should_scroll:function(){return-10<$("#session-info-panel").scrollTop()+$("#session-info-panel").height()-$("#session-info-out").height()},scroll_to_end:function(){ui_utils.on_next_tick(function(){ui_utils.scroll_to_after($("#session-info"))})},append_text:function(e){if($("#session-info").length){document.getElementById("session-info-out")||$("#session-info").append($("<pre id='session-info-out'></pre>"));var t=$("#session-info-out"),o=t.text();o.length>this.BUFFER_LIMIT&&(o=o.slice(o.length-this.BUFFER_LIMIT/2),t.text(o),console.log("truncated session log"));var n=this.should_scroll();t.append(e),RCloud.UI.right_panel.collapse($("#collapse-session-info"),!1,!1),n&&this.scroll_to_end()}else console.log("session log: ",e)},post_error:function(e,t,o){if($("#loading-animation").hide(),(t=t||this.error_dest_)&&t.length){var n="session-error";if("string"==typeof e)e=ui_utils.string_error(e),n="session-error spare";else if("object"!=typeof e)throw new Error("post_error expects a string or a jquery div");var r=this.should_scroll();e.addClass(n),t.append(e),this.show_error_area(),r&&this.scroll_to_end()}else"object"==typeof e&&(e=e.text()),RCloud.UI.fatal_dialog(e,"Login",ui_utils.relogin_uri());o||("object"==typeof e&&(e=e.text()),console.log("pre-init post_error: "+e))},post_rejection:function(e){var t="";RCloud.is_exception(e)?t=RCloud.exception_message(e):(!window.chrome&&e.message&&(t+="Error: "+e.message+"\n"),t+=e.stack),console.log(t),this.post_error(t,void 0,!0)},heading_content:function(){return RCloud.UI.panel_loader.load_snippet("session-info-panel-heading")},heading_content_selector:function(){return $("#session-panel-controls")}},RCloud.UI.settings_frame=function(){var t,r={},i={},s={};function l(e,t){try{s[e]=!0,r[e].set(t,i[e])}catch(e){throw e}finally{s[e]=!1}}var a={body:function(){return t=$.el.div({id:"settings-body-wrapper",class:"panel-body"},$.el.div({id:"settings-scroller",style:"width: 100%; height: 100%; overflow-x: auto"},$.el.div({id:"settings-body",class:"widget-vsize"})),$.el.span({class:"settings-reload-msg",style:"display: none"},"Reload to see changes"))},panel_sizer:function(e){var t=RCloud.UI.collapsible_column.default_sizer(e);return{height:t.height+5,padding:t.padding}},show_reload_msg:function(e){e?$(t).find(".settings-reload-msg").show():$(t).find(".settings-reload-msg").hide()},checkbox:function(i){return{sort:(i=_.extend({sort:1e4,default_value:!1,needs_reload:!1,label:"",id:"",set:function(e){}},i)).sort,default_value:i.default_value,create_control:function(t){var e=$.el.input({type:"checkbox"});$(e).prop("id",i.id);var o=$.el.span(i.label),n=$.el.label(e,o),r=$($.el.div({class:"checkbox"},n));return $(e).change(function(){var e=$(this).prop("checked");t(e),i.needs_reload&&a.show_reload_msg(!0),i.set(e)}),r},set:function(e,t){e=!!e,t.find("input").prop("checked",e),i.set(e)}}},text_input:function(s){return{sort:(s=_.extend({sort:1e4,default_value:"",needs_reload:!1,label:"",id:"",parse:function(e){return e},format:function(e){return e},set:function(e){}},s)).sort,default_value:s.default_value,create_control:function(t){var o=$.el.input({type:"text",class:"form-control-ext"});$(o).prop("id",s.id);var e=$.el.span(s.label),n=$.el.label(e,o),r=$($.el.div({class:"settings-input"},n));function i(){var e=$(o).val();e!==r.data("original-value")&&(e=s.parse(e),t(e),s.needs_reload&&a.show_reload_msg(!0),s.set(e),e=s.format(e),$(o).val(e),r.data("original-value",e))}return $(o).keydown(function(e){e.keyCode===$.ui.keyCode.ENTER?i():e.keyCode===$.ui.keyCode.ESCAPE&&$(o).val(r.data("original-value"))}),$(o).blur(function(){i()}),r},set:function(e,t){s.set(e),e=s.format(e),t.find("input").val(e),t.data("original-value",e)}}},text_input_vector:function(e){return e=_.extend({parse:function(e){return e.trim().split(/[, ]+/).filter(function(e){return!!e})},format:function(e){return e.join?e.join(", "):e}},e),this.text_input(e)},init:function(){var e=this;this.add({"show-command-prompt":e.checkbox({sort:1e3,default_value:!0,label:"Show Command Prompt",set:function(e){RCloud.UI.command_prompt.show_prompt(e)}}),"show-terse-dates":e.checkbox({sort:2e3,default_value:!0,needs_reload:!0,label:"Show Terse Version Dates",set:function(e){editor.set_terse_dates(e)}}),"show-cell-numbers":e.checkbox({sort:3e3,default_value:!0,label:"Show Cell Numbers",set:function(e){shell.notebook.controller.show_cell_numbers(e)}}),"color-recent-notebooks-by-modification-date":e.checkbox({sort:3500,default_value:!1,needs_reload:!0,label:"Color recent notebooks by modification date",set:function(e){editor.color_recent_notebooks_by_modification_date(e)}}),"show-folder-dates":e.checkbox({sort:3750,default_value:!1,needs_reload:!0,label:"Show folder date for date ordered tree",set:function(e){editor.set_show_folder_dates(e)}}),"panel-layout-by-size":e.checkbox({sort:4e3,default_value:!0,needs_reload:!0,label:"Arrange panels by size"}),"clear-r-session-when-run-all":e.checkbox({sort:5e3,default_value:!0,label:"Clear R Session when entire notebook is run",set:function(e){RCloud.UI.run_button.reset_on_run(e)}}),"export-only-selected-cells":e.checkbox({sort:6e3,default_value:!0,label:"Export only selected cells",set:function(e){RCloud.UI.import_export.export_only_selected_files(e)}}),"autoscroll-notebook-output":e.checkbox({sort:6500,default_value:!0,label:"Autoscroll notebook",set:function(e){shell.notebook.controller.autoscroll_notebook_output(e)}}),addons:e.text_input_vector({sort:1e4,needs_reload:!0,label:"Enable Extensions"}),"skip-addons":e.text_input_vector({sort:11e3,needs_reload:!0,label:"Disable Extensions"}),"new-notebook-prefix":e.text_input({sort:12e3,label:"New Notebook Prefix",default_value:editor.new_notebook_prefix(),set:function(e){editor.new_notebook_prefix(e)},parse:function(e){return e.split("/").filter(function(e,t,o){return t==o.length-1||!Notebook.empty_for_github(e)}).join("/")}})})},add:function(e){_.extend(r,e)},remove:function(e){delete r[e]},load:function(){var o=[];_.keys(r).forEach(function(t){var e=r[t];i[t]=e.create_control(function(e){s[t]||rcloud.config.set_user_option(t,e)}),o.push({sort:e.sort,control:i[t]})}),o=o.sort(function(e,t){return e.sort-t.sort});for(var e=$("#settings-body"),t=0;t<o.length;++t)e.append(o[t].control);var n=_.keys(r);return 1===n.length&&n.push("foo"),rcloud.config.get_user_option(n).then(function(e){for(var t in e){if("foo"!==t&&"r_attributes"!==t&&"r_type"!==t)l(t,null!==e[t]?e[t]:r[t].default_value)}})}};return a}(),RCloud.UI.share_button=function(){var i,o=null;function s(e){return rcloud.get_notebook_property(e,"view-type").then(function(e){return(e=e&&i.get(e)?e:o)||Promise.reject(new Error("share button view types set up wrong"))})}function n(o,n,e){var t=null;t=n?rcloud.get_tag_by_version(o,n).then(function(e){var t={notebook:o,version:n};return e&&(t.tag=e),t}):Promise.resolve(void 0).then(function(e){return{notebook:o}});var r=e?Promise.resolve(i.get(e)):s(o).then(function(e){return i.get(e)});return Promise.join(t,r,function(e,t){var o=t.page;return e.do_path=t.do_path,ui_utils.make_url(o,e)})}function r(e){e&&$("#view-type li a").css("font-weight",function(){return $(this).text()===e?"bold":"normal"})}return{init:function(){return i=RCloud.extension.create({defaults:{create:function(){var t=this;return{title:t.key,handler:function(){var e;return(e=(e=t.key)&&i.get(e)?e:o)?rcloud.set_notebook_property(shell.gistname(),"view-type",e):Promise.reject(new Error("share button view types set up wrong")),r(t.key),n(shell.gistname(),shell.version(),t.key).then(function(e){var t=RCloud.UI.navbar.control("shareable_link");t.set_url(e),t.open()})}}}}}),this.add({"view.html":{sort:1e3,page:"view.html"},"notebook.R":{sort:2e3,page:"notebook.R",do_path:!0},"mini.html":{sort:3e3,page:"mini.html"}}),this},add:function(e){return i&&i.add(e),this},remove:function(e){return i&&i.remove(command_name),this},load:function(){var e=i.create("all").array;return o=e.length?e[0].title:null,RCloud.UI.navbar.control("shareable_link").set_view_types(e),this},update_link:function(){return n(shell.gistname(),shell.version()).then(function(e){RCloud.UI.navbar.control("shareable_link").set_url(e)}).then(function(){return s(shell.gistname()).then(function(e){r(e)})})},resolve_view_link:function(e,t){return n(e,t)}}}(),RCloud.UI.upload_with_alerts=function(e,t){function n(e){t.$upload_results.append(e),t.$result_panel.trigger("size-changed"),t.$upload_results.length&&ui_utils.on_next_tick(function(){ui_utils.scroll_to_after(t.$upload_results)})}function i(e){var t=$("<div></div>");t.append(e);var o=bootstrap_utils.alert({class:"alert-danger",html:t});return n(o),o}function o(e){n(bootstrap_utils.alert({class:"alert-info",text:e,on_close:function(){t.$progress.hide(),t.$result_panel.trigger("size-changed")}}))}var r;return(t=function(e){if(_.isBoolean(e))e={force:e};else if(!_.isObject(e))throw new Error("didn't understand options "+e);return e=$.extend({$file:$("#file"),$progress:$(".progress"),$progress_bar:$("#progress-bar"),$upload_results:$("#file-upload-results").length?$("#file-upload-results"):RCloud.UI.session_pane.error_dest(),$result_panel:$("#collapse-file-upload")},e)}(t||{})).$result_panel.length&&!1!==t.show_result&&t.$result_panel.parent().parent().data("collapsible-column").collapse(t.$result_panel,!1),(e?RCloud.upload_assets(t,{add:function(e){o("Asset "+e+" added.")},replace:function(e){o("Asset "+e+" replaced.")}}):RCloud.upload_files(t,(r=t,{start:function(e){r.$progress.show(),r.$progress_bar.css("width","0%"),r.$progress_bar.attr("aria-valuenow","0")},progress:function(e,t){r.$progress_bar.attr("aria-valuenow",~~(e/t*100)),r.$progress_bar.css("width",e/t*100+"%")},done:function(e,t){o("File "+t+" "+(e?"replaced.":"uploaded."))},confirm_replace:Promise.promisify(function(e,t){var o=$("<p>File "+e+" exists. </p>"),n=bootstrap_utils.button({class:"btn-danger"}).click(function(){r.remove(),t(null,!0)}).text("Overwrite");o.append(n);var r=i(o);$("button.close",r).click(function(){t(new Error("Overwrite cancelled"),null)})})}))).catch(function(e){return function(e){var t,o=e.message;throw"empty"===o?t=$("<p>File is empty.</p>"):"Overwrite cancelled"===o?t=$("<p>").append(o):"badname"===o?t=$("<p>Filename not allowed.</p>"):(t=$("<p>(unexpected) "+o+"</p>"),console.log(o,e.stack)),i(t),e}(e)}).then(function(){t.$progress.length&&window.setTimeout(function(){t.$progress.hide()},5e3)})},RCloud.UI.upload_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("file-upload-snippet")},init:function(){$("#file").change(function(){$("#progress-bar").css("width","0%"),0===$("#file")[0].files.length?$("#upload-submit").prop("disabled",!0):$("#upload-submit").prop("disabled",!1)}),$("#upload-submit").prop("disabled",!0),$("#upload-submit").click(function(){if(0!==$("#file")[0].files.length){var e=$("#upload-to-notebook").is(":checked");RCloud.UI.upload_with_alerts(e).catch(function(){})}}),RCloud.session.listeners.push({on_reset:function(){$(".progress").hide(),$("#file-upload-results").empty(),$("#upload-submit").prop("disabled",!0)}})},panel_sizer:function(e){var t=RCloud.UI.collapsible_column.default_padder(e);return{height:24+$("#file-upload-controls").height()+$("#file-upload-results").height(),padding:t}}},RCloud.UI.thumb_dialog=function(){var e=$("#thumb-dialog"),r=$("#thumb-drop-overlay"),o=r.find(".inner"),n=e.find(".modal-footer"),i=n.find(".btn-primary"),s=$("#thumb-remove"),l=$("#thumb-upload"),a=$("#selected-file"),t=$("#upload-success"),c=null,u={is_visible:function(){return e.is(":visible")},set_image:function(e){var t=r;return 0===t.find("img").length&&t.append($("<img/>")),t.find("img").attr({src:e}),t},reset:function(){r.removeClass("active dropped"),r.find("img").remove(),c=null,ui_utils.disable_bs_button(i),r.css("height",r.data("height")+"px")},verify:function(e){var t=1===e.length&&"image/png"===e[0].type;return t||o.effect("shake"),t},display_image:function(e){r.addClass("dropped"),this.set_image(e),t.show(),setTimeout(function(){t.animate({"margin-top":"0px",opacity:"0"},{duration:"fast",complete:function(){t.css({opacity:"1.0","margin-top":"35px"}).hide()}})},1500)},upload:function(e){c=e,ui_utils.enable_bs_button(i);var t=this,o=new FileReader;o.onload=function(e){t.display_image(e.target.result)},o.readAsDataURL(c)},setup_paste:function(){var n=this;$(document).on("paste",function(e){if(n.is_visible()){var t=(e.clipboardData||e.originalEvent.clipboardData).items,o=_.find(t,function(e){return"file"===e.kind});o&&n.verify([o])&&n.upload(o.getAsFile())}})},setup_asset_drop:function(){var o,n=this;$(document).on("dragstart dragenter dragover",function(e){if(n.is_visible()){var t=e.originalEvent.dataTransfer;t&&null!==t.types&&(t.types.indexOf?-1!=t.types.indexOf("Files")&&-1==t.types.indexOf("text/html"):t.types.contains("application/x-moz-file"))&&(shell.notebook.model.read_only()?(e.stopPropagation(),e.preventDefault()):(e.stopPropagation(),e.preventDefault(),r.addClass("active"),o=!0))}}),$(document).on("drop dragleave",function(e){n.is_visible()&&(e.stopPropagation(),e.preventDefault(),o=!1,setTimeout(function(){o||r.removeClass("active")},100))}),r.bind({drop:function(e){var t=(e=e.originalEvent||e).files||e.dataTransfer.files;n.verify(t)&&n.upload(t[0])},"dragenter dragover":function(e){var t=e.originalEvent.dataTransfer;shell.notebook.model.read_only()||(t.dropEffect="copy")}})},init:function(){var t=this;e.on("hidden.bs.modal",function(){t.reset()}),n.find(".btn-cancel").on("click",function(){e.modal("hide"),t.reset()}),ui_utils.disable_bs_button(i),i.on("click",function(){e.modal("hide"),c&&RCloud.UI.upload_with_alerts(!0,{files:[c],filenames:["thumb.png"],show_result:!1}).catch(function(){}),t.reset()}),s.click(function(){t.reset()}),l.click(function(){a.click()}),a.change(function(e){t.verify(e.target.files)&&(t.upload(e.target.files[0]),a.val(""))}),this.setup_asset_drop(),this.setup_paste()},show:function(){r.removeClass("active"),e.modal({keyboard:!0})}};return{init:function(){u.init()},show:function(){u.show()},is_visible:function(){return u.is_visible()},display_image:function(e){u.display_image(e),c=function(e){for(var t=e.split(","),o=t[0].match(/:(.*?);/)[1],n=atob(t[1]),r=n.length,i=new Uint8Array(r);r--;)i[r]=n.charCodeAt(r);return new Blob([i],{type:o})}(e),ui_utils.enable_bs_button(i)}}}(),RCloud.UI.notebook_protection_logger={timeout:0,log:function(e){$(".logging-panel").removeClass("red").removeClass("white").addClass("green"),$(".logging-panel span").text(e),window.clearTimeout(this.timeout),this.timeout=setTimeout(function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")},2e4)},warn:function(e){$(".logging-panel").removeClass("green").removeClass("white").addClass("red"),$(".logging-panel span").text(e),window.clearTimeout(this.timeout),this.timeout=setTimeout(function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")},2e4)},clear:function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")}},RCloud.UI.notebook_protection=function(){return this.defaultCryptogroup=null,this.defaultNotebook=null,this.userId=null,this.userLogin=null,this.appScope=null,this.appInited=!1,{init:function(n){if(this.appInited)this.launch(n),$("#notebook-protection-dialog").modal({keyboard:!1});else{this.appInited=!0,this.buildDom();var r=this;require(["angular","./../../js/ui/notebook_protection_app","angular-selectize"],function(e,t,o){"use strict";e.element(document).ready(function(){_.delay(function(){e.bootstrap($("#protection-app")[0],["NotebookProtectionApp"]),e.resumeBootstrap()},100),_.delay(function(){r.appScope=e.element(document.getElementById("protection-app")).scope(),r.launch(n),$("#notebook-protection-dialog").modal({keyboard:!1})},200)})})}},launch:function(e){"both-tabs-enabled"===e?($("#protection-app #tab2").removeClass("active"),$("#protection-app #tab1").removeClass("disabled").addClass("active"),$("#protection-app #tab1 a").attr("href","#notebook-tab").attr("data-toggle","tab"),$("#protection-app #tab2 a").tab("show"),$("#protection-app #tab1 a").tab("show"),this.appScope.initBoth()):"group-tab-enabled"===e&&($("#protection-app #tab1").removeClass("active").addClass("disabled"),$("#protection-app #tab1 a").attr("href","#").removeAttr("data-toggle"),$("#protection-app #tab2 a").tab("show"),this.appScope.initGroups())},buildDom:function(){var e=$('<div class="container"></div>');e.append(RCloud.UI.panel_loader.load_snippet("notebook-protection-modal"));var t=$(['<div class="modal-header">','<button type="button" class="close" onClick="(RCloud.UI.notebook_protection.close.bind(RCloud.UI.notebook_protection))()" aria-hidden="true">&times;</button>',"<h3>Notebook Permissions / Group Management</h3>","</div>"].join("")),o=$('<div id="notebook-protection-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(t).append(e)));$("body").append(o)},close:function(){this.appScope.cancel()}}}(),RCloud.UI.discovery_page=function(){var n,r=function(){var t=$("#metric-type"),o=["recently.modified","most.popular"],n=o[0];function l(e){t.find("li").removeClass("active"),t.find('a[data-type="'+e+'"]').parent().addClass("active")}function r(){return t.find("a")}var i=function(){var e=RCloud.utils.get_url_parameter("metric");return-1<o.indexOf(e)?e:n};return{init:function(s){_.each(r(),function(e){$(e).attr("href","?metric="+$(e).attr("data-type"))}),r().click(function(e){e.preventDefault();var t,o,n,r,i=$(this).attr("data-type");l(i),t="metric",o=i,n=[location.protocol,"//",location.host,location.pathname].join(""),r="?"+t+"="+o,window.history.pushState({path:n+r},"",n+r),_.isFunction(s.change)&&s.change(i)}),window.addEventListener("popstate",function(e){if(_.isFunction(s.change)){var t=i();l(t),s.change(t)}});var e=i();l(e),_.isFunction(s.oncomplete)&&s.oncomplete(e)}}},i={load_current_metric:function(e){var o;e=e||"recently.modified",$("body").addClass("loading");var i=!rcloud.username();return rcloud.discovery.get_notebooks(e).then(function(e){return o=e,RCloud.discovery_model.get_notebooks(i,Object.keys(o.values))}).then(function(r){var e=_.chain(o.values).pairs().filter(function(e){return"r_attributes"!=e[0]&&"r_type"!=e[0]&&!_.isEmpty(r[e[0]])});"date"===o.sort?e=e.map(function(e){return[e[0],Date.parse(e[1])]}).sortBy(function(e){return-1*e[1]}):"number"===o.sort&&(e=e.sortBy(function(e){return-1*e[1]}));100<(e=e.value()).length&&(e=e.slice(0,100));var t=e.map(function(t){var e,o=r[t[0]],n=(e=o.description)&&-1!=e.lastIndexOf("/")?{path:e.substring(0,e.lastIndexOf("/")),name:e.substring(e.lastIndexOf("/")+1)}:{path:void 0,name:e};return rcloud.discovery.get_thumb(t[0]).then(function(e){return{id:t[0],time:t[1],description:n.name,folder_path:n.path,last_commit:o.last_commit,last_commit_date:new Date(o.last_commit).toDateString(),page:i?"view.html":"edit.html",username:o.username,stars:o.stars,star_icon:!_.isUndefined(o.is_starred_by_me)&&o.is_starred_by_me?"icon-star":"icon-star-empty",forks:o.forks,image_src:e||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAMAAAC3Ycb+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAURQTFRF6PH06fH0+fv8w9fd+vz94+3xxtne5O7xwNXbx9nf9fn64u3w5/Dzwtbc5u/yxdjeydvgz9/k4ezv1eTo9vr73+vu3Ons8vf4+vz84+7x6/P13entx9rf5vDy7/X32efr9vn6wdbb3ert8vf5zd7jzN3i8/j59Pj51uTo8Pb48fb4zt/k0ODlytzh9/r7w9fc1+Xp0+LnwdXb1OPn2+js4ezw4Ozv7vT2yNrg2ebq6PHz6vL0xNjdy9zh2Obq2OXq2ufr0+Lm7fT20uLm6vL17PT25vDzyNvg+Pr73urt5/Hz8/f57vX36fL0+fz8xtnf8ff4zN7i1uXp9Pj6xNfd3Ojs3uru+Pv77PP1+Pv84Ovv1OPo0uHm0eHlzt7jy93i8Pb30ODk6/L17PP21ePo5O7yydvh5O/y0eHm4+3wv9Ta5e/yk3jLJAAACxdJREFUeNrs3f1bFNcVwPGjKLvruu4CAlKwCAFFgfAiWrWAUNpQkzZGY22jpmn63nv//9+rxii7DLszc8/MnNn5nufJ88TnYYZzzsfx7p25c1emxROGQuQ8IoY43l4fiBjyOC/iEbHk4cUjYsnjPQgidjx+AkHEjMcHEESsePwMgogRj48giNjw+ASCiAmPEyCIWPA4CYKIAY8uEESK9+gGQaRwjx4QRIr26AVBpGCPUyCIFOtxGgSRQj0iQBAp0iMKBJECPSJBECnOIxoEkcI8zgBBpCiPs0AQKcjjTBBEivE4GwSRQjz6gCBShEc/EEQK8OgLgkj+Hv1BEMndYwAIInl7DAJBJGePgSCI5OsxGASRXD1igCCSp0ccEERy9IgFgkh+HvFAEMnNIyYIInl5xAVBJCeP2CCI5OMRHwSRXDwSgCCSh0cSEERy8EgEgkj2HslAEMncIyEIIll7JAVBJOt+iUfEkkdyEESy7ZV4RCx5pAFBJMs+iUfEkkc6EESy65F4RCx5pAVBJKv+iEfEkkd6EESy6Y14RCx5hIAgkkVfxCNiySMMBBH9nohHxJJHKAgi2v0Qj4glj3AQRHR7IR4RSx4aIIho9kE8IpY8dEAQ0euBeERMdUA8IqbqF4+IqerFI2KqdvGImKpcPCKm6haPiKmqxSNiqmbxiJiqWDwipuoVj4ipasUjYqpW8YiYqlQ8IqbqFI+IqSrFI2KqRvGImKpQPCKm6hOPiKnqxCNiqjbxiJiqTDwipuoSj4ipqsQjYqom8YiYqkg8IqbqEY+IqWrEI2KqFvGImKpEPCKm6hCPiKkqxCNiqgbxiJiqQDwipvIXj4ip7MUjYip38YiYylw8IqbyFo+Iqax5v9waPy0AhAAEEAIQQAhAACEAAYQAhBhqkCdjoy5VtJcXAVGP2poLiLuAKMfFOeeGSKT0ILVAD+dmAdGMv4Z6uAeAKMa8C48/AaIWMyMKIMuAqMWWgoer1wDRGtE3+ne68S7aA0UeA6IUryMZlv95MPuq+a/uH202m5OTs1Pzb+qnjxgDROkCiRpB5u4PnNf3HrILiE48jLob8p/Bx021eg66B4hKLEeAvIpz4GbPQQ8B0YhmxHAwEu/fup6j1gDRiJWIC+Tf8Q7tGXzmANGI9QiQmOPzgtmZSIlBavWoD73/i3Pofbt3T0oMshM5yYs1p5joPep7QMLjv9HT7jifmObSfRYApG90IjQ2Go2lycHzEMN3T4oEqc0vNV44ozHSWN5vVgtkZcMZj4WtWnVAmh1Xgng6XhWQi21Xiti4XxGQjitJjM5UAmTFlSa+rwJIbaQ8INv3KgCy70oUExUAWSoTyHoFQBplAmlVAGSkTCAOkPd/L8c2n48tRI6yP0zsrxw+yA/kIiDO7b2/jzQeMV1Z+nCHabYBSH4gox9uIp1eKvr802fnPUByA/n4isDDPssRaqMD1i0uHW4uLi5Ovv1vZ2Ws8wKQ1CCfPtj0PKcdmRnwXOPn6Bydfio7/vjZCCCpQEY//ehGv/sYZ1wijYkzn2TsLG0DEgTS/aM73ecZizp4wCPDmZUXgKiB9PT68PTAsRrjfvlmGxAlkJ63mN+cGjomY/3+2t1tQFRANrvP07O4dyP+UoXxPUA0QH7oHg66P4J1mkly2KwDEg7i5k+epvsN3KOESUy2AQkHaZ24CromjfWDxFnMdAAJBnHtj5P4iZMDcyvN6/+1Z4AEgzj34/ulOVPHXTP4yXSJjAESDuLcbqPR/VJa62XaTJ4BogByajYYsF3JHiD6IPMBqdQagGiDhL0heH8BEF2QucAV0fuAqIJsB6+HXgVEEyR8HdugLYUASQLyVCGdx4DogUxp5PMAEC2QPZV8pgDRAlHawbIDiA5IRymhHUB0QA60MhoFRANkQy2ju4BogOhtq3QPEA2QJ3oprQMSDqK5Q8kEIOEgmruJjgMSDrKvmdMuIMEgqi8sLwESCrKhmtNrQEJBOqo57QASCqK7Q/g4IKEgyl9WVAckEGRTN6kNQAJBDnSTagMSCDKlm9QDQAABBJAMQXZ0k5oDJBBE+Vs/GNRDQZ7rJtUCJBDkSDWnGjP1UJAl1ZwmAQkF0f1enHlAQkG2VXM6AiT4AdVLzZzWAQkGUb3dWwckGERzR90pFjmEgywopnQIiMJCuXm9lNqAKIDofTX9IktJNUDqTa2MfgRE5XUErW8uqLUAUQHRWt37mhd2lF5p01no0P8LZgBJANJWyec5L32qvRatMYoM2DkAkCQgLYUV12tsHKC4tcaz4GyesNeJ6m5AodP1gTtmAZIMpBW4HdDAfRcBSbiB2YOgXObZUU59i7+Q9xJeLgCiDuIOU2cyHuP8gCQGST0bae46QLIASSkyHmv7d0BSgKRaNTcZ7+SApAFxq4k3J51qOUCyA3GN+8mS2Ip7YkDSgbiFJMvhm+sOkIxBnNuLPWmfWHCAZA/i6luxRpLFRN+jC0h6EOdad2cG/fbZ9WSnBOTko/K6SxqtN/1G99r+cdITAuLcx7HgiUsTxyvN6F+8s9pKfjZATtwuXHYpo702/6r70pi9u76d6lSAfLoVcuSCorG8unq4srK6unrcTn8WQN5F52Dm4sGcsxCAGAtAAAEEkBKFH36Qp2XyaFUAZKlMIMcVAHlcJpCtCoDUWuXxqI9XACT+07riY81XAaQ2VxaP3WYlQHyzJJ98FyZ9NUD8vVJcI7t5exQH4mtbC+bH87WLvjogb//Zmlg3PENsd7buFdCUIkEIQAAhAAGEAAQQAhBACEAIQAAhAAGEAAQQAhBACEAIQAAhAAGEAAQQYqhBbn9+xWRPzl04V0mQ21evGP1bWqSI4GFLRPCwJVIUyJ2rtsfWwkQED1sigoctEcHDlkgRIHdulGOOVohIASDflMSjGBHBw5ZI7iDTJfIoQkTwsCWSM8j0Je8RsQNSPo/cRXIF+ayEHnmLCB62RAQPWyKChy0RwcOWSF4gX5XaI0cRwcOWSD4gN7/1HhE7IMPgkZdIHiA3b3mPiB2QYfHIR0TwsCWSOcitIfLIQ0TwsCWSMcitm94jYgdk+DwyF8kU5Nsh9MhaRPCwJZIhyKWvvEfEDsjwemQqkhnIpc+8R8QOyHB7ZCgieNgSETxsiQgetkSyALk07T0idkCq4pGNiOBhS0Qd5EaFPLIQETxsiSiD3PjGe0TsgFTPQ11EFeTGHe8RsQNytZIeyiKChy0RwcOWiBbIlau3vUfEDEjFPRRFBA9bIiogVz6vvIeaiOBhS0Q0PP6GhpqI4GFLRMI9fomEoojgYUtE8LAlEgZy5fd4KIsIHrZEQkCu46EvInjYEkkPcp3xPAsR4fqwJZIW5Pqf8chERNJ6/IGuZyIieNgSSQVy/Ts8shIRPGyJpAC5fv5XdDszEcHDlkhikC/wyFRE8LAlkhDki+/wyFZEuD5siQgetkSSgFw+/xv6m7WI4GFLRPCwJSJ42BIRPGyJCB62RCSmx+/oaT4igoctEcHDlojgYUtE8LAlIoM9/kEncxQRPGyJyCCPv9DFXEX6g1z+Go+cRQQPWyL9QC5f+wX9y1tE8LAlcjbIl3gUISJ42BI5C+TLr/EoRES4PmyJRIM8wqMoEcHDlkgUyCPGj+JEhOvDlojgYUvkFMijC3+nUwWKCB62RHpA5MJv6VKhIoKHLZEuELmGR9EiwvVhS0TwsCUiJzx+TW+KFxE8bInIx/EcDxMiwvVhS0TwsCUiP/0BDysigoctEXn3P3+kG2ZExJ+7hochEeH6sCUieJgSmf6/AAMAF4/8wMtS1yoAAAAASUVORK5CYII="}})});return Promise.all(t).then(function(e){var t=_.template($("#item_template").html());$(".grid").html(t({notebooks:e})).imagesLoaded(function(){new n(".grid",{itemSelector:".grid-item",transitionDuration:0}),$(".body").hasClass("loaded")||$("body").addClass("loaded"),$("body").scrollTop(0).removeClass("loading")})})})},init:function(){return new Promise(function(o,e){require(["imagesloaded.pkgd.min","masonry.pkgd.min"],function(e,t){"use strict";n=t,(new r).init({change:function(e){i.load_current_metric(e)},oncomplete:function(e){o(i.load_current_metric(e))}})},e)})}};return i}(),RCloud.UI.notebook_tree_search_service=function(){var e=function(){};return e.prototype={get_results:function(e){return new Promise(function(t){return rcloud.search_description(e.notebook).then(function(e){t(_.map(e.response.docs,function(e){return{id:e.id,author:e.user,name:e.description,star_count:e.starcount,updated_at:e.updated_at}}))})})}},e}(),RCloud.UI.incremental_search=function(){var e,o,n,r,i,t=!1,s=void 0,l=new RCloud.UI.notebook_tree_search_service;return{init:function(){e=_.template($("#tree-finder-template").html()),o=_.template($("#tree-finder-result-template").html()),r=(n="#tree-finder-dialog")+" input",(i=n+" .results")+"> p",l=new RCloud.UI.notebook_tree_search_service,rcloud.search&&RCloud.UI.shortcut_manager.add([{category:"Incremental Search",id:"incremental_search",description:"Show incremental search",keys:{win_mac:[["alt","s"]]},action:function(){t||s.modal({keyboard:!0}),t=!0}}]),$("body").append(e({})),s=$(n),$(s).on("shown.bs.modal",function(){$($(r)[0]).focus()}),$(s).on("hidden.bs.modal",function(){$(n).modal("hide"),$(r).val(""),$(i).html(""),t=!1}),$(r).on("keyup",function(){var t=[];$(r).map(function(e){t.push($(this).val())}),_.any(t,function(e){return e.length})?l.get_results({notebook:t[0],username:t[1]}).then(function(e){$(i).html(o({notebooks:e}))}):$(i).html("")}),$(i).on("click","p",function(){var t=$(this).data("id");rcloud.config.get_current_notebook().then(function(e){e.notebook!==t&&editor.load_notebook(t),$(n).modal("hide")})})}}}(),RCloud.UI.date_filter=function(e){this.$el_=$(e+" select"),this.on_change=new RCloud.UI.event(this);var t=this;this.$el_.on("change",function(){t.on_change.notify({prop:"tree-filter-date",value:$(this).val()})}),this.val=function(e){this.$el_.val(e)}},RCloud.UI.notebook_tree_model=function(e,t,o){var n=function(e,t,o){"use strict";this.order={HEADER:0,NOTEBOOK:1,MYFOLDER:2,SUBFOLDER:4},this.orderType={DEFAULT:0,DATE_DESC:1},this.username_=e,this.show_terse_dates_=t,this.show_folder_dates_=o,this.path_tips_=!1,this.tree_data_=[],this.histories_={},this.notebook_info_={},this.num_stars_={},this.fork_count_={},this.my_stars_={},this.my_friends_={},this.featured_=[],this.invalid_notebooks_={},this.current_=null,this.gist_sources_=null,this.lazy_load_={},this.sorted_by_=this.orderType.DEFAULT,this.matches_filter_=[],this.empty_folders_=[],this.folder_last_commits={},this.tree_filters_={tree_filter_date:function(){return!0}},this.CONFIG_VERSION=1,this.on_initialise_tree=new RCloud.UI.event(this),this.on_load_by_user=new RCloud.UI.event(this),this.on_open_and_select=new RCloud.UI.event(this),this.on_load_children=new RCloud.UI.event(this),this.on_add_node_before=new RCloud.UI.event(this),this.on_append_node=new RCloud.UI.event(this),this.on_update_node=new RCloud.UI.event(this),this.on_remove_node=new RCloud.UI.event(this),this.on_fake_hover=new RCloud.UI.event(this),this.on_select_node=new RCloud.UI.event(this),this.on_load_data=new RCloud.UI.event(this),this.on_show_history=new RCloud.UI.event(this),this.on_open_node=new RCloud.UI.event(this),this.remove_history_nodes=new RCloud.UI.event(this),this.on_update_sort_order=new RCloud.UI.event(this),this.on_update_show_nodes=new RCloud.UI.event(this),this.on_settings_complete=new RCloud.UI.event(this)};return n.prototype={username:function(){return this.username_},show_terse_dates:function(e){if(!arguments.length)return this.show_terse_dates_;this.show_terse_dates_=e},path_tips:function(){return this.path_tips_},set_current:function(e){this.current_=e},get_current:function(){return this.current_},get_current_notebook_histories:function(){return this.histories_[this.current_.notebook]},get_current_notebook_history_index:function(){return null===this.current_.version?0:this.find_index(this.get_current_notebook_histories(),function(e){return e.version===this.current_.version})},get_history_by_index:function(e){return this.histories_[this.current_.notebook][e]},get_previous:function(){var e=null===this.current_.version?0:this.get_current_notebook_history_index.call(this);return e===this.get_current_notebook_histories().length-1?void 0:this.get_history_by_index(e+1).version},get_next:function(){var e=this.get_current_notebook_history_index();return 0===e?void 0:e-1==0?null:this.get_history_by_index(e-1).version},get_gist_sources:function(){return this.gist_sources_},each_r_list:function(e,t){for(var o in e)"r_attributes"!==o&&"r_type"!==o&&t(o)},r_vector:function(e){return _.isArray(e)?e:[e]},someone_elses:function(e){return e+"'s Notebooks"},get_notebook_star_count:function(e){return this.num_stars_[e]||0},set_notebook_star_count:function(e,t){this.num_stars_[e]=t},notebook_star_count_exists:function(e){return _.has(this.num_stars_,e)},is_notebook_starred_by_current_user:function(e){return this.my_stars_[e]||!1},has_notebook_info:function(e){return this.notebook_info_[e]},get_notebook_info:function(e){return this.notebook_info_[e]||{}},set_notebook_info:function(e,t){this.notebook_info_[e]=t},set_visibility:function(e,t){var o=this.notebook_info_[e]||{};return o.visible=t,this.notebook_info_[e]=o,rcloud.set_notebook_visibility(e,t)},add_interest:function(e,t){this.my_stars_[t]||(this.my_stars_[t]=!0,this.my_friends_[e]=(this.my_friends_[e]||0)+1)},remove_interest:function(e,t){this.my_stars_[t]&&(delete this.my_stars_[t],0==--this.my_friends_[e]&&delete this.my_friends_[e])},get_my_star_count_by_friend:function(e){return this.my_friends_[e]},user_is_friend:function(e){return this.my_friends_[e]},get_notebooks_by_user:function(t){var o=this,n=_.pick(o.notebook_info_,_.filter(Object.keys(o.notebook_info_),function(e){return o.notebook_info_[e].username===t&&!o.notebook_info_[e].recent_only}));return rcloud.config.all_user_notebooks(t).then(o.get_infos_and_counts).then(function(e){return _.extend(o.notebook_info_,e.notebooks),_.extend(o.num_stars_,e.num_stars),_.extend(e.notebooks,n),e.notebooks})},remove_notebook_view:function(e,t){var o=this;function n(e){var t=o.get_node_by_id(e);t?o.remove_node(t):console.log("tried to remove node that doesn't exist: "+e)}this.my_friends_[e]&&n(this.node_id("friends",e,t)),n(this.node_id("alls",e,t))},populate_users:function(e){var t=this;return _.isString(e)&&(e=[e]),e.forEach(function(e){t.lazy_load_[e]=!0}),{label:"All Notebooks",id:"/alls",children:_.map(e,function(e){return t.lazy_node("alls",e)}).sort(this.compare_nodes.bind(this))}},populate_friends:function(e){var t=this;return{label:"People I Starred",id:"/friends",children:e.filter(function(e){return 0<t.my_friends_[e]}).map(function(e){return t.lazy_node("friends",e)}).sort(this.compare_nodes.bind(this))}},get_folder_last_commit_date:function(e){return this.folder_last_commits[e]},get_most_recent_child:function(e){var t=this,n=null,r=[],i=function(e){return{id:e.id,last_commit:e.last_commit}},s=function(e){var o;e&&e.children&&(o=e,_.findWhere(r,{parent_id:o.id})||r.push({parent_id:o.id,children:_.map(o.children,function(e){return i(e)})}),_.each(o.children,function(t){var e=_.filter(r,function(e){return o.id!=e.parent_id&&-1!=_.pluck(e.children,"id").indexOf(o.id)});_.each(e,function(e){e.children.push(i(t))})}),_.each(e.children,function(e){e.last_commit>n&&(n=e.last_commit),s(e)}))};return s(e),_.each(r,function(e){t.folder_last_commits[e.parent_id]=_.max(_.pluck(e.children,"last_commit"))}),n},is_date_sorted:function(){return this.sorted_by_===this.orderType.DATE_DESC},compare_nodes:function(e,t){var o=e.sort_order-t.sort_order,n=this;if(o)return o;var r=e.name||e.label,i=t.name||t.label;if(this.sorted_by_===this.orderType.DEFAULT||e.sort_order!==this.order.NOTEBOOK||t.sort_order!==this.order.NOTEBOOK){var s=RCloud.utils.split_number(r),l=RCloud.utils.split_number(i);if(s&&l&&s[0]==l[0])return+s[1]-+l[1];var a=r.localeCompare(i);if(0===a){if(e.children){if(t.children)throw new Error("uh oh, parallel folders");return-1}if(t.children)return 1;a=e.gistname.localeCompare(t.gistname)}return a}var c=function(e){return e.last_commit||e.children?e.last_commit?new Date(e.last_commit):n.get_most_recent_child(e):1/0};return c(t)-c(e)},lazy_node:function(e,t){var o=t===this.username_,n=this.node_id(e,t);return{label:o?"My Notebooks":this.someone_elses(t),id:n,sort_order:o?this.order.MYFOLDER:this.order.SUBFOLDER,children:[{label:"loading..."}],user:t,root:e}},populate_interests:function(e){var o=this;var t,n,r=(t=Object.keys(e),n={},_.each(t,function(e){var t=o.notebook_info_[e];return t?t.username&&"undefined"!==t.username&&t.description&&t.last_commit?(n[t.username]=n[t.username]||{})[e]=t:o.invalid_notebooks_[e]=t:o.invalid_notebooks_[e]=null,n}),n),i=[];for(var s in r){var l=r[s];for(var a in l)this.add_interest(s,a),l[a].description||(l[a].description="(no description)");var c=this.convert_notebook_set("interests",s,l),u=this.node_id("interests",s),d=s===this.username_,f={label:d?"My Notebooks":this.someone_elses(s),id:u,sort_order:d?this.order.MYFOLDER:this.order.SUBFOLDER,children:this.as_folder_hierarchy(c,u).sort(this.compare_nodes.bind(this))};i.push(f)}return{label:"Notebooks I Starred",id:"/interests",children:i.sort(this.compare_nodes.bind(this))}},as_folder_hierarchy:function(e,i,s){var l=this;function t(e){return e.label.match(/([^/]+)\/(.+)/)}var o=e;if(_.some(o,function(e){return void 0===e.label||null===e.label}))throw new Error("incomplete notebook entry (has it been shown yet?)");o=_.filter(o,t),o=_.map(o,function(e){var t=e.label.match(/([^/]+)\/(.+)/),o=_.clone(e);return o.folder_name=t[1],o.label=t[2],o}),o=_.groupBy(o,function(e){return e.folder_name}),o=_.map(o,function(e,t){var o=_.map(e,function(e){return _.omit(e,"folder_name")}),n=i+"/"+t,r=(s?s+"/":"")+t;return{label:t,full_name:r,user:e[0].user,sort_order:l.order.NOTEBOOK,id:n,children:l.as_folder_hierarchy(o,n,r)}});var n=_.filter(e,function(e){return!t(e)});return n.forEach(function(e){e.full_name=(s?s+"/":"")+e.label}),n.concat(o).sort(this.compare_nodes.bind(this))},convert_notebook_set:function(e,t,o){var n=[];for(var r in o){var i=o[r],s={label:i.description,gistname:r,user:t,root:e,visible:i.visible,source:i.source,last_commit:i.last_commit?new Date(i.last_commit):"none",id:this.node_id(e,t,r),sort_order:this.order.NOTEBOOK,fork_desc:i.fork_desc};n.push(s)}return n},node_id:function(e,t,o,n){for(var r="",i=0;i<arguments.length;++i)r=r+"/"+arguments[i];return r},load_user_notebooks:function(l){var a=this,c=function(e){a.matches_filter_=_.union(a.matches_filter_,e.matching_notebooks),a.empty_folders_=_.union(a.empty_folders_,e.empty_folders)};return a.lazy_load_[l]?a.get_notebooks_by_user(l).then(function(e){var t,o=a.node_id("alls",l),n=a.get_node_by_id(o),r=a.convert_notebook_set("alls",l,e),i=a.as_folder_hierarchy(r,o).sort(a.compare_nodes.bind(a));if(c(a.get_filter_matches([{children:i}])),delete a.lazy_load_[l],a.load_tree_data(i,o),a.my_friends_[l]){var s=a.duplicate_tree_data(n,a.transpose_notebook("friends"));c(a.get_filter_matches([{children:s}])),a.load_tree_data(s.children,a.node_id("friends",l)),t=s.children}a.on_load_by_user.notify({pid:a.node_id("alls",l),data:i,duplicate_data:t,duplicate_parent_id:a.node_id("friends",l)})}):Promise.resolve()},add_notebook_info:function(e,t,o){this.notebook_info_[t]||(this.notebook_info_[t]={}),_.extend(this.notebook_info_[t],o);var n=rcloud.set_notebook_info(t,o);return e===this.username()&&(n=n.then(function(){rcloud.config.add_notebook(t)})),n},tag_notebook_version:function(e,t,o){for(var n=this.histories_[e],r=0;r<n.length;++r)n[r].version===t&&(n[r].tag=o),n[r].tag===o&&n[r].version!=t&&(n[r].tag=void 0)},update_notebook:function(t,o,n,r){var i=this;return i.load_user_notebooks(t).then(function(){var e=i.notebook_info_[o]||{};return e.username=t,e.description=n,e.last_commit=r,i.add_notebook_info(t,o,e),e})},update_notebook_from_gist:function(e,t,o){var n=e.user.login,r=e.id,i=this;return t&&(i.histories_[r]=t),i.update_notebook(n,r,e.description,e.updated_at||e.history[0].committed_at).then(function(e){return i.update_notebook_view(n,r,e,o)})},skip_user_level:function(e){return"featured"===e&&1===this.featured_.length},update_tree_node:function(e,t){_.extend(e,t),this.on_update_node.notify({node:e,data:t})},set_node_open_status:function(e,t){this.get_node_by_id(e.id).is_open=t},remove_node:function(e){var t=this.get_parent(e.id);if(this.on_fake_hover.notify({node:e}),t.children=_.without(t.children,_.findWhere(t.children,{id:e.id})),this.remove_node_notify({node:e}),this.remove_empty_parents(t),"interests"===e.root&&e.user!==this.username_&&0===t.children.length){var o=this.get_node_by_id("/interests");o.children=_.without(o.children,_.findWhere(o.children,{id:t.id})),this.remove_node_notify({node:t})}},remove_node_notify:function(e){this.matches_filter_=_.without(this.matches_filter_,e.node.id),this.on_remove_node.notify(e)},unstar_notebook_view:function(e,t,o){var n=this.node_id("interests",e,t),r=this.get_node_by_id(n);if(r)return this.remove_node(r),this.update_notebook_view(e,t,this.get_notebook_info(t),o);console.log("attempt to unstar notebook we didn't know was starred",n)},update_notebook_view:function(n,r,e,t){var i=this;function o(e){if(i.current_.version){var t=i.skip_user_level(e.root)?i.node_id(e.root,r,i.current_.version):i.node_id(e.root,n,r,i.current_.version),o=i.get_node_by_id(t);if(!o)throw new Error("tree node was not created for current history");e=o}i.on_select_node.notify({node:e})}var s,l=i.my_stars_[r]||!1,a=[];if(!0===t&&(t=0<=i.featured_.indexOf(n)?"featured":l?"interests":i.my_friends_[n]?"friends":"alls"),l&&(s=i.update_tree_entry("interests",n,r,e,!0),"interests"===t&&(s=s.then(o)),a.push(s)),r===i.current_.notebook){var c=RCloud.UI.navbar.control("star_notebook");c&&(c.set_fill(l),c.set_count(i.num_stars_[r]))}return i.my_friends_[n]&&(s=i.update_tree_entry("friends",n,r,e,!0),"friends"===t&&(s=s.then(o)),a.push(s)),0<=i.featured_.indexOf(n)&&(s=i.update_tree_entry("featured",n,r,e,!0),"featured"===t&&(s=s.then(o)),a.push(s)),s=i.update_tree_entry("alls",n,r,e,!0),"alls"===t&&(s=s.then(o)),a.push(s),Promise.all(a)},find_sort_point:function(e,t){if(t.children)for(var o=0;o<t.children.length;++o){var n=t.children[o];if(this.compare_nodes.call(this,e,n)<0)return{child:n,position:o}}},insert_in_order:function(e,t){e.gistname&&1==RCloud.utils.filter(e,_.values(this.tree_filters_)).length&&this.matches_filter_.push(e.id),"string"==typeof t&&(t=this.get_node_by_id(t));var o=this.find_sort_point(e,t);return o?(t.children.splice(o.position,0,e),this.on_add_node_before.notify({node_to_insert:e,existing_node:o.child})):(t.children||(t.children=[]),t.children.push(e),this.on_append_node.notify({node_to_insert:e,parent_id:t.id})),e},traverse:function(){!function e(t){for(var o in t)t[o]&&"object"==typeof t[o]&&(console.log("traverse output: ",t[o]),e(t[o]))}(this.tree_data_)},get_filter_matches:function(e){var r=[],i=this,s=[],l=[],a=function(e,t){_.each(e,function(e){e.matches_filter=t})},c=function(t){for(var o in t)if(t[o]&&"object"==typeof t[o]){if(t[o].hasOwnProperty("children"))if(l=_.filter(t[o].children,function(e){return e.gistname&&!e.version}),a(l,!1),(l=RCloud.utils.filter(l,_.values(i.tree_filters_)))&&l.length){if(r.push.apply(r,l),a(l,!0),!t[o].gistname){var n=[];_.each(s,function(e){t[o].id.startsWith(e.id)&&n.push(e)}),s=_.difference(s,n)}}else t[o].gistname||s.push(t[o]);c(t[o])}};return c(e),{matching_notebooks:_.pluck(r,"id"),empty_folders:_.pluck(s,"id")}},sanitize_tree_setting:function(e,t){var o=_.findWhere([{key:"tree-filter-date",default_value:"all",valid_values:["all","last7","last30"]},{key:"tree-sort-order",default_value:"name",valid_values:["name","date_desc"]}],{key:e});return o?(null==t&&(t=""),0<=o.valid_values.indexOf(t.toLocaleLowerCase())?t.toLocaleLowerCase():o.default_value):(console.warn('Unknown setting_key "',e,'"'),t)},update_filter:function(e){if("tree-filter-date"==e.prop)switch(e.value){case null:case"all":this.tree_filters_[e.prop]=function(){return!0};break;case"last7":case"last30":var t=e.value.replace("last",""),o=this;this.tree_filters_[e.prop]=function(e){return e.gistname==o.current_.notebook||RCloud.utils.date_diff_days(e.last_commit,new Date)<t};break;default:console.warn("Unknown value for date filter type passed to notebook_tree_model.update_filter(...)")}var n=this.get_filter_matches(this.tree_data_);this.matches_filter_=n.matching_notebooks,this.empty_folders_=n.empty_folders,this.on_update_show_nodes.notify({nodes:this.matches_filter_,empty_folders:this.empty_folders_,filter_props:e}),rcloud.config.set_user_option(e.prop,e.value)},does_notebook_match_filter:function(e){return-1!=this.matches_filter_.indexOf(e)},does_folder_have_matching_descendants:function(e){return-1==this.empty_folders_.indexOf(e)},update_sort_type:function(e,t){var o,n=this;if(o="date_desc"==e.toLocaleLowerCase()?this.orderType.DATE_DESC:this.orderType.DEFAULT,this.sorted_by_!=o){if(this.sorted_by_=o,t){var r=[],i=function(e){for(var t in e)e[t]&&"object"==typeof e[t]&&(e[t].hasOwnProperty("children")&&(e[t].children.length&&!e[t].children[0].version&&e[t].children.sort(n.compare_nodes.bind(n)),r.push({node_id:e[t].id,children:e[t].children})),i(e[t]))};i(this.tree_data_),this.on_update_sort_order.notify({tree_data:this.tree_data_,sort_type:e})}rcloud.config.set_user_option("tree-sort-order",e)}},get_node_by_id:function(n){var r;return function e(t){for(var o in t)if(t[o]&&"object"==typeof t[o]){if(t[o].id===n){r=t[o];break}e(t[o])}}(this.tree_data_),r},get_parent:function(l){return function e(t,o){var n,r=null;if(t instanceof Array)for(var i=0;i<t.length&&!(r=e(t[i],o));i++);else for(var s in t){if("id"===s&&t.hasOwnProperty("children")&&(n=t,_.find(n.children,function(e){return e.id===l})))return t;if((t[s]instanceof Object||t[s]instanceof Array)&&(r=e(t[s],o)))break}return r}(this.tree_data_,l)},load_tree_data:function(e,t){var o=this.get_node_by_id(t);o&&(o.children=e)},duplicate_tree_data:function(e,t){console.assert(!e.user||!this.lazy_load_[e.user]);var o=t(e);if(e.children){for(var n=[],r=0;r<e.children.length;++r)n.push(this.duplicate_tree_data(e.children[r],t));o.children=n}return o},transpose_notebook:function(o,e){var n="/alls/";return e&&(n+=e+"/"),function(e){var t=_.pick(e,"label","name","full_name","gistname","user","visible","source","last_commit","sort_order","version");return t.id=e.id.replace(n,"/"+o+"/"),t.root=o,t}},update_tree:function(e,t,o,n,r,i){var s=this;if(!e)throw new Error("need root");if(!t)throw new Error("need user");if(!o)throw new Error("need gistname");var l=this.skip_user_level(e),a=l?this.node_id(e):this.node_id(e,t),c=this.get_node_by_id(a),u=null,d=null;if(!c){var f=t===this.username_;if(!(c=this.get_node_by_id(this.node_id(e))))throw new Error("root '"+e+"' of notebook tree not found!");l||(u={label:f?"My Notebooks":this.someone_elses(t),id:this.node_id(e,t),sort_order:f?this.order.MYFOLDER:this.order.SUBFOLDER},c=this.insert_in_order(u,c))}for(c.delay_children&&(delete c.delay_children,this.on_load_children.notify({node:c}));"children"in n;)(d=this.get_node_by_id(n.id))||(u=_.omit(n,"children"),d=this.insert_in_order(u,c)),c=d,n=n.children[0];var h=n,p=l?s.node_id(e,o):s.node_id(e,t,o);if(!(d=s.get_node_by_id(p))&&!i)return null;h.gistname=o,h.id=p,h.root=e,h.user=t;var m=function(e,t,o){e.children=_.without(e.children,_.findWhere(e.children,{id:t.id})),s.remove_node_notify({node:t}),o?t=s.insert_in_order(o,e):s.insert_in_order(t,e)};if(d){d.children,r&&r(d);var g=this.get_parent(d.id);if(g===c&&d.label===h.label&&this.sorted_by_!==this.orderType.DATE_DESC)this.update_tree_node(d,h);else if(g.children=_.without(g.children,_.findWhere(g.children,{id:d.id})),this.remove_node_notify({node:d}),d=this.insert_in_order(h,c),this.remove_empty_parents(g),this.sorted_by_===this.orderType.DATE_DESC)for(var v=d;c=this.get_parent(v.id),-1==[s.order.NOTEBOOK,s.order.MYFOLDER].indexOf(c.sort_order)?c=null:m(c,v,v.id===h.id?h:void 0),v=c;);}else if(d=s.insert_in_order(h,c),this.sorted_by_===this.orderType.DATE_DESC)for(v=d;c=this.get_parent(v.id),-1==[s.order.NOTEBOOK,s.order.MYFOLDER].indexOf(c.sort_order)?c=null:(m(c,v,v.id===h.id?h:void 0),d.id===v.id&&(d=v)),v=c;);return d},remove_empty_parents:function(e){if(e)for(;!e.children.length&&e.sort_order===this.order.NOTEBOOK;){var t=this.get_parent(e.id);t.children=_.without(t.children,_.findWhere(t.children,{id:e.id})),this.remove_node_notify({node:e,fake_hover:!1}),e=t}},update_tree_entry:function(e,t,o,n,r){var i=this,s={user:t,label:n.description,last_commit:new Date(n.last_commit),sort_order:this.order.NOTEBOOK,source:n.source,visible:n.visible},l="hide",a=null,c=i.as_folder_hierarchy([s],i.skip_user_level(e)?i.node_id(e):i.node_id(e,t))[0],u=i.update_tree(e,t,o,c,function(e){e.children&&e.children.length&&(l="index",a=e.children.length,e.children[a-1].id.startsWith("showmore")&&--a)},r);return u?(o===this.current_.notebook&&this.current_.version&&(l="sha",a=this.current_.version),this.update_history_nodes(u,l,a)):Promise.resolve(null)},toggle_folder_friendness:function(e){var t;if(this.my_friends_[e]){var o,n=this.get_node_by_id(this.node_id("alls",e));if(n)o=this.duplicate_tree_data(n,this.transpose_notebook("friends"));else{var r=e===this.username_;o={label:r?"My Notebooks":this.someone_elses(e),id:this.node_id("friends",e),sort_order:r?this.order.MYFOLDER:this.order.SUBFOLDER}}t=this.get_node_by_id(this.node_id("friends"));var i=this.insert_in_order(o,t);this.on_load_data.notify({children:o.children,node:i})}else{var s=this.get_node_by_id(this.node_id("friends",e));(t=this.get_parent(s.id)).children=_.without(t.children,_.findWhere(t.children,{id:s.id})),this.remove_node_notify({node:s})}},find_index:function(e,t){for(var o=0;o<e.length;o++)if(t(e[o],o,e))return o;return-1},find_next_copy_name:function(l,a){var c=this;return this.load_user_notebooks(l).then(function(){var e=-1===a.indexOf("/")?c.node_id("alls",l):c.node_id("alls",l,a.replace(/\/[^\/]*$/,"")),t=c.get_node_by_id(e);if(void 0===t)return a;var o,n,r,i,s=_.object(_.map(t.children,function(e){return[e.full_name,!0]}));if(!s[a])return a;for((o=RCloud.utils.split_number(a))?(n=o[0],r=+o[1]):(n=a+" ",r=1);s[i=n+ ++r];);return i})},update_history_nodes:function(g,t,n){var v=!1,b=null,y=this;function k(){var e=g.children.length;return b?e-1:e}var o,r=function(e,t){var o=y.find_index(e,function(e){return e.version===t});if(o<0)throw new Error("didn't find sha "+n+" in history");return o+5-1};function i(e){function a(e){var t=c[e];return(e+1<c.length?function(e,t){var o=(e=new Date(e))-(t=new Date(t)),n=e.getMinutes()===t.getMinutes(),r=e.getHours()===t.getHours(),i=e.toLocaleDateString()===t.toLocaleDateString();return o<=6e4&&r&&n&&this.show_terse_dates_?null:RCloud.utils.format_date_time_stamp(e,o,i,!0,this.show_terse_dates_)}.call(this,t.committed_at,c[e+1].committed_at):new Date(t.committed_at))||"none"}function t(e,t,o){var n=c[t],r={};_.extend(r,g),delete r.children;var i,s,l=n.version.substring(0,10);return r.committed_at=new Date(n.committed_at),r.last_commit=o?r.committed_at:a.call(this,t),r.label=n.tag?n.tag:l,r.version=n.version,r.id=g.id+"/"+r.version,i=r,s=e,v&&(i.color=s),r}function o(e,t){var o=c[t],n=o.version.substring(0,10),r={label:o.tag?o.tag:n};this.on_update_node.notify({node:e,data:r})}var c=y.histories_[g.gistname].slice(1);if(c){if(e=Math.min(e,c.length),v)for(var n=0,r=k();n<r;++n)this.on_update_node.notify({node:g.children[f],data:{color:""}});b&&this.on_update_node.notify({node:g.children[g.children.length-2],data:{last_commit:a(g.children.length-2)}});var i,s,l=null,u=0===g.children.length;if(u)i=e,l=function(e){g.children||(g.children=[]),g.children.push(e),this.on_append_node.notify({node_to_insert:e,parent_id:g.id})};else{var d=g.children[0];i=y.find_index(c,function(e){return e.version==d.version}),l=function(e){g.children.splice(i-1,0,e),this.on_add_node_before.notify({node_to_insert:e,existing_node:d})}}for(var f=0;f<i;++f)s=t.call(this,"green",f,u&&f==i-1),l.call(y,s);var h=k();for(f=i;f<h;++f)o.call(y,g.children[f],f);if(h<e)for(l=b?function(e){g.children.splice(g.children.length-1,0,e),this.on_add_node_before.notify({node_to_insert:e,existing_node:b})}:function(e){g.children||(g.children=[]),g.children.push(e),this.on_append_node.notify({node_to_insert:e,parent_id:g.id})},f=h;f<e;++f)s=t("mediumpurple",f,f==e-1),l.call(y,s);else e<h&&(g.children=g.children.splice(0,e),this.remove_history_nodes.notify({node:g,from_index:e}));if(b){if(e===c.length){var p=this.get_parent(b.id);p.children=_.without(p.children,_.findWhere(p.children,{id:b.id})),this.remove_node_notify({node:b}),b=null}}else if(e<c.length){var m={label:"...",id:"showmore-"+g.id};g.children.push(m),this.on_append_node.notify({node_to_insert:m,parent_id:g.id})}}}if(g.children||(g.children=[]),g.children&&g.children.length&&g.children[g.children.length-1].id.startsWith("showmore")&&(b=g.children[g.children.length-1]),"hide"===t)return g.children=[],this.remove_history_nodes.notify({node:g}),Promise.resolve(g);if("index"===t)o=Math.max(n,5);else if("same"===t)o=k();else if("more"===t)o=k()+5;else{if("sha"!==t)throw new Error("update_history_nodes don't understand how to seek '"+t+"'");y.histories_[g.gistname]&&(o=r(y.histories_[g.gistname],n))}return y.histories_[g.gistname]?(i.call(y,o),Promise.resolve(g)):rcloud.load_notebook(g.gistname,null).then(function(e){return y.histories_[g.gistname]=e.history,"sha"===t&&(o=r(y.histories_[g.gistname],n)),i.call(y,o),g}.bind(y))},get_infos_and_counts:function(e){return Promise.all([rcloud.stars.get_multiple_notebook_star_counts(e),rcloud.get_multiple_notebook_infos(e)]).spread(function(e,t){return{notebooks:RCloud.utils.clean_r(t),num_stars:RCloud.utils.clean_r(e)}})},get_starred_info:function(){return rcloud.stars.get_my_starred_notebooks().then(this.get_infos_and_counts)},get_recent_info:function(){var t=this;return rcloud.config.get_recent_notebooks().then(function(e){return t.get_infos_and_counts(Object.keys(e))})},get_featured:function(){var o=this;return rcloud.config.get_alluser_option("featured_users").then(function(e){return o.featured_=e||[],_.isString(o.featured_)&&(o.featured_=[o.featured_]),o.featured_.length?o.get_notebooks_by_user(o.featured_[0]).then(function(e){var t=o.convert_notebook_set("featured",o.featured_[0],e).map(function(e){return e.id="/featured/"+e.gistname,e});return{label:"RCloud Sample Notebooks",id:"/featured",children:o.as_folder_hierarchy(t,o.node_id("featured")).sort(o.compare_nodes.bind(o))}}):null})},update_history:function(e,t){var o=this;_.isBoolean(t)&&(t={toggle:t});var n=t.update?"same":"more",r=o.get_node_by_id(e.id);if(r.children&&r.children.length){if(!r.is_open)return o.on_open_node.notify({node:r}),Promise.resolve(void 0);t.toggle&&(n="hide")}return o.update_history_nodes(r,n,null).then(function(e){var t=0;o.histories_[e.gistname]&&(t=o.histories_[e.gistname].length),o.on_show_history.notify({node:e,history_len:t}),e.is_open=!0})},load_everything:function(){var l,a=this;return Promise.all([rcloud.get_users(),a.get_starred_info(),a.get_recent_info(),rcloud.get_gist_sources(),rcloud.config.get_user_option(["notebook-path-tips","tree-sort-order","tree-filter-date"])]).spread(function(t,o,e,n,r){for(var i in l=r,a.path_tips_=r["notebook-path-tips"],a.gist_sources_=n,_.extend(a.notebook_info_,o.notebooks),e.notebooks)a.notebook_info_[i]||(a.notebook_info_[i]=e.notebooks[i],a.notebook_info_[i].recent_only=!0);var s;return _.extend(a.num_stars_,e.num_stars),t=_.union(t,_.compact(_.pluck(o.notebooks,"username"))),Promise.all([rcloud.config.get_current_notebook(),a.get_featured()]).spread(function(e,t){a.current_=e,a.num_stars_=o.num_stars,s=t}).then(function(){var e=a.populate_users(t);return[s,a.populate_interests(o.notebooks),a.populate_friends(t),e].filter(function(e){return!!e})})}).then(function(e){this.tree_data_=e,_.each(["tree-sort-order","tree-filter-date"],function(e){l[e]=a.sanitize_tree_setting(e,l[e])}),this.update_filter({prop:"tree-filter-date",value:l["tree-filter-date"]}),this.update_sort_type("name",!0),this.on_initialise_tree.notify({data:e}),this.on_settings_complete.notify(l)}.bind(a)).then(function(){for(var e in this.invalid_notebooks_){var t=this.invalid_notebooks_[e];t?console.log("notebook metadata for "+e+" has invalid entries: "+JSON.stringify(_.pick(t,"username","description","last_commit","visible","source"))):console.log("notebook metadata for "+e+" is missing.")}}.bind(a)).catch(rclient.post_rejection)}},n}(),RCloud.UI.notebook_tree_view=function(e){var t=function(e){"use strict";this.model_=e,this.$tree_=null,this.tree_controls_root_selector="#tree-controls",this.$sort_order_select_=$("#tree_sort_order"),this.date_filter_=new RCloud.UI.date_filter("#tree-filter-by"),this.on_notebook_open=new RCloud.UI.event(this);var r=this,o=function(t){t&&t.children&&_.each(t.children,function(e){r.$tree_.tree("appendNode",e,r.$tree_.tree("getNodeById",t.id)),o(e)})};this.date_filter_.on_change.attach(function(e,t){r.model_.update_filter(t)}),this.model_.on_settings_complete.attach(function(e,o){$(r.tree_controls_root_selector).find("[data-settingkey]").each(function(){var e=$(this).data("settingkey"),t=o[e];null!=t&&$(this).val(t)})}),this.model_.on_initialise_tree.attach(function(e,t){var o=window.performance?window.performance.now():0;r.$tree_=$("#editor-book-tree"),r.$sort_order_select_.on("change",r.change_sort_order.bind(r)),r.$tree_.tree({data:t.data,onCreateLi:r.on_create_tree_li.bind(r),selectable:!0,useContextMenu:!1,keyboardSupport:!1}),r.$tree_.bind("tree.click",r.tree_click.bind(r)),r.$tree_.bind("tree.open",r.tree_open.bind(r)),r.$tree_.bind("tree.close",r.tree_close.bind(r)),o&&console.log("load tree took "+(window.performance.now()-o));var n=r.$tree_.tree("getNodeById","/interests");r.$tree_.tree("openNode",n)}),this.model_.on_update_sort_order.attach(function(e,t){if(r.$tree_){var o=r.$tree_.tree("getState");r.$tree_.tree("loadData",t.tree_data),r.$tree_.tree("setState",o)}r.$sort_order_select_.val(t.sort_type)}),this.model_.on_update_show_nodes.attach(function(e,o){r.$tree_&&r.$tree_.tree("getTree").iterate(function(t){return t.gistname?_.find(o.nodes,function(e){return t.id.startsWith(e)})?$(t.element).show():$(t.element).hide():1===t.sort_order&&(-1!=o.empty_folders.indexOf(t.id)?$(t.element).hide():$(t.element).show()),!0}),"tree-filter-date"==o.filter_props.prop&&r.date_filter_.val(o.filter_props.value)}),this.model_.on_load_by_user.attach(function(e,t){var o=r.$tree_.tree("getNodeById",t.pid);r.$tree_.tree("loadData",t.data,o),t.duplicate_data&&r.$tree_.tree("loadData",t.duplicate_data,r.$tree_.tree("getNodeById",t.duplicate_parent_id))}),this.model_.on_open_and_select.attach(function(e,t){var o=t.node;if(t.isHistorical){if(r.$tree_.tree("openNode",r.$tree_.tree("getNodeById",t.node.id)),!(o=r.$tree_.tree("getNodeById",t.id)))throw new Error("tree node was not created for current history")}else o=r.$tree_.tree("getNodeById",t.id);r.select_node(o)}),this.model_.on_select_node.attach(function(e,t){var o=r.$tree_.tree("getNodeById",t.node.id);r.$tree_.tree("selectNode",o),r.scroll_into_view(o).then(function(){o.user===e.username_?RCloud.UI.notebook_title.make_editable(o,o.element,!0):RCloud.UI.notebook_title.make_editable(null)})}),this.model_.on_load_children.attach(function(e,t){console.warn("redundant code?"),r.$tree_.tree("loadData",t.node.delay_children,t.node)}),this.model_.on_add_node_before.attach(function(e,t){r.$tree_.tree("addNodeBefore",t.node_to_insert,r.$tree_.tree("getNodeById",t.existing_node.id)),o(t.node_to_insert)}),this.model_.on_append_node.attach(function(e,t){r.$tree_.tree("appendNode",t.node_to_insert,r.$tree_.tree("getNodeById",t.parent_id)),o(t.node_to_insert)}),this.model_.on_load_data.attach(function(e,t){r.$tree_.tree("loadData",t.children,r.$tree_.tree("getNodeById",t.node.id))}),this.model_.on_update_node.attach(function(e,t){r.$tree_.tree("updateNode",r.$tree_.tree("getNodeById",t.node.id),t.data)}),this.model_.on_remove_node.attach(function(e,t){var o=r.$tree_.tree("getNodeById",t.node.id);t.fake_hover&&ui_utils.fake_hover(o),r.$tree_.tree("removeNode",o)}),this.model_.on_fake_hover.attach(function(e,t){ui_utils.fake_hover(r.$tree_.tree("getNodeById",t.node.id))}),this.model_.on_open_node.attach(function(e,t){r.$tree_.tree("removeNode",r.$tree_.tree("getNodeById",t.node.id))}),this.model_.on_show_history.attach(function(e,t){1===t.history_len&&$(".history i",$(r.$tree_.tree("getNodeById",t.node.id).element)).addClass("button-disabled"),r.$tree_.tree("openNode",r.$tree_.tree("getNodeById",t.node.id))}),this.model_.remove_history_nodes.attach(function(e,t){var o,n=r.$tree_.tree("getNodeById",t.node.id);if(n.children)if(t.from_index)for(o=n.children.length-1;o>=t.from_index;--o)r.$tree_.tree("removeNode",n.children[o]);else for(o=n.children.length-1;0<=o;o--)r.$tree_.tree("removeNode",n.children[o])})};return t.prototype={change_sort_order:function(e){var t=$(e.target).val();this.model_.update_sort_type(t,!0),this.scroll_into_view(this.$tree_.tree("getSelectedNode"))},tree_click:function(e){return e.node.id.startsWith("showmore")?this.model_.update_history(e.node.parent,!1):e.node.gistname?e.click_event.metaKey||e.click_event.ctrlKey?this.on_notebook_open.notify({gistname:e.node.gistname,version:e.node.version,source:e.node.source,selroot:!0,new_window:!0}):e.node.gistname===this.model_.get_current().notebook&&e.node.version==this.model_.get_current().version&&null==e.node.version?this.select_node(e.node):this.on_notebook_open.notify({gistname:e.node.gistname,version:e.node.version||null,source:e.node.source,selroot:e.node.root,new_window:!1}):(e.node.is_open||(this.$tree_.tree("openNode",e.node),ui_utils.fake_hover(e.node)),this.model_.set_node_open_status(e.node,e.node.is_open)),!1},select_node:function(e){this.scroll_into_view(e).then(function(){this.$tree_.tree("selectNode",e),e.user===this.model_.username_?RCloud.UI.notebook_title.make_editable(e,e.element,!0):RCloud.UI.notebook_title.make_editable(null)})},scroll_into_view:function(o){var n=this;return new Promise(function(e){for(var t=o.parent;t;)n.$tree_.tree("openNode",t),t=t.parent;ui_utils.scroll_into_view(n.$tree_,50,100,function(){e()},$(o.element))})},remove_node:function(e){var t=e.parent;ui_utils.fake_hover(e),$tree_.tree("removeNode",e),this.remove_empty_parents(t),"interests"===e.root&&e.user!==this.model_.username_&&0===t.children.length&&$tree_.tree("removeNode",t)},remove_empty_parents:function(e){for(;0===e.children.length&&e.sort_order===this.model_.order.NOTEBOOK;){var t=e.parent;$tree_.tree("removeNode",e),e=t}},reselect_node:function(e){var t=$tree_.tree("getSelectedNode");return e().then(function(){var e=$tree_.tree("getNodeById",t.id);e?this.select_node(e):console.log("sorry, neglected to highlight "+t.id)})},tree_open:function(e){var t=e.node;t.full_name&&t.user===this.model_.username()&&!t.gistname&&RCloud.UI.notebook_title.make_editable(t,t.element,!0),$("#collapse-notebook-tree").trigger("size-changed"),t.user&&this.model_.lazy_load_[t.user]&&this.model_.load_user_notebooks(t.user)},tree_close:function(e){var t=e.node;t.full_name&&!t.gistname&&RCloud.UI.notebook_title.make_editable(t,t.element,!1)},display_date:function(e){return $(this.display_date_html(e))[0]},display_date_html:function(e){if("none"===e)return"";if("string"==typeof e)return e;var t=new Date(e),o=new Date-t;return RCloud.utils.format_date_time_stamp(t,o,!0,!1,this.model_.show_terse_dates())},highlight_node:function(o){var n=this;return function(){return new Promise(function(e){for(var t=o.parent;t.sort_order===n.model_.order.NOTEBOOK;)n.$tree_.tree("openNode",t),t=t.parent;ui_utils.scroll_into_view(n.$tree_,150,150,function(){$(o.element).closest(".jqtree_common").effect("highlight",{color:"#fd0"},1500,function(){e()})},$(o.element))})}},highlight_notebooks:function(e){var t=this;_.map(_.isArray(e)?e:[e],function(e){return t.$tree_.tree("getNodeById","/"+["interests",t.model_.username_,e.id].join("/"))}).map(function(e){return t.highlight_node(e)}).reduce(function(e,t){return e.then(t)},Promise.resolve()).then(function(){})},on_create_tree_li:function(e,t){var o,n,r,i=t.find(".jqtree-element"),s=i.find(".jqtree-title");if(s.css("color",e.color),this.model_.path_tips()&&i.attr("title",e.id),e.gistname&&(e.source?s.addClass("foreign-notebook"):e.visible||s.addClass("hidden-notebook")),(e.version||"showmore"===e.id)&&s.addClass("history"),e.last_commit)o=e.last_commit;else if(this.model_.show_folder_dates_&&this.model_.is_date_sorted()){var l=this.model_.get_folder_last_commit_date(e.id);l&&(o=l,r=!0)}o&&(n=$.el.span({class:r?"notebook-date folder":"notebook-date"},this.display_date(o)));var a,c=$.el.span({class:"notebook-right"},n);(e.user===this.model_.username_&&(this.$tree_.tree("isNodeSelected",e)||!e.gistname&&e.full_name&&e.is_open)&&RCloud.UI.notebook_title.make_editable(e,t,!0),RCloud.UI.notebook_commands.decorate(t,e,c),i.append(c),e.gistname||!e.gistname&&1==e.sort_order)&&(a=e.gistname?this.model_.does_notebook_match_filter(e.id):!!e.version||this.model_.does_folder_have_matching_descendants(e.id),e.version?i.show():i.parent()[a?"show":"hide"]())}},t}(),RCloud.UI.notebook_tree_controller=function(e,t){var o=function(e,t){"use strict";this.model_=e,this.view_=t,this.show_terse_dates_=!1,this.on_notebook_open=new RCloud.UI.event(this);var o=this;this.view_.on_notebook_open.attach(function(e,t){o.on_notebook_open.notify(t)})};return o.prototype={get_tree_data:function(){return this.model_.tree_data_},set_current:function(e){this.model_.set_current(e)},get_current:function(){return this.model_.get_current()},get_previous:function(){return this.model_.get_previous()},get_next:function(){return this.model_.get_next()},get_gist_sources:function(){return this.model_.get_gist_sources()},get_notebook_star_count:function(e){return this.model_.get_notebook_star_count(e)},set_notebook_star_count:function(e,t){this.model_.set_notebook_star_count(e,t)},notebook_star_count_exists:function(e){return this.model_.notebook_star_count_exists(e)},is_notebook_starred_by_current_user:function(e){return this.model_.is_notebook_starred_by_current_user(e)},has_notebook_info:function(e){return this.model_.has_notebook_info(e)},get_notebook_info:function(e){return this.model_.get_notebook_info(e)},set_notebook_info:function(e,t){this.model_.set_notebook_info(e,t)},add_interest:function(e,t){this.model_.add_interest(e,t)},get_my_star_count_by_friend:function(e){return this.model_.get_my_star_count_by_friend(e)},user_is_friend:function(e){return this.model_.user_is_friend(e)},remove_interest:function(e,t){this.model_.remove_interest(e,t)},show_terse_dates:function(e){this.model_.show_terse_dates(e)},set_visibility:function(e,t){return this.model_.set_visibility(e,t)},load_everything:function(){return this.model_.load_everything()},highlight_notebooks:function(e){this.view_.highlight_notebooks(e)},select_history_node:function(e){this.select_node(e),$(e.element).find(".jqtree-element:eq(0)").trigger("click")},update_notebook_view:function(e,t,o,n){return this.model_.update_notebook_view(e,t,o,n)},unstar_notebook_view:function(e,t,o){this.model_.unstar_notebook_view(e,t,o)},update_notebook_from_gist:function(e,t,o){return this.model_.update_notebook_from_gist(e,t,o)},tag_notebook_version:function(e,t,o){this.model_.tag_notebook_version(e,t,o)},toggle_folder_friendness:function(e){this.model_.toggle_folder_friendness(e)},show_history:function(e,t){this.model_.update_history(e,t)},find_next_copy_name:function(e,t){return this.model_.find_next_copy_name(e,t)},remove_notebook_view:function(e,t){this.model_.remove_notebook_view(e,t)},traverse:function(){this.model_.traverse()},update_sort_type:function(e){this.model_.update_sort_type(e)}},o}();
//# sourceMappingURL=rcloud_bundle.min.js.map